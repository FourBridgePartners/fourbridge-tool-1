<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FourBridge Relationship Intelligence System</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
        }

        /* Password Gate */
        .password-gate {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #004D4D 0%, #006666 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .password-gate.hidden {
            display: none;
        }

        .password-box {
            background: white;
            padding: 40px 50px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .password-box-logo {
            font-size: 24px;
            font-weight: 700;
            color: #004D4D;
            margin-bottom: 8px;
        }

        .password-box-subtitle {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 30px;
        }

        .password-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 16px;
        }

        .password-input:focus {
            outline: none;
            border-color: #004D4D;
        }

        .password-input.error {
            border-color: #dc3545;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .password-btn {
            width: 100%;
            padding: 14px;
            background: #004D4D;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .password-btn:hover {
            background: #003939;
        }

        .password-error {
            color: #dc3545;
            font-size: 13px;
            margin-top: 12px;
            display: none;
        }

        .password-error.show {
            display: block;
        }

        .app-content {
            display: none;
        }

        .app-content.visible {
            display: block;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }

        .header {
            background: white;
            color: #1a1a1a;
            padding: 16px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e9ecef;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-logo img {
            height: 28px;
            width: auto;
        }

        .header-logo-text {
            font-size: 22px;
            font-weight: 600;
            color: #004D4D;
            letter-spacing: -0.5px;
        }

        .header h1 {
            display: none;
        }

        .header p {
            display: none;
        }

        .tabs {
            display: flex;
            gap: 4px;
        }

        .tab {
            background: transparent;
            color: #6c757d;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab:hover {
            background: #f8f9fa;
            color: #1a1a1a;
        }

        .tab.active {
            background: #004D4D;
            color: white;
        }

        /* Segmented Control Toggle */
        .segmented-control {
            display: inline-flex;
            background: #e9ecef;
            border-radius: 10px;
            padding: 4px;
            gap: 4px;
        }

        .segmented-control button {
            background: transparent;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .segmented-control button:hover {
            color: #004D4D;
            background: rgba(255,255,255,0.5);
        }

        .segmented-control button.active {
            background: white;
            color: #004D4D;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .segmented-control button .icon {
            font-size: 16px;
        }

        /* Loading Screen */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 77, 77, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            color: white;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(95, 196, 184, 0.3);
            border-top-color: #5FC4B8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .loading-details {
            font-size: 14px;
            opacity: 0.8;
            max-width: 600px;
            text-align: center;
            padding: 0 20px;
        }

        .loading-log {
            margin-top: 20px;
            max-width: 700px;
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            text-align: left;
        }

        .log-entry {
            margin: 4px 0;
            padding: 4px 0;
        }

        .log-success { color: #5FC4B8; }
        .log-warning { color: #ffc107; }
        .log-error { color: #ff6b6b; }
        .log-info { color: #e0e0e0; }

        .view {
            display: none;
            padding: 0 40px 40px 40px;
        }

        .view.active {
            display: block;
        }

        #actions-view {
            padding: 20px 40px 40px 40px;
        }

        #actions-view .action-center-page {
            padding: 0;
        }

        .info-tip {
            background: #f8f9fa;
            border-left: 3px solid #004D4D;
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 24px;
            font-size: 13px;
            color: #495057;
        }

        /* Dashboard Summary Card */
        .dashboard-summary {
            background: #004D4D;
            border-radius: 12px;
            padding: 24px 28px;
            margin: 24px;
            color: white;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .dashboard-header h2 {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .action-list-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-list-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .dashboard-stat {
            text-align: center;
            padding: 16px 12px;
            background: rgba(255,255,255,0.08);
            border-radius: 8px;
        }

        .dashboard-stat-value {
            display: block;
            font-size: 28px;
            font-weight: 600;
            color: white;
        }

        .dashboard-stat-label {
            font-size: 11px;
            text-transform: uppercase;
            opacity: 0.7;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .dashboard-opportunities h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            opacity: 0.7;
        }

        .top-opportunities {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .opportunity-card {
            background: rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .opportunity-card:hover {
            background: rgba(255,255,255,0.15);
        }

        .opportunity-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .opportunity-meta {
            font-size: 12px;
            opacity: 0.7;
        }

        .opportunity-score {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }

        /* Priority Contacts Card in Modal */
        .priority-contacts-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .priority-contacts-header {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6c757d;
            margin-bottom: 12px;
        }

        .priority-contact-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .priority-contact-item:last-child {
            margin-bottom: 0;
        }

        .priority-contact-name {
            font-weight: 600;
            font-size: 14px;
            color: #1a1a1a;
        }

        .priority-contact-title {
            font-size: 12px;
            color: #6c757d;
        }

        .priority-contact-paths {
            font-size: 12px;
            color: #004D4D;
            font-weight: 500;
        }

        /* Related Firms Card */
        .related-firms-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e8f5f3 100%);
            border: 1px solid #b8e0d9;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .related-firms-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .related-firms-title {
            font-weight: 700;
            font-size: 14px;
            color: #004D4D;
        }

        .related-firms-badge {
            background: #004D4D;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .related-firms-stats {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 12px;
            display: flex;
            gap: 6px;
        }

        .related-firms-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .related-firm-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: white;
            border: 1px solid #e0e7ed;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .related-firm-item:hover {
            border-color: #004D4D;
            background: #f0fafa;
        }

        .related-firm-info {
            flex: 1;
        }

        .related-firm-name {
            font-weight: 600;
            font-size: 13px;
            color: #004D4D;
        }

        .related-firm-meta {
            font-size: 11px;
            color: #6c757d;
        }

        .related-firm-count {
            background: #e8f5f3;
            color: #004D4D;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Back Navigation Button */
        .back-nav-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .back-nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Connector Detail Page Styles */
        .connector-firms-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .connector-firm-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .connector-firm-item:hover {
            background: #e8f5f3;
            border-color: #004D4D;
        }

        .connector-firm-name {
            font-weight: 600;
            font-size: 14px;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .connector-firm-meta {
            font-size: 12px;
            color: #495057;
        }

        .connector-firm-via {
            font-size: 11px;
            color: #004D4D;
            margin-top: 4px;
        }

        /* Prospect Detail Page Styles */
        .prospect-connectors-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .prospect-connector-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .prospect-connector-item:hover {
            background: #e8f5f3;
            border-color: #004D4D;
        }

        .prospect-connector-name {
            font-weight: 600;
            font-size: 14px;
            color: #1a1a1a;
        }

        .prospect-connector-title {
            font-size: 12px;
            color: #6c757d;
        }

        .prospect-connector-via {
            font-size: 11px;
            color: #004D4D;
            text-align: right;
        }

        .prospect-connector-count {
            font-size: 11px;
            color: #6c757d;
            text-align: right;
        }

        /* Clickable Names */
        .clickable-name {
            cursor: pointer;
            transition: color 0.2s;
        }

        .clickable-name:hover {
            color: #004D4D;
            text-decoration: underline;
        }

        /* Connector Detail Page - Redesigned */
        .connector-stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .connector-stat-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .connector-stat-value {
            font-size: 28px;
            font-weight: 600;
            color: #004D4D;
        }

        .connector-stat-label {
            font-size: 11px;
            text-transform: uppercase;
            color: #6c757d;
            letter-spacing: 0.3px;
            margin-top: 4px;
        }

        .connector-meta-row {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 24px;
            font-size: 13px;
            color: #495057;
        }

        .connector-meta-row a {
            color: #004D4D;
            text-decoration: none;
        }

        .connector-meta-row a:hover {
            text-decoration: underline;
        }

        /* Connector Firms Grouped List */
        .connector-firms-grouped {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .connector-firm-group {
            border: 1px solid #e9ecef;
            border-radius: 6px;
            overflow: hidden;
        }

        .connector-firm-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f8f9fa;
            cursor: pointer;
            transition: background 0.2s;
        }

        .connector-firm-header:hover {
            background: #e8f5f3;
        }

        .connector-firm-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .connector-firm-expand {
            color: #6c757d;
            font-size: 10px;
            transition: transform 0.2s;
        }

        .connector-firm-group.expanded .connector-firm-expand {
            transform: rotate(90deg);
        }

        .connector-firm-name-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .connector-firm-name {
            font-weight: 600;
            font-size: 14px;
            color: #1a1a1a;
        }

        .connector-firm-count {
            font-size: 12px;
            color: #004D4D;
            background: #e8f5f3;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .connector-firm-badges {
            display: flex;
            gap: 6px;
            margin-top: 4px;
        }

        .mini-badge {
            font-size: 10px;
            padding: 2px 6px;
            background: #e9ecef;
            color: #6c757d;
            border-radius: 3px;
        }

        .view-firm-btn {
            background: transparent;
            border: 1px solid #004D4D;
            color: #004D4D;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-firm-btn:hover {
            background: #004D4D;
            color: white;
        }

        .connector-firm-contacts {
            display: none;
            padding: 0 16px 12px 44px;
            background: white;
        }

        .connector-firm-group.expanded .connector-firm-contacts {
            display: block;
        }

        .connector-firm-contact {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-left: 3px solid #e9ecef;
            margin-top: 8px;
            transition: all 0.2s;
        }

        .connector-firm-contact:hover {
            background: #f8f9fa;
            border-left-color: #004D4D;
        }

        .connector-firm-contact-info {
            cursor: pointer;
            flex: 1;
        }

        .connector-firm-contact-name {
            font-weight: 500;
            font-size: 13px;
            color: #1a1a1a;
        }

        .connector-firm-contact-title {
            font-size: 12px;
            color: #6c757d;
        }

        /* Enhanced Prospect Connector Items */
        .prospect-connector-item-enhanced {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 8px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .prospect-connector-item-enhanced:hover {
            border-color: #004D4D;
        }

        .prospect-connector-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            cursor: pointer;
        }

        .prospect-connector-main:hover {
            background: #e8f5f3;
        }

        .prospect-connector-stats {
            text-align: right;
        }

        .prospect-connector-count-big {
            font-size: 20px;
            font-weight: 600;
            color: #004D4D;
        }

        .prospect-connector-count-label {
            font-size: 10px;
            text-transform: uppercase;
            color: #6c757d;
        }

        .prospect-connector-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        .prospect-connector-via {
            font-size: 12px;
            color: #004D4D;
        }

        /* Legacy best-action-card for compatibility */
        .best-action-card {
            display: none;
        }

        .best-action-buttons {
            display: flex;
            gap: 10px;
        }

        .best-action-btn {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .best-action-btn.primary {
            background: white;
            color: #28a745;
        }

        .best-action-btn.primary:hover {
            background: #f0f0f0;
        }

        .best-action-btn.secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .best-action-btn.secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        @media (max-width: 900px) {
            .dashboard-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            .top-opportunities {
                grid-template-columns: 1fr;
            }
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: #6c757d;
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }

        input[type="text"], select {
            padding: 10px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #5FC4B8;
            box-shadow: 0 0 0 3px rgba(95, 196, 184, 0.1);
        }

        .stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 24px;
            padding: 20px 30px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .stat {
            text-align: center;
            flex: 1;
            padding: 0 15px;
            border-right: 1px solid #dee2e6;
        }
        
        .stat:last-child {
            border-right: none;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #004D4D;
            display: block;
            line-height: 1.2;
        }

        .stat-label {
            font-size: 11px;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: #004D4D;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.3px;
            color: white;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            position: relative;
        }
        
        /* Default sort arrows - show both to indicate sortable */
        th.sortable::after {
            content: " ⇅";
            opacity: 0.5;
            font-size: 10px;
            margin-left: 4px;
        }

        th:hover {
            background: #003d3d;
        }
        
        th:hover::after {
            opacity: 0.8;
        }

        th.sorted-asc::after {
            content: " ↑";
            opacity: 1;
            font-size: 12px;
        }

        th.sorted-desc::after {
            content: " ↓";
            opacity: 1;
            font-size: 12px;
        }

        td {
            padding: 14px 16px;
            border-bottom: 1px solid #e9ecef;
        }

        /* Zebra striping */
        tbody tr:nth-child(odd) {
            background: #fafbfc;
        }
        
        tbody tr:nth-child(even) {
            background: white;
        }

        tbody tr {
            transition: all 0.2s;
        }

        tbody tr:hover {
            background: #f0f7f6 !important;
        }
        
        .clickable-row {
            cursor: pointer;
        }
        
        .clickable-row:hover {
            background: #f0f4f8 !important;
        }
        
        tbody tr:hover td strong {
            text-decoration: underline;
            color: #5FC4B8;
        }
        
        /* Clickable prospect items in modal */
        .clickable-prospect-item {
            padding: 12px 15px;
            margin: 8px 0;
            background: #f8f9fa;
            border-left: 3px solid #5FC4B8;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .clickable-prospect-item:hover {
            background: #e8f5f3;
            border-left-color: #004D4D;
            transform: translateX(4px);
        }
        
        .clickable-prospect-item:hover div:first-child {
            color: #004D4D !important;
        }
        
        /* Modal back button */
        .modal-back-btn {
            display: inline-block;
            padding: 8px 16px;
            background: #f0f4f8;
            color: #004D4D;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .modal-back-btn:hover {
            background: #004D4D;
            color: white;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            white-space: nowrap;
            letter-spacing: 0.3px;
        }

        .badge-sfo, .badge-single-family-office {
            background: #e8f5f3;
            color: #004D4D;
        }

        .badge-mfo, .badge-multi-family-office {
            background: #fef3e2;
            color: #b45309;
        }

        .badge-foundation {
            background: #f3e8ff;
            color: #6b21a8;
        }

        .badge-endowment {
            background: #fee2e2;
            color: #b91c1c;
        }

        .badge-target, .badge-target_prospect {
            background: #004D4D;
            color: white;
        }

        .badge-cold, .badge-cold_lead {
            background: #f3f4f6;
            color: #6b7280;
        }

        .badge-past, .badge-past_contact {
            background: #e8f5f3;
            color: #004D4D;
        }

        /* Tiered Warm Path Badges */
        .badge-paths-low {
            background: #e8f5f3;
            color: #004D4D;
        }
        
        .badge-paths-medium {
            background: #5FC4B8;
            color: white;
        }
        
        .badge-paths-high {
            background: #004D4D;
            color: white;
        }

        .badge-unknown {
            background: #f8f9fa;
            color: #6c757d;
            border: 1px dashed #adb5bd;
        }

        /* Footer */
        .app-footer {
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            padding: 15px 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            font-size: 13px;
            color: #6c757d;
        }
        
        .app-footer span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .footer-divider {
            color: #dee2e6;
        }
        
        .footer-highlight {
            color: #5FC4B8;
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 40px 20px;
            justify-content: center;
            align-items: flex-start;
        }

        .modal-content {
            background: white;
            max-width: 900px;
            margin: 0 auto;
            border-radius: 8px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            position: relative;
            max-height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .modal-header {
            background: #004D4D;
            color: white;
            padding: 20px 24px;
            border-radius: 8px 8px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-header h2 {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
            letter-spacing: -0.3px;
        }

        .modal-subtitle {
            font-size: 13px;
            opacity: 0.8;
            margin-top: 4px;
        }

        .close-btn {
            position: absolute;
            top: 16px;
            right: 20px;
            font-size: 28px;
            color: white;
            cursor: pointer;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .close-btn:hover {
            opacity: 1;
        }

        .btn-info {
            background: #5FC4B8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-info:hover {
            background: #004D4D;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(95, 196, 184, 0.3);
        }

        .modal-body {
            padding: 24px;
        }

        .detail-section {
            margin-bottom: 24px;
        }

        .detail-section h3 {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 12px;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .detail-section p {
            color: #495057;
            line-height: 1.6;
            font-size: 14px;
        }

        .contact-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .contact-card:hover {
            border-color: #5FC4B8;
            box-shadow: 0 4px 12px rgba(95, 196, 184, 0.15);
        }

        .contact-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .contact-name {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 18px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .contact-title {
            font-size: 14px;
            color: #6c757d;
            font-style: italic;
        }

        .path-indicator {
            background: #d4edda;
            color: #155724;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
        }

        .path-list {
            margin-top: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .path-item {
            padding: 10px;
            margin: 8px 0;
            background: white;
            border-left: 3px solid #28a745;
            border-radius: 6px;
        }

        .path-item.medium {
            border-left-color: #ffc107;
        }

        .path-item.weak {
            border-left-color: #dc3545;
        }

        .path-chain {
            font-size: 14px;
            color: #2d3748;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .path-details {
            font-size: 12px;
            color: #6c757d;
        }

        .no-paths {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            color: #856404;
        }

        /* Best Connectors Section */
        .best-connectors {
            background: linear-gradient(135deg, #f8fffe 0%, #f0faf9 100%);
            border: 2px solid #5FC4B8;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .best-connector-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #5FC4B8;
        }

        .best-connector-item.top-connector {
            border-left-color: #FFD700;
            background: linear-gradient(135deg, #fffef5 0%, #fffde8 100%);
        }

        .best-connector-info {
            flex: 1;
        }

        .best-connector-name {
            font-weight: 700;
            color: #2d3748;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .best-connector-title {
            font-size: 13px;
            color: #6c757d;
            margin-top: 4px;
        }

        .best-connector-reaches {
            font-size: 12px;
            color: #5FC4B8;
            margin-top: 6px;
        }

        .best-connector-stat {
            text-align: right;
            padding-left: 15px;
        }

        .best-connector-count {
            font-size: 20px;
            font-weight: 700;
            color: #5FC4B8;
        }

        .best-connector-label {
            font-size: 11px;
            color: #6c757d;
            text-transform: uppercase;
        }

        /* Sankey Chart */
        .sankey-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .sankey-column-headers {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            margin-bottom: 0;
            font-size: 12px;
            color: #6c757d;
        }

        .sankey-flow-arrow {
            color: #adb5bd;
        }

        .sankey-flow-label {
            font-weight: 500;
            color: #004D4D;
        }

        .sankey-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .sankey-filter-btn {
            padding: 6px 12px;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            background: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            color: #6c757d;
        }

        .sankey-filter-btn:hover {
            border-color: #5FC4B8;
            color: #5FC4B8;
        }

        .sankey-filter-btn.active {
            background: #5FC4B8;
            border-color: #5FC4B8;
            color: white;
        }

        .sankey-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .sankey-title {
            font-size: 16px;
            font-weight: 700;
            color: #2d3748;
        }

        .sankey-subtitle {
            font-size: 13px;
            color: #6c757d;
            margin-top: 4px;
        }

        #sankey-chart {
            width: 100%;
            height: 280px;
        }

        .sankey-quick-links {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e9ecef;
        }

        .sankey-quick-link {
            display: inline-block;
            padding: 4px 10px;
            background: #e8f5f3;
            color: #004D4D;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sankey-quick-link:hover {
            background: #004D4D;
            color: white;
        }

        /* Contacts View Toggle */
        .contacts-view-toggle {
            display: flex;
            gap: 0;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            width: fit-content;
        }

        .view-toggle-btn {
            padding: 8px 16px;
            border: none;
            background: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            color: #6c757d;
        }

        .view-toggle-btn:hover {
            background: #f8f9fa;
        }

        .view-toggle-btn.active {
            background: #004D4D;
            color: white;
        }

        /* Connector Group Card (for View by Connector) */
        .connector-group-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .connector-group-card:hover {
            border-color: #5FC4B8;
        }

        .connector-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            cursor: pointer;
            background: #f8f9fa;
        }

        .connector-group-header:hover {
            background: #f0f7f6;
        }

        .connector-group-info {
            flex: 1;
        }

        .connector-group-name {
            font-weight: 700;
            color: #2d3748;
            font-size: 15px;
        }

        .connector-group-title {
            font-size: 13px;
            color: #6c757d;
            margin-top: 2px;
        }

        .connector-group-meta {
            font-size: 12px;
            color: #5FC4B8;
            margin-top: 4px;
        }

        .connector-group-stats {
            text-align: right;
            padding-left: 15px;
        }

        .connector-group-count {
            font-size: 24px;
            font-weight: 700;
            color: #5FC4B8;
        }

        .connector-group-label {
            font-size: 11px;
            color: #6c757d;
            text-transform: uppercase;
        }

        .connector-group-contacts {
            display: none;
            padding: 15px;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        .connector-group-card.expanded .connector-group-contacts {
            display: block;
        }

        .connector-contact-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid #5FC4B8;
        }

        .connector-contact-name {
            font-weight: 600;
            color: #2d3748;
        }

        .connector-contact-title {
            font-size: 12px;
            color: #6c757d;
        }

        /* Multi-path highlight */
        .multi-path-badge {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .hot-badge {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            margin-left: 6px;
        }

        .hot-connector-card {
            border-left: 3px solid #FF6B35 !important;
            background: linear-gradient(90deg, rgba(255,107,53,0.05) 0%, white 50%);
        }

        .mini-path-item.hot-path {
            border-left: 3px solid #FF6B35;
            background: linear-gradient(90deg, rgba(255,107,53,0.05) 0%, white 50%);
            padding-left: 10px;
            margin-left: -10px;
        }

        .hot-connector-item {
            border-left: 3px solid #FF6B35 !important;
            background: linear-gradient(90deg, rgba(255,107,53,0.05) 0%, white 50%) !important;
        }

        /* Hot Contact Badge - shows on contacts with hot connector paths */
        .hot-contact-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 700;
            color: #c05621;
            background: linear-gradient(135deg, #fff3e6 0%, #ffe4cc 100%);
            border: 1px solid #f6ad55;
            padding: 3px 10px;
            border-radius: 12px;
            white-space: nowrap;
            animation: pulse-fire 2s ease-in-out infinite;
        }

        @keyframes pulse-fire {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        .contact-card-collapsible.has-hot-path {
            border-left: 3px solid #FF6B35;
            background: linear-gradient(90deg, rgba(255,107,53,0.03) 0%, white 30%);
        }

        .contact-path-count.hot-paths {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%) !important;
            color: white !important;
        }

        /* Save Path Button */
        .save-path-btn {
            background: transparent;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 12px;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .save-path-btn:hover {
            background: #f8f9fa;
            border-color: #5FC4B8;
            color: #5FC4B8;
        }

        .save-path-btn.saved {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .save-path-btn.saved:hover {
            background: #c3e6cb;
        }

        /* Action List Panel */
        .saved-paths-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            width: 340px;
            max-height: 480px;
            z-index: 999;
            overflow: hidden;
            display: none;
            border: 1px solid #e9ecef;
        }

        .saved-paths-panel.visible {
            display: block;
        }

        .saved-paths-header {
            background: #004D4D;
            color: white;
            padding: 14px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .saved-paths-header h3 {
            font-size: 14px;
            font-weight: 600;
        }

        .saved-paths-body {
            max-height: 340px;
            overflow-y: auto;
            padding: 12px;
        }

        .saved-path-item {
            background: #f8f9fa;
            border-left: 3px solid #004D4D;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            position: relative;
        }

        .saved-path-firm {
            font-size: 10px;
            text-transform: uppercase;
            color: #6c757d;
            margin-bottom: 4px;
            letter-spacing: 0.3px;
        }

        .saved-path-chain {
            font-size: 13px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .saved-path-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            background: transparent;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 16px;
            opacity: 0.5;
        }

        .saved-path-remove:hover {
            opacity: 1;
        }

        .saved-paths-footer {
            padding: 15px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
        }

        .saved-paths-footer button {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-export {
            background: #5FC4B8;
            color: white;
            border: none;
        }

        .btn-export:hover {
            background: #4db3a7;
        }

        .btn-clear {
            background: white;
            color: #dc3545;
            border: 1px solid #dc3545;
        }

        .btn-clear:hover {
            background: #dc3545;
            color: white;
        }

        /* Briefing Book Sections */
        .briefing-section {
            margin-bottom: 16px;
        }
        
        .briefing-section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 8px;
        }
        
        .briefing-section-icon {
            font-size: 14px;
        }
        
        .briefing-section-title {
            font-size: 11px;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .briefing-section-count {
            background: #004D4D;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
        }
        
        .briefing-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.15s;
        }
        
        .briefing-item:hover {
            border-color: #004D4D;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .briefing-item.hot {
            border-left: 3px solid #FF6B35;
            background: linear-gradient(90deg, rgba(255,107,53,0.05) 0%, white 30%);
        }
        
        .briefing-item-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }
        
        .briefing-item-info {
            flex: 1;
            min-width: 0;
        }
        
        .briefing-item-name {
            font-size: 13px;
            font-weight: 600;
            color: #2d3748;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .briefing-item-detail {
            font-size: 11px;
            color: #6c757d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .briefing-item-actions {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .briefing-view-btn {
            background: linear-gradient(135deg, #004D4D 0%, #006666 100%);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .briefing-view-btn:hover {
            background: linear-gradient(135deg, #006666 0%, #008080 100%);
        }
        
        .briefing-remove-btn {
            background: transparent;
            border: none;
            color: #adb5bd;
            font-size: 16px;
            cursor: pointer;
            padding: 0 4px;
            line-height: 1;
        }
        
        .briefing-remove-btn:hover {
            color: #c0392b;
        }
        
        /* Brief Modal */
        .brief-modal-content {
            max-width: 850px;
            width: 90%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            transition: max-width 0.3s ease;
        }
        
        .brief-modal-content.expanded {
            max-width: 1200px;
            width: 95%;
        }
        
        /* Two-column layout in expanded mode */
        .brief-modal-content.expanded .brief-modal-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-content: start;
        }
        
        .brief-modal-content.expanded .brief-section {
            margin-bottom: 0;
        }
        
        /* Make certain sections span full width in expanded mode */
        .brief-modal-content.expanded .brief-section:first-child,
        .brief-modal-content.expanded .notes-section {
            grid-column: 1 / -1;
        }
        
        /* Ensure brief modal appears above saved paths panel */
        #brief-modal {
            z-index: 2000;
        }
        
        .brief-modal-header {
            background: linear-gradient(135deg, #004D4D 0%, #006666 100%);
            color: white;
            padding: 20px 24px;
            border-radius: 12px 12px 0 0;
            position: relative;
        }
        
        .brief-modal-header h2 {
            margin: 0;
            font-size: 22px;
            font-weight: 700;
            padding-right: 80px;
        }
        
        .brief-modal-header .modal-subtitle {
            color: rgba(255,255,255,0.8);
            margin-top: 4px;
        }
        
        .btn-expand-modal {
            position: absolute;
            top: 20px;
            right: 50px;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-expand-modal:hover {
            background: rgba(255,255,255,0.25);
        }
        
        .brief-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #f8f9fa;
        }
        
        .brief-modal-footer {
            padding: 16px 24px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            border-radius: 0 0 12px 12px;
        }
        
        /* Brief Content Sections */
        .brief-section {
            background: white;
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .brief-section-title {
            font-size: 12px;
            font-weight: 700;
            color: #004D4D;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e6f7f5;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .brief-section-title .icon {
            font-size: 14px;
        }
        
        .brief-firm-card {
            background: linear-gradient(135deg, #e6f7f5 0%, #f0fdf4 100%);
            border: 1px solid #d1fae5;
            border-radius: 8px;
            padding: 12px 16px;
        }
        
        .brief-firm-name {
            font-size: 16px;
            font-weight: 700;
            color: #2d3748;
        }
        
        .brief-firm-details {
            font-size: 13px;
            color: #6c757d;
            margin-top: 4px;
        }
        
        .brief-paths-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .brief-path-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #e9ecef;
        }
        
        .brief-path-item.hot {
            background: linear-gradient(90deg, rgba(255,107,53,0.1) 0%, #f8f9fa 50%);
            border-left-color: #FF6B35;
        }
        
        .brief-path-icon {
            font-size: 14px;
        }
        
        .brief-path-info {
            flex: 1;
        }
        
        .brief-path-name {
            font-size: 13px;
            font-weight: 600;
            color: #2d3748;
        }
        
        .brief-path-detail {
            font-size: 11px;
            color: #6c757d;
        }
        
        .brief-path-badge {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
        }
        
        .brief-path-badge.hot {
            background: #FFF3E6;
            color: #c05621;
        }
        
        .brief-path-badge.mutual {
            background: #e6f7f5;
            color: #004D4D;
        }
        
        /* Intel Cards in Brief */
        .brief-intel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .brief-intel-card {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px 12px;
            border-left: 3px solid #004D4D;
        }
        
        .brief-intel-label {
            font-size: 10px;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        
        .brief-intel-value {
            font-size: 13px;
            color: #2d3748;
        }
        
        .brief-intel-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .brief-intel-list li {
            font-size: 12px;
            color: #2d3748;
            padding: 4px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .brief-intel-list li:last-child {
            border-bottom: none;
        }
        
        .brief-research-text {
            font-size: 13px;
            line-height: 1.6;
            color: #4a5568;
            white-space: pre-wrap;
            background: #f8f9fa;
            padding: 12px 16px;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .brief-people-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .brief-person-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .brief-person-item:hover {
            background: #e6f7f5;
        }
        
        .brief-person-icon {
            font-size: 14px;
        }
        
        .brief-person-info {
            flex: 1;
        }
        
        .brief-person-name {
            font-size: 13px;
            font-weight: 600;
            color: #2d3748;
        }
        
        .brief-person-title {
            font-size: 11px;
            color: #6c757d;
        }
        
        .brief-person-paths {
            font-size: 11px;
            color: #004D4D;
            font-weight: 500;
        }
        
        /* Connection Context Card */
        .connection-context-card {
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            border: 1px solid #d1fae5;
            border-radius: 10px;
            padding: 16px;
            margin: 12px 0;
        }
        
        .connection-context-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .connection-context-title {
            font-size: 12px;
            font-weight: 700;
            color: #004D4D;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .connection-strength {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .strength-bars {
            display: flex;
            gap: 2px;
        }
        
        .strength-bar {
            width: 8px;
            height: 16px;
            background: #e5e7eb;
            border-radius: 2px;
        }
        
        .strength-bar.filled {
            background: #10b981;
        }
        
        .strength-label {
            font-size: 11px;
            font-weight: 600;
        }
        
        .connection-context-path {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .path-node {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .path-node.team {
            background: #004D4D;
            color: white;
        }
        
        .path-node.connector {
            background: #e6f7f5;
            color: #004D4D;
            border: 1px solid #004D4D;
        }
        
        .path-node.connector.hot {
            background: linear-gradient(135deg, #FFF3E6 0%, #FFEDD5 100%);
            color: #c05621;
            border-color: #f6ad55;
        }
        
        .path-node.prospect {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        
        .path-arrow {
            color: #9ca3af;
            font-weight: bold;
        }
        
        .connection-overlaps {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .connection-overlap-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #10b981;
        }
        
        .overlap-icon {
            font-size: 16px;
        }
        
        .overlap-info {
            flex: 1;
        }
        
        .overlap-detail {
            font-size: 13px;
            font-weight: 500;
            color: #2d3748;
        }
        
        .overlap-subdetail {
            font-size: 11px;
            color: #6c757d;
            display: block;
        }
        
        .connection-summary {
            padding: 10px 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 12px;
        }
        
        .connection-summary p {
            font-size: 13px;
            color: #4a5568;
            margin: 0;
        }
        
        .connection-context-actions {
            display: flex;
            justify-content: center;
        }
        
        .btn-generate-intro {
            background: linear-gradient(135deg, #004D4D 0%, #006666 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        
        .btn-generate-intro:hover {
            background: linear-gradient(135deg, #006666 0%, #008080 100%);
            transform: translateY(-1px);
        }
        
        /* Intro Request Modal */
        .intro-request-container {
            max-width: 100%;
        }
        
        .intro-context-summary {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .intro-context-summary p {
            margin: 8px 0 0 0;
            font-size: 13px;
            color: #4a5568;
        }
        
        .intro-overlaps {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }
        
        .intro-overlap-tag {
            font-size: 11px;
            padding: 4px 10px;
            background: white;
            border: 1px solid #d1fae5;
            border-radius: 20px;
            color: #059669;
        }
        
        .intro-email-field {
            margin-bottom: 12px;
        }
        
        .intro-email-field label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        
        .intro-email-field input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            color: #2d3748;
        }
        
        .intro-email-field textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.6;
            color: #2d3748;
            font-family: inherit;
            resize: vertical;
        }
        
        .intro-email-field input:focus,
        .intro-email-field textarea:focus {
            outline: none;
            border-color: #004D4D;
            box-shadow: 0 0 0 3px rgba(0,77,77,0.1);
        }
        
        .intro-email-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 16px;
        }
        
        .btn-copy-intro {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-copy-intro:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        /* Notes Section */
        .notes-section {
            background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%);
            border: 1px solid #fde047;
        }
        
        .notes-input-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .note-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.5;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            background: white;
        }
        
        .note-textarea:focus {
            outline: none;
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.15);
        }
        
        .note-textarea::placeholder {
            color: #9ca3af;
        }
        
        .notes-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .btn-save-note {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }
        
        .btn-save-note:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-1px);
        }
        
        .note-hint {
            font-size: 11px;
            color: #92400e;
            font-style: italic;
        }
        
        .note-saved-badge {
            font-size: 10px;
            background: #fde047;
            color: #854d0e;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
            font-weight: 500;
        }
        
        .note-indicator {
            font-size: 10px;
            color: #f59e0b;
            margin-left: 4px;
        }
        
        /* Note preview in briefing list */
        .briefing-item-note {
            font-size: 11px;
            color: #92400e;
            background: #fef3c7;
            padding: 4px 8px;
            border-radius: 4px;
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        /* Path-Centric Briefing Book */
        .briefing-paths-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .briefing-firm-group {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e9ecef;
        }
        
        .briefing-firm-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid #e9ecef;
        }
        
        .briefing-firm-icon {
            font-size: 14px;
        }
        
        .briefing-firm-name {
            font-size: 13px;
            font-weight: 700;
            color: #2d3748;
        }
        
        .briefing-firm-location {
            font-size: 11px;
            color: #6c757d;
            margin-left: auto;
        }
        
        .briefing-firm-paths {
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .briefing-path-card {
            padding: 10px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            transition: all 0.15s;
            border-left: 3px solid #e9ecef;
        }
        
        .briefing-path-card:hover {
            background: #f0f4f8;
        }
        
        .briefing-path-card.hot {
            background: linear-gradient(90deg, rgba(255,107,53,0.08) 0%, #f8f9fa 50%);
            border-left-color: #FF6B35;
        }
        
        .briefing-path-card.hot:hover {
            background: linear-gradient(90deg, rgba(255,107,53,0.12) 0%, #f0f4f8 50%);
        }
        
        .briefing-path-chain {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .path-step {
            font-size: 11px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 12px;
        }
        
        .path-step.team {
            background: #004D4D;
            color: white;
        }
        
        .path-step.connector {
            background: #e6f7f5;
            color: #004D4D;
        }
        
        .path-step.connector.hot {
            background: #FFF3E6;
            color: #c05621;
        }
        
        .path-step.prospect {
            background: #f3f4f6;
            color: #374151;
        }
        
        .path-arrow {
            color: #9ca3af;
            font-size: 10px;
        }
        
        .briefing-path-note {
            font-size: 10px;
            color: #92400e;
            margin-top: 6px;
            padding-left: 4px;
        }
        
        .briefing-path-remove {
            background: transparent;
            border: 1px solid #e9ecef;
            color: #adb5bd;
            font-size: 14px;
            cursor: pointer;
            padding: 4px 10px;
            line-height: 1;
            border-radius: 4px;
        }
        
        .briefing-path-remove:hover {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .briefing-path-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            justify-content: flex-end;
        }
        
        /* Path Brief Modal Sections */
        .path-brief-target {
            background: linear-gradient(135deg, #e6f7f5 0%, #f0fdf4 100%);
            border: 1px solid #d1fae5;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .path-brief-target-name {
            font-size: 18px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 4px;
        }
        
        .path-brief-target-title {
            font-size: 13px;
            color: #6c757d;
        }
        
        .path-brief-target-firm {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #d1fae5;
        }
        
        .path-brief-target-firm-name {
            font-size: 14px;
            font-weight: 600;
            color: #004D4D;
        }
        
        .path-brief-target-firm-detail {
            font-size: 12px;
            color: #6c757d;
        }
        
        .path-brief-connector {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
        }
        
        .path-brief-connector.hot {
            background: linear-gradient(90deg, rgba(255,107,53,0.08) 0%, white 30%);
            border-left: 3px solid #FF6B35;
        }
        
        .path-brief-connector-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .path-brief-connector-name {
            font-size: 16px;
            font-weight: 700;
            color: #2d3748;
        }
        
        .path-brief-connector-company {
            font-size: 12px;
            color: #6c757d;
        }
        
        .path-brief-via {
            font-size: 11px;
            color: #004D4D;
            background: #e6f7f5;
            padding: 4px 10px;
            border-radius: 12px;
            margin-left: auto;
        }

        /* Floating Save Button */
        .saved-paths-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #004D4D;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,77,77,0.3);
            z-index: 998;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .saved-paths-toggle:hover {
            background: #003d3d;
        }

        .saved-paths-toggle .count {
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }

        /* Collapsible Contact Cards */
        .contact-card-collapsible {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .contact-card-collapsible:hover {
            border-color: #5FC4B8;
        }

        .contact-card-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .contact-card-header-row:hover {
            background: #f8f9fa;
        }

        .contact-card-left {
            flex: 1;
        }

        .contact-card-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .contact-path-count {
            background: #e8f5f3;
            color: #004D4D;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .contact-path-count.has-paths {
            background: #d4edda;
            color: #155724;
        }

        .contact-expand-icon {
            color: #6c757d;
            font-size: 12px;
            transition: transform 0.3s;
        }

        .contact-card-collapsible.expanded .contact-expand-icon {
            transform: rotate(180deg);
        }

        .contact-paths-container {
            display: none;
            padding: 0 20px 20px 20px;
            background: #fafbfc;
            border-top: 1px solid #e9ecef;
        }

        .contact-card-collapsible.expanded .contact-paths-container {
            display: block;
        }

        .contact-paths-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .mini-path-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #5FC4B8;
            font-size: 13px;
        }

        .mini-path-item .connector-name {
            font-weight: 600;
            color: #2d3748;
        }

        .mini-path-item .connector-detail {
            color: #6c757d;
            font-size: 11px;
            margin-top: 2px;
        }

        .profile-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .profile-card:hover {
            border-color: #5FC4B8;
            box-shadow: 0 4px 12px rgba(95, 196, 184, 0.15);
        }

        .profile-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            cursor: pointer;
            user-select: none;
            background: white;
            border-bottom: 2px solid #e9ecef;
        }

        .profile-card-header:hover {
            background: #f8f9fa;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 18px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .profile-role {
            font-size: 14px;
            color: #6c757d;
            font-style: italic;
        }

        .profile-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .expand-icon {
            font-size: 24px;
            color: #5FC4B8;
            transition: transform 0.3s;
        }

        .profile-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .profile-body {
            display: none;
            padding: 20px;
            background: #f8f9fa;
        }

        .profile-card.expanded .profile-body {
            display: block;
        }

        /* Simple List View Styles */
        .connector-list-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .connector-list-item:hover {
            border-color: #5FC4B8;
        }

        .connector-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            background: #f8f9fa;
            transition: background 0.2s;
        }

        .connector-list-header:hover {
            background: #f0f7f6;
        }

        .connector-list-name {
            font-size: 16px;
            font-weight: 700;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .connector-list-role {
            font-size: 13px;
            color: #6c757d;
            margin-top: 4px;
        }

        .connector-list-expand {
            color: #5FC4B8;
            font-size: 14px;
            transition: transform 0.2s;
        }

        .connector-list-item.expanded .connector-list-expand {
            transform: rotate(180deg);
        }

        .connector-list-prospects {
            display: none;
            flex-direction: column;
            gap: 8px;
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        .connector-list-item.expanded .connector-list-prospects {
            display: flex;
        }

        /* Team Member Filter Buttons */
        .team-filter-container {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .team-filter-label {
            font-size: 12px;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            margin-right: 8px;
        }

        .team-filter-btn {
            padding: 6px 14px;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            background: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            color: #6c757d;
        }

        .team-filter-btn:hover {
            border-color: #5FC4B8;
            color: #5FC4B8;
        }

        .team-filter-btn.active {
            background: #004D4D;
            border-color: #004D4D;
            color: white;
        }

        /* Overlapping connection highlight */
        .overlap-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            margin-left: 8px;
        }

        .connector-prospect-item {
            padding: 10px 15px;
            background: #f8f9fa;
            border-left: 3px solid #5FC4B8;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .connector-prospect-item:hover {
            background: #e9ecef;
            border-left-color: #004D4D;
            transform: translateX(5px);
        }

        .connector-prospect-firm {
            font-weight: 600;
            color: #2d3748;
        }

        .connector-prospect-name {
            color: #6c757d;
            margin-left: 8px;
        }

        .connector-prospect-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        /* ========== CUSTOM SCORING TOGGLE ========== */
        .custom-scoring-toggle {
            padding: 0 40px;
            margin-bottom: 16px;
        }

        .custom-toggle-btn {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 10px 16px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #004D4D;
            transition: all 0.2s;
            width: auto;
        }

        .custom-toggle-btn:hover {
            border-color: #004D4D;
            background: #f8f9fa;
        }

        .custom-toggle-btn.expanded {
            border-color: #004D4D;
            background: #004D4D;
            color: white;
        }

        .custom-toggle-btn .toggle-arrow {
            transition: transform 0.2s;
            font-size: 10px;
        }

        .custom-toggle-btn.expanded .toggle-arrow {
            transform: rotate(180deg);
        }

        /* ========== MULTI-SELECT DROPDOWN ========== */
        .multi-select-wrapper {
            position: relative;
            width: 100%;
        }

        .multi-select-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #495057;
            min-height: 42px;
        }

        .multi-select-display:hover {
            border-color: #004D4D;
        }

        .multi-select-arrow {
            font-size: 10px;
            color: #6c757d;
            transition: transform 0.2s;
        }

        .multi-select-wrapper.open .multi-select-arrow {
            transform: rotate(180deg);
        }

        .multi-select-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-height: 350px;
            overflow: hidden;
            margin-top: 4px;
        }

        .multi-select-wrapper.open .multi-select-dropdown {
            display: block;
        }

        .multi-select-search {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .multi-select-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 13px;
        }

        .multi-select-search input:focus {
            outline: none;
            border-color: #004D4D;
        }

        .multi-select-actions {
            display: flex;
            gap: 8px;
            padding: 8px 10px;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .multi-select-actions button {
            padding: 4px 10px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            color: #6c757d;
        }

        .multi-select-actions button:hover {
            border-color: #004D4D;
            color: #004D4D;
        }

        .multi-select-options {
            max-height: 250px;
            overflow-y: auto;
        }

        .multi-select-group {
            padding: 8px 0;
        }

        .multi-select-group-label {
            padding: 6px 14px;
            font-size: 10px;
            font-weight: 700;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #f8f9fa;
        }

        .multi-select-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 14px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.15s;
        }

        .multi-select-option:hover {
            background: #f0f7f6;
        }

        .multi-select-option.hidden {
            display: none;
        }

        .multi-select-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #004D4D;
        }

        .multi-select-option label {
            cursor: pointer;
            flex: 1;
        }

        .location-count {
            font-size: 11px;
            color: #6c757d;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 10px;
        }

        /* ========== SCORING PANEL ========== */
        .custom-panel {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 24px;
            margin: 0 40px 20px 40px;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .custom-panel.visible {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        .scoring-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .scoring-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 16px;
        }

        .scoring-section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .scoring-icon {
            font-size: 18px;
        }

        .scoring-title {
            font-weight: 600;
            font-size: 13px;
            color: #2d3748;
            flex: 1;
        }

        .scoring-value {
            font-size: 11px;
            font-weight: 600;
            color: #004D4D;
            background: #e8f5f3;
            padding: 2px 8px;
            border-radius: 10px;
        }

        /* AUM Inputs */
        .aum-inputs {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            margin-bottom: 12px;
        }

        .aum-field {
            flex: 1;
        }

        .aum-field label {
            display: block;
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 4px;
        }

        .aum-field input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
        }

        .aum-field input:focus {
            outline: none;
            border-color: #004D4D;
            box-shadow: 0 0 0 3px rgba(0,77,77,0.1);
        }

        .aum-separator {
            font-size: 12px;
            color: #6c757d;
            padding-bottom: 10px;
        }

        .aum-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .preset-chip {
            padding: 4px 10px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 15px;
            font-size: 11px;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.15s;
        }

        .preset-chip:hover {
            border-color: #004D4D;
            color: #004D4D;
        }

        .preset-chip.active {
            background: #004D4D;
            border-color: #004D4D;
            color: white;
        }

        /* Sliders */
        .scoring-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #dee2e6;
            outline: none;
            -webkit-appearance: none;
            margin: 8px 0;
        }

        .scoring-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #004D4D;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: transform 0.15s;
        }

        .scoring-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        .scoring-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #004D4D;
            cursor: pointer;
            border: none;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #adb5bd;
        }

        /* Footer */
        .scoring-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .scoring-preview {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }

        .preview-count {
            font-size: 24px;
            font-weight: 700;
            color: #004D4D;
        }

        .preview-label {
            font-size: 13px;
            color: #6c757d;
        }

        .scoring-actions {
            display: flex;
            gap: 10px;
        }

        .scoring-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .scoring-btn.secondary {
            background: white;
            border: 1px solid #dee2e6;
            color: #6c757d;
        }

        .scoring-btn.secondary:hover {
            border-color: #004D4D;
            color: #004D4D;
        }

        .scoring-btn.primary {
            background: #004D4D;
            border: none;
            color: white;
        }

        .scoring-btn.primary:hover {
            background: #003838;
        }

        /* ========== RESEARCH PANEL IN MODALS (Collapsible) ========== */
        .research-toggle-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: linear-gradient(135deg, #004D4D 0%, #006666 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 16px;
            transition: all 0.2s;
            width: 100%;
            justify-content: space-between;
        }

        .research-toggle-btn:hover {
            background: linear-gradient(135deg, #003838 0%, #005555 100%);
        }

        .research-toggle-btn .toggle-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .research-toggle-btn .toggle-arrow {
            transition: transform 0.2s;
        }

        .research-toggle-btn.expanded .toggle-arrow {
            transform: rotate(180deg);
        }

        .research-panel {
            background: white;
            border: 1px solid #e0e7ed;
            border-radius: 12px;
            padding: 0;
            margin-bottom: 20px;
            display: none;
            overflow: hidden;
        }

        .research-panel.visible {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .research-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .research-title {
            font-weight: 600;
            font-size: 14px;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .research-toggle-btn {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 20px;
            background: linear-gradient(135deg, #004D4D 0%, #006666 100%);
            border: none;
            cursor: pointer;
            color: white;
            font-size: 14px;
            font-weight: 500;
        }

        .research-toggle-btn .toggle-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .research-toggle-btn .toggle-arrow {
            transition: transform 0.2s;
            opacity: 0.7;
        }

        .research-toggle-btn.expanded .toggle-arrow {
            transform: rotate(180deg);
        }

        .research-toggle-btn.no-research {
            background: #f8f9fa;
            color: #6c757d;
            border-bottom: 1px solid #e0e7ed;
        }

        .research-toggle-btn.no-research:hover {
            background: #e9ecef;
        }

        .research-badge {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .research-toggle-btn.no-research .research-badge {
            background: #e9ecef;
            color: #6c757d;
        }

        .research-badge.pending {
            background: #e9ecef;
            color: #6c757d;
        }

        .no-research-msg {
            text-align: center;
            padding: 32px;
            color: #6c757d;
        }

        /* Key Facts Strip */
        .research-key-facts {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            flex-wrap: wrap;
        }

        .key-fact {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .key-fact-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6c757d;
            font-weight: 600;
        }

        .key-fact-value {
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
        }

        .key-fact-divider {
            width: 1px;
            background: #dee2e6;
            margin: 0 4px;
        }

        /* Succession Alert */
        .succession-alert {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px 20px;
            background: linear-gradient(135deg, #fef3cd 0%, #fff9e6 100%);
            border-bottom: 1px solid #ffc107;
        }

        .succession-alert-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .succession-alert-content {
            flex: 1;
        }

        .succession-alert-title {
            font-weight: 600;
            color: #856404;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .succession-alert-text {
            font-size: 13px;
            color: #664d03;
            line-height: 1.5;
        }

        /* Research Content Area */
        .research-content {
            padding: 20px;
        }

        /* Prospect Research Card - Auto-expanded */
        .prospect-research-card {
            background: white;
            border: 1px solid #e0e7ed;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .prospect-research-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e9ecef;
        }

        .prospect-affiliations {
            padding: 12px 0 16px;
            margin-bottom: 12px;
            border-bottom: 1px solid #e9ecef;
        }

        .affiliation-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6c757d;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .affiliation-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .affiliation-tag {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .affiliation-tag.school {
            background: rgba(0,77,77,0.1);
            color: #004D4D;
        }

        .affiliation-tag.company {
            background: rgba(44,82,130,0.1);
            color: #2c5282;
        }

        .affiliation-tag.location {
            background: rgba(116,66,16,0.1);
            color: #744210;
        }

        .affiliation-tag.board {
            background: rgba(85,60,154,0.1);
            color: #553c9a;
        }

        .affiliation-tag.generation {
            background: rgba(156,66,33,0.15);
            color: #9c4221;
            font-weight: 700;
        }

        .affiliation-tag.military {
            background: rgba(45,55,72,0.15);
            color: #2d3748;
            font-weight: 600;
        }

        .affiliation-tag.family {
            background: rgba(39,103,73,0.15);
            color: #276749;
            font-weight: 500;
        }

        .affiliation-tag.foundation {
            background: rgba(184,50,128,0.15);
            color: #b83280;
        }

        /* Clickable Prospect Name */
        .clickable-prospect-name {
            color: #004D4D;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline;
        }

        .clickable-prospect-name:hover {
            color: #006666;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 3px;
        }

        /* Research indicator dot */
        .has-research::before {
            content: '';
            display: inline-block;
            width: 6px;
            height: 6px;
            background: #004D4D;
            border-radius: 50%;
            margin-right: 6px;
            vertical-align: middle;
        }

        .prospect-research-title {
            font-weight: 600;
            font-size: 15px;
            color: #2d3748;
        }

        .research-empty {
            color: #6c757d;
            font-style: italic;
            font-size: 13px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin: 0;
        }

        .no-research-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 8px;
            color: #6c757d;
            font-size: 13px;
            margin-bottom: 16px;
        }

        /* Research badge on table rows */
        .badge-researched-small {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            background: #e8f5f3;
            color: #004D4D;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
        }

        /* Intro Queue Styles */
        .queue-empty, .hot-empty {
            text-align: center;
            padding: 30px;
            color: #6c757d;
        }

        .queue-empty p:first-child, .hot-empty p:first-child {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .queue-hint, .hot-hint {
            font-size: 12px;
            color: #adb5bd;
        }

        .queue-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .queue-group {
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            overflow: hidden;
        }

        .queue-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: white;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
        }

        .queue-group-header:hover {
            background: #f8f9fa;
        }

        .queue-group-firm {
            font-weight: 600;
            font-size: 13px;
            color: #2d3748;
        }

        .queue-group-count {
            font-size: 11px;
            color: #6c757d;
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .queue-group-items {
            padding: 8px;
            display: none;
        }

        .queue-group.expanded .queue-group-items {
            display: block;
        }

        .queue-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 6px;
            border-left: 3px solid #004D4D;
        }

        .queue-item:last-child {
            margin-bottom: 0;
        }

        .queue-item-path {
            flex: 1;
            font-size: 13px;
        }

        .queue-item-chain {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .queue-item-person {
            font-weight: 500;
            color: #2d3748;
        }

        .queue-item-arrow {
            color: #adb5bd;
            font-size: 11px;
        }

        .queue-item-target {
            color: #004D4D;
            font-weight: 600;
        }

        .queue-item-role {
            font-size: 11px;
            color: #6c757d;
            margin-top: 2px;
        }

        .queue-item-connector.is-hot .queue-item-person {
            color: #ea580c;
        }

        .queue-item-remove {
            background: none;
            border: none;
            color: #adb5bd;
            cursor: pointer;
            padding: 4px;
            font-size: 14px;
            line-height: 1;
        }

        .queue-item-remove:hover {
            color: #dc3545;
        }

        .queue-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e9ecef;
        }

        .action-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn.secondary {
            background: white;
            border: 1px solid #dee2e6;
            color: #6c757d;
        }

        .action-btn.secondary:hover {
            border-color: #adb5bd;
        }

        .action-btn.primary {
            background: #004D4D;
            border: none;
            color: white;
        }

        .action-btn.primary:hover {
            background: #003838;
        }

        /* Star/Save pathway button */
        .save-path-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            opacity: 0.4;
            transition: all 0.15s;
        }

        .save-path-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .save-path-btn.saved {
            opacity: 1;
            color: #f59e0b;
        }

        /* ========== EMPTY STATES ========== */
        .empty-state {
            text-align: center;
            padding: 24px 16px;
        }

        .empty-state-icon {
            font-size: 32px;
            margin-bottom: 12px;
            opacity: 0.8;
        }

        .empty-state-title {
            font-size: 15px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .empty-state-text {
            font-size: 13px;
            color: #6c757d;
            line-height: 1.5;
            max-width: 280px;
            margin: 0 auto;
        }

        /* ========== ACTION CENTER PAGE ========== */
        .action-center-page {
            padding: 24px 20px 20px 20px;
        }

        .action-center-header {
            margin-bottom: 20px;
        }

        .action-center-header h2 {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
            margin: 0 0 8px 0;
        }

        .action-center-subtitle {
            color: #6c757d;
            font-size: 14px;
            margin: 0;
        }

        .action-section {
            background: white;
            border: 1px solid #e0e7ed;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .action-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .action-section-header h3 {
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            margin: 0;
        }

        .action-section-clear {
            background: none;
            border: none;
            color: #adb5bd;
            font-size: 12px;
            cursor: pointer;
        }

        .action-section-clear:hover {
            color: #dc3545;
        }

        .recently-viewed-section .recently-viewed-list {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .recent-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s;
            min-width: 110px;
            text-align: center;
        }

        .recent-item:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .recent-item-icon {
            font-size: 24px;
            margin-bottom: 6px;
        }

        .recent-item-name {
            font-size: 13px;
            font-weight: 600;
            color: #2d3748;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100px;
        }

        .recent-item-type {
            font-size: 11px;
            color: #6c757d;
            margin-top: 2px;
        }

        /* Three Column Layout */
        .action-columns {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .action-columns {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 800px) {
            .action-columns {
                grid-template-columns: 1fr;
            }
        }

        .action-column {
            background: white;
            border: 1px solid #e0e7ed;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            min-height: 400px;
        }

        .action-column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }

        .action-column-header h3 {
            font-size: 15px;
            font-weight: 600;
            color: #2d3748;
            margin: 0;
        }

        .action-column-count {
            background: #004D4D;
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .action-column-body {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            max-height: 450px;
        }

        .action-column-footer {
            padding: 12px 16px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .action-btn.full-width {
            width: 100%;
            justify-content: center;
        }

        /* ========== TRIP PLANNER (in column) ========== */
        .trip-planner select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            margin-bottom: 16px;
        }

        .trip-planner select:focus {
            outline: none;
            border-color: #004D4D;
        }

        .trip-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .trip-stat {
            text-align: center;
        }

        .trip-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #004D4D;
        }

        .trip-stat-label {
            font-size: 11px;
            color: #6c757d;
            text-transform: uppercase;
        }

        .trip-section {
            margin-top: 8px;
        }

        .trip-section-header {
            font-size: 13px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 6px;
        }

        .trip-section-hint {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .trip-connectors {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .trip-connector-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, #fff8f0 0%, #fff3e6 100%);
            border: 1px solid #fed7aa;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .trip-connector-chip:hover {
            background: #fff3e6;
            transform: translateY(-1px);
        }

        .trip-connector-chip.is-hot {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            border-color: transparent;
            color: white;
        }

        .trip-connector-name {
            font-weight: 500;
        }

        .trip-connector-reach {
            font-size: 10px;
            opacity: 0.8;
        }

        .trip-firms {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .trip-firm-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .trip-firm-card:hover {
            border-color: #004D4D;
            background: #f8fffe;
        }

        .trip-firm-info {
            flex: 1;
        }

        .trip-firm-name {
            font-weight: 600;
            font-size: 13px;
            color: #2d3748;
        }

        .trip-firm-meta {
            font-size: 11px;
            color: #6c757d;
            margin-top: 2px;
        }

        .trip-firm-paths {
            text-align: right;
        }

        .trip-firm-path-count {
            font-weight: 600;
            font-size: 14px;
            color: #004D4D;
        }

        .trip-firm-path-label {
            font-size: 10px;
            color: #6c757d;
        }

        .trip-actions {
            margin-top: 12px;
            display: flex;
            justify-content: flex-end;
        }

        /* Hot Connectors Styles */
        .hot-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .hot-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: linear-gradient(135deg, #fff8f0 0%, #fff3e6 100%);
            border: 1px solid #fed7aa;
            border-radius: 8px;
        }

        .hot-item-icon {
            font-size: 20px;
        }

        .hot-item-info {
            flex: 1;
        }

        .hot-item-name {
            font-weight: 600;
            font-size: 14px;
            color: #2d3748;
        }

        .hot-item-meta {
            font-size: 12px;
            color: #6c757d;
            margin-top: 2px;
        }

        .hot-item-reach {
            text-align: right;
        }

        .hot-item-reach-count {
            font-weight: 700;
            font-size: 18px;
            color: #ea580c;
        }

        .hot-item-reach-label {
            font-size: 10px;
            color: #6c757d;
        }

        .hot-remove-btn {
            background: none;
            border: none;
            color: #adb5bd;
            cursor: pointer;
            padding: 4px;
            font-size: 16px;
        }

        .hot-remove-btn:hover {
            color: #dc3545;
        }

        .hot-add-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e9ecef;
        }

        .add-hot-btn {
            width: 100%;
            padding: 10px;
            background: white;
            border: 1px dashed #dee2e6;
            border-radius: 8px;
            color: #6c757d;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-hot-btn:hover {
            border-color: #004D4D;
            color: #004D4D;
            background: #f8fffe;
        }

        /* Hot connector badge in pathway displays */
        .hot-connector-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
            margin-left: 4px;
        }

        .hot-icon {
            margin-left: 4px;
            font-size: 13px;
        }

        /* Firm Badges (inline after name) */
        .firm-badges {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
        }

        .firm-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            cursor: help;
        }

        .firm-badge.hot {
            background: #fff3e0;
        }

        .firm-badge.succession {
            background: #e3f2fd;
        }

        .firm-badge.saved {
            background: #e8f5e9;
            color: #2e7d32;
            gap: 2px;
        }

        .firm-badge.priority {
            background: #fce4ec;
        }

        .firm-badge.research {
            background: #f3e5f5;
        }

        /* Saved Buckets Section */
        .bucket-management {
            display: flex;
            gap: 6px;
            padding: 8px 12px;
        }

        .bucket-select {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 13px;
            background: white;
        }

        .new-bucket-btn {
            background: #004D4D;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }

        .new-bucket-btn:hover {
            background: #003939;
        }

        .active-bucket-name {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: #e8f5f3;
            margin: 0 12px 8px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: #004D4D;
        }

        .bucket-item-count {
            background: #004D4D;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        /* Add to bucket button */
        .add-to-bucket-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: #004D4D;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-to-bucket-btn:hover {
            background: #003838;
        }

        .add-to-bucket-btn.added {
            background: #28a745;
        }

        /* Firm Status Bar */
        .firm-status-bar {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 10px 14px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .firm-saved-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            color: #f59e0b;
            font-weight: 500;
        }

        .hot-path-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            color: #ea580c;
            font-weight: 500;
        }

        /* Mark as hot button on connector cards */
        .mark-hot-btn {
            padding: 4px 8px;
            background: white;
            border: 1px solid #fed7aa;
            border-radius: 6px;
            color: #ea580c;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mark-hot-btn:hover {
            background: #fff8f0;
        }

        .mark-hot-btn.is-hot {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            border-color: transparent;
        }

        /* Connector Hot Toggle in Modal */
        .connector-hot-toggle {
            margin-bottom: 16px;
        }

        .connector-hot-toggle .mark-hot-btn {
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 8px;
        }

        /* Add Hot Connector Modal */
        .add-hot-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }

        .add-hot-modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            max-height: 70vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .add-hot-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .add-hot-modal-header h3 {
            margin: 0;
            font-size: 16px;
            color: #2d3748;
        }

        .add-hot-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #6c757d;
            cursor: pointer;
            line-height: 1;
        }

        .add-hot-search {
            margin: 12px 20px;
            padding: 10px 14px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }

        .add-hot-search:focus {
            outline: none;
            border-color: #004D4D;
        }

        .add-hot-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 20px 20px 20px;
        }

        .add-hot-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .add-hot-item:hover {
            background: #fff8f0;
        }

        .add-hot-item-name {
            font-weight: 500;
            color: #2d3748;
            flex: 1;
        }

        .add-hot-item-company {
            font-size: 12px;
            color: #6c757d;
        }

        .add-hot-item-reach {
            font-size: 11px;
            color: #ea580c;
            font-weight: 600;
        }

        /* ========== ROW ACTION MENU (Kebab) ========== */
        .row-actions {
            position: relative;
        }

        .row-actions-btn {
            background: none;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 16px;
            color: #adb5bd;
            border-radius: 4px;
            transition: all 0.15s;
        }

        .row-actions-btn:hover {
            background: #e9ecef;
            color: #495057;
        }

        .row-actions-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border: 1px solid #e0e7ed;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 160px;
            z-index: 100;
            display: none;
            overflow: hidden;
        }

        .row-actions-menu.show {
            display: block;
        }

        .row-actions-menu-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            font-size: 13px;
            color: #2d3748;
            cursor: pointer;
            transition: background 0.15s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .row-actions-menu-item:hover {
            background: #f8f9fa;
        }

        .row-actions-menu-item.danger {
            color: #dc3545;
        }

        .row-actions-menu-item.hot {
            color: #ea580c;
        }

        .row-actions-menu-divider {
            height: 1px;
            background: #e9ecef;
            margin: 4px 0;
        }

        /* Hot toggle button in list */
        .btn-hot-toggle {
            background: none;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 14px;
            opacity: 0.5;
            transition: all 0.15s;
        }

        .btn-hot-toggle:hover {
            opacity: 1;
            border-color: #f59e0b;
        }

        .btn-hot-toggle.is-hot {
            opacity: 1;
            background: #fff8f0;
            border-color: #f59e0b;
        }

        /* Ensure menu doesn't get cut off */
        .ac-table td.row-actions,
        table td.row-actions {
            position: relative;
            overflow: visible;
        }

        /* ========== NEW ACTION CENTER STYLES ========== */
        .action-center-page {
            padding: 24px 20px 20px 20px;
            max-width: 100%;
        }

        .action-center-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .action-center-header h2 {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
            margin: 0;
        }

        .action-center-tabs {
            display: flex;
            gap: 8px;
        }

        .ac-tab {
            padding: 10px 20px;
            background: white;
            border: 1px solid #e0e7ed;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ac-tab:hover {
            border-color: #004D4D;
            color: #004D4D;
        }

        .ac-tab.active {
            background: #004D4D;
            border-color: #004D4D;
            color: white;
        }

        .ac-tab-count {
            background: rgba(0,77,77,0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 6px;
        }

        .ac-tab.active .ac-tab-count {
            background: rgba(255,255,255,0.3);
        }

        .trip-tabs {
            display: flex;
            gap: 8px;
            padding: 16px 20px;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .trip-planner-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            background: white;
        }

        .trip-location-select {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .trip-location-select label {
            font-size: 15px;
            font-weight: 600;
            color: #2d3748;
        }

        .trip-location-select select {
            padding: 10px 40px 10px 16px;
            font-size: 15px;
            font-weight: 500;
            border: 2px solid #e0e7ed;
            border-radius: 8px;
            background: white;
            color: #2d3748;
            cursor: pointer;
            min-width: 280px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236c757d' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
        }

        .trip-location-select select:focus {
            outline: none;
            border-color: #004D4D;
        }

        .trip-location-select select:hover {
            border-color: #004D4D;
        }

        .trip-tab {
            padding: 10px 16px;
            background: white;
            border: 1px solid #e0e7ed;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .trip-tab:hover {
            border-color: #004D4D;
            color: #004D4D;
        }

        .trip-tab.active {
            background: #004D4D;
            border-color: #004D4D;
            color: white;
        }

        .trip-tab-count {
            background: rgba(0,77,77,0.15);
            color: #004D4D;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
        }

        .trip-tab.active .trip-tab-count {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        .ac-content {
            display: none;
        }

        .ac-content.active {
            display: block;
        }

        .ac-split-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            min-height: 600px;
            align-items: start;
        }

        @media (max-width: 1000px) {
            .ac-split-layout {
                grid-template-columns: 1fr;
            }
        }

        .ac-main {
            background: white;
            border: 1px solid #e0e7ed;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .ac-sidebar {
            background: white;
            border: 1px solid #e0e7ed;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 150px);
        }

        .ac-section-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .ac-section-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            margin: 0 0 4px 0;
        }

        .ac-section-header p {
            font-size: 13px;
            color: #6c757d;
            margin: 0;
        }

        .ac-filters {
            display: flex;
            gap: 12px;
            padding: 12px 20px;
            border-bottom: 1px solid #e9ecef;
            flex-wrap: wrap;
            align-items: center;
        }

        .ac-team-tabs {
            display: flex;
            gap: 4px;
        }

        .team-filter-btn {
            padding: 6px 14px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .team-filter-btn:hover {
            border-color: #004D4D;
        }

        .team-filter-btn.active {
            background: #004D4D;
            border-color: #004D4D;
            color: white;
        }

        .ac-search {
            flex: 1;
            min-width: 200px;
            padding: 8px 14px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
        }

        .ac-search:focus {
            outline: none;
            border-color: #004D4D;
        }

        .ac-select {
            padding: 8px 14px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .ac-location-select {
            width: 100%;
            max-width: 400px;
            padding: 12px 16px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 15px;
            background: white;
        }

        .ac-table-container {
            flex: 1;
            overflow-y: auto;
            max-height: 500px;
        }

        .ac-table {
            width: 100%;
            border-collapse: collapse;
        }

        .ac-table th {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            padding: 12px 16px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: #6c757d;
            border-bottom: 1px solid #e9ecef;
        }

        .ac-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f3f4;
            font-size: 14px;
        }

        .ac-table tbody tr {
            cursor: pointer;
            transition: background 0.15s;
        }

        .ac-table tbody tr:hover {
            background: #f8fffe;
        }

        .ac-table .hot-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            opacity: 0.3;
            transition: all 0.15s;
        }

        .ac-table .hot-btn:hover {
            opacity: 1;
        }

        .ac-table .hot-btn.is-hot {
            opacity: 1;
        }

        .ac-sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .ac-sidebar-header h4 {
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            margin: 0;
        }

        .ac-sidebar-count {
            background: #004D4D;
            color: white;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
        }

        .ac-sidebar-actions {
            display: flex;
            gap: 8px;
            padding: 12px 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .action-btn.small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .ac-sidebar-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .ac-sidebar-empty {
            padding: 30px 20px;
            text-align: center;
            color: #6c757d;
            font-size: 13px;
        }

        .ac-sidebar-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .ac-sidebar-item.hot {
            background: linear-gradient(135deg, #fff8f0 0%, #fff3e6 100%);
            border: 1px solid #fed7aa;
        }

        .ac-sidebar-item-info {
            flex: 1;
            min-width: 0;
        }

        .ac-sidebar-item-name {
            font-weight: 600;
            font-size: 13px;
            color: #2d3748;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ac-sidebar-item-meta {
            font-size: 11px;
            color: #6c757d;
        }

        .ac-sidebar-item-location {
            font-size: 10px;
            color: #004D4D;
            margin-top: 2px;
        }

        .ac-sidebar-item:hover .ac-sidebar-item-name {
            color: #004D4D;
        }

        .ac-sidebar-item-remove {
            background: none;
            border: none;
            color: #adb5bd;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
        }

        .ac-sidebar-item-remove:hover {
            color: #dc3545;
        }

        /* Trip Summary Bar */
        .trip-summary {
            display: flex;
            align-items: center;
            gap: 24px;
            padding: 12px 20px;
            background: #e8f5f3;
            border-radius: 8px;
            margin-top: 12px;
        }

        .trip-summary-stat {
            font-size: 14px;
            color: #2d3748;
        }

        .trip-summary-stat strong {
            color: #004D4D;
            font-size: 18px;
        }

        .trip-content {
            background: white;
            border: 1px solid #e0e7ed;
            border-radius: 12px;
            margin-top: 16px;
            overflow: hidden;
        }

        .trip-connectors-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            background: #fff8f0;
            border-bottom: 1px solid #fed7aa;
            flex-wrap: wrap;
        }

        .trip-connectors-label {
            font-size: 13px;
            font-weight: 500;
            color: #92400e;
        }

        .trip-connectors-chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Queue sidebar with pathway info */
        .queue-sidebar-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 8px;
            border-left: 3px solid #004D4D;
        }

        .queue-sidebar-firm {
            font-size: 11px;
            font-weight: 600;
            color: #004D4D;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .queue-sidebar-path {
            font-size: 12px;
            color: #2d3748;
        }

        .queue-sidebar-path .arrow {
            color: #adb5bd;
            margin: 0 4px;
        }

        /* ========== KEBAB MENU (Three Dots) ========== */
        .kebab-menu {
            position: relative;
            display: inline-block;
        }

        .kebab-btn {
            background: none;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 16px;
            color: #adb5bd;
            border-radius: 4px;
            transition: all 0.15s;
        }

        .kebab-btn:hover {
            background: #e9ecef;
            color: #495057;
        }

        .kebab-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border: 1px solid #e0e7ed;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 180px;
            z-index: 100;
            overflow: hidden;
        }

        .kebab-dropdown.show {
            display: block;
        }

        .kebab-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            font-size: 13px;
            color: #2d3748;
            cursor: pointer;
            transition: background 0.15s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .kebab-item:hover {
            background: #f8f9fa;
        }

        .kebab-item.hot {
            color: #ea580c;
        }

        .kebab-item.hot:hover {
            background: #fff8f0;
        }

        .kebab-divider {
            height: 1px;
            background: #e9ecef;
            margin: 4px 0;
        }

        /* ========== NEW ACTION CENTER - TEAM PANELS ========== */
        .ac-full-layout {
            background: white;
            border: 1px solid #e0e7ed;
            border-radius: 12px;
            overflow: hidden;
        }

        /* Network Intelligence Styles */
        .intel-search-bar {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .intel-search-bar input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e7ed;
            border-radius: 8px;
            font-size: 15px;
            margin-bottom: 12px;
        }

        .intel-search-bar input:focus {
            outline: none;
            border-color: #004D4D;
        }

        .intel-filter-pills {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .intel-pill {
            padding: 6px 14px;
            background: white;
            border: 1px solid #e0e7ed;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.2s;
        }

        .intel-pill:hover {
            border-color: #004D4D;
            color: #004D4D;
        }

        .intel-pill.active {
            background: #004D4D;
            border-color: #004D4D;
            color: white;
        }

        .intel-stats-row {
            display: flex;
            gap: 20px;
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e9ecef;
        }

        .intel-stat {
            flex: 1;
            text-align: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .intel-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #004D4D;
        }

        .intel-stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .intel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
            padding: 20px;
            max-height: calc(100vh - 350px);
            overflow-y: auto;
            align-items: start;
        }

        .intel-card {
            background: white;
            border: 1px solid #e0e7ed;
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .intel-card:hover {
            border-color: #004D4D;
            box-shadow: 0 4px 12px rgba(0,77,77,0.1);
        }

        .intel-card-header {
            padding: 14px 16px;
            background: linear-gradient(135deg, #004D4D 0%, #006666 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .intel-card-title {
            font-weight: 600;
            font-size: 14px;
        }

        .intel-card-type {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
            background: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 10px;
        }

        .intel-card-body {
            padding: 12px 16px;
        }

        .intel-person {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.15s;
        }

        .intel-person:last-child {
            border-bottom: none;
        }

        .intel-person:hover {
            background: #f8f9fa;
            margin: 0 -16px;
            padding: 8px 16px;
        }

        .intel-person-info {
            flex: 1;
        }

        .intel-person-name {
            font-weight: 600;
            color: #004D4D;
            font-size: 13px;
        }

        .intel-person-detail {
            font-size: 12px;
            color: #6c757d;
        }

        .intel-person-right {
            text-align: right;
        }

        .intel-person-firm {
            font-size: 11px;
            color: #004D4D;
            background: rgba(0,77,77,0.1);
            padding: 2px 8px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .intel-person-firm:hover {
            background: rgba(0,77,77,0.2);
        }

        .intel-person-location {
            font-size: 10px;
            color: #6c757d;
            margin-top: 3px;
        }

        .intel-card-count {
            font-size: 11px;
            color: #6c757d;
            padding: 8px 16px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            text-align: center;
        }

        .intel-card-toggle {
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .intel-card-toggle:hover {
            background: #e9ecef;
            color: #004D4D;
        }

        .intel-toggle-icon {
            font-size: 10px;
            transition: transform 0.2s;
        }

        .intel-card.expanded {
            max-height: none;
        }

        .intel-card-expanded {
            border-top: 1px dashed #e9ecef;
            padding-top: 8px;
            margin-top: 8px;
        }

        .intel-card-body {
            padding: 12px 16px;
            max-height: 280px;
            overflow-y: auto;
        }

        .intel-card.expanded .intel-card-body {
            max-height: 500px;
        }

        /* Scrollbar styling for intel cards */
        .intel-card-body::-webkit-scrollbar {
            width: 6px;
        }

        .intel-card-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .intel-card-body::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .intel-card-body::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        .intel-empty {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .intel-empty-icon {
            font-size: 48px;
            opacity: 0.3;
            margin-bottom: 16px;
        }

        .intel-highlight {
            background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
            border-color: #ffc107;
        }

        .intel-highlight .intel-card-header {
            background: linear-gradient(135deg, #f7931e 0%, #ff6b35 100%);
        }

        /* Firm Groups Styles */
        .fg-header-actions {
            display: flex;
            gap: 8px;
        }

        .fg-layout {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            padding: 20px;
            min-height: 500px;
        }

        @media (max-width: 900px) {
            .fg-layout {
                grid-template-columns: 1fr;
            }
        }

        .fg-ungrouped-panel, .fg-groups-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 16px;
            display: flex;
            flex-direction: column;
        }

        .fg-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .fg-panel-header h4 {
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            margin: 0;
        }

        .fg-panel-count {
            background: #004D4D;
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .fg-search {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e7ed;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 12px;
        }

        .fg-search:focus {
            outline: none;
            border-color: #004D4D;
        }

        .fg-firm-list {
            flex: 1;
            overflow-y: auto;
            max-height: 450px;
        }

        .fg-firm-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: white;
            border: 1px solid #e0e7ed;
            border-radius: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .fg-firm-item:hover {
            border-color: #004D4D;
            background: #f0fafa;
        }

        .fg-firm-item.selected {
            border-color: #004D4D;
            background: #e8f5f3;
        }

        .fg-firm-info {
            flex: 1;
            min-width: 0;
        }

        .fg-firm-name {
            font-weight: 600;
            font-size: 13px;
            color: #2d3748;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .fg-firm-meta {
            font-size: 11px;
            color: #6c757d;
            display: flex;
            gap: 8px;
        }

        .fg-firm-type {
            background: #e9ecef;
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 10px;
        }

        .fg-firm-add-btn {
            background: #004D4D;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .fg-firm-item:hover .fg-firm-add-btn {
            opacity: 1;
        }

        .fg-groups-list {
            flex: 1;
            overflow-y: auto;
            max-height: 500px;
        }

        .fg-groups-empty {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
            font-size: 13px;
        }

        .fg-group-card {
            background: white;
            border: 1px solid #e0e7ed;
            border-radius: 10px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .fg-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(135deg, #004D4D 0%, #006666 100%);
            color: white;
        }

        .fg-group-name {
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
        }

        .fg-group-name:hover {
            text-decoration: underline;
        }

        .fg-group-actions {
            display: flex;
            gap: 8px;
        }

        .fg-group-action-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .fg-group-action-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .fg-group-body {
            padding: 12px;
        }

        .fg-group-entity {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 6px;
        }

        .fg-group-entity:last-child {
            margin-bottom: 0;
        }

        .fg-entity-info {
            flex: 1;
        }

        .fg-entity-name {
            font-weight: 500;
            font-size: 13px;
            color: #004D4D;
            cursor: pointer;
        }

        .fg-entity-name:hover {
            text-decoration: underline;
        }

        .fg-entity-meta {
            font-size: 11px;
            color: #6c757d;
        }

        .fg-entity-remove {
            background: none;
            border: none;
            color: #adb5bd;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
        }

        .fg-entity-remove:hover {
            color: #dc3545;
        }

        .fg-group-stats {
            display: flex;
            gap: 16px;
            padding: 10px 12px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            font-size: 12px;
            color: #6c757d;
        }

        .fg-group-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .fg-group-stat-value {
            font-weight: 600;
            color: #004D4D;
        }

        /* Suggestions Panel */
        .fg-suggestions {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            z-index: 1002;
            overflow: hidden;
        }

        .fg-suggestions-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1001;
        }

        .fg-suggestions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: linear-gradient(135deg, #004D4D 0%, #006666 100%);
            color: white;
        }

        .fg-suggestions-header h4 {
            margin: 0;
            font-size: 16px;
        }

        .fg-suggestions-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.8;
        }

        .fg-suggestions-close:hover {
            opacity: 1;
        }

        .fg-suggestions-list {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .fg-suggestion-card {
            border: 1px solid #e0e7ed;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .fg-suggestion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .fg-suggestion-name {
            font-weight: 600;
            color: #2d3748;
        }

        .fg-suggestion-actions {
            display: flex;
            gap: 8px;
        }

        .fg-suggestion-body {
            padding: 12px 16px;
        }

        .fg-suggestion-firm {
            padding: 6px 0;
            font-size: 13px;
            color: #4a5568;
            border-bottom: 1px solid #f0f0f0;
        }

        .fg-suggestion-firm:last-child {
            border-bottom: none;
        }

        .ac-team-panels {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0;
            border-top: 1px solid #e9ecef;
        }

        @media (max-width: 1000px) {
            .ac-team-panels {
                grid-template-columns: 1fr;
            }
        }

        .ac-team-panel {
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            max-height: 600px;
        }

        .ac-team-panel:last-child {
            border-right: none;
        }

        .ac-team-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .ac-team-panel-header h4 {
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            margin: 0;
        }

        .ac-team-hot-count {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .ac-panel-search {
            margin: 12px;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 13px;
            width: calc(100% - 24px);
        }

        .ac-panel-search:focus {
            outline: none;
            border-color: #004D4D;
        }

        .ac-team-panel-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 12px 12px;
        }

        .ac-connector-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s;
            margin-bottom: 4px;
        }

        .ac-connector-row:hover {
            background: #f8f9fa;
        }

        .ac-connector-row.is-hot {
            background: #fff8f0;
            border: 1px solid #fed7aa;
        }

        .ac-connector-hot-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            opacity: 0.3;
            transition: all 0.15s;
            padding: 4px;
        }

        .ac-connector-hot-btn:hover {
            opacity: 1;
        }

        .ac-connector-hot-btn.is-hot {
            opacity: 1;
        }

        .ac-connector-info {
            flex: 1;
            min-width: 0;
        }

        .ac-connector-name {
            font-size: 13px;
            font-weight: 500;
            color: #2d3748;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ac-connector-meta {
            font-size: 11px;
            color: #6c757d;
        }

        .ac-connector-location {
            font-size: 10px;
            color: #004D4D;
            margin-top: 2px;
        }

        .ac-connector-row:hover .ac-connector-name {
            color: #004D4D;
        }

        /* Clickable names in tables */
        .clickable-name {
            color: #004D4D;
            cursor: pointer;
            transition: all 0.15s;
        }

        .clickable-name:hover {
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 2px;
        }

        /* Location hints in tables */
        .tb-location-hint {
            font-size: 10px;
            color: #6c757d;
            margin-top: 2px;
        }

        .ac-connector-reach {
            font-size: 12px;
            font-weight: 600;
            color: #004D4D;
        }

        /* ========== TRIP BUILDER ========== */
        .trip-builder-stats {
            display: flex;
            gap: 20px;
            padding: 8px 16px;
            background: #e8f5f3;
            border-radius: 6px;
            font-size: 13px;
        }

        .trip-builder-stats strong {
            color: #004D4D;
        }

        .tb-data-tabs {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            border-bottom: 1px solid #e9ecef;
        }

        .tb-tab {
            padding: 8px 16px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .tb-tab:hover {
            border-color: #004D4D;
        }

        .tb-tab.active {
            background: #004D4D;
            border-color: #004D4D;
            color: white;
        }

        .tb-data-content {
            max-height: 450px;
            overflow-y: auto;
        }

        .tb-add-btn {
            background: none;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .tb-add-btn:hover {
            background: #004D4D;
            border-color: #004D4D;
            color: white;
        }

        .tb-add-btn.added {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .ac-sidebar-divider {
            height: 1px;
            background: #e9ecef;
            margin: 16px 0;
        }

        .saved-intro-group {
            margin-bottom: 12px;
        }

        .saved-intro-firm {
            font-size: 11px;
            font-weight: 600;
            color: #004D4D;
            text-transform: uppercase;
            margin-bottom: 6px;
            padding: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px;
            transition: background 0.15s;
        }

        .saved-intro-firm:hover {
            background: rgba(0,77,77,0.1);
        }

        .saved-intro-location {
            font-size: 10px;
            font-weight: 400;
            color: #6c757d;
            text-transform: none;
        }

        .saved-intro-path {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 4px;
            font-size: 12px;
            color: #2d3748;
            border-left: 3px solid #10b981;
        }

        .saved-intro-path .clickable-name {
            font-weight: 500;
        }

        .saved-intro-path button {
            background: none;
            border: none;
            color: #adb5bd;
            cursor: pointer;
            font-size: 16px;
            padding: 0 4px;
        }

        .saved-intro-path button:hover {
            color: #dc3545;
        }

        /* Trip Builder Expandable Connectors */
        .tb-connector-row {
            cursor: pointer;
            transition: background 0.15s;
        }

        .tb-connector-row:hover {
            background: #f8f9fa;
        }

        .tb-local-reach {
            display: inline-block;
            padding: 3px 10px;
            background: #e8f5f3;
            color: #004D4D;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .tb-expand-icon {
            color: #adb5bd;
            font-size: 11px;
        }

        .tb-connector-firms td {
            background: #f8f9fa;
        }

        .tb-firms-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px 16px;
        }

        .tb-firm-chip {
            display: flex;
            flex-direction: column;
            padding: 8px 12px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            min-width: 150px;
        }

        .tb-firm-chip:hover {
            border-color: #004D4D;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background: #f8fffe;
        }
        
        .tb-firm-chip.in-bucket {
            background: #e6f7f5;
            border-color: #004D4D;
        }

        .tb-firm-chip-name {
            font-size: 13px;
            font-weight: 500;
            color: #2d3748;
        }

        .tb-firm-chip-type {
            font-size: 10px;
            color: #6c757d;
            text-transform: uppercase;
        }
        
        .tb-firm-chip-paths {
            font-size: 10px;
            color: #004D4D;
            font-weight: 600;
            margin-top: 4px;
        }
        
        /* Hot connector row in Trip Builder */
        .hot-connector-row {
            background: linear-gradient(90deg, rgba(255,107,53,0.08) 0%, white 40%) !important;
        }
        
        .hot-connector-row td:first-child {
            border-left: 3px solid #FF6B35;
        }
        
        /* Bucket Sections */
        .bucket-section {
            margin-bottom: 16px;
        }
        
        .bucket-section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 8px;
        }
        
        .bucket-section-icon {
            font-size: 14px;
        }
        
        .bucket-section-title {
            font-size: 12px;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .bucket-section-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .bucket-firm-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .bucket-firm-item:hover {
            border-color: #004D4D;
            background: #f8fffe;
        }
        
        .bucket-item-main {
            flex: 1;
            min-width: 0;
        }
        
        .bucket-item-name {
            font-size: 13px;
            font-weight: 600;
            color: #2d3748;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .bucket-item-via {
            font-size: 11px;
            color: #004D4D;
            margin-top: 2px;
        }
        
        .bucket-item-location {
            font-size: 10px;
            color: #6c757d;
        }
        
        .bucket-item-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .bucket-prospect-count {
            font-size: 11px;
            color: #6c757d;
            background: #f1f3f4;
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .bucket-remove-btn {
            background: transparent;
            border: none;
            color: #adb5bd;
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
            transition: color 0.15s;
        }
        
        .bucket-remove-btn:hover {
            color: #dc3545;
        }
        
        /* Prospects section */
        .bucket-section.prospects-section {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
        }
        
        .bucket-prospects-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .bucket-prospect-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .bucket-prospect-item:hover {
            border-color: #004D4D;
        }
        
        .bucket-prospect-info {
            flex: 1;
            min-width: 0;
        }
        
        .bucket-prospect-name {
            font-size: 12px;
            font-weight: 500;
            color: #2d3748;
        }
        
        .bucket-prospect-name.has-research {
            color: #004D4D;
        }
        
        .bucket-prospect-name.has-research::before {
            content: "•";
            color: #5FC4B8;
            margin-right: 4px;
        }
        
        .bucket-prospect-title {
            font-size: 10px;
            color: #6c757d;
        }
        
        .bucket-prospect-firm {
            font-size: 10px;
            color: #004D4D;
            background: #e6f7f5;
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
        }
        
        .bucket-more {
            font-size: 11px;
            color: #6c757d;
            text-align: center;
            padding: 8px;
            font-style: italic;
        }
        
        /* Connector items in bucket */
        .bucket-connector-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .bucket-connector-item:hover {
            border-color: #004D4D;
        }
        
        .bucket-connector-item.hot {
            border-left: 3px solid #FF6B35;
            background: linear-gradient(90deg, rgba(255,107,53,0.05) 0%, white 40%);
        }
        
        /* Bucket Tree Structure */
        .bucket-tree {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .bucket-tree-firm {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .bucket-tree-firm-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .bucket-tree-firm-header:hover {
            background: #f8f9fa;
        }
        
        .bucket-tree-firm-header.has-hot {
            background: linear-gradient(90deg, rgba(255,107,53,0.08) 0%, white 50%);
            border-left: 3px solid #FF6B35;
            margin-left: -1px;
        }
        
        .bucket-tree-toggle {
            font-size: 10px;
            color: #6c757d;
            width: 12px;
            text-align: center;
        }
        
        .bucket-tree-icon {
            font-size: 14px;
        }
        
        .bucket-tree-firm-info {
            flex: 1;
            min-width: 0;
        }
        
        .bucket-tree-firm-name {
            font-size: 13px;
            font-weight: 600;
            color: #2d3748;
        }
        
        .bucket-tree-via {
            font-size: 11px;
            color: #004D4D;
        }
        
        .bucket-tree-location {
            font-size: 10px;
            color: #6c757d;
        }
        
        .bucket-tree-meta {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .bucket-tree-count {
            font-size: 11px;
            font-weight: 600;
            color: white;
            background: #004D4D;
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        /* Prospects level */
        .bucket-tree-prospects {
            border-top: 1px solid #e9ecef;
            background: #fafbfc;
        }
        
        .bucket-tree-prospect {
            border-bottom: 1px solid #e9ecef;
        }
        
        .bucket-tree-prospect:last-child {
            border-bottom: none;
        }
        
        .bucket-tree-prospect-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px 8px 24px;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .bucket-tree-prospect-header:hover {
            background: #f1f3f4;
        }
        
        .bucket-tree-prospect-header.has-hot {
            background: linear-gradient(90deg, rgba(255,107,53,0.06) 0%, transparent 50%);
        }
        
        .bucket-tree-prospect-info {
            flex: 1;
            min-width: 0;
        }
        
        .bucket-tree-prospect-name {
            font-size: 12px;
            font-weight: 500;
            color: #2d3748;
            cursor: pointer;
        }
        
        .bucket-tree-prospect-name:hover {
            color: #004D4D;
            text-decoration: underline;
        }
        
        .bucket-tree-prospect-name.has-research::before {
            content: "•";
            color: #5FC4B8;
            margin-right: 4px;
        }
        
        .bucket-tree-prospect-title {
            font-size: 10px;
            color: #6c757d;
        }
        
        .bucket-tree-path-count {
            font-size: 10px;
            color: #004D4D;
            background: #e6f7f5;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .bucket-tree-no-paths {
            font-size: 10px;
            color: #adb5bd;
            font-style: italic;
        }
        
        /* Connectors level */
        .bucket-tree-connectors {
            background: #f1f3f4;
            padding: 4px 0;
        }
        
        .bucket-tree-connector {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px 6px 44px;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .bucket-tree-connector:hover {
            background: #e9ecef;
        }
        
        .bucket-tree-connector.hot {
            background: linear-gradient(90deg, rgba(255,107,53,0.1) 0%, transparent 60%);
        }
        
        .bucket-tree-connector-info {
            flex: 1;
        }
        
        .bucket-tree-connector-name {
            font-size: 11px;
            font-weight: 500;
            color: #2d3748;
        }
        
        .bucket-tree-connector.hot .bucket-tree-connector-name {
            color: #c05621;
        }
        
        .bucket-tree-connector-detail {
            font-size: 10px;
            color: #6c757d;
        }
        
        .bucket-tree-more {
            font-size: 10px;
            color: #6c757d;
            padding: 4px 44px;
            font-style: italic;
        }
        
        /* Bucket Summary */
        .bucket-summary {
            display: flex;
            gap: 16px;
            padding: 12px;
            margin-top: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            justify-content: center;
        }
        
        .bucket-summary-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .bucket-summary-value {
            font-size: 18px;
            font-weight: 700;
            color: #004D4D;
        }
        
        .bucket-summary-label {
            font-size: 10px;
            color: #6c757d;
            text-transform: uppercase;
        }
        
        /* Bucket Sections */
        .bucket-section {
            margin-bottom: 16px;
        }
        
        .bucket-section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 8px;
        }
        
        .bucket-section-icon {
            font-size: 14px;
        }
        
        .bucket-section-title {
            font-size: 11px;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Connectors Section */
        .bucket-section.connectors-section {
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #d1fae5;
        }
        
        .bucket-section.connectors-section .bucket-section-header {
            border-bottom-color: #a7f3d0;
        }
        
        .bucket-tree-connector-block {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        
        .bucket-tree-connector-block.hot {
            border-left: 3px solid #FF6B35;
            background: linear-gradient(90deg, rgba(255,107,53,0.05) 0%, white 30%);
        }
        
        .bucket-tree-connector-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .bucket-tree-connector-header:hover {
            background: #f8f9fa;
        }
        
        .bucket-tree-connector-main {
            flex: 1;
            min-width: 0;
        }
        
        .bucket-tree-connector-name {
            font-size: 13px;
            font-weight: 600;
            color: #2d3748;
            cursor: pointer;
        }
        
        .bucket-tree-connector-name:hover {
            color: #004D4D;
            text-decoration: underline;
        }
        
        .bucket-tree-connector-company {
            font-size: 11px;
            color: #6c757d;
        }
        
        .bucket-tree-connector-location {
            font-size: 10px;
            color: #9ca3af;
        }
        
        .bucket-tree-firm-count {
            font-size: 10px;
            color: #004D4D;
            background: #e6f7f5;
            padding: 2px 8px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .bucket-tree-connector-firms {
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            padding: 8px 12px 8px 36px;
        }
        
        .bucket-connector-firm-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            margin-bottom: 4px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .bucket-connector-firm-row:hover {
            background: #e6f7f5;
        }
        
        .bucket-connector-firm-info {
            flex: 1;
        }
        
        .bucket-connector-firm-name {
            font-size: 12px;
            font-weight: 500;
            color: #2d3748;
        }
        
        .bucket-connector-firm-location {
            font-size: 10px;
            color: #6c757d;
        }
        
        /* Firms Section styling */
        .bucket-section.firms-section {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
        }

        /* Improved Research Panel */
        .research-tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid #e9ecef;
            background: #fafbfc;
        }

        .research-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            font-size: 13px;
            font-weight: 500;
            color: #6c757d;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.2s;
        }

        .research-tab:hover {
            color: #004D4D;
            background: rgba(0,77,77,0.03);
        }

        .research-tab.active {
            color: #004D4D;
            border-bottom-color: #004D4D;
            background: white;
        }

        .research-tab-content {
            display: none;
            padding: 20px;
        }

        .research-tab-content.active {
            display: block;
        }

        .research-highlight-card {
            background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
            border-left: 4px solid #ffc107;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .research-highlight-title {
            font-weight: 600;
            color: #856404;
            font-size: 14px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .research-highlight-text {
            font-size: 13px;
            color: #5a4a00;
            line-height: 1.6;
        }

        .research-field {
            margin-bottom: 20px;
        }

        .research-field:last-child {
            margin-bottom: 0;
        }

        .research-field-label {
            font-size: 11px;
            font-weight: 600;
            color: #004D4D;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .research-field-value {
            font-size: 14px;
            color: #2d3748;
            line-height: 1.7;
        }

        .research-meta {
            display: flex;
            justify-content: flex-end;
            padding: 12px 20px;
            background: #fafbfc;
            border-top: 1px solid #e9ecef;
        }

        .research-meta-item {
            font-size: 11px;
            color: #6c757d;
        }

        .research-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 14px;
        }

        .research-item {
            font-size: 13px;
        }

        .research-label {
            color: #6c757d;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .research-value {
            color: #2d3748;
            line-height: 1.5;
        }

        .research-full {
            grid-column: 1 / -1;
        }

        .succession-alert {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .succession-alert-icon {
            font-size: 20px;
        }

        .succession-alert-text {
            font-size: 13px;
            color: #92400e;
        }

        .succession-alert-title {
            font-weight: 600;
        }

        .no-research-msg {
            color: #6c757d;
            font-size: 13px;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        /* ========== SCORE BREAKDOWN TOOLTIP ========== */
        .score-breakdown-trigger {
            cursor: help;
            position: relative;
        }

        .score-breakdown {
            position: absolute;
            background: #2d3748;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
            min-width: 200px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: none;
            right: 0;
            top: 100%;
            margin-top: 8px;
        }

        .score-breakdown.visible {
            display: block;
        }

        .breakdown-title {
            font-weight: 600;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            font-size: 13px;
        }

        .breakdown-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }

        .breakdown-factor {
            color: rgba(255,255,255,0.8);
        }

        .breakdown-points {
            font-weight: 600;
            color: #5FC4B8;
        }

        .breakdown-total {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.2);
            font-weight: 600;
        }

        /* ========== HOT INTRO BADGE ========== */
        .badge-hot-intro {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 6px;
        }

        .badge-succession {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 6px;
        }

        .badge-researched {
            background: #004D4D;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 6px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 28px;
            }

            .scoring-lenses {
                padding: 0 20px;
            }

            .custom-panel {
                margin: 0 20px 20px 20px;
                padding: 16px 20px;
            }

            .trip-planner {
                margin: 0 20px 20px 20px;
            }

            .trip-results {
                grid-template-columns: repeat(2, 1fr);
            }

            .research-grid {
                grid-template-columns: 1fr;
            }

            .filter-row {
                grid-template-columns: 1fr;
            }

            .stats {
                flex-direction: column;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 10px;
            }

            .modal-content {
                margin: 20px auto;
            }

            .profile-card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .profile-actions {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <!-- PASSWORD GATE -->
    <div class="password-gate" id="password-gate">
        <div class="password-box">
            <div class="password-box-logo">🌉 FourBridge</div>
            <div class="password-box-subtitle">Relationship Intelligence System</div>
            <input type="password" class="password-input" id="password-input" placeholder="Enter password" autocomplete="off" autofocus onkeypress="if(event.key==='Enter')checkPassword()">
            <button class="password-btn" onclick="checkPassword()">Access Dashboard</button>
            <div class="password-error" id="password-error">Incorrect password. Please try again.</div>
        </div>
    </div>

    <div class="app-content" id="app-content">
    <!-- LOADING OVERLAY -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">🔄 Loading FourBridge Data from Google Sheets...</div>
        <div class="loading-details">Fetching firms, prospects, connections, and team data...</div>
        <div class="loading-log" id="loading-log"></div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-logo">
                <img src="data:image/webp;base64,UklGRrAFAABXRUJQVlA4WAoAAAAwAAAAiAAAdgAASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZBTFBIpQEAAA2QFkm27jbDQJfBuwwsBrpGkMdALwwuAx0j8AkCXyNwBYElBhYCWwgSIch3Xp1ynf2XSkRMAP/IrG8i1PG2aGAzJxRsAw2rb9DQZjRsjobFJzTsHQ2bo2GxGzRcDA23jobFdmg4OxrWgYal79FwNjSsAxFtj4ZtoGH1DRrajIZtoGHxCQ17R8PmaFh8QsPF0HDrhF6mNIrtCL17esliMUJPC5Qc6iD0unwhydL3hH66J8vZCD0vZFkHoVd7JkvbE/p4IMs2CL0sZFl9Q+wgS5vRsA00LGODhr2jYXM0LD6hYe9ouHU0LLZDw8UIvdp9Flsn9vFAz6H0D4SeOlnORujFXkmyDkKv/kSSpe8J/Xwgy+aEnjtZVt8QebVnsrSZWCfLNtCwjA0a9o6GzdGw+ISGvaPhdqBhsR0aLoaGWyf0wpRFsR2RV3841iRmI/TugSzrIPTRyLL0PZGnhTRnI/Jk38iyOpEXeyVNm4n8+EyabRA7yLL6Bg37gobN0bD4hIa9I+ILMvbzu+jnVXXF7aq64nbdzW+OvMuXr6vWHletPa77b1YAVlA4IBQCAAAQEgCdASqJAHcAPlEijEQjoiEYPFSQOAUEsbdurxwUwnsY0LFgA9wHiRfpR1lPMB+zvrp+lX/a+kl1F+8k/uxlQPgD+AfgB+AH7+9/hka9cKA1fGZwCSSOdE0Op3Af9lkIrLsSisBfonmmouujcveheH0j7aGsCvzTCYLUgBFuGaHJ/+88wWRMrfSsp8C4BGdxGhbq4UTQzAAA/v1uSAhPmj7ZSmfH91SXTfUyr8ZK8IInmAipTr2aS7OuQXeHeq0mcNArujJnfFjjNII5nDueZcCWOfR5rS3l3o6L0ANQgCMm5HfKmAa4EsvvirKfETm/cXgspD2vJcBjh3B3NmQUCKQrjBWmVhji3RRo9+BLPQQYIpNQIRy9evXEI3O6M3vTtjXocvIMqh9WQWMz9UehN7wHUiPmRWoJpG2+ntc+HMzd64CjmAfevx/Linergty4p3qyxgkWX4Yu5G2XXm2Nehze5atF8I/dHiAGLIexKuzwo6vXk1YMfu9tabF/Ik1Dmhf2fdGlp+xEH5iEyYYCAy/zi3wuaV7+ccgu8O+5BO4fjF77ucW6vDn2iuVffLvAqpUtr3UqgS7whFJdmab01+5xxl7UD3RT1yEvj+lNaufDkiD7T4ghg1JiULMTluy5HogBOMVxx57fKHF3iqcSWKtgrZ4UWcVBCgD0xIUFZJoS+ZN/5PAYhfm3FP4AAAAAAAAA" alt="FourBridge" style="height: 32px; width: auto;">
                <span class="header-logo-text">FourBridge</span>
            </div>
            <div class="tabs">
                <button class="tab active" onclick="switchView('prospects')">Prospects</button>
                <button class="tab" onclick="switchView('connections')">Connections</button>
                <button class="tab" onclick="switchView('firms')">Firms</button>
                <button class="tab" onclick="switchView('team')">Team</button>
                <button class="tab" onclick="switchView('actions')">🎯 Action Center</button>
            </div>
        </div>

        <!-- PROSPECTS VIEW -->
        <div id="prospects-view" class="view active">
            <!-- Dashboard Summary Card -->
            <div class="dashboard-summary" id="dashboard-summary">
                <div class="dashboard-header">
                    <h2>Your Warm Reach</h2>
                    <button class="action-list-btn" onclick="showSavedPaths()">
                        Briefing Book <span id="action-list-count">(0)</span>
                    </button>
                </div>
                <div class="dashboard-stats">
                    <div class="dashboard-stat">
                        <span class="dashboard-stat-value" id="dash-reachable">0</span>
                        <span class="dashboard-stat-label">Firms Reachable</span>
                    </div>
                    <div class="dashboard-stat">
                        <span class="dashboard-stat-value" id="dash-contacts">0</span>
                        <span class="dashboard-stat-label">Contacts Mapped</span>
                    </div>
                    <div class="dashboard-stat">
                        <span class="dashboard-stat-value" id="dash-connectors">0</span>
                        <span class="dashboard-stat-label">Active Connectors</span>
                    </div>
                    <div class="dashboard-stat">
                        <span class="dashboard-stat-value" id="dash-paths">0</span>
                        <span class="dashboard-stat-label">Warm Paths</span>
                    </div>
                </div>
            </div>

            <div class="info-tip">
                💡 <strong>Prospects View:</strong> Target people and firms we want to reach. Toggle between people-focused and firm-focused views below.
            </div>

            <!-- SCORING & FILTER PANEL (Collapsible) -->
            <div class="custom-scoring-toggle" id="custom-scoring-section">
                <button class="custom-toggle-btn" onclick="toggleCustomScoring()">
                    <span>⚙️ Scoring & Ranking Settings</span>
                    <span class="toggle-arrow" id="custom-toggle-arrow">▼</span>
                </button>
            </div>
            
            <div class="custom-panel" id="custom-panel">
                <div class="scoring-grid">
                    <!-- AUM Scoring -->
                    <div class="scoring-section">
                        <div class="scoring-section-header">
                            <span class="scoring-icon">💰</span>
                            <span class="scoring-title">AUM Target Range</span>
                        </div>
                        <div class="aum-inputs">
                            <div class="aum-field">
                                <label>Min ($M)</label>
                                <input type="number" id="score-aum-min" placeholder="0" value="0" onchange="updateScoring()">
                            </div>
                            <span class="aum-separator">to</span>
                            <div class="aum-field">
                                <label>Max ($M)</label>
                                <input type="number" id="score-aum-max" placeholder="Any" value="" onchange="updateScoring()">
                            </div>
                        </div>
                        <div class="aum-presets">
                            <button class="preset-chip" onclick="setAumPreset(0, 100)">Under $100M</button>
                            <button class="preset-chip" onclick="setAumPreset(100, 500)">$100M-$500M</button>
                            <button class="preset-chip" onclick="setAumPreset(500, 2000)">$500M-$2B</button>
                            <button class="preset-chip" onclick="setAumPreset(2000, null)">$2B+</button>
                            <button class="preset-chip active" onclick="setAumPreset(0, null)">Any</button>
                        </div>
                    </div>
                    
                    <!-- Warm Paths Weight -->
                    <div class="scoring-section">
                        <div class="scoring-section-header">
                            <span class="scoring-icon">🔥</span>
                            <span class="scoring-title">Warm Paths Importance</span>
                            <span class="scoring-value" id="paths-weight-display">High</span>
                        </div>
                        <input type="range" class="scoring-slider" id="score-paths" min="0" max="5" value="4" oninput="updateScoring()">
                        <div class="slider-labels">
                            <span>Not Important</span>
                            <span>Critical</span>
                        </div>
                    </div>
                    
                    <!-- Contacts Weight -->
                    <div class="scoring-section">
                        <div class="scoring-section-header">
                            <span class="scoring-icon">👥</span>
                            <span class="scoring-title"># of Contacts Importance</span>
                            <span class="scoring-value" id="contacts-weight-display">Medium</span>
                        </div>
                        <input type="range" class="scoring-slider" id="score-contacts" min="0" max="5" value="3" oninput="updateScoring()">
                        <div class="slider-labels">
                            <span>Not Important</span>
                            <span>Critical</span>
                        </div>
                    </div>
                    
                    <!-- Succession Weight -->
                    <div class="scoring-section">
                        <div class="scoring-section-header">
                            <span class="scoring-icon">⏰</span>
                            <span class="scoring-title">Succession Ready Bonus</span>
                            <span class="scoring-value" id="succession-weight-display">High</span>
                        </div>
                        <input type="range" class="scoring-slider" id="score-succession" min="0" max="5" value="4" oninput="updateScoring()">
                        <div class="slider-labels">
                            <span>No Bonus</span>
                            <span>Big Bonus</span>
                        </div>
                    </div>
                    
                    <!-- Research Weight -->
                    <div class="scoring-section">
                        <div class="scoring-section-header">
                            <span class="scoring-icon">📊</span>
                            <span class="scoring-title">Has Research Bonus</span>
                            <span class="scoring-value" id="research-weight-display">Medium</span>
                        </div>
                        <input type="range" class="scoring-slider" id="score-research" min="0" max="5" value="3" oninput="updateScoring()">
                        <div class="slider-labels">
                            <span>No Bonus</span>
                            <span>Big Bonus</span>
                        </div>
                    </div>
                </div>
                
                <div class="scoring-footer">
                    <div class="scoring-preview">
                        <span class="preview-count" id="scoring-match-count">589</span>
                        <span class="preview-label">firms match your criteria</span>
                    </div>
                    <div class="scoring-actions">
                        <button class="scoring-btn secondary" onclick="resetScoring()">Reset to Default</button>
                        <button class="scoring-btn primary" onclick="applyScoring()">Apply & Rank</button>
                    </div>
                </div>
            </div>

            <div style="display: flex; justify-content: center; margin-bottom: 25px;">
                <div class="segmented-control">
                    <button id="view-people-btn" onclick="setProspectsViewMode('people')">
                        <span class="icon">👤</span> People
                    </button>
                    <button id="view-firms-btn" class="active" onclick="setProspectsViewMode('firms')">
                        <span class="icon">🏢</span> Firms
                    </button>
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-group">
                    <label>Search</label>
                    <input type="text" id="prospects-search" placeholder="Search names, firms, titles...">
                </div>
                <div class="filter-group">
                    <label>Organization Type</label>
                    <select id="prospects-type">
                        <option value="">All Types</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Location</label>
                    <div class="multi-select-wrapper" id="location-filter-wrapper">
                        <div class="multi-select-display" onclick="toggleLocationDropdown()">
                            <span id="location-display-text">All Locations</span>
                            <span class="multi-select-arrow">▼</span>
                        </div>
                        <div class="multi-select-dropdown" id="location-dropdown">
                            <div class="multi-select-search">
                                <input type="text" placeholder="Search locations..." id="location-search" oninput="filterLocationOptions()">
                            </div>
                            <div class="multi-select-actions">
                                <button onclick="selectAllLocations()">Select All</button>
                                <button onclick="clearAllLocations()">Clear All</button>
                            </div>
                            <div class="multi-select-options" id="location-options">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-group">
                    <label>AUM Range</label>
                    <select id="prospects-aum-range" onchange="scoringApplied = false; renderProspectsView()">
                        <option value="">Any Size</option>
                        <option value="0-100">Under $100M</option>
                        <option value="100-500">$100M - $500M</option>
                        <option value="500-1000">$500M - $1B</option>
                        <option value="1000-2000">$1B - $2B</option>
                        <option value="2000-5000">$2B - $5B</option>
                        <option value="5000+">$5B+</option>
                    </select>
                </div>
            </div>
            <div class="filter-row">
                <div class="filter-group">
                    <label>Connection Status</label>
                    <select id="prospects-connection">
                        <option value="">All</option>
                        <option value="yes">With Warm Paths</option>
                        <option value="no">No Connections</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Research Status</label>
                    <select id="prospects-research" onchange="renderProspectsView()">
                        <option value="">All</option>
                        <option value="yes">Has Research</option>
                        <option value="no">No Research</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Sort By</label>
                    <select id="prospects-sort" onchange="renderProspectsView()">
                        <option value="opportunity">Opportunity Score</option>
                        <option value="aum">AUM (High to Low)</option>
                        <option value="paths">Warm Paths</option>
                        <option value="alpha">A-Z</option>
                    </select>
                </div>
                <div class="filter-group" id="decision-maker-filter-group" style="display: none;">
                    <label>Decision Maker</label>
                    <select id="prospects-decision-maker">
                        <option value="">All</option>
                        <option value="yes">Decision Makers Only</option>
                        <option value="no">Non-Decision Makers</option>
                    </select>
                </div>
            </div>

            <div class="stats" id="prospects-stats"></div>

            <div class="table-container" id="prospects-firms-table">
                <table id="prospects-table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortProspectsTable(0)">Firm Name</th>
                            <th class="sortable" onclick="sortProspectsTable(1)">Type</th>
                            <th class="sortable" onclick="sortProspectsTable(2)">Location</th>
                            <th class="sortable" onclick="sortProspectsTable(3)">AUM</th>
                            <th class="sortable" onclick="sortProspectsTable(4)">Contacts</th>
                            <th class="sortable" onclick="sortProspectsTable(5)">Warm Paths</th>
                            <th class="sortable" onclick="sortProspectsTable(6)">Score</th>
                            <th style="width: 40px;"></th>
                        </tr>
                    </thead>
                    <tbody id="prospects-table-body"></tbody>
                </table>
            </div>

            <div class="table-container" id="prospects-people-table-container" style="display: none;">
                <table id="prospects-people-table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortProspectsPeopleTable(0)">Prospect Name</th>
                            <th class="sortable" onclick="sortProspectsPeopleTable(1)">Title</th>
                            <th class="sortable" onclick="sortProspectsPeopleTable(2)">Firm</th>
                            <th class="sortable" onclick="sortProspectsPeopleTable(3)">Type</th>
                            <th class="sortable" onclick="sortProspectsPeopleTable(4)">Location</th>
                            <th class="sortable" onclick="sortProspectsPeopleTable(5)">Status</th>
                            <th class="sortable" onclick="sortProspectsPeopleTable(6)">Warm Paths</th>
                            <th style="width: 40px;"></th>
                        </tr>
                    </thead>
                    <tbody id="prospects-people-table-body"></tbody>
                </table>
            </div>
        </div>

        <!-- CONNECTIONS VIEW -->
        <div id="connections-view" class="view">
            <div class="info-tip">
                💡 <strong>Connections View:</strong> Browse by mutual connections. Click connector names to expand and see prospects they can reach. Click "Info" to see which FourBridge team members know them.
            </div>

            <div class="filter-row">
                <div class="filter-group">
                    <label>Search Connectors</label>
                    <input type="text" id="connections-search" placeholder="Search name or company...">
                </div>
                <div class="filter-group">
                    <label>Team Member</label>
                    <select id="connections-team-filter">
                        <option value="">All Team</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Sort By</label>
                    <select id="connections-sort">
                        <option value="most">Most Connections</option>
                        <option value="fewest">Fewest Connections</option>
                        <option value="alpha">A-Z</option>
                        <option value="alpha-desc">Z-A</option>
                    </select>
                </div>
            </div>

            <div class="stats" id="connections-stats"></div>

            <div id="connectors-display"></div>
        </div>

        <!-- FIRMS DATABASE VIEW -->
        <div id="firms-view" class="view">
            <div class="info-tip">
                💡 <strong>Firms Database:</strong> Complete directory of all firms. This includes target prospects, past contacts, and cold leads. Click any firm to see full details and relationship map.
            </div>

            <div class="filter-row">
                <div class="filter-group">
                    <label>Search</label>
                    <input type="text" id="firms-search" placeholder="Search firms...">
                </div>
                <div class="filter-group">
                    <label>Type</label>
                    <select id="firms-type">
                        <option value="">All Types</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>State</label>
                    <select id="firms-location">
                        <option value="">All States</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Status</label>
                    <select id="firms-status">
                        <option value="">All Status</option>
                        <option value="target_prospect">Target Prospect</option>
                        <option value="cold_lead">Cold Lead</option>
                        <option value="past_contact">Past Contact</option>
                    </select>
                </div>
            </div>

            <div class="stats" id="firms-stats"></div>

            <div class="table-container">
                <table id="firms-table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortFirmsTable(0)">Firm Name</th>
                            <th class="sortable" onclick="sortFirmsTable(1)">Type</th>
                            <th class="sortable" onclick="sortFirmsTable(2)">Location</th>
                            <th class="sortable" onclick="sortFirmsTable(3)">AUM</th>
                            <th class="sortable" onclick="sortFirmsTable(4)">Status</th>
                            <th class="sortable" onclick="sortFirmsTable(5)">Contacts</th>
                            <th class="sortable" onclick="sortFirmsTable(6)">Warm Paths</th>
                            <th style="width: 40px;"></th>
                        </tr>
                    </thead>
                    <tbody id="firms-table-body"></tbody>
                </table>
            </div>
        </div>

        <!-- TEAM DATABASE VIEW -->
        <div id="team-view" class="view">
            <div class="info-tip">
                💡 <strong>Team Database:</strong> FourBridge team member profiles with network strength metrics. Click any team member to see their complete network map and reachable prospects.
            </div>

            <div class="filter-row">
                <div class="filter-group">
                    <label>Search Team</label>
                    <input type="text" id="team-search" placeholder="Search name or role...">
                </div>
                <div class="filter-group">
                    <label>Sort By</label>
                    <select id="team-sort">
                        <option value="reach">Most Reach</option>
                        <option value="connectors">Most Connectors</option>
                        <option value="alpha">A-Z</option>
                    </select>
                </div>
            </div>

            <div class="stats" id="team-stats"></div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTeamTable(0)">Name</th>
                            <th class="sortable" onclick="sortTeamTable(1)">Role</th>
                            <th class="sortable" onclick="sortTeamTable(2)">Location</th>
                            <th class="sortable" onclick="sortTeamTable(3)">Connectors</th>
                            <th class="sortable" onclick="sortTeamTable(4)">Firms Reachable</th>
                            <th class="sortable" onclick="sortTeamTable(5)">Prospects</th>
                        </tr>
                    </thead>
                    <tbody id="team-table-body"></tbody>
                </table>
            </div>
        </div>

        <!-- ACTION CENTER VIEW -->
        <div id="actions-view" class="view">
            <div class="action-center-page">
                <div class="action-center-header">
                    <h2>Action Center</h2>
                    <div class="action-center-tabs">
                        <button class="ac-tab active" onclick="switchACTab('connectors')">Hot Connectors</button>
                        <button class="ac-tab" onclick="switchACTab('trip')">Trip Builder</button>
                        <button class="ac-tab" onclick="switchACTab('intelligence')">Network Intelligence</button>
                        <button class="ac-tab" onclick="switchACTab('firmgroups')">Firm Groups</button>
                    </div>
                </div>
                
                <!-- HOT CONNECTORS TAB -->
                <div class="ac-content active" id="ac-connectors">
                    <div class="ac-full-layout">
                        <div class="ac-section-header">
                            <div>
                                <h3>Manage Hot Connectors by Team Member</h3>
                                <p>Mark people you're especially close with - they'll boost firm rankings and be highlighted in pathways</p>
                            </div>
                        </div>
                        <div class="ac-team-panels">
                            <div class="ac-team-panel" id="panel-ted">
                                <div class="ac-team-panel-header">
                                    <h4>Ted's Connections</h4>
                                    <span class="ac-team-hot-count" id="ted-hot-count">0 hot</span>
                                </div>
                                <input type="text" class="ac-panel-search" placeholder="Search Ted's connections..." oninput="filterTeamPanel('ted')">
                                <div class="ac-team-panel-list" id="ted-connectors-list"></div>
                            </div>
                            <div class="ac-team-panel" id="panel-jon">
                                <div class="ac-team-panel-header">
                                    <h4>Jon's Connections</h4>
                                    <span class="ac-team-hot-count" id="jon-hot-count">0 hot</span>
                                </div>
                                <input type="text" class="ac-panel-search" placeholder="Search Jon's connections..." oninput="filterTeamPanel('jon')">
                                <div class="ac-team-panel-list" id="jon-connectors-list"></div>
                            </div>
                            <div class="ac-team-panel" id="panel-chris">
                                <div class="ac-team-panel-header">
                                    <h4>Chris's Connections</h4>
                                    <span class="ac-team-hot-count" id="chris-hot-count">0 hot</span>
                                </div>
                                <input type="text" class="ac-panel-search" placeholder="Search Chris's connections..." oninput="filterTeamPanel('chris')">
                                <div class="ac-team-panel-list" id="chris-connectors-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- TRIP BUILDER TAB -->
                <div class="ac-content" id="ac-trip">
                    <div class="ac-split-layout">
                        <div class="ac-main">
                            <div class="trip-planner-header">
                                <div class="trip-location-select">
                                    <label>Planning trip to:</label>
                                    <select id="trip-location" onchange="updateTripBuilder()">
                                        <option value="">Select a location...</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="trip-tabs" id="trip-tabs" style="display:none;">
                                <button class="trip-tab active" onclick="switchTripTab('firms')">
                                    Firms <span class="trip-tab-count" id="tb-firm-count">0</span>
                                </button>
                                <button class="trip-tab" onclick="switchTripTab('prospects')">
                                    Prospects <span class="trip-tab-count" id="tb-prospect-count">0</span>
                                </button>
                                <button class="trip-tab" onclick="switchTripTab('connectors')">
                                    Connectors <span class="trip-tab-count" id="tb-connector-count">0</span>
                                </button>
                            </div>
                            
                            <div class="trip-content" id="tb-firms-content" style="display:none;">
                                <table class="trip-table">
                                    <thead>
                                        <tr>
                                            <th style="width:50px;">Add</th>
                                            <th>Firm</th>
                                            <th>Type</th>
                                            <th>AUM</th>
                                            <th>Paths</th>
                                            <th style="width:40px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tb-firms-body"></tbody>
                                </table>
                            </div>
                            
                            <div class="trip-content" id="tb-prospects-content" style="display:none;">
                                <table class="trip-table">
                                    <thead>
                                        <tr>
                                            <th style="width:50px;">Add</th>
                                            <th>Prospect</th>
                                            <th>Firm</th>
                                            <th>Paths</th>
                                            <th style="width:40px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tb-prospects-body"></tbody>
                                </table>
                            </div>
                            
                            <div class="trip-content" id="tb-connectors-content" style="display:none;">
                                <table class="trip-table">
                                    <thead>
                                        <tr>
                                            <th style="width:50px;">Add</th>
                                            <th style="width:50px;">Hot</th>
                                            <th>Connector</th>
                                            <th>Firms They Can Intro</th>
                                            <th style="width:40px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tb-connectors-body"></tbody>
                                </table>
                            </div>
                            
                            <div class="trip-empty" id="trip-empty">
                                <div class="empty-state">
                                    <div class="empty-state-icon" style="font-size: 48px; opacity: 0.3;">📍</div>
                                    <div class="empty-state-title">Plan your next trip</div>
                                    <div class="empty-state-text">Select a location above to browse firms, prospects, and connectors</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="ac-sidebar">
                            <div class="ac-sidebar-header">
                                <h4>Saved Intros</h4>
                                <span class="ac-sidebar-count" id="intros-count">0</span>
                            </div>
                            <div class="ac-sidebar-actions" id="intros-actions" style="display: none;">
                                <button class="action-btn secondary small" onclick="clearSavedIntros()">Clear</button>
                                <button class="action-btn primary small" onclick="exportSavedIntros()">Export</button>
                            </div>
                            <div class="ac-sidebar-list" id="intros-list"></div>
                            <div class="ac-sidebar-empty" id="intros-empty">
                                <p>Star intro paths from firm/prospect views</p>
                            </div>
                            
                            <div class="ac-sidebar-divider"></div>
                            
                            <div class="ac-sidebar-header">
                                <h4>Trip Buckets</h4>
                            </div>
                            
                            <div class="bucket-management">
                                <select id="active-bucket-select" class="bucket-select" onchange="switchBucket()">
                                    <option value="">Select a bucket...</option>
                                </select>
                                <button class="new-bucket-btn" onclick="createNewBucket()" title="Create new bucket">➕</button>
                            </div>
                            
                            <div class="active-bucket-name" id="active-bucket-name" style="display:none;">
                                <span id="current-bucket-label"></span>
                                <span class="bucket-item-count" id="bucket-count">0</span>
                            </div>
                            
                            <div class="ac-sidebar-actions" id="bucket-actions" style="display: none;">
                                <button class="action-btn secondary small" onclick="clearCurrentBucket()">Clear</button>
                                <button class="action-btn secondary small" onclick="deleteCurrentBucket()">Delete</button>
                                <button class="action-btn primary small" onclick="exportCurrentBucket()">Export</button>
                            </div>
                            <div class="ac-sidebar-list" id="bucket-list"></div>
                            <div class="ac-sidebar-empty" id="bucket-empty">
                                <p>Create a bucket to start adding firms and prospects</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- NETWORK INTELLIGENCE TAB -->
                <div class="ac-content" id="ac-intelligence">
                    <div class="ac-full-layout">
                        <div class="ac-section-header">
                            <div>
                                <h3>Network Intelligence</h3>
                                <p>Discover commonalities across your prospect network - schools, companies, families, and more</p>
                            </div>
                        </div>
                        
                        <div class="intel-search-bar">
                            <input type="text" id="intel-search" placeholder="Search by school, company, board, family, location, or person..." oninput="filterIntelligence()">
                            <div class="intel-filter-pills">
                                <button class="intel-pill active" onclick="switchIntelCategory('all')">All</button>
                                <button class="intel-pill" onclick="switchIntelCategory('schools')">🎓 Schools</button>
                                <button class="intel-pill" onclick="switchIntelCategory('companies')">🏢 Companies</button>
                                <button class="intel-pill" onclick="switchIntelCategory('boards')">📋 Boards</button>
                                <button class="intel-pill" onclick="switchIntelCategory('foundations')">❤️ Foundations</button>
                                <button class="intel-pill" onclick="switchIntelCategory('families')">👨‍👩‍👧 Families</button>
                                <button class="intel-pill" onclick="switchIntelCategory('generations')">📊 Generation</button>
                                <button class="intel-pill" onclick="switchIntelCategory('military')">🎖️ Military</button>
                                <button class="intel-pill" onclick="switchIntelCategory('locations')">📍 Locations</button>
                            </div>
                        </div>
                        
                        <div class="intel-stats-row" id="intel-stats">
                            <div class="intel-stat">
                                <div class="intel-stat-value" id="intel-school-count">0</div>
                                <div class="intel-stat-label">Schools</div>
                            </div>
                            <div class="intel-stat">
                                <div class="intel-stat-value" id="intel-company-count">0</div>
                                <div class="intel-stat-label">Companies</div>
                            </div>
                            <div class="intel-stat">
                                <div class="intel-stat-value" id="intel-board-count">0</div>
                                <div class="intel-stat-label">Boards</div>
                            </div>
                            <div class="intel-stat">
                                <div class="intel-stat-value" id="intel-foundation-count">0</div>
                                <div class="intel-stat-label">Foundations</div>
                            </div>
                            <div class="intel-stat">
                                <div class="intel-stat-value" id="intel-family-count">0</div>
                                <div class="intel-stat-label">Families</div>
                            </div>
                            <div class="intel-stat">
                                <div class="intel-stat-value" id="intel-generation-count">0</div>
                                <div class="intel-stat-label">Generations</div>
                            </div>
                            <div class="intel-stat">
                                <div class="intel-stat-value" id="intel-military-count">0</div>
                                <div class="intel-stat-label">Military</div>
                            </div>
                            <div class="intel-stat">
                                <div class="intel-stat-value" id="intel-location-count">0</div>
                                <div class="intel-stat-label">Locations</div>
                            </div>
                        </div>
                        
                        <div class="intel-grid" id="intel-grid">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <!-- FIRM GROUPS TAB -->
                <div class="ac-content" id="ac-firmgroups">
                    <div class="ac-full-layout">
                        <div class="ac-section-header">
                            <div>
                                <h3>Firm Groups</h3>
                                <p>Link related entities (family offices, trusts, foundations, holdings) to see the full family picture</p>
                            </div>
                            <div class="fg-header-actions">
                                <button class="action-btn secondary small" onclick="autoSuggestFirmGroups()">🔍 Auto-Suggest Groups</button>
                                <button class="action-btn secondary small" onclick="clearAllFirmGroups()">Clear All</button>
                            </div>
                        </div>
                        
                        <div class="fg-layout">
                            <!-- Left: Ungrouped Firms -->
                            <div class="fg-ungrouped-panel">
                                <div class="fg-panel-header">
                                    <h4>Ungrouped Firms</h4>
                                    <span class="fg-panel-count" id="fg-ungrouped-count">0</span>
                                </div>
                                <input type="text" class="fg-search" id="fg-ungrouped-search" placeholder="Search firms..." oninput="filterUngroupedFirms()">
                                <div class="fg-firm-list" id="fg-ungrouped-list">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                            
                            <!-- Right: Groups -->
                            <div class="fg-groups-panel">
                                <div class="fg-panel-header">
                                    <h4>Firm Groups</h4>
                                    <button class="action-btn primary small" onclick="createNewFirmGroup()">+ New Group</button>
                                </div>
                                <div class="fg-groups-list" id="fg-groups-list">
                                    <!-- Populated by JS -->
                                </div>
                                <div class="fg-groups-empty" id="fg-groups-empty">
                                    <p>No firm groups created yet.</p>
                                    <p>Click "Auto-Suggest Groups" to find related firms, or create a new group manually.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Suggested Groups -->
                        <div class="fg-suggestions" id="fg-suggestions" style="display: none;">
                            <div class="fg-suggestions-header">
                                <h4>Suggested Groups</h4>
                                <button class="fg-suggestions-close" onclick="closeFirmSuggestions()">×</button>
                            </div>
                            <div class="fg-suggestions-list" id="fg-suggestions-list">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="app-footer" id="app-footer">
            <span>🔄 Last synced: <span id="footer-sync-time">just now</span></span>
            <span class="footer-divider">•</span>
            <span id="footer-version">v2025-12-03</span>
            <span class="footer-divider">•</span>
            <span><span class="footer-highlight" id="footer-firms">0</span> firms</span>
            <span class="footer-divider">•</span>
            <span><span class="footer-highlight" id="footer-reachable">0</span> reachable</span>
        </div>
    </div>

    <!-- ACTION LIST TOGGLE BUTTON -->
    <button class="saved-paths-toggle" onclick="toggleSavedPathsPanel()">
        📋 Briefing Book <span class="count" id="saved-paths-count">0</span>
    </button>

    <!-- BRIEFING BOOK PANEL -->
    <div class="saved-paths-panel" id="saved-paths-panel">
        <div class="saved-paths-header">
            <h3>📋 Briefing Book</h3>
            <button onclick="toggleSavedPathsPanel()" style="background: transparent; border: none; color: white; font-size: 20px; cursor: pointer;">&times;</button>
        </div>
        <div class="saved-paths-body" id="saved-paths-body">
            <p style="color: #6c757d; text-align: center; padding: 20px;">No items saved yet.<br>Star ☆ prospects, firms, or connectors to build your briefing book.</p>
        </div>
        <div class="saved-paths-footer">
            <button class="btn-export" onclick="exportAllBriefs()">📄 Export Briefs</button>
            <button class="btn-export" onclick="exportSavedPaths()" style="background: #6c757d;">📋 Copy for Sheets</button>
            <button class="btn-clear" onclick="clearSavedPaths()">Clear All</button>
        </div>
    </div>

    <!-- BRIEF MODAL -->
    <div id="brief-modal" class="modal" onclick="closeBriefModal(event)">
        <div class="modal-content brief-modal-content" id="brief-modal-content" onclick="event.stopPropagation()">
            <div class="modal-header brief-modal-header">
                <button class="btn-expand-modal" onclick="toggleBriefModalSize()" id="btn-expand-brief">⬌ Expand</button>
                <span class="close-btn" onclick="closeBriefModal()">&times;</span>
                <h2 id="brief-modal-title"></h2>
                <div class="modal-subtitle" id="brief-modal-subtitle"></div>
            </div>
            <div class="modal-body brief-modal-body" id="brief-modal-body"></div>
            <div class="brief-modal-footer">
                <button onclick="exportCurrentBrief()" class="btn-export">📄 Export This Brief</button>
                <button onclick="closeBriefModal()" class="btn-clear">Close</button>
            </div>
        </div>
    </div>


    <!-- DETAIL MODAL -->
    <div id="detail-modal" class="modal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="close-btn" onclick="closeModal()">&times;</span>
                <h2 id="modal-name"></h2>
                <div class="modal-subtitle" id="modal-subtitle"></div>
            </div>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION ==========
        const SHEET_ID = '183HM7pUH-gdd4FXm94G05Bm0KJrfHioDU2Ti1GQiOWo';
        const PUBLISHED_ID = '2PACX-1vQa6QC3ZJ9qU8KoypqBCBMsf68a8W7257eyTyk6nCIx4aRc54MPxtqwDBjjiDQxlhF5Y85_XT2ND-CK';
        
        // Tab GIDs from the actual Google Sheet
        const SHEET_TABS = {
            firms: { name: 'firms', gid: 0 },
            team: { name: 'team', gid: 835603482 },
            mutualConnections: { name: 'mutual connections', gid: 519427041 },
            prospects: { name: 'prospects', gid: 857156726 },
            firmResearch: { name: 'firm research', gid: 172578860 },
            prospectResearch: { name: 'prospect research', gid: 500024875 }
        };

        // ========== GLOBAL DATA STORAGE ==========
        let toolData = {
            version: "2025-12-17-enhanced-scoring",
            lastUpdated: new Date().toISOString(),
            firms: [],
            prospects: [],
            teamMembers: [],
            mutualConnections: [],
            relationships: [],
            firmResearch: {},  // firmName -> research data
            prospectResearch: {} // prospectName -> research data
        };

        // ========== SCORING LENS STATE ==========
        let currentLens = 'custom'; // Always use custom scoring now
        let selectedLocations = []; // Multi-select locations
        
        let customWeights = {
            aum: 3,
            paths: 4,
            contacts: 2,
            succession: 3,
            research: 2
        };

        let savedPresets = JSON.parse(localStorage.getItem('fourbridge_presets') || '[]');
        
        // Location data - US states + international
        const ALL_LOCATIONS = {
            us: {
                label: '🇺🇸 United States',
                locations: {
                    'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas', 'CA': 'California',
                    'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware', 'FL': 'Florida', 'GA': 'Georgia',
                    'HI': 'Hawaii', 'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',
                    'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine', 'MD': 'Maryland',
                    'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi', 'MO': 'Missouri',
                    'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey',
                    'NM': 'New Mexico', 'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',
                    'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',
                    'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah', 'VT': 'Vermont',
                    'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming',
                    'DC': 'Washington DC'
                }
            },
            international: {
                label: '🌍 International',
                locations: {
                    'GBR': 'United Kingdom', 'CHE': 'Switzerland', 'DEU': 'Germany', 'FRA': 'France',
                    'SGP': 'Singapore', 'HKG': 'Hong Kong', 'ARE': 'UAE / Dubai', 'AUS': 'Australia',
                    'CAN': 'Canada', 'JPN': 'Japan', 'CHN': 'China', 'IND': 'India',
                    'NLD': 'Netherlands', 'LUX': 'Luxembourg', 'MCO': 'Monaco', 'IRL': 'Ireland',
                    'ISR': 'Israel', 'BRA': 'Brazil', 'MEX': 'Mexico', 'KOR': 'South Korea'
                }
            }
        };

        // ========== LOGGING UTILITY ==========
        function log(message, type = 'info') {
            const logDiv = document.getElementById('loading-log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // ========== NAME NORMALIZATION ==========
        // Format number with commas
        function formatNumber(num) {
            if (num === null || num === undefined) return '0';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }
        
        function normalizeName(name) {
            if (!name) return '';
            return name.toString().toLowerCase().trim().replace(/\s+/g, ' ');
        }

        // Generate alternate lookup keys for firm names
        function generateFirmNameVariants(name) {
            if (!name) return [];
            const variants = new Set();
            const normalized = normalizeName(name);
            
            // Common suffixes to strip
            const suffixes = [
                ', llc', ' llc', ',llc',
                ', lp', ' lp', ',lp',
                ', inc', ' inc', ',inc', ' inc.',
                ', l.l.c.', ' l.l.c.',
                ', l.p.', ' l.p.',
                ' corporation', ', corporation',
                ' corp', ', corp', ' corp.',
                ' company', ', company',
                ' co.', ', co.',
                ' ltd', ', ltd', ' ltd.',
                ' limited', ', limited',
                ' llp', ', llp',
                ' pllc', ', pllc',
                ' pc', ', pc', ' p.c.',
                ' & co', ' and company',
                ' holdings', ' group', ' partners', ' capital',
                ' management', ' advisors', ' advisory',
                ' investments', ' ventures', ' fund',
                ' family office', ' family offices',
                ' wealth management', ' wealth partners',
                ' private wealth', ' asset management'
            ];
            
            // Add version without each suffix
            let stripped = normalized;
            suffixes.forEach(suffix => {
                if (stripped.endsWith(suffix)) {
                    stripped = stripped.slice(0, -suffix.length).trim();
                    variants.add(stripped);
                }
            });
            
            // Handle "Name / Alternate Name" patterns
            if (normalized.includes(' / ')) {
                const parts = normalized.split(' / ');
                parts.forEach(part => {
                    variants.add(part.trim());
                    // Also strip suffixes from each part
                    let partStripped = part.trim();
                    suffixes.forEach(suffix => {
                        if (partStripped.endsWith(suffix)) {
                            partStripped = partStripped.slice(0, -suffix.length).trim();
                            variants.add(partStripped);
                        }
                    });
                });
            }
            
            // Handle "(Formerly XYZ)" or "(DBA XYZ)" patterns
            const parenthetical = normalized.match(/\((?:formerly|dba|fka|aka|d\/b\/a)\s+([^)]+)\)/i);
            if (parenthetical) {
                variants.add(parenthetical[1].trim());
                // Also add version without the parenthetical
                variants.add(normalized.replace(/\s*\([^)]+\)\s*/g, ' ').trim());
            }
            
            // Handle "Name (Alternate)" pattern
            const altMatch = normalized.match(/^([^(]+)\s*\(([^)]+)\)$/);
            if (altMatch) {
                variants.add(altMatch[1].trim());
                variants.add(altMatch[2].trim());
            }
            
            return [...variants].filter(v => v.length > 2);
        }

        // Find matching firm with fuzzy matching
        function findMatchingFirm(firmName) {
            if (!firmName) return null;
            
            const normalized = normalizeName(firmName);
            
            // 1. Try exact match
            if (window.firmsByName[normalized]) {
                return window.firmsByName[normalized];
            }
            
            // 2. Try variants of the search term
            const searchVariants = generateFirmNameVariants(firmName);
            for (const variant of searchVariants) {
                if (window.firmsByName[variant]) {
                    return window.firmsByName[variant];
                }
            }
            
            // 3. Try partial match (if firm name contains or is contained by search)
            const firmKeys = Object.keys(window.firmsByName);
            for (const key of firmKeys) {
                // Skip very short keys to avoid false matches
                if (key.length < 5) continue;
                
                // Check if one contains the other
                if (normalized.includes(key) || key.includes(normalized)) {
                    return window.firmsByName[key];
                }
            }
            
            return null;
        }

        // ========== STATE NORMALIZATION ==========
        const CITY_TO_STATE = {
            // Major cities
            'new york': 'NY', 'nyc': 'NY', 'n.y.c.': 'NY', 'manhattan': 'NY', 'brooklyn': 'NY', 'queens': 'NY', 'bronx': 'NY', 'staten island': 'NY',
            'rochester': 'NY', 'buffalo': 'NY', 'albany': 'NY', 'syracuse': 'NY', 'white plains': 'NY', 'yonkers': 'NY',
            'los angeles': 'CA', 'la': 'CA', 'l.a.': 'CA', 'san francisco': 'CA', 'sf': 'CA', 's.f.': 'CA', 'san diego': 'CA', 'palo alto': 'CA', 'silicon valley': 'CA', 'menlo park': 'CA',
            'chicago': 'IL', 'highland park': 'IL', 'evanston': 'IL', 'lake forest': 'IL', 'winnetka': 'IL',
            'boston': 'MA', 'cambridge': 'MA', 'brookline': 'MA', 'newton': 'MA',
            'houston': 'TX', 'dallas': 'TX', 'austin': 'TX', 'san antonio': 'TX', 'fort worth': 'TX', 'plano': 'TX',
            'philadelphia': 'PA', 'philly': 'PA', 'pittsburgh': 'PA', 'king of prussia': 'PA',
            'phoenix': 'AZ', 'scottsdale': 'AZ', 'paradise valley': 'AZ', 'tucson': 'AZ',
            'seattle': 'WA', 'bellevue': 'WA', 'redmond': 'WA', 'tacoma': 'WA',
            'denver': 'CO', 'boulder': 'CO', 'aspen': 'CO', 'colorado springs': 'CO',
            'atlanta': 'GA', 'buckhead': 'GA',
            'miami': 'FL', 'ft. lauderdale': 'FL', 'fort lauderdale': 'FL', 'palm beach': 'FL', 'tampa': 'FL', 'jacksonville': 'FL', 'orlando': 'FL', 'naples': 'FL', 'boca raton': 'FL', 'west palm beach': 'FL',
            'detroit': 'MI', 'ann arbor': 'MI', 'grand rapids': 'MI', 'bloomfield hills': 'MI',
            'minneapolis': 'MN', 'st. paul': 'MN', 'saint paul': 'MN', 'edina': 'MN',
            'charlotte': 'NC', 'raleigh': 'NC', 'durham': 'NC', 'advance': 'NC', 'chapel hill': 'NC', 'winston-salem': 'NC',
            'nashville': 'TN', 'knoxville': 'TN', 'memphis': 'TN', 'chattanooga': 'TN',
            'baltimore': 'MD', 'bethesda': 'MD', 'chevy chase': 'MD',
            'washington': 'DC', 'dc': 'DC', 'd.c.': 'DC',
            'cleveland': 'OH', 'columbus': 'OH', 'cincinnati': 'OH', 'dayton': 'OH', 'akron': 'OH',
            'kansas city': 'MO', 'st. louis': 'MO', 'saint louis': 'MO',
            'indianapolis': 'IN', 'bloomington': 'IN', 'carmel': 'IN',
            'milwaukee': 'WI', 'madison': 'WI',
            'des moines': 'IA', 'cedar rapids': 'IA',
            'omaha': 'NE', 'lincoln': 'NE',
            'hartford': 'CT', 'greenwich': 'CT', 'stamford': 'CT', 'new haven': 'CT', 'westport': 'CT', 'darien': 'CT',
            'providence': 'RI', 'newport': 'RI',
            'portland': 'OR', 'eugene': 'OR',
            'portland': 'ME',
            'las vegas': 'NV', 'reno': 'NV',
            'salt lake city': 'UT', 'park city': 'UT',
            'new orleans': 'LA', 'baton rouge': 'LA',
            'birmingham': 'AL', 'huntsville': 'AL',
            'louisville': 'KY', 'lexington': 'KY',
            'richmond': 'VA', 'mclean': 'VA', 'arlington': 'VA', 'tysons': 'VA', 'vienna': 'VA',
            'charleston': 'SC', 'greenville': 'SC',
            'greater chicago area': 'IL',
            'newark': 'NJ', 'jersey city': 'NJ', 'princeton': 'NJ', 'hoboken': 'NJ', 'morristown': 'NJ'
        };

        const STATE_NAMES = {
            'alabama': 'AL', 'alaska': 'AK', 'arizona': 'AZ', 'arkansas': 'AR', 'california': 'CA',
            'colorado': 'CO', 'connecticut': 'CT', 'delaware': 'DE', 'florida': 'FL', 'georgia': 'GA',
            'hawaii': 'HI', 'idaho': 'ID', 'illinois': 'IL', 'indiana': 'IN', 'iowa': 'IA',
            'kansas': 'KS', 'kentucky': 'KY', 'louisiana': 'LA', 'maine': 'ME', 'maryland': 'MD',
            'massachusetts': 'MA', 'michigan': 'MI', 'minnesota': 'MN', 'mississippi': 'MS', 'missouri': 'MO',
            'montana': 'MT', 'nebraska': 'NE', 'nevada': 'NV', 'new hampshire': 'NH', 'new jersey': 'NJ',
            'new mexico': 'NM', 'new york': 'NY', 'north carolina': 'NC', 'north dakota': 'ND', 'ohio': 'OH',
            'oklahoma': 'OK', 'oregon': 'OR', 'pennsylvania': 'PA', 'rhode island': 'RI', 'south carolina': 'SC',
            'south dakota': 'SD', 'tennessee': 'TN', 'texas': 'TX', 'utah': 'UT', 'vermont': 'VT',
            'virginia': 'VA', 'washington': 'WA', 'west virginia': 'WV', 'wisconsin': 'WI', 'wyoming': 'WY',
            'district of columbia': 'DC'
        };

        const VALID_STATE_CODES = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY','DC'];

        function normalizeLocation(location) {
            if (!location) return [];
            
            const states = new Set();
            
            // Handle multiple locations separated by / or ,
            const parts = location.split(/[\/,]/).map(s => s.trim()).filter(s => s);
            
            for (let part of parts) {
                const lower = part.toLowerCase().trim();
                const upper = part.toUpperCase().trim();
                
                // Check if it's already a valid 2-letter state code
                if (VALID_STATE_CODES.includes(upper)) {
                    states.add(upper);
                    continue;
                }
                
                // Check if it's a full state name
                if (STATE_NAMES[lower]) {
                    states.add(STATE_NAMES[lower]);
                    continue;
                }
                
                // Check if it's a known city
                if (CITY_TO_STATE[lower]) {
                    states.add(CITY_TO_STATE[lower]);
                    continue;
                }
                
                // Check for international locations
                const intlLower = lower;
                if (intlLower.includes('london') || intlLower.includes('uk') || intlLower.includes('united kingdom') || intlLower.includes('england')) {
                    states.add('GBR');
                    continue;
                }
                if (intlLower.includes('switzerland') || intlLower.includes('zurich') || intlLower.includes('geneva') || intlLower.includes('swiss')) {
                    states.add('CHE');
                    continue;
                }
                if (intlLower.includes('germany') || intlLower.includes('munich') || intlLower.includes('berlin') || intlLower.includes('frankfurt')) {
                    states.add('DEU');
                    continue;
                }
                if (intlLower.includes('france') || intlLower.includes('paris')) {
                    states.add('FRA');
                    continue;
                }
                if (intlLower.includes('singapore')) {
                    states.add('SGP');
                    continue;
                }
                if (intlLower.includes('hong kong')) {
                    states.add('HKG');
                    continue;
                }
                if (intlLower.includes('dubai') || intlLower.includes('uae') || intlLower.includes('abu dhabi')) {
                    states.add('ARE');
                    continue;
                }
                if (intlLower.includes('australia') || intlLower.includes('sydney') || intlLower.includes('melbourne')) {
                    states.add('AUS');
                    continue;
                }
                if (intlLower.includes('canada') || intlLower.includes('toronto') || intlLower.includes('vancouver') || intlLower.includes('montreal') || intlLower.includes('calgary')) {
                    states.add('CAN');
                    continue;
                }
                if (intlLower.includes('japan') || intlLower.includes('tokyo')) {
                    states.add('JPN');
                    continue;
                }
                if (intlLower.includes('china') || intlLower.includes('beijing') || intlLower.includes('shanghai')) {
                    states.add('CHN');
                    continue;
                }
                if ((intlLower.includes('india') && !intlLower.includes('indiana')) || intlLower.includes('mumbai') || intlLower.includes('bangalore') || intlLower.includes('delhi') || intlLower.includes('chennai')) {
                    states.add('IND');
                    continue;
                }
                if (intlLower.includes('netherlands') || intlLower.includes('amsterdam')) {
                    states.add('NLD');
                    continue;
                }
                if (intlLower.includes('luxembourg')) {
                    states.add('LUX');
                    continue;
                }
                if (intlLower.includes('monaco')) {
                    states.add('MCO');
                    continue;
                }
                if (intlLower.includes('ireland') || intlLower.includes('dublin')) {
                    states.add('IRL');
                    continue;
                }
                if (intlLower.includes('israel') || intlLower.includes('tel aviv') || intlLower.includes('jerusalem')) {
                    states.add('ISR');
                    continue;
                }
                if (intlLower.includes('brazil') || intlLower.includes('sao paulo') || intlLower.includes('rio')) {
                    states.add('BRA');
                    continue;
                }
                if (intlLower.includes('mexico') || intlLower.includes('mexico city')) {
                    states.add('MEX');
                    continue;
                }
                if (intlLower.includes('korea') || intlLower.includes('seoul')) {
                    states.add('KOR');
                    continue;
                }
                
                // Try to parse "City, ST" or "City ST" format
                const match = part.match(/,?\s*([A-Za-z]{2})$/);
                if (match) {
                    const code = match[1].toUpperCase();
                    if (VALID_STATE_CODES.includes(code)) {
                        states.add(code);
                        continue;
                    }
                }
                
                // Try city match without state suffix
                const cityPart = part.replace(/,?\s*[A-Za-z]{2}$/, '').trim().toLowerCase();
                if (CITY_TO_STATE[cityPart]) {
                    states.add(CITY_TO_STATE[cityPart]);
                    continue;
                }
            }
            
            return [...states].sort();
        }

        function getStateDisplay(states) {
            if (!states || states.length === 0) return 'Unknown';
            return states.join(', ');
        }

        // ========== CSV PARSER ==========
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const result = [];
            let currentRow = [];
            let inQuotes = false;
            let currentField = '';

            for (let line of lines) {
                if (!line.trim()) continue;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];

                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            currentField += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        currentRow.push(currentField);
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }

                if (!inQuotes) {
                    currentRow.push(currentField);
                    result.push(currentRow);
                    currentRow = [];
                    currentField = '';
                } else {
                    currentField += '\n';
                }
            }

            return result;
        }

        // ========== DATA FETCHING ==========
        async function fetchSheetData(tabName) {
            log(`Fetching ${tabName} data...`, 'info');
            
            // Get the GID for this tab
            const tabConfig = SHEET_TABS[tabName];
            if (!tabConfig) {
                throw new Error(`Unknown tab: ${tabName}`);
            }
            
            const gid = tabConfig.gid;
            
            // Try multiple URL formats
            const urls = [
                // Format 1: Direct export with GID (most reliable)
                `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`,
                // Format 2: Published sheet
                `https://docs.google.com/spreadsheets/d/e/${PUBLISHED_ID}/pub?gid=${gid}&single=true&output=csv`
            ];
            
            for (let i = 0; i < urls.length; i++) {
                try {
                    log(`  Trying URL format ${i + 1} (GID ${gid})...`, 'info');
                    
                    const response = await fetch(urls[i], {
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    if (!response.ok) {
                        log(`  Format ${i + 1} failed: HTTP ${response.status}`, 'warning');
                        continue;
                    }
                    
                    const text = await response.text();
                    
                    // Check if we got actual data
                    if (!text || text.length < 10) {
                        log(`  Format ${i + 1} returned empty data`, 'warning');
                        continue;
                    }
                    
                    const rows = parseCSV(text);
                    
                    if (rows.length === 0) {
                        log(`  Format ${i + 1} parsed 0 rows`, 'warning');
                        continue;
                    }
                    
                    log(`✓ Loaded ${rows.length - 1} rows from ${tabName}`, 'success');
                    return rows;
                    
                } catch (error) {
                    log(`  Format ${i + 1} error: ${error.message}`, 'warning');
                    continue;
                }
            }
            
            // All methods failed
            throw new Error(`Failed to fetch ${tabName} - all URL formats failed. The sheet may need additional permissions or the browser may be blocking requests.`);
        }

        // ========== PARSE CURRENCY ==========
        function parseCurrency(value) {
            if (!value) return 0;
            const str = value.toString().replace(/[$,]/g, '');
            const num = parseFloat(str);
            return isNaN(num) ? 0 : num / 1000000; // Convert to millions
        }

        // State abbreviation to full name for display
        const stateFullNames = {
            'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas',
            'CA': 'California', 'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware',
            'DC': 'Washington DC', 'FL': 'Florida', 'GA': 'Georgia', 'HI': 'Hawaii',
            'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',
            'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine',
            'MD': 'Maryland', 'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota',
            'MS': 'Mississippi', 'MO': 'Missouri', 'MT': 'Montana', 'NE': 'Nebraska',
            'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey', 'NM': 'New Mexico',
            'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',
            'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island',
            'SC': 'South Carolina', 'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas',
            'UT': 'Utah', 'VT': 'Vermont', 'VA': 'Virginia', 'WA': 'Washington',
            'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming'
        };

        // ========== DATA PROCESSING ==========
        async function loadAllData() {
            try {
                log('🚀 Starting data load...', 'info');

                // Fetch all sheets
                const [firmsData, teamData, connectorsData, prospectsData] = await Promise.all([
                    fetchSheetData('firms'),
                    fetchSheetData('team'),
                    fetchSheetData('mutualConnections'),
                    fetchSheetData('prospects')
                ]);

                log('📊 Processing firms data...', 'info');
                processFirmsData(firmsData);
                
                log('👥 Processing team data...', 'info');
                processTeamData(teamData);
                
                log('🤝 Processing connectors data...', 'info');
                processConnectorsData(connectorsData);
                
                log('🎯 Processing prospects data...', 'info');
                processProspectsData(prospectsData);
                
                log('🔗 Building relationships...', 'info');
                buildRelationships();
                
                // Load research data (non-blocking - continues even if these fail)
                log('📚 Loading research data...', 'info');
                try {
                    await Promise.all([
                        loadFirmResearchData(),
                        loadProspectResearchData()
                    ]);
                } catch (researchError) {
                    log(`⚠ Research data load failed (non-critical): ${researchError.message}`, 'warning');
                }
                
                log('✅ Data load complete!', 'success');
                log(`📈 Stats: ${toolData.firms.length} firms, ${toolData.prospects.length} prospects, ${toolData.teamMembers.length} team members, ${toolData.mutualConnections.length} connectors, ${toolData.relationships.length} relationships`, 'info');
                log(`📚 Research: ${Object.keys(toolData.firmResearch).length} firms, ${Object.keys(toolData.prospectResearch).length} prospects`, 'info');

                return true;
            } catch (error) {
                log(`❌ Fatal error: ${error.message}`, 'error');
                throw error;
            }
        }

        function processFirmsData(rows) {
            const headers = rows[0];
            const firmsByName = {};

            // Actual column structure from Google Sheet:
            // 0: Firm Name, 1: Type, 2: Location, 3: Description, 4: AUM, 
            // 5: Website, 6: LinkedIn, 7: Status, 8: Priority, 9: Notes,
            // 10: # Prospects, 11: Has Warm Intro, 12+: Prospect 1-55

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row[0]) continue;

                const rawLocation = row[2] || '';
                
                // Validate status - sometimes LinkedIn URL ends up in wrong column
                let status = row[7] || 'target_prospect';
                if (status.toLowerCase().includes('linkedin.com') || status.toLowerCase().includes('http')) {
                    status = 'target_prospect'; // Default if URL is in status field
                }
                
                const firm = {
                    id: `firm_${i}`,
                    name: row[0] || '',
                    type: row[1] || 'SFO',
                    location: rawLocation,
                    normalizedState: normalizeLocation(rawLocation),
                    description: row[3] || '',
                    aum: parseCurrency(row[4]),
                    website: row[5] || '',
                    linkedin: row[6] || '',
                    status: status,
                    priority: parseInt(row[8]) || 0,
                    notes: row[9] || '',
                    prospectCount: parseInt(row[10]) || 0,
                    hasWarmIntro: row[11] === 'Yes' || row[11] === 'TRUE' || row[11] === 'true',
                    prospectNames: [], // Store prospect names from columns 12+
                    tags: [],
                    dateAdded: new Date().toISOString().split('T')[0],
                    lastUpdated: new Date().toISOString()
                };

                // Parse prospect names from columns 12+
                for (let j = 12; j < row.length; j++) {
                    if (row[j] && row[j].trim()) {
                        firm.prospectNames.push(row[j].trim());
                    }
                }

                toolData.firms.push(firm);
                firmsByName[normalizeName(firm.name)] = firm;
                
                // Also index by alternate names (without suffixes, alternate versions)
                const alternateKeys = generateFirmNameVariants(firm.name);
                alternateKeys.forEach(key => {
                    if (!firmsByName[key]) {
                        firmsByName[key] = firm;
                    }
                });
            }

            window.firmsByName = firmsByName;
            
            // Log location normalization stats
            const allStates = toolData.firms.flatMap(f => f.normalizedState || []);
            const uniqueStates = [...new Set(allStates)];
            const firmsWithStates = toolData.firms.filter(f => f.normalizedState && f.normalizedState.length > 0).length;
            const firmsWithoutStates = toolData.firms.filter(f => !f.normalizedState || f.normalizedState.length === 0).length;
            
            log(`Processed ${toolData.firms.length} firms`, 'success');
            log(`  - Normalized to ${uniqueStates.length} unique states: ${uniqueStates.slice(0, 10).join(', ')}${uniqueStates.length > 10 ? '...' : ''}`, 'info');
            if (firmsWithoutStates > 0) {
                log(`  - ${firmsWithoutStates} firms have unrecognized locations`, 'warning');
            }
        }

        function processTeamData(rows) {
            const headers = rows[0];

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row[0]) continue;

                const member = {
                    id: `team_${i}`,
                    name: row[0] || '',
                    role: row[1] || '',
                    email: row[2] || '',
                    phone: row[3] || '',
                    linkedin: row[4] || '',
                    active: row[5] !== 'false',
                    location: row[6] || '',
                    specialties: row[7] || ''
                };

                toolData.teamMembers.push(member);
            }

            log(`Processed ${toolData.teamMembers.length} team members`, 'success');
        }

        function processConnectorsData(rows) {
            const headers = rows[0];

            // DEBUG: Log the actual headers to see column structure
            log(`Mutual Connections headers (first 15): ${headers.slice(0, 15).map((h, i) => `[${i}]="${h}"`).join(', ')}`, 'info');

            // Actual column structure from Google Sheet:
            // 0: Mutual Connection Name, 1: Title, 2: Firm, 3: Email, 4: Phone,
            // 5: LinkedIn URL, 6: Location, 7: Mutual Count,
            // 8-11: Team member names as headers (Ted Clark, Jon Terbell, Chris Gilman, TJ Agnihotri)
            //       with Yes/No values in the cells
            // 12+: Prospect names as headers with Yes/No values

            // Extract team member names from headers (columns 8-11)
            const teamMemberColumns = [];
            for (let j = 8; j < Math.min(headers.length, 12); j++) {
                if (headers[j] && headers[j].trim()) {
                    teamMemberColumns.push({
                        index: j,
                        name: headers[j].trim()
                    });
                }
            }
            log(`Found ${teamMemberColumns.length} team member columns: ${teamMemberColumns.map(t => `[${t.index}]${t.name}`).join(', ')}`, 'info');

            // Extract prospect names from headers (columns 12+)
            const prospectColumns = [];
            for (let j = 12; j < headers.length; j++) {
                if (headers[j] && headers[j].trim()) {
                    // Header might be "Prospect 1: Can Intro?" or just the prospect name
                    let prospectName = headers[j].trim();
                    // Clean up header if it has ": Can Intro?" suffix
                    prospectName = prospectName.replace(/:\s*Can Intro\??/i, '').trim();
                    prospectColumns.push({
                        index: j,
                        name: prospectName
                    });
                }
            }
            log(`Found ${prospectColumns.length} prospect columns in Mutual Connections headers`, 'info');

            // DEBUG: Show first data row values at team member columns
            if (rows.length > 1) {
                const firstRow = rows[1];
                log(`First data row team values: ${teamMemberColumns.map(col => `[${col.index}]="${firstRow[col.index]}"`).join(', ')}`, 'info');
                log(`First data row has ${firstRow.length} total columns`, 'info');
            }

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row[0]) continue;

                const connector = {
                    id: `connector_${i}`,
                    name: row[0] || '',
                    title: row[1] || '',
                    company: row[2] || '',
                    email: row[3] || '',
                    phone: row[4] || '',
                    linkedin: row[5] || '',
                    location: row[6] || '',
                    mutualCount: parseInt(row[7]) || 0,
                    teamConnections: [], // Which team members know this person (actual names)
                    prospects: [] // Which prospects this person knows (actual names)
                };

                // Parse team connections - check for ANY non-empty value in team columns
                teamMemberColumns.forEach(col => {
                    const rawVal = row[col.index];
                    const val = (rawVal || '').toString().trim();
                    const valLower = val.toLowerCase();
                    const headerLower = col.name.toLowerCase();
                    
                    // DEBUG: Log first 5 rows to see exact values
                    if (i <= 5) {
                        log(`  Row ${i}, Col ${col.index} (${col.name}): raw="${rawVal}", trimmed="${val}"`, 'info');
                    }
                    
                    // Match if: "Yes", "TRUE", "1", "X", "✓" OR if value contains team member name OR any non-empty value
                    if (val && val.length > 0) {
                        if (valLower === 'yes' || valLower === 'true' || valLower === 'x' || valLower === '✓' || valLower === '1' ||
                            valLower === headerLower || val === col.name ||
                            valLower.includes(headerLower) || headerLower.includes(valLower)) {
                            // Store the actual team member name from the header
                            connector.teamConnections.push(col.name);
                        }
                    }
                });

                // Parse prospects - the cell VALUE is the prospect's name (not Yes/No)
                // Headers are like "Prospect 1: Can Intro?" but cells contain actual names like "Jordan Lichtenberg"
                prospectColumns.forEach(col => {
                    const val = (row[col.index] || '').toString().trim();
                    if (val && val.toLowerCase() !== 'no' && val.toLowerCase() !== 'false' && val !== '0' && val !== '') {
                        // The cell value IS the prospect name
                        connector.prospects.push(val);
                    }
                });

                // DEBUG: Log first few rows to see what values are in team columns
                if (i <= 3) {
                    const teamVals = teamMemberColumns.map(col => `[${col.index}]="${row[col.index]}"`).join(', ');
                    log(`Row ${i} "${connector.name}" team columns: ${teamVals}`, 'info');
                    log(`  → teamConnections: [${connector.teamConnections.join(', ')}]`, 'info');
                }

                toolData.mutualConnections.push(connector);
            }

            // Store for debugging
            window.connectorHeaders = headers;
            window.teamMemberColumns = teamMemberColumns;
            window.prospectColumns = prospectColumns;

            // Log sample for debugging
            if (toolData.mutualConnections.length > 0) {
                const sample = toolData.mutualConnections[0];
                log(`Sample connector "${sample.name}": knows ${sample.teamConnections.length} team members, can intro to ${sample.prospects.length} prospects`, 'info');
            }

            log(`Processed ${toolData.mutualConnections.length} connectors`, 'success');
        }

        function processProspectsData(rows) {
            const headers = rows[0];
            let matchedFirms = 0;
            let dynamicFirms = 0;
            let noFirm = 0;

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row[0]) continue;

                const prospect = {
                    id: `prospect_${i}`,
                    name: row[0] || '',
                    title: row[1] || '',
                    firmName: row[2] || '',
                    firmId: null,
                    email: row[3] || '',
                    phone: row[4] || '',
                    linkedin: row[5] || '',
                    mutualConnections: [],
                    role: '',
                    notes: '',
                    primaryContact: false
                };

                // Link to firm using smart matching
                const firm = findMatchingFirm(prospect.firmName);
                if (firm) {
                    prospect.firmId = firm.id;
                    matchedFirms++;
                } else if (prospect.firmName) {
                    // Create a dynamic firm for this prospect so they're not orphaned
                    const dynamicFirmId = `firm_dynamic_${toolData.firms.length + 1}`;
                    const dynamicFirm = {
                        id: dynamicFirmId,
                        name: prospect.firmName,
                        type: 'Unknown',
                        aum: '',
                        location: '',
                        normalizedState: [],
                        teamCoverage: [],
                        prospectNames: [prospect.name],
                        notes: '',
                        isDynamic: true // Flag to identify auto-created firms
                    };
                    toolData.firms.push(dynamicFirm);
                    window.firmsByName[normalizeName(prospect.firmName)] = dynamicFirm;
                    
                    // Also add variants
                    const variants = generateFirmNameVariants(prospect.firmName);
                    variants.forEach(v => {
                        if (!window.firmsByName[v]) {
                            window.firmsByName[v] = dynamicFirm;
                        }
                    });
                    
                    prospect.firmId = dynamicFirmId;
                    dynamicFirms++;
                } else {
                    noFirm++;
                }

                // Parse mutual connections from remaining columns
                for (let j = 6; j < row.length; j++) {
                    if (row[j] && row[j].trim()) {
                        prospect.mutualConnections.push(row[j].trim());
                    }
                }

                toolData.prospects.push(prospect);
            }

            log(`Processed ${toolData.prospects.length} prospects`, 'success');
            log(`  - ${matchedFirms} matched to existing firms`, 'info');
            if (dynamicFirms > 0) {
                log(`  - ${dynamicFirms} created dynamic firms (prospects with unrecognized firm names)`, 'info');
            }
            if (noFirm > 0) {
                log(`  - ${noFirm} have no firm listed`, 'info');
            }
        }

        function buildRelationships() {
            const relationships = [];
            const prospectsByName = {};
            const connectorsByName = {};
            const teamByName = {};

            // Build lookup dictionaries
            toolData.prospects.forEach(p => {
                prospectsByName[normalizeName(p.name)] = p;
            });
            toolData.mutualConnections.forEach(c => {
                connectorsByName[normalizeName(c.name)] = c;
            });
            toolData.teamMembers.forEach(t => {
                teamByName[normalizeName(t.name)] = t;
            });

            log(`Lookup tables: ${Object.keys(prospectsByName).length} prospects, ${Object.keys(connectorsByName).length} connectors, ${Object.keys(teamByName).length} team members`, 'info');

            let matched = 0;
            let unmatchedConnectors = 0;
            let unmatchedTeam = 0;
            let unmatchedProspects = 0;

            // Build relationships from prospects (using their mutual connections list)
            toolData.prospects.forEach(prospect => {
                prospect.mutualConnections.forEach(connectorName => {
                    const normalizedConnector = normalizeName(connectorName);
                    const connector = connectorsByName[normalizedConnector];

                    if (connector) {
                        // Find which team members know this connector
                        connector.teamConnections.forEach(teamName => {
                            const normalizedTeam = normalizeName(teamName);
                            const teamMember = teamByName[normalizedTeam];

                            if (teamMember) {
                                const exists = relationships.some(r =>
                                    r.teamMemberId === teamMember.id &&
                                    r.connectorId === connector.id &&
                                    r.prospectId === prospect.id
                                );
                                if (!exists) {
                                    relationships.push({
                                        teamMemberId: teamMember.id,
                                        connectorId: connector.id,
                                        prospectId: prospect.id,
                                        firmId: prospect.firmId,
                                        strength: 'strong'
                                    });
                                    matched++;
                                }
                            } else {
                                unmatchedTeam++;
                            }
                        });
                    } else {
                        unmatchedConnectors++;
                    }
                });
            });

            // Also process from connector side (the prospect columns with Yes/No)
            toolData.mutualConnections.forEach(connector => {
                connector.prospects.forEach(prospectName => {
                    const normalizedProspect = normalizeName(prospectName);
                    const prospect = prospectsByName[normalizedProspect];

                    if (prospect) {
                        connector.teamConnections.forEach(teamName => {
                            const normalizedTeam = normalizeName(teamName);
                            const teamMember = teamByName[normalizedTeam];

                            if (teamMember) {
                                // Check if this relationship already exists
                                const exists = relationships.some(r =>
                                    r.teamMemberId === teamMember.id &&
                                    r.connectorId === connector.id &&
                                    r.prospectId === prospect.id
                                );

                                if (!exists) {
                                    relationships.push({
                                        teamMemberId: teamMember.id,
                                        connectorId: connector.id,
                                        prospectId: prospect.id,
                                        firmId: prospect.firmId,
                                        strength: 'strong'
                                    });
                                    matched++;
                                }
                            }
                        });
                    } else {
                        unmatchedProspects++;
                    }
                });
            });

            toolData.relationships = relationships;
            log(`Built ${relationships.length} relationship paths`, 'success');
            log(`  - Matched: ${matched}`, 'info');
            if (unmatchedConnectors > 0) log(`  - Unmatched connector refs: ${unmatchedConnectors}`, 'warning');
            if (unmatchedTeam > 0) log(`  - Unmatched team refs: ${unmatchedTeam}`, 'warning');
            if (unmatchedProspects > 0) log(`  - Unmatched prospect refs: ${unmatchedProspects}`, 'warning');
            
            // Build precomputed indexes for faster filtering
            buildRelationshipIndexes();
            
            // Debug: Sample some data
            if (toolData.prospects.length > 0) {
                const sampleProspect = toolData.prospects[0];
                log(`  - Sample prospect "${sampleProspect.name}" has ${sampleProspect.mutualConnections.length} mutual connections`, 'info');
            }
            if (toolData.mutualConnections.length > 0) {
                const sampleConnector = toolData.mutualConnections[0];
                log(`  - Sample connector "${sampleConnector.name}" knows: [${sampleConnector.teamConnections.join(', ')}]`, 'info');
            }
        }
        
        // Precomputed indexes for fast lookup
        const indexes = {
            prospectPathCounts: {},    // prospectId -> count
            firmPathCounts: {},        // firmId -> count
            connectorReachCounts: {},  // connectorId -> count
            prospectsWithPaths: new Set(),
            firmsWithPaths: new Set(),
            connectorsWithPaths: new Set(),
            relationshipsByConnector: {},  // connectorId -> relationships[]
            relationshipsByFirm: {},       // firmId -> relationships[]
            relationshipsByProspect: {}    // prospectId -> relationships[]
        };
        
        function buildRelationshipIndexes() {
            // Clear indexes
            indexes.prospectPathCounts = {};
            indexes.firmPathCounts = {};
            indexes.connectorReachCounts = {};
            indexes.prospectsWithPaths = new Set();
            indexes.firmsWithPaths = new Set();
            indexes.connectorsWithPaths = new Set();
            indexes.relationshipsByConnector = {};
            indexes.relationshipsByFirm = {};
            indexes.relationshipsByProspect = {};
            
            // Build counts and arrays from relationships
            toolData.relationships.forEach(r => {
                // Prospect counts and arrays
                indexes.prospectPathCounts[r.prospectId] = (indexes.prospectPathCounts[r.prospectId] || 0) + 1;
                indexes.prospectsWithPaths.add(r.prospectId);
                if (!indexes.relationshipsByProspect[r.prospectId]) indexes.relationshipsByProspect[r.prospectId] = [];
                indexes.relationshipsByProspect[r.prospectId].push(r);
                
                // Firm counts and arrays
                indexes.firmPathCounts[r.firmId] = (indexes.firmPathCounts[r.firmId] || 0) + 1;
                indexes.firmsWithPaths.add(r.firmId);
                if (!indexes.relationshipsByFirm[r.firmId]) indexes.relationshipsByFirm[r.firmId] = [];
                indexes.relationshipsByFirm[r.firmId].push(r);
                
                // Connector counts and arrays
                indexes.connectorReachCounts[r.connectorId] = (indexes.connectorReachCounts[r.connectorId] || 0) + 1;
                indexes.connectorsWithPaths.add(r.connectorId);
                if (!indexes.relationshipsByConnector[r.connectorId]) indexes.relationshipsByConnector[r.connectorId] = [];
                indexes.relationshipsByConnector[r.connectorId].push(r);
            });
            
            log(`Built indexes: ${Object.keys(indexes.prospectPathCounts).length} prospects, ${Object.keys(indexes.firmPathCounts).length} firms, ${Object.keys(indexes.connectorReachCounts).length} connectors with paths`, 'info');
        }
        
        // Fast lookup functions
        function getProspectPathCount(prospectId) {
            return indexes.prospectPathCounts[prospectId] || 0;
        }
        
        function getFirmPathCount(firmId) {
            return indexes.firmPathCounts[firmId] || 0;
        }
        
        function getConnectorReachCount(connectorId) {
            return indexes.connectorReachCounts[connectorId] || 0;
        }
        
        function hasProspectPaths(prospectId) {
            return indexes.prospectsWithPaths.has(prospectId);
        }
        
        function hasFirmPaths(firmId) {
            return indexes.firmsWithPaths.has(firmId);
        }
        
        function getRelationshipsByConnector(connectorId) {
            return indexes.relationshipsByConnector[connectorId] || [];
        }
        
        function getRelationshipsByFirm(firmId) {
            return indexes.relationshipsByFirm[firmId] || [];
        }
        
        function getRelationshipsByProspect(prospectId) {
            return indexes.relationshipsByProspect[prospectId] || [];
        }

        // ========== RESEARCH DATA LOADING ==========
        
        // Fetch firm research from main spreadsheet
        async function loadFirmResearchData() {
            try {
                log('Fetching firmResearch data...', 'info');
                const rows = await fetchSheetData('firmResearch');
                
                if (rows.length < 2) {
                    log('No firm research data found', 'warning');
                    return;
                }
                
                const headers = rows[0].map(h => h.toLowerCase().trim());
                
                // Find column indexes based on headers from user's schema:
                // Firm Name, Wealth Source, Founding Story, Org Structure, Investment Focus, 
                // Key Milestones, Succession Notes, Key Relationships, Research Notes, Primary Sources, Last Updated
                const colMap = {
                    firmName: headers.findIndex(h => h.includes('firm name') || h === 'firm'),
                    wealthSource: headers.findIndex(h => h.includes('wealth source')),
                    foundingStory: headers.findIndex(h => h.includes('founding story')),
                    orgStructure: headers.findIndex(h => h.includes('org structure')),
                    investmentFocus: headers.findIndex(h => h.includes('investment focus')),
                    keyMilestones: headers.findIndex(h => h.includes('key milestones')),
                    successionNotes: headers.findIndex(h => h.includes('succession')),
                    keyRelationships: headers.findIndex(h => h.includes('key relationships')),
                    researchNotes: headers.findIndex(h => h.includes('research notes')),
                    primarySources: headers.findIndex(h => h.includes('primary sources')),
                    lastUpdated: headers.findIndex(h => h.includes('last updated'))
                };
                
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    const firmName = row[colMap.firmName] || row[0];
                    if (!firmName || !firmName.trim()) continue;
                    
                    const normalized = normalizeName(firmName);
                    toolData.firmResearch[normalized] = {
                        firmName: firmName.trim(),
                        wealthSource: colMap.wealthSource >= 0 ? (row[colMap.wealthSource] || '').trim() : '',
                        foundingStory: colMap.foundingStory >= 0 ? (row[colMap.foundingStory] || '').trim() : '',
                        orgStructure: colMap.orgStructure >= 0 ? (row[colMap.orgStructure] || '').trim() : '',
                        investmentFocus: colMap.investmentFocus >= 0 ? (row[colMap.investmentFocus] || '').trim() : '',
                        keyMilestones: colMap.keyMilestones >= 0 ? (row[colMap.keyMilestones] || '').trim() : '',
                        successionNotes: colMap.successionNotes >= 0 ? (row[colMap.successionNotes] || '').trim() : '',
                        keyRelationships: colMap.keyRelationships >= 0 ? (row[colMap.keyRelationships] || '').trim() : '',
                        researchNotes: colMap.researchNotes >= 0 ? (row[colMap.researchNotes] || '').trim() : '',
                        primarySources: colMap.primarySources >= 0 ? (row[colMap.primarySources] || '').trim() : '',
                        lastUpdated: colMap.lastUpdated >= 0 ? (row[colMap.lastUpdated] || '').trim() : ''
                    };
                }
                
                log(`Loaded research for ${Object.keys(toolData.firmResearch).length} firms`, 'success');
            } catch (error) {
                log(`Firm research load error: ${error.message}`, 'warning');
            }
        }
        
        // Fetch prospect research from main spreadsheet
        async function loadProspectResearchData() {
            try {
                const rows = await fetchSheetData('prospectResearch');
                
                if (rows.length < 2) {
                    log('No prospect research data found', 'warning');
                    return;
                }
                
                const headers = rows[0].map(h => h.toLowerCase().trim());
                
                // Find column indexes based on user's schema:
                // Prospect Name, Firm, Career History, Education, Certifications, Board Seats,
                // Family Role, Notable Achievements, Research Notes, Primary Sources, Last Updated
                const colMap = {
                    prospectName: headers.findIndex(h => h.includes('prospect name') || h === 'name'),
                    firmName: headers.findIndex(h => h === 'firm'),
                    careerHistory: headers.findIndex(h => h.includes('career')),
                    education: headers.findIndex(h => h.includes('education')),
                    certifications: headers.findIndex(h => h.includes('certification')),
                    boardSeats: headers.findIndex(h => h.includes('board')),
                    familyRole: headers.findIndex(h => h.includes('family role')),
                    notableAchievements: headers.findIndex(h => h.includes('notable') || h.includes('achievement')),
                    researchNotes: headers.findIndex(h => h.includes('research notes')),
                    primarySources: headers.findIndex(h => h.includes('primary sources')),
                    lastUpdated: headers.findIndex(h => h.includes('last updated'))
                };
                
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    const prospectName = row[colMap.prospectName] || row[0];
                    if (!prospectName || !prospectName.trim()) continue;
                    
                    const normalized = normalizeName(prospectName);
                    toolData.prospectResearch[normalized] = {
                        prospectName: prospectName.trim(),
                        firmName: colMap.firmName >= 0 ? (row[colMap.firmName] || '').trim() : '',
                        careerHistory: colMap.careerHistory >= 0 ? (row[colMap.careerHistory] || '').trim() : '',
                        education: colMap.education >= 0 ? (row[colMap.education] || '').trim() : '',
                        certifications: colMap.certifications >= 0 ? (row[colMap.certifications] || '').trim() : '',
                        boardSeats: colMap.boardSeats >= 0 ? (row[colMap.boardSeats] || '').trim() : '',
                        familyRole: colMap.familyRole >= 0 ? (row[colMap.familyRole] || '').trim() : '',
                        notableAchievements: colMap.notableAchievements >= 0 ? (row[colMap.notableAchievements] || '').trim() : '',
                        researchNotes: colMap.researchNotes >= 0 ? (row[colMap.researchNotes] || '').trim() : '',
                        primarySources: colMap.primarySources >= 0 ? (row[colMap.primarySources] || '').trim() : '',
                        lastUpdated: colMap.lastUpdated >= 0 ? (row[colMap.lastUpdated] || '').trim() : ''
                    };
                }
                
                log(`Loaded research for ${Object.keys(toolData.prospectResearch).length} prospects`, 'success');
            } catch (error) {
                log(`Prospect research load error: ${error.message}`, 'warning');
            }
        }
        
        // Get prospect research data
        function getProspectResearch(prospectName) {
            const normalized = normalizeName(prospectName);
            return toolData.prospectResearch[normalized] || null;
        }

        function hasProspectResearch(prospectName) {
            return !!getProspectResearch(prospectName);
        }
        
        // Global research data lookup (name -> full research text)
        // This is populated after data loads
        let researchData = {};
        
        // Build the researchData lookup from toolData.prospectResearch
        function buildResearchDataLookup() {
            researchData = {};
            Object.entries(toolData.prospectResearch).forEach(([normalizedName, research]) => {
                // Combine all research fields into one text block
                const fullText = [
                    research.careerHistory,
                    research.education,
                    research.certifications,
                    research.boardSeats,
                    research.familyRole,
                    research.notableAchievements,
                    research.researchNotes
                ].filter(Boolean).join('\n\n');
                
                // Store by normalized name
                researchData[normalizedName] = fullText;
                
                // Also store by original name if we can find the prospect
                const prospect = toolData.prospects.find(p => normalizeName(p.name) === normalizedName);
                if (prospect && prospect.name !== normalizedName) {
                    researchData[prospect.name] = fullText;
                }
            });
            console.log('Built researchData lookup with', Object.keys(researchData).length, 'entries');
        }

        // ========== UI INITIALIZATION ==========
        async function initializeApp() {
            try {
                await loadAllData();
                
                // Build the research data lookup for easy access
                buildResearchDataLookup();
                
                // Hide loading overlay
                setTimeout(() => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    
                    // Initialize all views
                    initializeViews();
                    renderAllViews();
                }, 1000);
            } catch (error) {
                log(`💥 Application failed to load: ${error.message}`, 'error');
                
                // Show helpful error message
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    padding: 30px;
                    border-radius: 12px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    max-width: 600px;
                    z-index: 10000;
                `;
                errorDiv.innerHTML = `
                    <h2 style="color: #ff6b6b; margin-bottom: 15px;">❌ Unable to Load Data</h2>
                    <p style="margin-bottom: 15px;">The tool couldn't fetch data from your Google Sheet. This usually means the sheet needs to be published.</p>
                    <h3 style="color: #004D4D; margin-top: 20px; margin-bottom: 10px;">📋 How to Fix:</h3>
                    <ol style="line-height: 1.8; color: #2d3748;">
                        <li>Open your Google Sheet</li>
                        <li>Click <strong>File</strong> → <strong>Share</strong> → <strong>Publish to web</strong></li>
                        <li>Select <strong>Entire Document</strong></li>
                        <li>Click <strong>Publish</strong></li>
                        <li>Click <strong>OK</strong> on the confirmation</li>
                        <li>Refresh this page</li>
                    </ol>
                    <p style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 8px; font-size: 14px;">
                        💡 <strong>Note:</strong> "Anyone with link can view" is different from "Publish to web". You need to publish it.
                    </p>
                    <button onclick="location.reload()" style="
                        margin-top: 20px;
                        padding: 12px 24px;
                        background: #5FC4B8;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        font-size: 16px;
                        font-weight: 600;
                        cursor: pointer;
                    ">Retry After Publishing</button>
                `;
                document.body.appendChild(errorDiv);
            }
        }

        function initializeViews() {
            // Type normalization mapping - consolidate similar types
            const typeNormalization = {
                // Single Family Office variations
                'SFO': 'Single Family Office',
                'Single Family Office': 'Single Family Office',
                
                // Multi-Family Office variations
                'MFO': 'Multi-Family Office',
                'Multi Family Office': 'Multi-Family Office',
                'Multi-Family Office': 'Multi-Family Office',
                'Collaborative / Hybrid SFO (functions as MFO for multiple families)': 'Multi-Family Office',
                
                // Foundation
                'Foundation': 'Foundation',
                'Family Foundation': 'Foundation',
                'Family Foundation with investment arm (functions as SFO for Sontag family)': 'Foundation',
                
                // Endowment
                'Endowment': 'Endowment',
                
                // Investment firms
                'Alternative Investment': 'Investment Firm',
                'Direct Investments': 'Investment Firm',
                'Private Equity': 'Investment Firm',
                'Venture Capital': 'Investment Firm',
                
                // Wealth Management
                'Wealth Management': 'Wealth Management',
                
                // Holding/Corporate
                'Holding Company': 'Holding Company',
                
                // Professional Services
                'Law/Accounting': 'Professional Services',
                'Securities Law Firm': 'Professional Services',
                
                // Networks/Groups
                'Network Group': 'Network/Group',
                'Networking Group': 'Network/Group'
            };
            
            // Normalize types in the data
            toolData.firms.forEach(firm => {
                if (firm.type && typeNormalization[firm.type]) {
                    firm.originalType = firm.type;  // Keep original
                    firm.type = typeNormalization[firm.type];
                }
            });
            
            // Get unique normalized types for dropdown
            const types = [...new Set(toolData.firms.map(f => f.type).filter(t => t))].sort();
            
            ['prospects-type', 'firms-type'].forEach(id => {
                const select = document.getElementById(id);
                types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    select.appendChild(option);
                });
            });

            // Populate location filters with normalized states
            // Flatten the arrays since normalizedState is an array per firm
            const allStates = toolData.firms.flatMap(f => f.normalizedState || []);
            const uniqueStates = [...new Set(allStates)].sort();
            
            // State code to full name mapping for display
            const stateFullNames = {
                'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas', 'CA': 'California',
                'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware', 'FL': 'Florida', 'GA': 'Georgia',
                'HI': 'Hawaii', 'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',
                'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine', 'MD': 'Maryland',
                'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi', 'MO': 'Missouri',
                'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey',
                'NM': 'New Mexico', 'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',
                'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',
                'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah', 'VT': 'Vermont',
                'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming',
                'DC': 'Washington DC'
            };
            
            ['firms-location'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    uniqueStates.forEach(state => {
                        const option = document.createElement('option');
                        option.value = state;
                        option.textContent = stateFullNames[state] || state;
                        select.appendChild(option);
                    });
                }
            });

            // Populate team member filter for connections view
            const connectionsTeamSelect = document.getElementById('connections-team-filter');
            if (connectionsTeamSelect) {
                toolData.teamMembers.forEach(tm => {
                    const option = document.createElement('option');
                    option.value = tm.name;
                    option.textContent = tm.name;
                    connectionsTeamSelect.appendChild(option);
                });
            }

            // Debounce function for search inputs
            function debounce(func, wait) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }

            // Debounced versions of render functions for search inputs
            const debouncedProspectsView = debounce(renderProspectsView, 150);
            const debouncedConnectionsView = debounce(renderConnectionsView, 150);
            const debouncedFirmsView = debounce(renderFirmsView, 150);
            const debouncedTeamView = debounce(renderTeamView, 150);

            // Attach filter event listeners
            document.getElementById('prospects-search').addEventListener('input', debouncedProspectsView);
            document.getElementById('prospects-type').addEventListener('change', renderProspectsView);
            document.getElementById('prospects-connection').addEventListener('change', renderProspectsView);
            document.getElementById('prospects-research').addEventListener('change', renderProspectsView);

            document.getElementById('connections-search').addEventListener('input', debouncedConnectionsView);
            document.getElementById('connections-team-filter').addEventListener('change', renderConnectionsView);
            document.getElementById('connections-sort').addEventListener('change', renderConnectionsView);

            document.getElementById('firms-search').addEventListener('input', debouncedFirmsView);
            document.getElementById('firms-type').addEventListener('change', renderFirmsView);
            document.getElementById('firms-location').addEventListener('change', renderFirmsView);
            document.getElementById('firms-status').addEventListener('change', renderFirmsView);

            document.getElementById('team-search').addEventListener('input', debouncedTeamView);
            document.getElementById('team-sort').addEventListener('change', renderTeamView);
        }

        function renderAllViews() {
            try {
                log('🎨 Starting renderAllViews...', 'info');
                
                // Initialize new features
                log('  - initLocationFilter...', 'info');
                initLocationFilter();
                
                log('  - renderSavedPresets...', 'info');
                renderSavedPresets();
                
                log('  - initActionCenter...', 'info');
                initActionCenter();
                
                log('  - updateDashboard...', 'info');
                updateDashboard();
                
                log('  - renderProspectsView...', 'info');
                renderProspectsView();
                
                log('  - renderConnectionsView...', 'info');
                renderConnectionsView();
                
                log('  - renderFirmsView...', 'info');
                renderFirmsView();
                
                log('  - renderTeamView...', 'info');
                renderTeamView();
                
                log('  - updateFooter...', 'info');
                updateFooter();
                
                log('✅ renderAllViews complete!', 'success');
            } catch (err) {
                console.error('renderAllViews error:', err);
                log(`❌ Render error: ${err.message}`, 'error');
            }
        }

        // ========== VIEW SWITCHING ==========
        let currentView = 'prospects';

        function switchView(viewName) {
            currentView = viewName;
            
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                // Set active based on which view this tab navigates to
                if (tab.textContent.includes('Prospects') && viewName === 'prospects') tab.classList.add('active');
                if (tab.textContent.includes('Connections') && viewName === 'connections') tab.classList.add('active');
                if (tab.textContent.includes('Firms') && viewName === 'firms') tab.classList.add('active');
                if (tab.textContent.includes('Team') && viewName === 'team') tab.classList.add('active');
                if (tab.textContent.includes('Action Center') && viewName === 'actions') tab.classList.add('active');
            });

            // Show selected view
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(`${viewName}-view`).classList.add('active');
        }

        // ========== PROSPECTS VIEW ==========
        let prospectsViewMode = 'firms';

        function setProspectsViewMode(mode) {
            prospectsViewMode = mode;
            
            document.getElementById('view-people-btn').classList.toggle('active', mode === 'people');
            document.getElementById('view-firms-btn').classList.toggle('active', mode === 'firms');
            
            document.getElementById('prospects-people-table-container').style.display = mode === 'people' ? 'block' : 'none';
            document.getElementById('prospects-firms-table').style.display = mode === 'firms' ? 'block' : 'none';
            
            renderProspectsView();
        }

        // ========== OPPORTUNITY SCORING ==========
        
        // Get firm research data
        function getFirmResearch(firmName) {
            const normalized = normalizeName(firmName);
            return toolData.firmResearch[normalized] || null;
        }

        // Check if firm has succession notes
        function hasSuccessionNotes(firm) {
            const research = getFirmResearch(firm.name);
            return research && research.successionNotes && research.successionNotes.trim().length > 0;
        }

        // Check if firm has research
        function hasResearch(firm) {
            return getFirmResearch(firm.name) !== null;
        }

        // Calculate score using custom weights
        function calculateOpportunityScore(firm) {
            const contacts = toolData.prospects.filter(p => p.firmId === firm.id).length;
            const paths = toolData.relationships.filter(r => r.firmId === firm.id).length;
            const aum = firm.aum || 0;
            const hasSuccession = hasSuccessionNotes(firm);
            const hasResearchData = hasResearch(firm);
            const hasHotPath = firmHasHotPath(firm.id);
            
            // Normalize scores to 0-5 scale
            const aumScore = Math.min(aum / 500, 5);
            const pathsScore = Math.min(paths / 20, 5);
            const contactsScore = Math.min(contacts / 2, 5);
            const successionScore = hasSuccession ? 5 : 0;
            const researchScore = hasResearchData ? 3 : 0;
            const hotScore = hasHotPath ? 5 : 0; // Bonus for hot connector
            
            // Use custom weights
            const score = (aumScore * customWeights.aum) + 
                    (pathsScore * customWeights.paths) + 
                    (contactsScore * customWeights.contacts) +
                    (successionScore * customWeights.succession / 5) +
                    (researchScore * customWeights.research / 3) +
                    (hotScore * 0.8); // Hot connector bonus (significant boost)
            
            return Math.round(score * 10) / 10;
        }

        // Get score breakdown for tooltip
        function getScoreBreakdown(firm) {
            const contacts = toolData.prospects.filter(p => p.firmId === firm.id).length;
            const paths = toolData.relationships.filter(r => r.firmId === firm.id).length;
            const aum = firm.aum || 0;
            const hasSuccession = hasSuccessionNotes(firm);
            const hasResearchData = hasResearch(firm);
            
            const breakdown = [];
            breakdown.push({ factor: `AUM (×${customWeights.aum})`, value: formatAUM(aum), points: Math.round(Math.min(aum / 500, 5) * customWeights.aum * 10) / 10 });
            breakdown.push({ factor: `Paths (×${customWeights.paths})`, value: `${paths} paths`, points: Math.round(Math.min(paths / 20, 5) * customWeights.paths * 10) / 10 });
            breakdown.push({ factor: `Contacts (×${customWeights.contacts})`, value: `${contacts} people`, points: Math.round(Math.min(contacts / 2, 5) * customWeights.contacts * 10) / 10 });
            if (hasSuccession) {
                breakdown.push({ factor: `Succession (×${customWeights.succession})`, value: 'Yes', points: Math.round(5 * customWeights.succession / 5 * 10) / 10 });
            }
            if (hasResearchData) {
                breakdown.push({ factor: `Research (×${customWeights.research})`, value: 'Yes', points: Math.round(3 * customWeights.research / 3 * 10) / 10 });
            }
            
            return breakdown;
        }

        // ========== CUSTOM SCORING TOGGLE ==========
        function toggleCustomScoring() {
            const btn = document.querySelector('.custom-toggle-btn');
            const panel = document.getElementById('custom-panel');
            btn.classList.toggle('expanded');
            panel.classList.toggle('visible');
            
            // Update preview count when opening
            if (panel.classList.contains('visible')) {
                updateScoringPreview();
            }
        }

        // ========== NEW SCORING SYSTEM ==========
        let scoringSettings = {
            aumMin: 0,
            aumMax: null,
            pathsWeight: 4,
            contactsWeight: 3,
            successionWeight: 4,
            researchWeight: 3
        };
        
        let scoringApplied = false; // Track if scoring panel filters are active

        function setAumPreset(min, max) {
            document.getElementById('score-aum-min').value = min;
            document.getElementById('score-aum-max').value = max || '';
            
            // Update active chip
            document.querySelectorAll('.aum-presets .preset-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateScoring();
        }

        function getWeightLabel(value) {
            if (value === 0) return 'Off';
            if (value <= 1) return 'Low';
            if (value <= 2) return 'Medium';
            if (value <= 3) return 'Medium';
            if (value <= 4) return 'High';
            return 'Critical';
        }

        function updateScoring() {
            // Read values from UI
            const minEl = document.getElementById('score-aum-min');
            const maxEl = document.getElementById('score-aum-max');
            const pathsEl = document.getElementById('score-paths');
            const contactsEl = document.getElementById('score-contacts');
            const successionEl = document.getElementById('score-succession');
            const researchEl = document.getElementById('score-research');
            
            if (minEl) scoringSettings.aumMin = parseInt(minEl.value) || 0;
            if (maxEl) {
                const maxVal = maxEl.value;
                scoringSettings.aumMax = maxVal ? parseInt(maxVal) : null;
            }
            if (pathsEl) scoringSettings.pathsWeight = parseInt(pathsEl.value);
            if (contactsEl) scoringSettings.contactsWeight = parseInt(contactsEl.value);
            if (successionEl) scoringSettings.successionWeight = parseInt(successionEl.value);
            if (researchEl) scoringSettings.researchWeight = parseInt(researchEl.value);
            
            // Update labels
            const pathsDisplay = document.getElementById('paths-weight-display');
            const contactsDisplay = document.getElementById('contacts-weight-display');
            const successionDisplay = document.getElementById('succession-weight-display');
            const researchDisplay = document.getElementById('research-weight-display');
            
            if (pathsDisplay) pathsDisplay.textContent = getWeightLabel(scoringSettings.pathsWeight);
            if (contactsDisplay) contactsDisplay.textContent = getWeightLabel(scoringSettings.contactsWeight);
            if (successionDisplay) successionDisplay.textContent = getWeightLabel(scoringSettings.successionWeight);
            if (researchDisplay) researchDisplay.textContent = getWeightLabel(scoringSettings.researchWeight);
            
            // Update preview count
            updateScoringPreview();
        }

        function updateScoringPreview() {
            if (!toolData.firms || toolData.firms.length === 0) return;
            
            const matchCount = toolData.firms.filter(firm => {
                const aum = firm.aum || 0;
                if (aum < scoringSettings.aumMin) return false;
                if (scoringSettings.aumMax && aum > scoringSettings.aumMax) return false;
                return true;
            }).length;
            
            const countEl = document.getElementById('scoring-match-count');
            if (countEl) {
                countEl.textContent = matchCount;
            }
        }

        function resetScoring() {
            const minEl = document.getElementById('score-aum-min');
            const maxEl = document.getElementById('score-aum-max');
            const pathsEl = document.getElementById('score-paths');
            const contactsEl = document.getElementById('score-contacts');
            const successionEl = document.getElementById('score-succession');
            const researchEl = document.getElementById('score-research');
            
            if (minEl) minEl.value = 0;
            if (maxEl) maxEl.value = '';
            if (pathsEl) pathsEl.value = 4;
            if (contactsEl) contactsEl.value = 3;
            if (successionEl) successionEl.value = 4;
            if (researchEl) researchEl.value = 3;
            
            // Reset AUM preset buttons
            document.querySelectorAll('.aum-presets .preset-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            const lastChip = document.querySelector('.aum-presets .preset-chip:last-child');
            if (lastChip) lastChip.classList.add('active');
            
            // Reset scoring applied flag
            scoringApplied = false;
            
            // Reset weights
            customWeights.paths = 4;
            customWeights.contacts = 3;
            customWeights.succession = 4;
            customWeights.research = 3;
            
            updateScoring();
            renderProspectsView();
            showToast('Reset to defaults');
        }

        function applyScoring() {
            // Update the customWeights object used by calculateOpportunityScore
            customWeights.aum = 3;
            customWeights.paths = scoringSettings.pathsWeight;
            customWeights.contacts = scoringSettings.contactsWeight;
            customWeights.succession = scoringSettings.successionWeight;
            customWeights.research = scoringSettings.researchWeight;
            
            // Mark scoring as applied - this will use scoring panel's AUM filter
            scoringApplied = true;
            
            // Re-render with new scoring AND filtering
            renderProspectsView();
            updateDashboard();
            
            // Visual feedback
            const btn = document.querySelector('.scoring-btn.primary');
            if (btn) {
                const originalText = btn.textContent;
                btn.textContent = '✓ Applied!';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 1500);
            }
            
            showToast(`Showing ${document.getElementById('scoring-match-count')?.textContent || ''} firms matching criteria`);
        }

        function renderSavedPresets() {
            // Placeholder for backward compatibility
        }

        // ========== MULTI-SELECT LOCATION FUNCTIONS ==========
        function initLocationFilter() {
            const optionsContainer = document.getElementById('location-options');
            if (!optionsContainer) return;
            
            // Get all locations that exist in the data
            const dataLocations = new Set();
            toolData.firms.forEach(f => {
                if (f.normalizedState) {
                    f.normalizedState.forEach(s => dataLocations.add(s));
                }
                // Also check raw location for international
                if (f.location) {
                    const loc = f.location.toLowerCase();
                    Object.entries(ALL_LOCATIONS.international.locations).forEach(([code, name]) => {
                        if (loc.includes(name.toLowerCase()) || loc.includes(code.toLowerCase())) {
                            dataLocations.add(code);
                        }
                    });
                }
            });
            
            let html = '';
            
            // US States
            html += `<div class="multi-select-group">`;
            html += `<div class="multi-select-group-label">${ALL_LOCATIONS.us.label}</div>`;
            Object.entries(ALL_LOCATIONS.us.locations).forEach(([code, name]) => {
                const count = toolData.firms.filter(f => f.normalizedState && f.normalizedState.includes(code)).length;
                if (count > 0) {
                    html += `
                        <div class="multi-select-option" data-code="${code}" data-name="${name.toLowerCase()}">
                            <input type="checkbox" id="loc-${code}" onchange="toggleLocation('${code}')">
                            <label for="loc-${code}">${name}</label>
                            <span class="location-count">${count}</span>
                        </div>
                    `;
                }
            });
            html += `</div>`;
            
            // International
            html += `<div class="multi-select-group">`;
            html += `<div class="multi-select-group-label">${ALL_LOCATIONS.international.label}</div>`;
            Object.entries(ALL_LOCATIONS.international.locations).forEach(([code, name]) => {
                // Check if any firms match this international location
                const count = toolData.firms.filter(f => {
                    if (!f.location) return false;
                    const loc = f.location.toLowerCase();
                    return loc.includes(name.toLowerCase()) || loc.includes(code.toLowerCase());
                }).length;
                if (count > 0) {
                    html += `
                        <div class="multi-select-option" data-code="${code}" data-name="${name.toLowerCase()}">
                            <input type="checkbox" id="loc-${code}" onchange="toggleLocation('${code}')">
                            <label for="loc-${code}">${name}</label>
                            <span class="location-count">${count}</span>
                        </div>
                    `;
                }
            });
            html += `</div>`;
            
            optionsContainer.innerHTML = html;
        }
        
        function toggleLocationDropdown() {
            const wrapper = document.getElementById('location-filter-wrapper');
            wrapper.classList.toggle('open');
            
            // Close when clicking outside
            if (wrapper.classList.contains('open')) {
                setTimeout(() => {
                    document.addEventListener('click', closeLocationDropdownOnClickOutside);
                }, 0);
            }
        }
        
        function closeLocationDropdownOnClickOutside(e) {
            const wrapper = document.getElementById('location-filter-wrapper');
            if (!wrapper.contains(e.target)) {
                wrapper.classList.remove('open');
                document.removeEventListener('click', closeLocationDropdownOnClickOutside);
            }
        }
        
        function toggleLocation(code) {
            const index = selectedLocations.indexOf(code);
            if (index > -1) {
                selectedLocations.splice(index, 1);
            } else {
                selectedLocations.push(code);
            }
            updateLocationDisplay();
            renderProspectsView();
        }
        
        function selectAllLocations() {
            const checkboxes = document.querySelectorAll('#location-options input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = true;
                const code = cb.id.replace('loc-', '');
                if (!selectedLocations.includes(code)) {
                    selectedLocations.push(code);
                }
            });
            updateLocationDisplay();
            renderProspectsView();
        }
        
        function clearAllLocations() {
            selectedLocations = [];
            const checkboxes = document.querySelectorAll('#location-options input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateLocationDisplay();
            renderProspectsView();
        }
        
        function updateLocationDisplay() {
            const display = document.getElementById('location-display-text');
            if (selectedLocations.length === 0) {
                display.textContent = 'All Locations';
            } else if (selectedLocations.length === 1) {
                const code = selectedLocations[0];
                const name = ALL_LOCATIONS.us.locations[code] || ALL_LOCATIONS.international.locations[code] || code;
                display.textContent = name;
            } else {
                display.textContent = `${selectedLocations.length} locations`;
            }
        }
        
        function filterLocationOptions() {
            const search = document.getElementById('location-search').value.toLowerCase();
            const options = document.querySelectorAll('#location-options .multi-select-option');
            options.forEach(opt => {
                const name = opt.dataset.name || '';
                const code = opt.dataset.code || '';
                const matches = name.includes(search) || code.toLowerCase().includes(search);
                opt.classList.toggle('hidden', !matches);
            });
        }
        
        // ========== AUM RANGE FILTER ==========
        function getAumRange() {
            const select = document.getElementById('prospects-aum-range');
            if (!select) return null;
            const value = select.value;
            if (!value) return null;
            
            if (value.endsWith('+')) {
                return { min: parseInt(value), max: Infinity };
            }
            const [min, max] = value.split('-').map(Number);
            return { min, max };
        }
        
        function firmMatchesAumRange(firm, range) {
            const aum = firm.aum || 0;
            
            // If scoring panel is applied, use those AUM settings
            if (scoringApplied) {
                if (aum < scoringSettings.aumMin) return false;
                if (scoringSettings.aumMax && aum > scoringSettings.aumMax) return false;
                return true;
            }
            
            // Otherwise use dropdown filter
            if (!range) return true;
            return aum >= range.min && aum <= range.max;
        }
        
        // ========== LOCATION MATCHING ==========
        function firmMatchesSelectedLocations(firm) {
            if (selectedLocations.length === 0) return true;
            
            // Check US states
            if (firm.normalizedState) {
                for (const state of firm.normalizedState) {
                    if (selectedLocations.includes(state)) return true;
                }
            }
            
            // Check international
            if (firm.location) {
                const loc = firm.location.toLowerCase();
                for (const code of selectedLocations) {
                    const intlName = ALL_LOCATIONS.international.locations[code];
                    if (intlName && (loc.includes(intlName.toLowerCase()) || loc.includes(code.toLowerCase()))) {
                        return true;
                    }
                }
            }
            
            return false;
        }

        function getTopOpportunities(limit = 5) {
            return toolData.firms
                .map(firm => ({
                    firm,
                    score: calculateOpportunityScore(firm),
                    contacts: toolData.prospects.filter(p => p.firmId === firm.id).length,
                    paths: toolData.relationships.filter(r => r.firmId === firm.id).length,
                    hasSuccession: hasSuccessionNotes(firm),
                    hasResearch: hasResearch(firm)
                }))
                .filter(o => o.paths > 0) // Only firms with warm paths
                .sort((a, b) => b.score - a.score)
                .slice(0, limit);
        }

        function updateDashboard() {
            // Calculate stats
            const firmsWithPaths = toolData.firms.filter(f => 
                toolData.relationships.some(r => r.firmId === f.id)
            ).length;
            const totalContacts = toolData.prospects.length;
            const activeConnectors = toolData.mutualConnections.filter(c =>
                toolData.relationships.some(r => r.connectorId === c.id)
            ).length;
            const totalPaths = toolData.relationships.length;
            
            // Update stat values with commas
            document.getElementById('dash-reachable').textContent = formatNumber(firmsWithPaths);
            document.getElementById('dash-contacts').textContent = formatNumber(totalContacts);
            document.getElementById('dash-connectors').textContent = formatNumber(activeConnectors);
            document.getElementById('dash-paths').textContent = formatNumber(totalPaths);
            
            // Update action list count
            const savedPaths = JSON.parse(localStorage.getItem('fourbridge_saved_paths') || '[]');
            document.getElementById('action-list-count').textContent = `(${savedPaths.length})`;
            
            // Render top opportunities with badges
            const topOpps = getTopOpportunities(3);
            const oppsContainer = document.getElementById('top-opportunities');
            if (oppsContainer) {
                oppsContainer.innerHTML = topOpps.map(o => `
                    <div class="opportunity-card" onclick="showFirmDetail(toolData.firms.find(f => f.id === '${o.firm.id}'))">
                        <div class="opportunity-name">
                            ${o.firm.name}
                            <span class="opportunity-score">${o.score}</span>
                            ${o.hasSuccession ? '<span class="badge-succession">Succession</span>' : ''}
                            ${o.hasResearch ? '<span class="badge-researched">Researched</span>' : ''}
                        </div>
                        <div class="opportunity-meta">
                            ${o.contacts} contacts · ${o.paths} paths · ${formatAUM(o.firm.aum)}
                        </div>
                    </div>
                `).join('');
            }
        }

        // ========== PROSPECTS VIEW ==========
        function renderProspectsView() {
            const search = document.getElementById('prospects-search').value.toLowerCase();
            const typeFilter = document.getElementById('prospects-type').value;
            const connectionFilter = document.getElementById('prospects-connection').value;
            const researchFilter = document.getElementById('prospects-research')?.value || '';
            const aumRange = getAumRange();

            if (prospectsViewMode === 'firms') {
                renderProspectsFirmsView(search, typeFilter, connectionFilter, aumRange, researchFilter);
            } else {
                renderProspectsPeopleView(search, typeFilter, connectionFilter, aumRange, researchFilter);
            }
        }

        function renderProspectsFirmsView(search, typeFilter, connectionFilter, aumRange, researchFilter) {
            const sortBy = document.getElementById('prospects-sort')?.value || 'opportunity';
            
            let filtered = toolData.firms.filter(firm => {
                const matchesSearch = !search || 
                    firm.name.toLowerCase().includes(search) ||
                    (firm.location && firm.location.toLowerCase().includes(search));
                
                const matchesType = !typeFilter || firm.type === typeFilter;
                
                // Multi-select location filter
                const matchesLocation = firmMatchesSelectedLocations(firm);
                
                // AUM range filter
                const matchesAum = firmMatchesAumRange(firm, aumRange);
                
                const hasConnections = hasFirmPaths(firm.id);
                const matchesConnection = !connectionFilter || 
                    (connectionFilter === 'yes' && hasConnections) ||
                    (connectionFilter === 'no' && !hasConnections);
                
                // Research filter
                const firmHasResearch = hasResearch(firm);
                const matchesResearch = !researchFilter ||
                    (researchFilter === 'yes' && firmHasResearch) ||
                    (researchFilter === 'no' && !firmHasResearch);

                return matchesSearch && matchesType && matchesLocation && matchesAum && matchesConnection && matchesResearch;
            });

            // Calculate scores and sort
            filtered = filtered.map(firm => ({
                ...firm,
                opportunityScore: calculateOpportunityScore(firm),
                pathCount: getFirmPathCount(firm.id),
                contactCount: toolData.prospects.filter(p => p.firmId === firm.id).length
            }));

            // Sort based on selection
            switch(sortBy) {
                case 'opportunity':
                    filtered.sort((a, b) => b.opportunityScore - a.opportunityScore);
                    break;
                case 'aum':
                    filtered.sort((a, b) => (b.aum || 0) - (a.aum || 0));
                    break;
                case 'paths':
                    filtered.sort((a, b) => b.pathCount - a.pathCount);
                    break;
                case 'alpha':
                    filtered.sort((a, b) => a.name.localeCompare(b.name));
                    break;
            }

            const tbody = document.getElementById('prospects-table-body');
            tbody.innerHTML = '';

            filtered.forEach(firm => {
                try {
                    const row = tbody.insertRow();
                    row.className = 'clickable-row';

                    const typeClass = (firm.type || 'unknown').toLowerCase().replace(/[^a-z]/g, '-');
                    
                    // Check for badges
                    const hasSuccession = hasSuccessionNotes(firm);
                    const hasResearchData = hasResearch(firm);
                    const hasHotPath = firmHasHotPath(firm.id);
                    const savedCount = getSavedPathsCountForFirm(firm.id);
                    const isPriority = isPriorityFirm(firm.id);
                    
                    // Build badge string
                    let badges = '';
                    if (hasHotPath) badges += '<span class="firm-badge hot" title="Has hot connector path">🔥</span>';
                    if (hasSuccession) badges += '<span class="firm-badge succession" title="Succession opportunity">⏰</span>';
                    if (savedCount > 0) badges += `<span class="firm-badge saved" title="${savedCount} paths saved">⭐${savedCount}</span>`;
                    if (isPriority) badges += '<span class="firm-badge priority" title="High priority">🎯</span>';
                    if (hasResearchData) badges += '<span class="firm-badge research" title="Has research data">📊</span>';

                    row.innerHTML = `
                        <td><strong>${firm.name}</strong>${badges ? '<span class="firm-badges">' + badges + '</span>' : ''}</td>
                        <td><span class="badge badge-${typeClass}">${firm.type || '—'}</span></td>
                        <td>${firm.location || '—'}</td>
                        <td>${formatAUM(firm.aum)}</td>
                        <td>${firm.contactCount}</td>
                        <td>${getWarmPathBadge(firm.pathCount)}</td>
                        <td>${firm.opportunityScore > 0 ? firm.opportunityScore : '—'}</td>
                        ${getRowActionsHTML('firm', firm.id, firm.name)}
                    `;
                    
                    // Set onclick AFTER innerHTML to ensure it persists
                    row.style.cursor = 'pointer';
                    row.addEventListener('click', function() { 
                        showFirmDetail(firm); 
                    });
                } catch (e) {
                    console.error('Error rendering firm row:', firm.name, e);
                }
            });

            // Update stats
            const firmsWithPaths = filtered.filter(f => f.pathCount > 0).length;
            const totalContacts = filtered.reduce((sum, f) => sum + f.contactCount, 0);
            const avgContacts = filtered.length > 0 ? (totalContacts / filtered.length).toFixed(1) : 0;
            
            document.getElementById('prospects-stats').innerHTML = `
                <div class="stat">
                    <span class="stat-value">${toolData.firms.length}</span>
                    <span class="stat-label">Total Firms</span>
                </div>
                <div class="stat">
                    <span class="stat-value">${filtered.length}</span>
                    <span class="stat-label">Filtered</span>
                </div>
                <div class="stat">
                    <span class="stat-value">${firmsWithPaths}</span>
                    <span class="stat-label">With Warm Paths</span>
                </div>
                <div class="stat">
                    <span class="stat-value">${avgContacts}</span>
                    <span class="stat-label">Contacts/Firm</span>
                </div>
            `;
        }

        function renderProspectsPeopleView(search, typeFilter, connectionFilter, aumRange, researchFilter) {
            let filtered = toolData.prospects.map(p => {
                const firm = toolData.firms.find(f => f.id === p.firmId);
                return { ...p, firm };
            }).filter(p => {
                if (!p.firm) return false;

                const matchesSearch = !search || 
                    p.name.toLowerCase().includes(search) ||
                    (p.title && p.title.toLowerCase().includes(search)) ||
                    (p.firmName && p.firmName.toLowerCase().includes(search));
                
                const matchesType = !typeFilter || p.firm.type === typeFilter;
                
                // Multi-select location filter
                const matchesLocation = firmMatchesSelectedLocations(p.firm);
                
                // AUM range filter
                const matchesAum = firmMatchesAumRange(p.firm, aumRange);
                
                const hasConnections = hasProspectPaths(p.id);
                const matchesConnection = !connectionFilter || 
                    (connectionFilter === 'yes' && hasConnections) ||
                    (connectionFilter === 'no' && !hasConnections);
                
                // Research filter - check if prospect has research
                const prospectHasResearch = getProspectResearch(p.name) !== null;
                const matchesResearch = !researchFilter ||
                    (researchFilter === 'yes' && prospectHasResearch) ||
                    (researchFilter === 'no' && !prospectHasResearch);

                return matchesSearch && matchesType && matchesLocation && matchesAum && matchesConnection && matchesResearch;
            });

            const tbody = document.getElementById('prospects-people-table-body');
            tbody.innerHTML = '';

            filtered.forEach(prospect => {
                const row = tbody.insertRow();
                row.className = 'clickable-row';

                const pathCount = getProspectPathCount(prospect.id);
                const typeClass = (prospect.firm.type || 'unknown').toLowerCase().replace(/[^a-z]/g, '-');
                const statusClass = (prospect.firm.status || 'unknown').toLowerCase().replace(/[^a-z]/g, '-');
                
                // Check if prospect has research
                const hasResearchData = getProspectResearch(prospect.name) !== null;
                const researchBadge = hasResearchData ? '<span class="badge-researched-small">📊</span>' : '';

                row.innerHTML = `
                    <td><strong>${prospect.name}</strong>${researchBadge}</td>
                    <td>${prospect.title || '—'}</td>
                    <td>${prospect.firmName || '—'}</td>
                    <td><span class="badge badge-${typeClass}">${prospect.firm.type || '—'}</span></td>
                    <td>${prospect.firm.location || '—'}</td>
                    <td><span class="badge badge-${statusClass}">${(prospect.firm.status || '').replace(/_/g, ' ') || '—'}</span></td>
                    <td>${getWarmPathBadge(pathCount)}</td>
                    ${getRowActionsHTML('prospect', prospect.id, prospect.name, { firmId: prospect.firmId })}
                `;
                
                row.style.cursor = 'pointer';
                row.addEventListener('click', function() { 
                    showProspectDetail(prospect.id); 
                });
            });

            // Update stats
            const withPaths = indexes.prospectsWithPaths.size;
            const activeConnectors = indexes.connectorsWithPaths.size;
            
            document.getElementById('prospects-stats').innerHTML = `
                <div class="stat">
                    <span class="stat-value">${toolData.prospects.length}</span>
                    <span class="stat-label">Prospects</span>
                </div>
                <div class="stat">
                    <span class="stat-value">${filtered.length}</span>
                    <span class="stat-label">Filtered</span>
                </div>
                <div class="stat">
                    <span class="stat-value">${withPaths}</span>
                    <span class="stat-label">With Paths</span>
                </div>
                <div class="stat">
                    <span class="stat-value">${activeConnectors}</span>
                    <span class="stat-label">Connectors</span>
                </div>
            `;
        }

        // ========== CONNECTIONS VIEW ==========
        function renderConnectionsView() {
            const search = document.getElementById('connections-search').value.toLowerCase();
            const teamFilter = document.getElementById('connections-team-filter').value;
            const sortBy = document.getElementById('connections-sort').value;

            let filtered = toolData.mutualConnections.filter(c => {
                const matchesSearch = !search || 
                    c.name.toLowerCase().includes(search) ||
                    c.company.toLowerCase().includes(search) ||
                    c.title.toLowerCase().includes(search);
                
                // Filter by team member
                const matchesTeam = !teamFilter || (c.teamConnections && c.teamConnections.includes(teamFilter));
                
                return matchesSearch && matchesTeam;
            });

            // Sort - always put hot connectors first, then apply selected sort
            filtered.sort((a, b) => {
                // Primary: Hot connectors always first
                const aHot = isHotConnector(a.id) ? 1 : 0;
                const bHot = isHotConnector(b.id) ? 1 : 0;
                if (bHot !== aHot) return bHot - aHot;
                
                // Secondary: apply selected sort
                const aReach = getConnectorReachCount(a.id);
                const bReach = getConnectorReachCount(b.id);

                if (sortBy === 'most') return bReach - aReach;
                if (sortBy === 'fewest') return aReach - bReach;
                if (sortBy === 'alpha') return a.name.localeCompare(b.name);
                if (sortBy === 'alpha-desc') return b.name.localeCompare(a.name);
                return bReach - aReach; // default to most reach
            });

            const display = document.getElementById('connectors-display');
            display.innerHTML = '';

            // Simple List View - Collapsible
            filtered.forEach((connector, idx) => {
                const reach = getRelationshipsByConnector(connector.id);
                
                const listItem = document.createElement('div');
                listItem.className = 'connector-list-item';
                listItem.id = `connector-list-${idx}`;
                
                const prospectsHtml = reach.map(r => {
                    const prospect = toolData.prospects.find(p => p.id === r.prospectId);
                    const firm = toolData.firms.find(f => f.id === r.firmId);
                    if (!prospect || !firm) return '';
                    
                    return `
                        <div class="connector-prospect-item" onclick="event.stopPropagation(); showFirmDetail(toolData.firms.find(f => f.id === '${firm.id}'))">
                            <div>
                                <span class="connector-prospect-firm">${firm.name}</span>
                                <span class="connector-prospect-name">- ${prospect.name}</span>
                            </div>
                            <div class="connector-prospect-meta">
                                <span class="badge badge-${(firm.type || 'unknown').toLowerCase().replace(/[^a-z]/g, '-')}">${firm.type || '—'}</span>
                                <span style="color: #6c757d;">${formatAUM(firm.aum)}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Check if known by multiple team members
                const teamCount = connector.teamConnections?.length || 0;
                const overlapBadge = teamCount > 1 ? `<span class="overlap-badge">${teamCount} team</span>` : '';
                
                listItem.innerHTML = `
                    <div class="connector-list-header" onclick="toggleConnectorList(${idx})">
                        <div>
                            <div class="connector-list-name">
                                ${connector.name}
                                ${isHotConnector(connector.id) ? '<span style="margin-left: 4px;">🔥</span>' : ''}
                                <span class="badge" style="background: #5FC4B8; color: white;">${reach.length} path${reach.length !== 1 ? 's' : ''}</span>
                                ${overlapBadge}
                            </div>
                            <div class="connector-list-role">${connector.title}${connector.company ? `, ${connector.company}` : ''}</div>
                            <div style="font-size: 12px; color: #5FC4B8; margin-top: 4px;">via ${connector.teamConnections?.join(', ') || 'Unknown'}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button class="btn-hot-toggle ${isHotConnector(connector.id) ? 'is-hot' : ''}" onclick="event.stopPropagation(); toggleHotConnector('${connector.id}'); renderConnectionsView();" title="${isHotConnector(connector.id) ? 'Remove Hot' : 'Mark Hot'}">
                                ${isHotConnector(connector.id) ? '🔥' : '☆'}
                            </button>
                            <button class="btn-info" onclick="event.stopPropagation(); showConnectorDetail('${connector.id}')">Info</button>
                            <span class="connector-list-expand">▼</span>
                        </div>
                    </div>
                    <div class="connector-list-prospects">
                        ${prospectsHtml}
                    </div>
                `;
                
                display.appendChild(listItem);
            });

            // Update stats
            const avgReach = filtered.length > 0 ? 
                Math.round(filtered.reduce((sum, c) => {
                    return sum + getConnectorReachCount(c.id);
                }, 0) / filtered.length) : 0;

            document.getElementById('connections-stats').innerHTML = `
                <div class="stat">
                    <span class="stat-value">${toolData.mutualConnections.length}</span>
                    <span class="stat-label">Total Connectors</span>
                </div>
                <div class="stat">
                    <span class="stat-value">${filtered.length}</span>
                    <span class="stat-label">Filtered</span>
                </div>
                <div class="stat">
                    <span class="stat-value">${avgReach}</span>
                    <span class="stat-label">Avg Reach</span>
                </div>
            `;
        }

        // ========== FIRMS VIEW ==========
        function renderFirmsView() {
            const search = document.getElementById('firms-search').value.toLowerCase();
            const typeFilter = document.getElementById('firms-type').value;
            const locationFilter = document.getElementById('firms-location').value;
            const statusFilter = document.getElementById('firms-status').value;

            let filtered = toolData.firms.filter(firm => {
                const matchesSearch = !search || firm.name.toLowerCase().includes(search);
                const matchesType = !typeFilter || firm.type === typeFilter;
                const matchesLocation = !locationFilter || (firm.normalizedState && firm.normalizedState.includes(locationFilter));
                const matchesStatus = !statusFilter || firm.status === statusFilter;

                return matchesSearch && matchesType && matchesLocation && matchesStatus;
            });

            const tbody = document.getElementById('firms-table-body');
            tbody.innerHTML = '';

            filtered.forEach(firm => {
                const row = tbody.insertRow();
                row.className = 'clickable-row';

                const contactCount = toolData.prospects.filter(p => p.firmId === firm.id).length;
                const pathCount = toolData.relationships.filter(r => r.firmId === firm.id).length;

                const typeClass = (firm.type || 'unknown').toLowerCase().replace(/[^a-z]/g, '-');
                const statusClass = (firm.status || 'unknown').toLowerCase().replace(/[^a-z]/g, '-');

                row.innerHTML = `
                    <td><strong>${firm.name}</strong></td>
                    <td><span class="badge badge-${typeClass}">${firm.type || '—'}</span></td>
                    <td>${firm.location || '—'}</td>
                    <td>${formatAUM(firm.aum)}</td>
                    <td><span class="badge badge-${statusClass}">${(firm.status || '').replace(/_/g, ' ') || '—'}</span></td>
                    <td>${contactCount}</td>
                    <td>${getWarmPathBadge(pathCount)}</td>
                    ${getRowActionsHTML('firm', firm.id, firm.name)}
                `;
                
                // Set onclick AFTER innerHTML
                row.style.cursor = 'pointer';
                row.addEventListener('click', function() { 
                    showFirmDetail(firm); 
                });
            });

            // Update stats
            const statuses = {
                target_prospect: toolData.firms.filter(f => f.status === 'target_prospect').length,
                cold_lead: toolData.firms.filter(f => f.status === 'cold_lead').length,
                past_contact: toolData.firms.filter(f => f.status === 'past_contact').length
            };

            document.getElementById('firms-stats').innerHTML = `
                <div class="stat">
                    <span class="stat-value">${toolData.firms.length}</span>
                    <span class="stat-label">Total Firms</span>
                </div>
                <div class="stat">
                    <span class="stat-value">${filtered.length}</span>
                    <span class="stat-label">Filtered</span>
                </div>
                <div class="stat">
                    <span class="stat-value">${statuses.target_prospect}</span>
                    <span class="stat-label">Target Prospects</span>
                </div>
                <div class="stat">
                    <span class="stat-value">${statuses.past_contact}</span>
                    <span class="stat-label">Past Contacts</span>
                </div>
            `;
        }

        // ========== TEAM VIEW ==========
        function renderTeamView() {
            const search = document.getElementById('team-search').value.toLowerCase();
            const sortBy = document.getElementById('team-sort').value;

            let filtered = toolData.teamMembers.filter(member => {
                return !search || 
                    member.name.toLowerCase().includes(search) ||
                    member.role.toLowerCase().includes(search);
            });

            // Calculate metrics for each team member
            filtered = filtered.map(member => {
                const rels = toolData.relationships.filter(r => r.teamMemberId === member.id);
                const connectors = new Set(rels.map(r => r.connectorId)).size;
                const firms = new Set(rels.map(r => r.firmId).filter(id => id)).size;
                const prospects = new Set(rels.map(r => r.prospectId)).size;

                return { ...member, connectors, firms, prospects };
            });

            // Sort
            filtered.sort((a, b) => {
                if (sortBy === 'reach') return b.prospects - a.prospects;
                if (sortBy === 'connectors') return b.connectors - a.connectors;
                if (sortBy === 'alpha') return a.name.localeCompare(b.name);
                return 0;
            });

            const tbody = document.getElementById('team-table-body');
            tbody.innerHTML = '';

            filtered.forEach(member => {
                const row = tbody.insertRow();
                row.className = 'clickable-row';

                row.innerHTML = `
                    <td><strong>${member.name}</strong></td>
                    <td>${member.role}</td>
                    <td>${member.location}</td>
                    <td>${member.connectors}</td>
                    <td>${member.firms}</td>
                    <td>${member.prospects}</td>
                `;
                
                row.style.cursor = 'pointer';
                row.addEventListener('click', function() { 
                    showTeamDetail(member); 
                });
            });

            // Update stats
            const totalReach = filtered.reduce((sum, m) => sum + m.prospects, 0);
            const avgReach = filtered.length > 0 ? Math.round(totalReach / filtered.length) : 0;

            document.getElementById('team-stats').innerHTML = `
                <div class="stat">
                    <span class="stat-value">${toolData.teamMembers.length}</span>
                    <span class="stat-label">Team Members</span>
                </div>
                <div class="stat">
                    <span class="stat-value">${avgReach}</span>
                    <span class="stat-label">Avg Reach</span>
                </div>
                <div class="stat">
                    <span class="stat-value">${totalReach}</span>
                    <span class="stat-label">Total Reach</span>
                </div>
            `;
        }

        // ========== DETAIL MODALS ==========
        function showFirmDetail(firm) {
            console.log('showFirmDetail called', firm);
            if (!firm) {
                console.error('showFirmDetail called with undefined firm');
                alert('Error: Firm data not found');
                return;
            }
            
            // Track this view (safely)
            try {
                if (typeof trackView === 'function') {
                    trackView('firm', firm.id, firm.name, { type: firm.type });
                }
            } catch (e) {
                console.log('trackView error:', e);
            }
            
            // Reset team filter for new modal
            window.currentTeamFilter = 'all';
            
            // Clear navigation history when opening from main list
            navigationHistory = [];
            
            const contacts = toolData.prospects.filter(p => p.firmId === firm.id);
            const paths = toolData.relationships.filter(r => r.firmId === firm.id);

            // Build connector rankings - which connectors can reach the most contacts at this firm
            const connectorReach = {};
            paths.forEach(p => {
                const connector = toolData.mutualConnections.find(c => c.id === p.connectorId);
                const prospect = toolData.prospects.find(pr => pr.id === p.prospectId);
                const team = toolData.teamMembers.find(t => t.id === p.teamMemberId);
                if (!connector || !prospect) return;
                
                if (!connectorReach[connector.id]) {
                    connectorReach[connector.id] = {
                        connector: connector,
                        team: team,
                        contacts: new Set(),
                        contactNames: [],
                        contactIds: [],
                        contactObjects: []
                    };
                }
                connectorReach[connector.id].contacts.add(prospect.id);
                if (!connectorReach[connector.id].contactNames.includes(prospect.name)) {
                    connectorReach[connector.id].contactNames.push(prospect.name);
                    connectorReach[connector.id].contactIds.push(prospect.id);
                    connectorReach[connector.id].contactObjects.push(prospect);
                }
            });

            // All connectors sorted by: 1) Hot status, 2) reach, 3) mutualCount
            const allConnectorsSorted = Object.values(connectorReach)
                .sort((a, b) => {
                    // Primary: Hot connectors first
                    const aHot = isHotConnector(a.connector.id) ? 1 : 0;
                    const bHot = isHotConnector(b.connector.id) ? 1 : 0;
                    if (bHot !== aHot) return bHot - aHot;
                    
                    // Secondary: contacts at this firm
                    const reachDiff = b.contacts.size - a.contacts.size;
                    if (reachDiff !== 0) return reachDiff;
                    
                    // Tertiary: total mutual count from database
                    return (b.connector.mutualCount || 0) - (a.connector.mutualCount || 0);
                });
            
            // Multi-path connectors (reach 2+ contacts)
            const multiPathConnectors = allConnectorsSorted.filter(c => c.contacts.size >= 2);
            
            // Top 5 by reach
            const top5Connectors = allConnectorsSorted.slice(0, 5);

            // Build paths by contact for the collapsible sections
            const pathsByContact = {};
            contacts.forEach(c => {
                pathsByContact[c.id] = paths.filter(p => p.prospectId === c.id).map(p => {
                    const team = toolData.teamMembers.find(t => t.id === p.teamMemberId);
                    const connector = toolData.mutualConnections.find(conn => conn.id === p.connectorId);
                    return { team, connector, prospectId: c.id, prospectName: c.name, firmName: firm.name, firmId: firm.id };
                });
            });

            // Store data globally for dynamic filtering
            window.currentFirmData = {
                firm,
                contacts,
                paths,
                connectorReach,
                allConnectorsSorted,
                multiPathConnectors,
                top5Connectors,
                pathsByContact
            };

            // Build Sankey section with filters
            let sankeyHTML = '';
            if (paths.length > 0) {
                // Get top connectors for quick links
                const topConnectorsForLinks = allConnectorsSorted.slice(0, 6);
                const quickLinksHtml = topConnectorsForLinks.map(c => `
                    <span class="sankey-quick-link" onclick="showConnectorDetail('${c.connector.id}')">${c.connector.name}</span>
                `).join('');
                
                sankeyHTML = `
                    <div class="detail-section">
                        <h3>Relationship Flow</h3>
                        <p style="color: #6c757d; font-size: 13px; margin-bottom: 15px;">Visual map showing your best paths into ${firm.name}</p>
                        <div class="sankey-controls">
                            <button class="sankey-filter-btn active" onclick="filterSankey('top5')" data-mode="top5">Top 5 by Reach</button>
                            <button class="sankey-filter-btn" onclick="filterSankey('multipath')" data-mode="multipath">Multi-Path Only (${multiPathConnectors.length})</button>
                            ${allConnectorsSorted.length <= 10 ? `<button class="sankey-filter-btn" onclick="filterSankey('all')" data-mode="all">All (${allConnectorsSorted.length})</button>` : ''}
                        </div>
                        <div class="sankey-column-headers">
                            <span class="sankey-flow-label">👥 Your Team</span>
                            <span class="sankey-flow-arrow">→</span>
                            <span class="sankey-flow-label">🤝 Connectors</span>
                            <span class="sankey-flow-arrow">→</span>
                            <span class="sankey-flow-label">🎯 Prospects at ${firm.name}</span>
                        </div>
                        <div class="sankey-container">
                            <div id="sankey-chart"></div>
                        </div>
                        <div class="sankey-quick-links">
                            <span style="font-size: 11px; color: #6c757d; margin-right: 8px;">Quick links:</span>
                            ${quickLinksHtml}
                        </div>
                    </div>
                `;
            }

            // Get unique team members who have paths to this firm
            const teamMembersWithPaths = [...new Set(paths.map(p => {
                const team = toolData.teamMembers.find(t => t.id === p.teamMemberId);
                return team?.name;
            }).filter(n => n))];

            // Build Contacts section with view toggle AND team filter
            let contactsHTML = '';
            if (contacts.length > 0) {
                const teamFilterButtons = teamMembersWithPaths.length > 1 ? `
                    <div class="team-filter-container">
                        <span class="team-filter-label">Filter by Team:</span>
                        <button class="team-filter-btn active" onclick="filterContactsByTeam('all')">All</button>
                        ${teamMembersWithPaths.map(name => `
                            <button class="team-filter-btn" onclick="filterContactsByTeam('${name}')">${name.split(' ')[0]}</button>
                        `).join('')}
                    </div>
                ` : '';

                contactsHTML = `
                    <div class="detail-section">
                        <h3>Contacts & Pathways</h3>
                        ${teamFilterButtons}
                        <div class="contacts-view-toggle">
                            <button class="view-toggle-btn active" onclick="switchContactsView('byContact')">By Contact</button>
                            <button class="view-toggle-btn" onclick="switchContactsView('byConnector')">By Connector</button>
                        </div>
                        <div id="contacts-display">
                            ${renderContactsByContact(contacts, pathsByContact, firm)}
                        </div>
                    </div>
                `;
            }

            // No paths message if needed
            let noPathsMessage = '';
            if (paths.length === 0 && contacts.length > 0) {
                noPathsMessage = `
                    <div class="detail-section">
                        <div class="no-paths">No warm introduction paths found to any contacts. Consider cold outreach or seeking 2nd degree connections.</div>
                    </div>
                `;
            }

            // Build Priority Contacts card - shows top contacts by warm paths
            let priorityContactsHTML = '';
            if (paths.length > 0) {
                // Sort contacts by number of warm paths
                const contactsWithPaths = contacts.map(c => {
                    const pathCount = (pathsByContact[c.id] || []).length;
                    return { ...c, pathCount };
                }).filter(c => c.pathCount > 0)
                  .sort((a, b) => b.pathCount - a.pathCount)
                  .slice(0, 3);
                
                if (contactsWithPaths.length > 0) {
                    priorityContactsHTML = `
                        <div class="priority-contacts-card">
                            <div class="priority-contacts-header">Priority Contacts</div>
                            ${contactsWithPaths.map(c => `
                                <div class="priority-contact-item">
                                    <div>
                                        <div class="priority-contact-name">
                                            <span class="clickable-prospect-name" onclick="showProspectDetail('${c.id}')">${c.name}</span>
                                        </div>
                                        <div class="priority-contact-title">${c.title}</div>
                                    </div>
                                    <div class="priority-contact-paths">${c.pathCount} warm path${c.pathCount > 1 ? 's' : ''}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }

            document.getElementById('modal-name').textContent = firm.name;
            document.getElementById('modal-subtitle').innerHTML = `
                ${firm.type} • ${firm.location || 'Unknown'}
                <button class="back-nav-btn" onclick="navigateBack()" style="margin-left: 15px;">← Back</button>
            `;
            
            // Build research panel (always show button, with or without data)
            const research = getFirmResearch(firm.name);
            let researchHTML = '';
            
            if (research) {
                // Build tabbed research panel
                const hasSuccession = research.successionNotes && research.successionNotes.trim();
                const successionHighlight = hasSuccession ? `
                    <div class="succession-alert">
                        <div class="succession-alert-icon">🎯</div>
                        <div class="succession-alert-content">
                            <div class="succession-alert-title">Succession Opportunity</div>
                            <div class="succession-alert-text">${research.successionNotes}</div>
                        </div>
                    </div>
                ` : '';
                
                researchHTML = `
                    <button class="research-toggle-btn" onclick="toggleResearchPanel(this)">
                        <span class="toggle-left">
                            <span>Research Intelligence</span>
                            <span class="research-badge">RESEARCHED</span>
                        </span>
                        <span class="toggle-arrow">▼</span>
                    </button>
                    <div class="research-panel" id="firm-research-panel">
                        ${successionHighlight}
                        
                        <div class="research-tabs">
                            <button class="research-tab active" onclick="switchResearchTab(this, 'overview')">Overview</button>
                            <button class="research-tab" onclick="switchResearchTab(this, 'investment')">Investment</button>
                            <button class="research-tab" onclick="switchResearchTab(this, 'relationships')">Relationships</button>
                            <button class="research-tab" onclick="switchResearchTab(this, 'notes')">Notes</button>
                        </div>
                        
                        <div class="research-tab-content active" data-tab="overview">
                            ${research.wealthSource ? `
                                <div class="research-field">
                                    <div class="research-field-label">Wealth Source</div>
                                    <div class="research-field-value">${research.wealthSource}</div>
                                </div>
                            ` : ''}
                            ${research.foundingStory ? `
                                <div class="research-field">
                                    <div class="research-field-label">Founding Story</div>
                                    <div class="research-field-value">${research.foundingStory}</div>
                                </div>
                            ` : ''}
                            ${research.orgStructure ? `
                                <div class="research-field">
                                    <div class="research-field-label">Organization Structure</div>
                                    <div class="research-field-value">${research.orgStructure}</div>
                                </div>
                            ` : ''}
                            ${!research.wealthSource && !research.foundingStory && !research.orgStructure ? '<p style="color: #6c757d; font-style: italic; text-align: center; padding: 20px 0;">No overview data available.</p>' : ''}
                        </div>
                        
                        <div class="research-tab-content" data-tab="investment">
                            ${research.investmentFocus ? `
                                <div class="research-field">
                                    <div class="research-field-label">Investment Focus & Philosophy</div>
                                    <div class="research-field-value">${research.investmentFocus}</div>
                                </div>
                            ` : ''}
                            ${research.keyMilestones ? `
                                <div class="research-field">
                                    <div class="research-field-label">Key Milestones</div>
                                    <div class="research-field-value">${research.keyMilestones}</div>
                                </div>
                            ` : ''}
                            ${!research.investmentFocus && !research.keyMilestones ? '<p style="color: #6c757d; font-style: italic; text-align: center; padding: 20px 0;">No investment data available.</p>' : ''}
                        </div>
                        
                        <div class="research-tab-content" data-tab="relationships">
                            ${research.keyRelationships ? `
                                <div class="research-field">
                                    <div class="research-field-label">Key Relationships</div>
                                    <div class="research-field-value">${research.keyRelationships}</div>
                                </div>
                            ` : '<p style="color: #6c757d; font-style: italic; text-align: center; padding: 20px 0;">No relationship data available.</p>'}
                        </div>
                        
                        <div class="research-tab-content" data-tab="notes">
                            ${research.researchNotes ? `
                                <div class="research-field">
                                    <div class="research-field-label">Research Notes</div>
                                    <div class="research-field-value">${research.researchNotes}</div>
                                </div>
                            ` : ''}
                            ${research.primarySources ? `
                                <div class="research-field">
                                    <div class="research-field-label">Sources</div>
                                    <div class="research-field-value">${research.primarySources}</div>
                                </div>
                            ` : ''}
                            ${!research.researchNotes && !research.primarySources ? '<p style="color: #6c757d; font-style: italic; text-align: center; padding: 20px 0;">No notes available.</p>' : ''}
                        </div>
                        
                        ${research.lastUpdated ? `
                            <div class="research-meta">
                                <span class="research-meta-item">Last updated: ${research.lastUpdated}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                // No research - show button with "no research" state
                researchHTML = `
                    <button class="research-toggle-btn no-research" onclick="toggleResearchPanel(this)">
                        <span class="toggle-left">
                            <span>Research Intelligence</span>
                            <span class="research-badge pending">NO DATA YET</span>
                        </span>
                        <span class="toggle-arrow">▼</span>
                    </button>
                    <div class="research-panel" id="firm-research-panel">
                        <div class="no-research-msg">
                            <p>No research data available for this firm yet.</p>
                            <p style="margin-top: 8px; font-size: 12px; opacity: 0.7;">Add research to your Firm Research spreadsheet tab.</p>
                        </div>
                    </div>
                `;
            }
            
            // Check if firm has hot connector paths
            const hasHotPath = firmHasHotPath(firm.id);
            
            // Count saved pathways for this firm
            const savedPathsCount = savedPaths.filter(p => p.firmId === firm.id).length;
            const savedIndicator = savedPathsCount > 0 ? `
                <div class="firm-saved-indicator">
                    <span>★ ${savedPathsCount} intro${savedPathsCount > 1 ? 's' : ''} saved</span>
                </div>
            ` : '';
            
            const hotPathIndicator = hasHotPath ? `
                <div class="hot-path-indicator">
                    <span>🔥 Hot connector path available</span>
                </div>
            ` : '';
            
            const firmStatusBar = (savedIndicator || hotPathIndicator) ? `
                <div class="firm-status-bar">
                    ${savedIndicator}
                    ${hotPathIndicator}
                </div>
            ` : '';
            
            // Check for related firms in same group
            const firmGroup = getFirmGroup(firm.id);
            let relatedFirmsHTML = '';
            if (firmGroup) {
                const relatedFirms = firmGroup.firmIds
                    .filter(id => id !== firm.id)
                    .map(id => toolData.firms.find(f => f.id === id))
                    .filter(Boolean);
                
                if (relatedFirms.length > 0) {
                    // Calculate aggregate stats for the group
                    const allGroupFirms = [firm, ...relatedFirms];
                    const totalProspects = allGroupFirms.reduce((sum, f) => 
                        sum + toolData.prospects.filter(p => p.firmId === f.id).length, 0);
                    const totalPaths = allGroupFirms.reduce((sum, f) => 
                        sum + toolData.relationships.filter(r => r.firmId === f.id).length, 0);
                    
                    relatedFirmsHTML = `
                        <div class="related-firms-card">
                            <div class="related-firms-header">
                                <span class="related-firms-title">${firmGroup.name}</span>
                                <span class="related-firms-badge">${allGroupFirms.length} entities</span>
                            </div>
                            <div class="related-firms-stats">
                                <span>${totalProspects} prospects</span>
                                <span>•</span>
                                <span>${totalPaths} warm paths across group</span>
                            </div>
                            <div class="related-firms-list">
                                ${relatedFirms.map(rf => {
                                    const rfProspects = toolData.prospects.filter(p => p.firmId === rf.id).length;
                                    return `
                                        <div class="related-firm-item" onclick="showFirmDetail(toolData.firms.find(f=>f.id==='${rf.id}'))">
                                            <div class="related-firm-info">
                                                <div class="related-firm-name">${rf.name}</div>
                                                <div class="related-firm-meta">${rf.type || 'Unknown'}${rf.location ? ' • ' + rf.location : ''}</div>
                                            </div>
                                            <div class="related-firm-count">${rfProspects}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            }
            
            document.getElementById('modal-body').innerHTML = `
                ${firmStatusBar}
                ${relatedFirmsHTML}
                ${priorityContactsHTML}
                ${researchHTML}
                <div class="detail-section">
                    <h3>Overview</h3>
                    <p><strong>AUM:</strong> ${formatAUM(firm.aum)}</p>
                    <p><strong>Status:</strong> <span class="badge badge-${(firm.status || '').replace(/_/g, '-')}">${(firm.status || '').replace(/_/g, ' ')}</span></p>
                    ${firm.website ? `<p><strong>Website:</strong> <a href="${firm.website}" target="_blank">${firm.website}</a></p>` : ''}
                    ${firm.linkedin ? `<p><strong>LinkedIn:</strong> <a href="${firm.linkedin}" target="_blank">View Company Page</a></p>` : ''}
                </div>
                ${firm.description ? `
                    <div class="detail-section">
                        <h3>Description</h3>
                        <p>${firm.description}</p>
                    </div>
                ` : ''}
                ${sankeyHTML}
                ${contactsHTML}
                ${noPathsMessage}
                ${firm.notes ? `
                    <div class="detail-section">
                        <h3>Notes</h3>
                        <p>${firm.notes}</p>
                    </div>
                ` : ''}
            `;

            document.getElementById('detail-modal').style.display = 'block';
            
            // Draw Sankey chart with top 5 by default
            if (paths.length > 0) {
                setTimeout(() => filterSankey('top5'), 100);
            }
        }

        // Render contacts grouped by contact (default view)
        function renderContactsByContact(contacts, pathsByContact, firm, teamFilter = 'all') {
            // Sort contacts: those with hot paths first, then multiple team members (overlap), then by path count
            const sortedContacts = [...contacts].sort((a, b) => {
                const aPathsRaw = pathsByContact[a.id] || [];
                const bPathsRaw = pathsByContact[b.id] || [];
                
                // Check for hot connector paths
                const aHasHot = aPathsRaw.some(p => isHotConnector(p.connector?.id));
                const bHasHot = bPathsRaw.some(p => isHotConnector(p.connector?.id));
                
                // Hot paths first
                if (aHasHot && !bHasHot) return -1;
                if (bHasHot && !aHasHot) return 1;
                
                // Count unique team members per contact
                const aTeams = new Set(aPathsRaw.map(p => p.team?.name).filter(n => n));
                const bTeams = new Set(bPathsRaw.map(p => p.team?.name).filter(n => n));
                
                // Overlaps (2+ team members) first
                if (aTeams.size > 1 && bTeams.size <= 1) return -1;
                if (bTeams.size > 1 && aTeams.size <= 1) return 1;
                
                // Then by path count
                return bPathsRaw.length - aPathsRaw.length;
            });

            return sortedContacts.map((c, idx) => {
                let contactPaths = pathsByContact[c.id] || [];
                
                // Filter by team if specified
                if (teamFilter && teamFilter !== 'all') {
                    contactPaths = contactPaths.filter(p => p.team?.name === teamFilter);
                }
                
                // Sort connectors: hot first, then by mutualCount (highest first)
                contactPaths = [...contactPaths].sort((a, b) => {
                    // Hot connectors first
                    const aHot = isHotConnector(a.connector?.id) ? 1 : 0;
                    const bHot = isHotConnector(b.connector?.id) ? 1 : 0;
                    if (bHot !== aHot) return bHot - aHot;
                    // Then by mutual count
                    return (b.connector?.mutualCount || 0) - (a.connector?.mutualCount || 0);
                });
                
                const pathCount = contactPaths.length;
                const hasPathsClass = pathCount > 0 ? 'has-paths' : '';
                
                // Check if contact has hot connector path (before team filter)
                const allPaths = pathsByContact[c.id] || [];
                const hotPaths = allPaths.filter(p => isHotConnector(p.connector?.id));
                const hasHotPath = hotPaths.length > 0;
                const hotBadge = hasHotPath ? `<span class="hot-contact-badge" style="display:inline-flex !important;visibility:visible !important;">🔥 HOT</span>` : '';
                
                // Debug: log hot path detection
                if (hasHotPath) {
                    console.log(`🔥 ${c.name} has ${hotPaths.length} hot paths:`, hotPaths.map(p => p.connector?.name));
                }
                
                // Check for overlapping team members (before filter)
                const uniqueTeams = new Set(allPaths.map(p => p.team?.name).filter(n => n));
                const hasOverlap = uniqueTeams.size > 1;
                const overlapBadge = hasOverlap ? `<span class="overlap-badge">${uniqueTeams.size} team</span>` : '';
                
                // Check if prospect has research
                const prospectHasResearch = hasProspectResearch(c.name);
                const researchClass = prospectHasResearch ? 'has-research' : '';
                
                return `
                    <div class="contact-card-collapsible ${hasHotPath ? 'has-hot-path' : ''}" id="contact-card-${idx}">
                        <div class="contact-card-header-row" onclick="toggleContactPaths(${idx})">
                            <div class="contact-card-left">
                                <div class="contact-name">
                                    ${hotBadge}
                                    <span class="clickable-prospect-name ${researchClass}" onclick="event.stopPropagation(); showProspectDetail('${c.id}')">${c.name}</span>
                                    ${overlapBadge}
                                </div>
                                <div class="contact-title">${c.title}</div>
                                ${c.linkedin ? `<div style="margin-top: 6px;"><a href="${c.linkedin}" target="_blank" onclick="event.stopPropagation();" style="color: #5FC4B8; font-size: 13px;">LinkedIn</a></div>` : ''}
                            </div>
                            <div class="contact-card-right">
                                <span class="contact-path-count ${hasPathsClass} ${hasHotPath ? 'hot-paths' : ''}">
                                    ${pathCount > 0 ? `${pathCount} intro path${pathCount > 1 ? 's' : ''}` : 'No paths'}
                                </span>
                                ${pathCount > 0 ? '<span class="contact-expand-icon">▼</span>' : ''}
                            </div>
                        </div>
                        ${pathCount > 0 ? `
                            <div class="contact-paths-container">
                                <div style="font-size: 13px; color: #6c757d; margin-bottom: 10px;">People who can introduce you to ${c.name}:</div>
                                <div class="contact-paths-grid">
                                    ${contactPaths.map((p, pathIdx) => {
                                        const pathId = `${firm.id}-${c.id}-${p.connector?.id || pathIdx}`;
                                        const isSaved = isPathSaved(pathId);
                                        const connectorIsHot = isHotConnector(p.connector?.id);
                                        return `
                                        <div class="mini-path-item ${connectorIsHot ? 'hot-path' : ''}" style="display: flex; justify-content: space-between; align-items: flex-start;">
                                            <div style="flex: 1; cursor: pointer;" onclick="event.stopPropagation(); showConnectorDetail('${p.connector?.id}')">
                                                <div class="connector-name">${p.connector?.name || 'Unknown'} ${connectorIsHot ? '<span class="hot-badge">🔥 HOT</span>' : ''}</div>
                                                <div class="connector-detail">${p.connector?.title || ''}${p.connector?.company ? `, ${p.connector.company}` : ''}</div>
                                                <div class="connector-detail" style="color: #004D4D;">via ${p.team?.name || 'Unknown'} • ${p.connector?.mutualCount || 0} connections</div>
                                            </div>
                                            <button class="save-path-btn ${isSaved ? 'saved' : ''}" 
                                                onclick="event.stopPropagation(); toggleSavePath('${pathId}', '${firm.name.replace(/'/g, "\\'")}', '${p.team?.name || 'Unknown'}', '${(p.connector?.name || 'Unknown').replace(/'/g, "\\'")}', '${c.name.replace(/'/g, "\\'")}')"
                                                title="${isSaved ? 'Remove from saved' : 'Save this path'}">
                                                ${isSaved ? '★' : '☆'}
                                            </button>
                                        </div>
                                    `}).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Render contacts grouped by connector (alternate view)
        function renderContactsByConnector(teamFilter = 'all') {
            const data = window.currentFirmData;
            if (!data) return '';
            
            let { allConnectorsSorted, firm } = data;
            
            // Filter by team if specified
            if (teamFilter && teamFilter !== 'all') {
                allConnectorsSorted = allConnectorsSorted.filter(rc => rc.team?.name === teamFilter);
            }
            
            return allConnectorsSorted.map((rc, idx) => {
                const isMultiPath = rc.contacts.size >= 2;
                const isHot = isHotConnector(rc.connector.id);
                return `
                    <div class="connector-group-card ${isHot ? 'hot-connector-card' : ''}" id="connector-group-${idx}">
                        <div class="connector-group-header" onclick="toggleConnectorGroup(${idx})">
                            <div class="connector-group-info">
                                <div class="connector-group-name">
                                    <span class="clickable-name" onclick="event.stopPropagation(); showConnectorDetail('${rc.connector.id}')">${rc.connector.name}</span>
                                    ${isHot ? '<span class="hot-badge">🔥 HOT</span>' : ''}
                                    ${isMultiPath ? '<span class="multi-path-badge">Multi-Path</span>' : ''}
                                </div>
                                <div class="connector-group-title">${rc.connector.title}${rc.connector.company ? `, ${rc.connector.company}` : ''}</div>
                                <div class="connector-group-meta">via ${rc.team?.name || 'Unknown'} • ${rc.connector.mutualCount || 0} LinkedIn connections</div>
                            </div>
                            <div class="connector-group-stats">
                                <div class="connector-group-count">${rc.contacts.size}</div>
                                <div class="connector-group-label">contact${rc.contacts.size > 1 ? 's' : ''}</div>
                            </div>
                        </div>
                        <div class="connector-group-contacts">
                            <div style="font-size: 13px; color: #6c757d; margin-bottom: 12px;">${rc.connector.name} can introduce you to:</div>
                            ${rc.contactObjects.map(contact => {
                                const pathId = `${firm.id}-${contact.id}-${rc.connector.id}`;
                                const isSaved = isPathSaved(pathId);
                                return `
                                    <div class="connector-contact-item">
                                        <div onclick="showProspectDetail('${contact.id}')" style="cursor: pointer;">
                                            <div class="connector-contact-name clickable-prospect-name">${contact.name}</div>
                                            <div class="connector-contact-title">${contact.title}</div>
                                        </div>
                                        <button class="save-path-btn ${isSaved ? 'saved' : ''}" 
                                            onclick="toggleSavePath('${pathId}', '${firm.name.replace(/'/g, "\\'")}', '${rc.team?.name || 'Unknown'}', '${rc.connector.name.replace(/'/g, "\\'")}', '${contact.name.replace(/'/g, "\\'")}')"
                                            title="${isSaved ? 'Remove from saved' : 'Save this path'}">
                                            ${isSaved ? '★' : '☆'}
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Switch between contact views
        function switchContactsView(view) {
            const data = window.currentFirmData;
            if (!data) return;
            
            // Update toggle buttons
            document.querySelectorAll('.view-toggle-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Get current team filter
            const teamFilter = window.currentTeamFilter || 'all';
            
            const display = document.getElementById('contacts-display');
            if (view === 'byContact') {
                display.innerHTML = renderContactsByContact(data.contacts, data.pathsByContact, data.firm, teamFilter);
            } else {
                display.innerHTML = renderContactsByConnector(teamFilter);
            }
        }

        // Toggle connector group expansion
        function toggleConnectorGroup(idx) {
            const card = document.getElementById(`connector-group-${idx}`);
            if (card) {
                card.classList.toggle('expanded');
            }
        }

        // Filter contacts by team member
        function filterContactsByTeam(teamName) {
            const data = window.currentFirmData;
            if (!data) return;
            
            // Update filter buttons
            document.querySelectorAll('.team-filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Store current team filter
            window.currentTeamFilter = teamName;
            
            // Re-render current view with filter applied
            const activeViewBtn = document.querySelector('.view-toggle-btn.active');
            const currentView = activeViewBtn?.textContent.includes('Contact') ? 'byContact' : 'byConnector';
            
            const display = document.getElementById('contacts-display');
            if (currentView === 'byContact') {
                display.innerHTML = renderContactsByContact(data.contacts, data.pathsByContact, data.firm, teamName);
            } else {
                display.innerHTML = renderContactsByConnector(teamName);
            }
        }

        // Filter Sankey chart
        function filterSankey(mode) {
            const data = window.currentFirmData;
            if (!data) return;
            
            // Update filter buttons
            document.querySelectorAll('.sankey-filter-btn').forEach(btn => btn.classList.remove('active'));
            const clickedBtn = document.querySelector(`.sankey-filter-btn[data-mode="${mode}"]`);
            if (clickedBtn) clickedBtn.classList.add('active');
            
            let connectorsToShow;
            switch(mode) {
                case 'multipath':
                    connectorsToShow = data.multiPathConnectors.slice(0, 8);
                    break;
                case 'all':
                    connectorsToShow = data.allConnectorsSorted.slice(0, 10);
                    break;
                case 'top5':
                default:
                    connectorsToShow = data.top5Connectors;
            }
            
            // Build flow data for selected connectors
            const flowCounts = {};
            const nameToId = {}; // Map names to IDs for click handling
            const connectorIds = new Set(connectorsToShow.map(c => c.connector.id));
            
            data.paths.forEach(p => {
                if (!connectorIds.has(p.connectorId)) return;
                
                const team = toolData.teamMembers.find(t => t.id === p.teamMemberId);
                const connector = toolData.mutualConnections.find(c => c.id === p.connectorId);
                const prospect = toolData.prospects.find(pr => pr.id === p.prospectId);
                if (!team || !connector || !prospect) return;
                
                // Store name mappings
                nameToId[team.name] = { type: 'team', id: team.id };
                nameToId[connector.name] = { type: 'connector', id: connector.id };
                nameToId[prospect.name] = { type: 'prospect', id: prospect.id };
                
                const tcKey = `${team.name}|${connector.name}`;
                flowCounts[tcKey] = (flowCounts[tcKey] || 0) + 1;
                
                const cpKey = `${connector.name}|${prospect.name}`;
                flowCounts[cpKey] = (flowCounts[cpKey] || 0) + 1;
            });
            
            window.currentSankeyData = flowCounts;
            window.sankeyNameToId = nameToId;
            drawSankeyChart();
        }

        function toggleContactPaths(idx) {
            const card = document.getElementById(`contact-card-${idx}`);
            if (card) {
                card.classList.toggle('expanded');
            }
        }

        function toggleConnectorList(idx) {
            const item = document.getElementById(`connector-list-${idx}`);
            if (item) {
                item.classList.toggle('expanded');
            }
        }

        function showConnectorInfo(connectorId) {
            const connector = toolData.mutualConnections.find(c => c.id === connectorId);
            if (!connector) return;

            const paths = toolData.relationships.filter(r => r.connectorId === connectorId);
            const uniqueFirms = new Set(paths.map(r => r.firmId));
            const uniqueProspects = new Set(paths.map(r => r.prospectId));

            const modalBody = `
                <div class="modal-back-btn" onclick="closeModal()" style="margin-bottom: 15px;">
                    ← Back to list
                </div>
                <div class="detail-section">
                    <h3>Role & Company</h3>
                    <p><strong>${connector.title}</strong>${connector.company ? ` at ${connector.company}` : ''}</p>
                    ${connector.location ? `<p>📍 ${connector.location}</p>` : ''}
                </div>
                <div class="detail-section">
                    <h3>Contact Information</h3>
                    ${connector.email ? `<p>📧 <a href="mailto:${connector.email}">${connector.email}</a></p>` : ''}
                    ${connector.phone ? `<p>📱 ${connector.phone}</p>` : ''}
                    ${connector.linkedin ? `<p>🔗 <a href="${connector.linkedin}" target="_blank">LinkedIn Profile</a></p>` : ''}
                    ${!connector.email && !connector.phone && !connector.linkedin ? '<p style="color: #6c757d; font-style: italic;">No contact info available</p>' : ''}
                </div>
                <div class="detail-section">
                    <h3>Reach Statistics</h3>
                    <p>Can connect to <strong>${uniqueProspects.size} prospects</strong> at <strong>${uniqueFirms.size} firms</strong></p>
                    <p>Total relationship paths: <strong>${paths.length}</strong></p>
                </div>
                <div class="detail-section">
                    <h3>Known By (FourBridge Team)</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        ${connector.teamConnections && connector.teamConnections.length > 0 ? 
                            connector.teamConnections.map(tc => `<div style="margin: 8px 0;">• ${tc}</div>`).join('') :
                            '<p style="color: #6c757d; font-style: italic;">No team connections listed</p>'}
                    </div>
                </div>
                <div class="detail-section">
                    <h3>Can Introduce To</h3>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${paths.length > 0 ? paths.map(r => {
                            const prospect = toolData.prospects.find(p => p.id === r.prospectId);
                            const firm = toolData.firms.find(f => f.id === r.firmId);
                            if (!prospect) return '';
                            return `
                                <div class="clickable-prospect-item" onclick="navigateToProspectFromModal('${prospect.id}')">
                                    <div style="font-weight: 600; color: #2d3748;">${prospect.name}</div>
                                    <div style="color: #6c757d; font-size: 14px; margin-top: 4px;">${prospect.title}${firm ? ` at ${firm.name}` : ''}</div>
                                </div>
                            `;
                        }).join('') : '<p style="color: #6c757d; font-style: italic;">No prospects linked yet</p>'}
                    </div>
                </div>
            `;

            document.getElementById('modal-name').textContent = connector.name;
            document.getElementById('modal-subtitle').textContent = connector.title ? `${connector.title}${connector.company ? ` at ${connector.company}` : ''}` : '';
            document.getElementById('modal-body').innerHTML = modalBody;
            document.getElementById('detail-modal').style.display = 'block';
        }
        
        // Navigate from modal to prospect detail
        function navigateToProspectFromModal(prospectId) {
            // Close modal first
            document.getElementById('detail-modal').style.display = 'none';
            // Navigate to prospect detail (use the ID-based version)
            setTimeout(() => {
                showProspectDetail(prospectId);
            }, 50);
        }

        function showTeamDetail(member) {
            const rels = toolData.relationships.filter(r => r.teamMemberId === member.id);
            const uniqueConnectors = [...new Set(rels.map(r => r.connectorId))];
            const uniqueFirms = [...new Set(rels.map(r => r.firmId).filter(id => id))];
            const uniqueProspects = [...new Set(rels.map(r => r.prospectId))];

            document.getElementById('modal-name').textContent = member.name;
            document.getElementById('modal-subtitle').textContent = member.role;
            document.getElementById('modal-body').innerHTML = `
                <div class="detail-section">
                    <h3>Network Reach</h3>
                    <p><strong>Connectors:</strong> ${uniqueConnectors.length}</p>
                    <p><strong>Firms Reachable:</strong> ${uniqueFirms.length}</p>
                    <p><strong>Prospects Reachable:</strong> ${uniqueProspects.length}</p>
                </div>
                <div class="detail-section">
                    <h3>Contact</h3>
                    ${member.email ? `<p>📧 ${member.email}</p>` : ''}
                    ${member.phone ? `<p>📞 ${member.phone}</p>` : ''}
                    ${member.linkedin ? `<p>🔗 <a href="${member.linkedin}" target="_blank">LinkedIn Profile</a></p>` : ''}
                </div>
                <div class="detail-section">
                    <h3>Top Connectors</h3>
                    ${uniqueConnectors.slice(0, 10).map(cId => {
                        const connector = toolData.mutualConnections.find(c => c.id === cId);
                        const count = rels.filter(r => r.connectorId === cId).length;
                        return `<p>• ${connector?.name} (${count} connections)</p>`;
                    }).join('')}
                </div>
            `;

            document.getElementById('detail-modal').style.display = 'block';
        }

        function closeModal(event) {
            if (!event || event.target.id === 'detail-modal') {
                document.getElementById('detail-modal').style.display = 'none';
            }
        }

        // ========== UTILITY FUNCTIONS ==========
        function formatAUM(aum) {
            if (!aum || aum === 0) return 'N/A';
            if (aum >= 1000) return `$${(aum / 1000).toFixed(1)}B`;
            return `$${aum.toFixed(0)}M`;
        }

        function getWarmPathBadge(pathCount) {
            if (pathCount === 0) {
                return '<span style="color: #6c757d;">—</span>';
            }
            
            let badgeClass = 'badge-paths-low';
            if (pathCount >= 20) {
                badgeClass = 'badge-paths-high';
            } else if (pathCount >= 6) {
                badgeClass = 'badge-paths-medium';
            }
            
            return `<span class="badge ${badgeClass}">✓ ${pathCount} path${pathCount > 1 ? 's' : ''}</span>`;
        }

        function updateFooter() {
            const totalFirms = toolData.firms.length;
            const reachableFirms = toolData.firms.filter(f => 
                toolData.relationships.some(r => r.firmId === f.id)
            ).length;
            
            document.getElementById('footer-firms').textContent = totalFirms;
            document.getElementById('footer-reachable').textContent = reachableFirms;
            document.getElementById('footer-version').textContent = `v${toolData.version}`;
            document.getElementById('footer-sync-time').textContent = 'just now';
        }

        // ========== SORTING ==========
        let firmsSortCol = -1;
        let firmsSortAsc = true;
        let peopleSortCol = -1;
        let peopleSortAsc = true;
        let firmsDbSortCol = -1;
        let firmsDbSortAsc = true;

        function updateSortIndicators(tableId, col, ascending) {
            const headers = document.querySelectorAll(`#${tableId} th`);
            headers.forEach((h, i) => {
                h.classList.remove('sorted-asc', 'sorted-desc');
                if (i === col) {
                    h.classList.add(ascending ? 'sorted-asc' : 'sorted-desc');
                }
            });
        }

        function sortProspectsTable(col) {
            if (firmsSortCol === col) {
                firmsSortAsc = !firmsSortAsc;
            } else {
                firmsSortCol = col;
                firmsSortAsc = true;
            }
            updateSortIndicators('prospects-table', col, firmsSortAsc);
            
            const tbody = document.getElementById('prospects-table-body');
            const rows = Array.from(tbody.rows);
            
            rows.sort((a, b) => {
                let aVal = a.cells[col].textContent.trim();
                let bVal = b.cells[col].textContent.trim();
                
                // Handle AUM column (parse currency)
                if (col === 3) {
                    aVal = aVal === 'N/A' ? 0 : parseFloat(aVal.replace(/[$BMN\/A]/g, '')) * (aVal.includes('B') ? 1000 : 1);
                    bVal = bVal === 'N/A' ? 0 : parseFloat(bVal.replace(/[$BMN\/A]/g, '')) * (bVal.includes('B') ? 1000 : 1);
                }
                // Handle Contacts and Priority columns (numeric)
                else if (col === 4 || col === 6) {
                    aVal = aVal === '—' ? -1 : parseInt(aVal) || 0;
                    bVal = bVal === '—' ? -1 : parseInt(bVal) || 0;
                }
                // Handle Warm Paths column (parse number from badge)
                else if (col === 5) {
                    const aMatch = aVal.match(/(\d+)/);
                    const bMatch = bVal.match(/(\d+)/);
                    aVal = aMatch ? parseInt(aMatch[1]) : 0;
                    bVal = bMatch ? parseInt(bMatch[1]) : 0;
                }
                
                if (aVal < bVal) return firmsSortAsc ? -1 : 1;
                if (aVal > bVal) return firmsSortAsc ? 1 : -1;
                return 0;
            });
            
            rows.forEach(row => tbody.appendChild(row));
        }

        function sortProspectsPeopleTable(col) {
            if (peopleSortCol === col) {
                peopleSortAsc = !peopleSortAsc;
            } else {
                peopleSortCol = col;
                peopleSortAsc = true;
            }
            updateSortIndicators('prospects-people-table', col, peopleSortAsc);
            
            const tbody = document.getElementById('prospects-people-table-body');
            const rows = Array.from(tbody.rows);
            
            rows.sort((a, b) => {
                let aVal = a.cells[col].textContent.trim();
                let bVal = b.cells[col].textContent.trim();
                
                // Handle Warm Paths column (parse number from badge)
                if (col === 6) {
                    const aMatch = aVal.match(/(\d+)/);
                    const bMatch = bVal.match(/(\d+)/);
                    aVal = aMatch ? parseInt(aMatch[1]) : 0;
                    bVal = bMatch ? parseInt(bMatch[1]) : 0;
                }
                
                if (aVal < bVal) return peopleSortAsc ? -1 : 1;
                if (aVal > bVal) return peopleSortAsc ? 1 : -1;
                return 0;
            });
            
            rows.forEach(row => tbody.appendChild(row));
        }

        function sortFirmsTable(col) {
            if (firmsDbSortCol === col) {
                firmsDbSortAsc = !firmsDbSortAsc;
            } else {
                firmsDbSortCol = col;
                firmsDbSortAsc = true;
            }
            updateSortIndicators('firms-table', col, firmsDbSortAsc);
            
            const tbody = document.getElementById('firms-table-body');
            const rows = Array.from(tbody.rows);
            
            rows.sort((a, b) => {
                let aVal = a.cells[col].textContent.trim();
                let bVal = b.cells[col].textContent.trim();
                
                // Handle AUM column (parse currency)
                if (col === 3) {
                    aVal = aVal === 'N/A' ? 0 : parseFloat(aVal.replace(/[$BMN\/A]/g, '')) * (aVal.includes('B') ? 1000 : 1);
                    bVal = bVal === 'N/A' ? 0 : parseFloat(bVal.replace(/[$BMN\/A]/g, '')) * (bVal.includes('B') ? 1000 : 1);
                }
                // Handle Contacts column (numeric)
                else if (col === 5) {
                    aVal = parseInt(aVal) || 0;
                    bVal = parseInt(bVal) || 0;
                }
                // Handle Warm Paths column (parse number from badge)
                else if (col === 6) {
                    const aMatch = aVal.match(/(\d+)/);
                    const bMatch = bVal.match(/(\d+)/);
                    aVal = aMatch ? parseInt(aMatch[1]) : 0;
                    bVal = bMatch ? parseInt(bMatch[1]) : 0;
                }
                
                if (aVal < bVal) return firmsDbSortAsc ? -1 : 1;
                if (aVal > bVal) return firmsDbSortAsc ? 1 : -1;
                return 0;
            });
            
            rows.forEach(row => tbody.appendChild(row));
        }

        function sortTeamTable(col) {
            // Team table sorting - similar pattern
        }

        // ========== GOOGLE CHARTS - SANKEY ==========
        let googleChartsLoaded = false;
        
        // Load Google Charts
        google.charts.load('current', {'packages':['sankey']});
        google.charts.setOnLoadCallback(() => {
            googleChartsLoaded = true;
        });

        function drawSankeyChart() {
            if (!googleChartsLoaded || !window.currentSankeyData) return;
            
            const chartDiv = document.getElementById('sankey-chart');
            if (!chartDiv) return;
            
            const flowCounts = window.currentSankeyData;
            const rows = [];
            
            // Convert flow counts to chart data
            Object.entries(flowCounts).forEach(([key, count]) => {
                const [from, to] = key.split('|');
                rows.push([from, to, count]);
            });
            
            if (rows.length === 0) return;
            
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'From');
            data.addColumn('string', 'To');
            data.addColumn('number', 'Paths');
            data.addColumn({type: 'string', role: 'tooltip'});
            
            // Add rows with custom tooltips
            rows.forEach(row => {
                const [from, to, count] = row;
                const tooltip = `${from} → ${to}\n${count} ${count === 1 ? 'path' : 'paths'}`;
                data.addRow([from, to, count, tooltip]);
            });

            const options = {
                width: '100%',
                height: 300,
                tooltip: { isHtml: false },
                sankey: {
                    node: {
                        colors: ['#3b82f6', '#8b5cf6', '#10b981', '#f97316', '#06b6d4', '#ec4899', '#84cc16'],
                        label: {
                            fontName: 'Inter, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif',
                            fontSize: 13,
                            color: '#1a1a1a',
                            bold: true
                        },
                        nodePadding: 25,
                        width: 12,
                        interactivity: true
                    },
                    link: {
                        colorMode: 'source',
                        color: { fillOpacity: 0.4 }
                    }
                }
            };

            const chart = new google.visualization.Sankey(chartDiv);
            
            // Add click event handler for Sankey nodes
            google.visualization.events.addListener(chart, 'select', function() {
                const selection = chart.getSelection();
                if (selection.length > 0) {
                    const item = selection[0];
                    // Sankey selection gives us the name directly
                    if (item.name) {
                        handleSankeyClick(item.name);
                    }
                }
            });
            
            chart.draw(data, options);
        }
        
        // Handle clicks on Sankey chart names
        function handleSankeyClick(name) {
            const nameMapping = window.sankeyNameToId;
            if (!nameMapping || !nameMapping[name]) return;
            
            const mapping = nameMapping[name];
            
            if (mapping.type === 'connector') {
                // Navigate to connector detail
                showConnectorDetail(mapping.id);
            } else if (mapping.type === 'prospect') {
                // Navigate to prospect detail
                showProspectDetail(mapping.id);
            }
            // Team members don't have their own detail page in current design
        }
        
        // Show connector detail page - REDESIGNED
        function showConnectorDetail(connectorId) {
            const connector = toolData.mutualConnections.find(c => c.id === connectorId);
            if (!connector) return;
            
            // Track this view
            trackView('connector', connector.id, connector.name, { company: connector.company });
            
            // Push current state to navigation history
            pushNavigationHistory();
            
            // Find all paths involving this connector
            const connectorPaths = toolData.relationships.filter(r => r.connectorId === connectorId);
            
            // Get unique teams this connector is linked through
            const teamsSet = new Set();
            connectorPaths.forEach(p => {
                const team = toolData.teamMembers.find(t => t.id === p.teamMemberId);
                if (team) teamsSet.add(team.name);
            });
            const teamsList = [...teamsSet];
            
            // Group by firm
            const firmGroups = {};
            connectorPaths.forEach(p => {
                const firm = toolData.firms.find(f => f.id === p.firmId);
                const prospect = toolData.prospects.find(pr => pr.id === p.prospectId);
                const team = toolData.teamMembers.find(t => t.id === p.teamMemberId);
                if (!firm || !prospect) return;
                
                if (!firmGroups[firm.id]) {
                    firmGroups[firm.id] = { firm, contacts: [], teams: new Set(), paths: [] };
                }
                // Avoid duplicate contacts
                if (!firmGroups[firm.id].contacts.find(c => c.id === prospect.id)) {
                    firmGroups[firm.id].contacts.push(prospect);
                }
                if (team) firmGroups[firm.id].teams.add(team.name);
                firmGroups[firm.id].paths.push(p);
            });
            
            const firmList = Object.values(firmGroups)
                .sort((a, b) => b.contacts.length - a.contacts.length);
            
            // Calculate stats
            const totalProspects = new Set(connectorPaths.map(p => p.prospectId)).size;
            const totalFirms = firmList.length;
            const totalConnections = connector.mutualCount || 0;
            
            // Build Sankey data for this connector
            const connectorSankeyData = {};
            connectorPaths.forEach(p => {
                const team = toolData.teamMembers.find(t => t.id === p.teamMemberId);
                const prospect = toolData.prospects.find(pr => pr.id === p.prospectId);
                if (!team || !prospect) return;
                
                // Team -> Connector
                const tcKey = `${team.name}|${connector.name}`;
                connectorSankeyData[tcKey] = (connectorSankeyData[tcKey] || 0) + 1;
                
                // Connector -> Prospect
                const cpKey = `${connector.name}|${prospect.name}`;
                connectorSankeyData[cpKey] = (connectorSankeyData[cpKey] || 0) + 1;
            });
            
            // Store for Sankey drawing
            window.connectorSankeyData = connectorSankeyData;
            window.currentConnectorId = connectorId;
            
            document.getElementById('modal-name').textContent = connector.name;
            document.getElementById('modal-subtitle').innerHTML = `
                ${connector.title}${connector.company ? ` at ${connector.company}` : ''}
                <button class="back-nav-btn" onclick="navigateBack()" style="margin-left: 15px;">← Back</button>
            `;
            
            document.getElementById('modal-body').innerHTML = `
                <!-- Hot Connector Toggle -->
                <div class="connector-hot-toggle">
                    <button class="mark-hot-btn ${isHotConnector(connectorId) ? 'is-hot' : ''}" onclick="toggleHotConnector('${connectorId}'); this.classList.toggle('is-hot'); this.innerHTML = this.classList.contains('is-hot') ? '🔥 Hot Connector' : '☆ Mark as Hot';">
                        ${isHotConnector(connectorId) ? '🔥 Hot Connector' : '☆ Mark as Hot'}
                    </button>
                </div>
                
                <!-- Stats Row -->
                <div class="connector-stats-row">
                    <div class="connector-stat-box">
                        <div class="connector-stat-value">${totalProspects}</div>
                        <div class="connector-stat-label">Prospects</div>
                    </div>
                    <div class="connector-stat-box">
                        <div class="connector-stat-value">${totalFirms}</div>
                        <div class="connector-stat-label">Firms</div>
                    </div>
                    <div class="connector-stat-box">
                        <div class="connector-stat-value">${totalConnections}</div>
                        <div class="connector-stat-label">LinkedIn</div>
                    </div>
                </div>
                
                <!-- Metadata Row -->
                <div class="connector-meta-row">
                    ${connector.location ? `<span>📍 ${connector.location}</span>` : ''}
                    ${connector.linkedin ? `<a href="${connector.linkedin}" target="_blank">🔗 LinkedIn Profile</a>` : ''}
                    <span>via ${teamsList.join(', ')}</span>
                </div>
                
                <!-- Sankey Chart -->
                ${totalProspects > 0 ? `
                    <div class="detail-section">
                        <h3>Reach Map</h3>
                        <p style="color: #6c757d; font-size: 13px; margin-bottom: 12px;">How ${connector.name.split(' ')[0]} connects your team to prospects</p>
                        <div class="sankey-column-headers">
                            <span class="sankey-flow-label">👥 Your Team</span>
                            <span class="sankey-flow-arrow">→</span>
                            <span class="sankey-flow-label">🤝 ${connector.name.split(' ')[0]}</span>
                            <span class="sankey-flow-arrow">→</span>
                            <span class="sankey-flow-label">🎯 Prospects</span>
                        </div>
                        <div class="sankey-container">
                            <div id="connector-sankey-chart"></div>
                        </div>
                    </div>
                ` : ''}
                
                <!-- Firms List -->
                <div class="detail-section">
                    <h3>Firms ${connector.name.split(' ')[0]} Can Introduce You To</h3>
                    <div class="connector-firms-grouped">
                        ${firmList.map((fg, idx) => `
                            <div class="connector-firm-group" id="connector-firm-${idx}">
                                <div class="connector-firm-header" onclick="toggleConnectorFirmGroup(${idx})">
                                    <div class="connector-firm-left">
                                        <span class="connector-firm-expand">▶</span>
                                        <div>
                                            <div class="connector-firm-name-row">
                                                <span class="connector-firm-name">${fg.firm.name}</span>
                                                <span class="connector-firm-count">${fg.contacts.length} contact${fg.contacts.length > 1 ? 's' : ''}</span>
                                            </div>
                                            <div class="connector-firm-badges">
                                                ${fg.firm.aum ? `<span class="mini-badge">${formatAUM(fg.firm.aum)}</span>` : ''}
                                                <span class="mini-badge">${fg.firm.type}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="view-firm-btn" onclick="event.stopPropagation(); showFirmDetail(toolData.firms.find(f => f.id === '${fg.firm.id}'))">
                                        View Firm →
                                    </button>
                                </div>
                                <div class="connector-firm-contacts">
                                    ${fg.contacts.map(contact => {
                                        const pathId = `${fg.firm.id}-${contact.id}-${connector.id}`;
                                        const isSaved = isPathSaved(pathId);
                                        const teamName = [...fg.teams][0] || 'Unknown';
                                        return `
                                            <div class="connector-firm-contact">
                                                <div class="connector-firm-contact-info" onclick="showProspectDetail('${contact.id}')">
                                                    <div class="connector-firm-contact-name clickable-prospect-name">${contact.name}</div>
                                                    <div class="connector-firm-contact-title">${contact.title}</div>
                                                </div>
                                                <button class="save-path-btn ${isSaved ? 'saved' : ''}" 
                                                    onclick="toggleSavePath('${pathId}', '${fg.firm.name.replace(/'/g, "\\'")}', '${teamName}', '${connector.name.replace(/'/g, "\\'")}', '${contact.name.replace(/'/g, "\\'")}')"
                                                    title="${isSaved ? 'Remove from saved' : 'Save this path'}">
                                                    ${isSaved ? '★' : '☆'}
                                                </button>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Show modal
            document.getElementById('detail-modal').style.display = 'block';
            
            // Draw Sankey chart after DOM updates
            if (totalProspects > 0) {
                setTimeout(() => drawConnectorSankeyChart(), 100);
            }
        }
        
        // Toggle connector firm group expansion
        function toggleConnectorFirmGroup(idx) {
            const group = document.getElementById(`connector-firm-${idx}`);
            if (group) {
                group.classList.toggle('expanded');
            }
        }
        
        // Draw Sankey chart for connector detail page
        function drawConnectorSankeyChart() {
            if (!googleChartsLoaded || !window.connectorSankeyData) return;
            
            const chartDiv = document.getElementById('connector-sankey-chart');
            if (!chartDiv) return;
            
            const flowCounts = window.connectorSankeyData;
            const rows = [];
            
            // Convert flow counts to chart data (limit to top prospects for readability)
            const entries = Object.entries(flowCounts);
            
            // Separate team->connector and connector->prospect flows
            const teamFlows = entries.filter(([key]) => {
                const [from] = key.split('|');
                return toolData.teamMembers.some(t => t.name === from);
            });
            
            const prospectFlows = entries.filter(([key]) => {
                const [from] = key.split('|');
                return !toolData.teamMembers.some(t => t.name === from);
            }).sort((a, b) => b[1] - a[1]).slice(0, 8); // Top 8 prospects
            
            [...teamFlows, ...prospectFlows].forEach(([key, count]) => {
                const [from, to] = key.split('|');
                rows.push([from, to, count]);
            });
            
            if (rows.length === 0) return;
            
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'From');
            data.addColumn('string', 'To');
            data.addColumn('number', 'Paths');
            data.addColumn({type: 'string', role: 'tooltip'});
            
            // Add rows with custom tooltips
            rows.forEach(row => {
                const [from, to, count] = row;
                const tooltip = `${from} → ${to}\n${count} ${count === 1 ? 'path' : 'paths'}`;
                data.addRow([from, to, count, tooltip]);
            });

            const options = {
                width: '100%',
                height: 250,
                tooltip: { isHtml: false },
                sankey: {
                    node: {
                        colors: ['#3b82f6', '#8b5cf6', '#10b981', '#f97316', '#06b6d4', '#ec4899', '#84cc16'],
                        label: {
                            fontName: 'Inter, -apple-system, BlinkMacSystemFont, sans-serif',
                            fontSize: 12,
                            color: '#1a1a1a',
                            bold: true
                        },
                        nodePadding: 18,
                        width: 10
                    },
                    link: {
                        colorMode: 'source',
                        color: { fillOpacity: 0.4 }
                    }
                }
            };

            const chart = new google.visualization.Sankey(chartDiv);
            chart.draw(data, options);
        }
        
        // Show prospect detail page - REDESIGNED
        function showProspectDetail(prospectId) {
            const prospect = toolData.prospects.find(p => p.id === prospectId);
            if (!prospect) return;
            
            // Track this view
            trackView('prospect', prospect.id, prospect.name, { title: prospect.title });
            
            // Push current state to navigation history
            pushNavigationHistory();
            
            const firm = toolData.firms.find(f => f.id === prospect.firmId);
            
            // Find all paths to this prospect
            const prospectPaths = toolData.relationships.filter(r => r.prospectId === prospectId);
            
            // Get unique teams
            const teamsSet = new Set();
            prospectPaths.forEach(p => {
                const team = toolData.teamMembers.find(t => t.id === p.teamMemberId);
                if (team) teamsSet.add(team.name);
            });
            const teamsList = [...teamsSet];
            
            // Sort connectors: hot first, then by mutualCount
            const connectorsList = prospectPaths.map(p => {
                const connector = toolData.mutualConnections.find(c => c.id === p.connectorId);
                const team = toolData.teamMembers.find(t => t.id === p.teamMemberId);
                return { connector, team, path: p };
            }).filter(c => c.connector)
              .sort((a, b) => {
                  // Hot connectors first
                  const aHot = isHotConnector(a.connector.id) ? 1 : 0;
                  const bHot = isHotConnector(b.connector.id) ? 1 : 0;
                  if (bHot !== aHot) return bHot - aHot;
                  // Then by mutual count
                  return (b.connector.mutualCount || 0) - (a.connector.mutualCount || 0);
              });
            
            // Calculate stats
            const totalPaths = connectorsList.length;
            const totalTeams = teamsList.length;
            
            // Build prospect research panel - auto-show if research exists
            const research = getProspectResearch(prospect.name);
            let researchHTML = '';
            
            // Find affiliations for this prospect
            const affiliations = findProspectAffiliations(prospect);
            let affiliationHTML = '';
            const hasAffiliations = affiliations.schools.length > 0 || affiliations.companies.length > 0 || affiliations.boards.length > 0 || affiliations.generation || affiliations.military.length > 0 || affiliations.families.length > 0;
            
            if (hasAffiliations) {
                affiliationHTML = `
                    <div class="prospect-affiliations">
                        <div class="affiliation-label">Network Affiliations</div>
                        <div class="affiliation-tags">
                            ${affiliations.generation ? `<span class="affiliation-tag generation">${affiliations.generation}</span>` : ''}
                            ${affiliations.military.map(m => `<span class="affiliation-tag military">🎖️ ${m}</span>`).join('')}
                            ${affiliations.schools.map(s => `<span class="affiliation-tag school">${s}</span>`).join('')}
                            ${affiliations.companies.map(c => `<span class="affiliation-tag company">${c}</span>`).join('')}
                            ${affiliations.boards.map(b => `<span class="affiliation-tag board">${b}</span>`).join('')}
                            ${affiliations.families.map(f => `<span class="affiliation-tag family">👨‍👩‍👧 ${f} Family</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (research) {
                // Auto-expanded research section for prospects with data
                researchHTML = `
                    <div class="prospect-research-card">
                        <div class="prospect-research-header">
                            <span class="prospect-research-title">Research Intelligence</span>
                            <span class="research-badge" style="background: #004D4D;">RESEARCHED</span>
                        </div>
                        ${affiliationHTML}
                        
                        <div class="research-tabs" style="margin: 0 -20px; border-radius: 0;">
                            <button class="research-tab active" onclick="switchResearchTab(this, 'background')">Background</button>
                            <button class="research-tab" onclick="switchResearchTab(this, 'career')">Career</button>
                            <button class="research-tab" onclick="switchResearchTab(this, 'notes')">Notes</button>
                        </div>
                        
                        <div class="research-tab-content active" data-tab="background" style="padding-top: 20px;">
                            ${research.familyRole ? `
                                <div class="research-field">
                                    <div class="research-field-label">Family Role</div>
                                    <div class="research-field-value">${research.familyRole}</div>
                                </div>
                            ` : ''}
                            ${research.education ? `
                                <div class="research-field">
                                    <div class="research-field-label">Education</div>
                                    <div class="research-field-value">${research.education}</div>
                                </div>
                            ` : ''}
                            ${!research.familyRole && !research.education ? '<p style="color: #6c757d; font-style: italic; text-align: center; padding: 20px 0;">No background data available.</p>' : ''}
                        </div>
                        
                        <div class="research-tab-content" data-tab="career" style="padding-top: 20px;">
                            ${research.careerHistory ? `
                                <div class="research-field">
                                    <div class="research-field-label">Career History</div>
                                    <div class="research-field-value">${research.careerHistory}</div>
                                </div>
                            ` : ''}
                            ${research.boardSeats ? `
                                <div class="research-field">
                                    <div class="research-field-label">Board Seats</div>
                                    <div class="research-field-value">${research.boardSeats}</div>
                                </div>
                            ` : ''}
                            ${research.certifications ? `
                                <div class="research-field">
                                    <div class="research-field-label">Certifications</div>
                                    <div class="research-field-value">${research.certifications}</div>
                                </div>
                            ` : ''}
                            ${research.notableAchievements ? `
                                <div class="research-field">
                                    <div class="research-field-label">Notable Achievements</div>
                                    <div class="research-field-value">${research.notableAchievements}</div>
                                </div>
                            ` : ''}
                            ${!research.careerHistory && !research.boardSeats && !research.certifications && !research.notableAchievements ? '<p style="color: #6c757d; font-style: italic; text-align: center; padding: 20px 0;">No career data available.</p>' : ''}
                        </div>
                        
                        <div class="research-tab-content" data-tab="notes" style="padding-top: 20px;">
                            ${research.researchNotes ? `
                                <div class="research-field">
                                    <div class="research-field-label">Research Notes</div>
                                    <div class="research-field-value">${research.researchNotes}</div>
                                </div>
                            ` : ''}
                            ${research.primarySources ? `
                                <div class="research-field">
                                    <div class="research-field-label">Primary Sources</div>
                                    <div class="research-field-value">${research.primarySources}</div>
                                </div>
                            ` : ''}
                            ${!research.researchNotes && !research.primarySources ? '<p class="research-empty">No notes available.</p>' : ''}
                        </div>
                        
                        ${research.lastUpdated ? `
                            <div class="research-meta">
                                <span class="research-meta-item">Last updated: ${research.lastUpdated}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                // Minimal indicator for prospects without research
                researchHTML = `
                    <div class="no-research-indicator">
                        <span>📊</span>
                        <span>No research data yet</span>
                    </div>
                `;
            }
            
            document.getElementById('modal-name').textContent = prospect.name;
            document.getElementById('modal-subtitle').innerHTML = `
                ${prospect.title}
                <button class="back-nav-btn" onclick="navigateBack()" style="margin-left: 15px;">← Back</button>
            `;
            document.getElementById('modal-body').innerHTML = `
                <!-- Stats Row -->
                <div class="connector-stats-row">
                    <div class="connector-stat-box">
                        <div class="connector-stat-value">${totalPaths}</div>
                        <div class="connector-stat-label">Intro Paths</div>
                    </div>
                    <div class="connector-stat-box">
                        <div class="connector-stat-value">${totalTeams}</div>
                        <div class="connector-stat-label">Team Links</div>
                    </div>
                    <div class="connector-stat-box" onclick="showFirmDetail(toolData.firms.find(f => f.id === '${prospect.firmId}'))" style="cursor: pointer;">
                        <div class="connector-stat-value" style="font-size: 14px; line-height: 1.3;">${firm?.name || 'Unknown'}</div>
                        <div class="connector-stat-label">Firm →</div>
                    </div>
                </div>
                
                <!-- Metadata Row -->
                <div class="connector-meta-row">
                    ${prospect.location || firm?.location ? `<span>📍 ${prospect.location || firm?.location}</span>` : ''}
                    ${prospect.linkedin ? `<a href="${prospect.linkedin}" target="_blank">🔗 LinkedIn Profile</a>` : ''}
                    ${prospect.email ? `<a href="mailto:${prospect.email}">✉️ ${prospect.email}</a>` : ''}
                    ${prospect.phone ? `<span>📞 ${prospect.phone}</span>` : ''}
                </div>
                
                ${researchHTML}
                
                ${connectorsList.length > 0 ? `
                    <div class="detail-section">
                        <h3>People Who Can Introduce You (${connectorsList.length})</h3>
                        <p style="color: #6c757d; font-size: 13px; margin-bottom: 12px;">Hot connectors first, then by LinkedIn connections</p>
                        <div class="prospect-connectors-list">
                            ${connectorsList.map(({ connector, team }) => {
                                const pathId = `${firm?.id || 'unknown'}-${prospect.id}-${connector.id}`;
                                const isSaved = isPathSaved(pathId);
                                const connectorIsHot = isHotConnector(connector.id);
                                return `
                                    <div class="prospect-connector-item-enhanced ${connectorIsHot ? 'hot-connector-item' : ''}">
                                        <div class="prospect-connector-main" onclick="showConnectorDetail('${connector.id}')">
                                            <div class="prospect-connector-info">
                                                <div class="prospect-connector-name">${connector.name} ${connectorIsHot ? '<span class="hot-badge">🔥 HOT</span>' : ''}</div>
                                                <div class="prospect-connector-title">${connector.title}${connector.company ? ` at ${connector.company}` : ''}</div>
                                            </div>
                                            <div class="prospect-connector-stats">
                                                <div class="prospect-connector-count-big">${connector.mutualCount || 0}</div>
                                                <div class="prospect-connector-count-label">connections</div>
                                            </div>
                                        </div>
                                        <div class="prospect-connector-actions">
                                            <span class="prospect-connector-via">via ${team?.name || 'Unknown'}</span>
                                            <button class="save-path-btn ${isSaved ? 'saved' : ''}" 
                                                onclick="toggleSavePath('${pathId}', '${(firm?.name || 'Unknown').replace(/'/g, "\\'")}', '${team?.name || 'Unknown'}', '${connector.name.replace(/'/g, "\\'")}', '${prospect.name.replace(/'/g, "\\'")}')"
                                                title="${isSaved ? 'Remove from saved' : 'Save this path'}">
                                                ${isSaved ? '★' : '☆'}
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : `
                    <div class="detail-section">
                        <div class="no-paths">No warm introduction paths found. Consider cold outreach.</div>
                    </div>
                `}
            `;
            
            // Show the modal
            document.getElementById('detail-modal').style.display = 'block';
        }
        
        // Navigation history management
        
        // Toggle research panel visibility
        function toggleResearchPanel(btn) {
            btn.classList.toggle('expanded');
            const panel = btn.nextElementSibling;
            if (panel && panel.classList.contains('research-panel')) {
                panel.classList.toggle('visible');
            }
        }

        // Switch research tabs
        function switchResearchTab(btn, tabName) {
            // Update tab buttons
            const tabContainer = btn.closest('.research-panel') || btn.closest('.prospect-research-card');
            if (!tabContainer) return;
            tabContainer.querySelectorAll('.research-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            // Update content
            tabContainer.querySelectorAll('.research-tab-content').forEach(content => {
                content.classList.remove('active');
                if (content.dataset.tab === tabName) {
                    content.classList.add('active');
                }
            });
        }

        // ========== INTRO QUEUE (uses existing savedPaths) ==========
        function updateQueueCount() {
            const countEl = document.getElementById('queue-count');
            if (countEl) countEl.textContent = savedPaths.length;
        }

        function clearIntroQueue() {
            if (!confirm('Clear all saved intros?')) return;
            savedPaths = [];
            persistSavedPaths();
        }

        function exportIntroQueue() {
            exportSavedPaths(); // Use existing export function
        }

        function renderIntroQueue() {
            const listEl = document.getElementById('queue-list');
            const emptyEl = document.getElementById('queue-empty');
            const actionsEl = document.getElementById('queue-actions');
            
            if (!listEl) return;
            
            updateQueueCount();
            
            if (savedPaths.length === 0) {
                listEl.innerHTML = '';
                if (emptyEl) emptyEl.style.display = 'block';
                if (actionsEl) actionsEl.style.display = 'none';
                return;
            }
            
            if (emptyEl) emptyEl.style.display = 'none';
            if (actionsEl) actionsEl.style.display = 'flex';
            
            // Group by firm
            const byFirm = {};
            savedPaths.forEach(p => {
                const firmName = p.firmName || 'Unknown Firm';
                if (!byFirm[firmName]) {
                    byFirm[firmName] = [];
                }
                byFirm[firmName].push(p);
            });
            
            listEl.innerHTML = Object.entries(byFirm).map(([firmName, paths]) => `
                <div class="queue-group expanded">
                    <div class="queue-group-header" onclick="this.parentElement.classList.toggle('expanded')">
                        <span class="queue-group-firm">${firmName}</span>
                        <span class="queue-group-count">${paths.length} intro${paths.length > 1 ? 's' : ''}</span>
                    </div>
                    <div class="queue-group-items">
                        ${paths.map(p => {
                            const connectorIsHot = isHotConnector(getConnectorIdByName(p.connectorName));
                            return `
                            <div class="queue-item">
                                <div class="queue-item-path">
                                    <div class="queue-item-chain">
                                        <span class="queue-item-person">${p.teamName}</span>
                                        <span class="queue-item-arrow">→</span>
                                        <span class="queue-item-connector ${connectorIsHot ? 'is-hot' : ''}">
                                            <span class="queue-item-person">${p.connectorName}</span>
                                            ${connectorIsHot ? '<span class="hot-connector-badge">🔥</span>' : ''}
                                        </span>
                                        <span class="queue-item-arrow">→</span>
                                        <span class="queue-item-target">${p.contactName}</span>
                                    </div>
                                </div>
                                <button class="queue-item-remove" onclick="removeSavedPath('${p.id}'); renderIntroQueue();" title="Remove">×</button>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Helper to find connector ID by name (for hot connector check)
        function getConnectorIdByName(name) {
            const connector = toolData.mutualConnections?.find(c => c.name === name);
            return connector?.id || '';
        }

        // ========== HOT CONNECTORS SYSTEM ==========
        let hotConnectors = JSON.parse(localStorage.getItem('fourbridge_hot_connectors') || '[]');

        function toggleHotConnector(connectorId) {
            if (isHotConnector(connectorId)) {
                hotConnectors = hotConnectors.filter(id => id !== connectorId);
            } else {
                hotConnectors.push(connectorId);
            }
            saveHotConnectors();
            renderHotConnectors();
            // Re-render current views to update hot badges
            renderProspectsView();
        }

        function isHotConnector(connectorId) {
            return hotConnectors.includes(connectorId);
        }

        function saveHotConnectors() {
            localStorage.setItem('fourbridge_hot_connectors', JSON.stringify(hotConnectors));
            updateHotCount();
        }

        function updateHotCount() {
            const countEl = document.getElementById('hot-count');
            if (countEl) countEl.textContent = hotConnectors.length;
        }

        function renderHotConnectors() {
            const listEl = document.getElementById('hot-list');
            const emptyEl = document.getElementById('hot-empty');
            
            if (!listEl) return;
            
            updateHotCount();
            
            if (hotConnectors.length === 0) {
                listEl.innerHTML = '';
                if (emptyEl) emptyEl.style.display = 'block';
                return;
            }
            
            if (emptyEl) emptyEl.style.display = 'none';
            
            listEl.innerHTML = hotConnectors.map(connectorId => {
                const connector = toolData.mutualConnections.find(c => c.id === connectorId);
                if (!connector) return '';
                
                const reach = getConnectorReachCount(connectorId);
                
                return `
                    <div class="hot-item">
                        <div class="hot-item-icon">🔥</div>
                        <div class="hot-item-info">
                            <div class="hot-item-name">${connector.name}</div>
                            <div class="hot-item-meta">${connector.company || ''}</div>
                        </div>
                        <div class="hot-item-reach">
                            <div class="hot-item-reach-count">${reach}</div>
                            <div class="hot-item-reach-label">prospects</div>
                        </div>
                        <button class="hot-remove-btn" onclick="toggleHotConnector('${connectorId}')">×</button>
                    </div>
                `;
            }).join('');
        }

        function showAddHotConnector() {
            // Create a simple modal to search and add connectors
            const connectors = toolData.mutualConnections
                .filter(c => !isHotConnector(c.id))
                .sort((a, b) => (getConnectorReachCount(b.id) - getConnectorReachCount(a.id)));
            
            const modalHtml = `
                <div class="add-hot-modal" id="add-hot-modal">
                    <div class="add-hot-modal-content">
                        <div class="add-hot-modal-header">
                            <h3>Add Hot Connector</h3>
                            <button class="add-hot-modal-close" onclick="closeAddHotModal()">×</button>
                        </div>
                        <input type="text" class="add-hot-search" placeholder="Search connectors..." oninput="filterHotConnectorList(this.value)">
                        <div class="add-hot-list" id="add-hot-list">
                            ${connectors.slice(0, 20).map(c => `
                                <div class="add-hot-item" onclick="toggleHotConnector('${c.id}'); closeAddHotModal();">
                                    <span class="add-hot-item-name">${c.name}</span>
                                    <span class="add-hot-item-company">${c.company || ''}</span>
                                    <span class="add-hot-item-reach">${getConnectorReachCount(c.id)} prospects</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to body
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer.firstElementChild);
        }

        function closeAddHotModal() {
            const modal = document.getElementById('add-hot-modal');
            if (modal) modal.remove();
        }

        function filterHotConnectorList(search) {
            const searchLower = search.toLowerCase();
            const connectors = toolData.mutualConnections
                .filter(c => !isHotConnector(c.id))
                .filter(c => c.name.toLowerCase().includes(searchLower) || (c.company && c.company.toLowerCase().includes(searchLower)))
                .sort((a, b) => (getConnectorReachCount(b.id) - getConnectorReachCount(a.id)))
                .slice(0, 20);
            
            const listEl = document.getElementById('add-hot-list');
            if (listEl) {
                listEl.innerHTML = connectors.map(c => `
                    <div class="add-hot-item" onclick="toggleHotConnector('${c.id}'); closeAddHotModal();">
                        <span class="add-hot-item-name">${c.name}</span>
                        <span class="add-hot-item-company">${c.company || ''}</span>
                        <span class="add-hot-item-reach">${getConnectorReachCount(c.id)} prospects</span>
                    </div>
                `).join('');
            }
        }

        function getConnectorReachCount(connectorId) {
            return toolData.relationships.filter(r => r.connectorId === connectorId).length;
        }

        // Check if firm has any hot connector paths
        function firmHasHotPath(firmId) {
            const firmPaths = toolData.relationships.filter(r => r.firmId === firmId);
            return firmPaths.some(p => isHotConnector(p.connectorId));
        }

        // Get count of saved paths for a firm
        function getSavedPathsCountForFirm(firmId) {
            const firm = toolData.firms.find(f => f.id === firmId);
            if (!firm) return 0;
            return savedPaths.filter(p => p.firmName === firm.name).length;
        }

        // Priority firms (stored in localStorage)
        let priorityFirms = JSON.parse(localStorage.getItem('fourbridge_priority_firms') || '[]');

        function isPriorityFirm(firmId) {
            return priorityFirms.includes(firmId);
        }

        function togglePriorityFirm(firmId) {
            const idx = priorityFirms.indexOf(firmId);
            if (idx >= 0) {
                priorityFirms.splice(idx, 1);
                showToast('Removed from high priority');
            } else {
                priorityFirms.push(firmId);
                showToast('🎯 Marked as high priority!');
            }
            localStorage.setItem('fourbridge_priority_firms', JSON.stringify(priorityFirms));
            renderProspectsView();
        }

        // ========== NETWORK INTELLIGENCE ==========
        let networkIntelligence = {
            schools: new Map(),
            companies: new Map(),
            locations: new Map()
        };
        let currentIntelCategory = 'all';

        function extractNetworkIntelligence() {
            // Reset data with expanded categories
            networkIntelligence = {
                schools: new Map(),
                companies: new Map(),
                locations: new Map(),
                boards: new Map(),
                generations: new Map(),
                families: new Map(),      // NEW: Family relationships
                foundations: new Map(),   // NEW: Philanthropic foundations
                military: new Map()       // NEW: Military service
            };

            // Process prospect research data
            Object.entries(toolData.prospectResearch).forEach(([normalizedName, research]) => {
                // Find the actual prospect
                const prospect = toolData.prospects.find(p => normalizeName(p.name) === normalizedName);
                if (!prospect) return;

                const firm = toolData.firms.find(f => f.id === prospect.firmId);
                const prospectInfo = {
                    id: prospect.id,
                    name: prospect.name,
                    title: prospect.title,
                    firmName: firm?.name || '',
                    firmId: firm?.id || ''
                };

                // Extract schools with structured data (entity + degree + year)
                if (research.education) {
                    const schools = extractAllSchools(research.education);
                    schools.forEach(school => {
                        const key = school.name.toLowerCase().trim();
                        if (key.length < 3) return;
                        if (!networkIntelligence.schools.has(key)) {
                            networkIntelligence.schools.set(key, { 
                                name: school.name, 
                                people: [],
                                details: school.details || []
                            });
                        }
                        const existing = networkIntelligence.schools.get(key);
                        if (!existing.people.find(p => p.id === prospectInfo.id)) {
                            // Store person with their specific degree details
                            const personWithDetails = { 
                                ...prospectInfo, 
                                details: school.details || []
                            };
                            existing.people.push(personWithDetails);
                        }
                    });
                }

                // Extract companies from career history
                if (research.careerHistory) {
                    const companies = extractAllCompanies(research.careerHistory);
                    companies.forEach(company => {
                        const key = company.toLowerCase().trim();
                        if (key.length < 2) return;
                        if (!networkIntelligence.companies.has(key)) {
                            networkIntelligence.companies.set(key, { name: company, people: [] });
                        }
                        if (!networkIntelligence.companies.get(key).people.find(p => p.id === prospectInfo.id)) {
                            networkIntelligence.companies.get(key).people.push(prospectInfo);
                        }
                    });
                }

                // Extract board seats
                if (research.boardSeats) {
                    const boards = extractAllBoards(research.boardSeats);
                    boards.forEach(board => {
                        const key = board.toLowerCase().trim();
                        if (key.length < 3) return;
                        if (!networkIntelligence.boards.has(key)) {
                            networkIntelligence.boards.set(key, { name: board, people: [] });
                        }
                        if (!networkIntelligence.boards.get(key).people.find(p => p.id === prospectInfo.id)) {
                            networkIntelligence.boards.get(key).people.push(prospectInfo);
                        }
                    });
                    
                    // Also extract foundations from board seats
                    const foundations = extractFoundations(research.boardSeats);
                    foundations.forEach(foundation => {
                        const key = foundation.name.toLowerCase().trim();
                        if (!networkIntelligence.foundations.has(key)) {
                            networkIntelligence.foundations.set(key, { 
                                name: foundation.name, 
                                established: foundation.established,
                                people: [] 
                            });
                        }
                        if (!networkIntelligence.foundations.get(key).people.find(p => p.id === prospectInfo.id)) {
                            networkIntelligence.foundations.get(key).people.push(prospectInfo);
                        }
                    });
                }

                // Extract family generation (G1, G2, G3, spouse, etc.)
                if (research.familyRole) {
                    const gen = extractGeneration(research.familyRole);
                    if (gen) {
                        const key = gen.toLowerCase();
                        if (!networkIntelligence.generations.has(key)) {
                            networkIntelligence.generations.set(key, { name: gen, people: [] });
                        }
                        if (!networkIntelligence.generations.get(key).people.find(p => p.id === prospectInfo.id)) {
                            networkIntelligence.generations.get(key).people.push(prospectInfo);
                        }
                    }
                    
                    // Extract family relationships
                    const relationships = extractFamilyRelationships(research.familyRole, prospect.name);
                    relationships.forEach(rel => {
                        // Create a family connection entry
                        const familyName = extractFamilySurname(rel.name);
                        if (familyName && familyName.length > 2) {
                            const key = familyName.toLowerCase();
                            if (!networkIntelligence.families.has(key)) {
                                networkIntelligence.families.set(key, { 
                                    name: familyName + ' Family', 
                                    people: [],
                                    connections: []
                                });
                            }
                            const existing = networkIntelligence.families.get(key);
                            if (!existing.people.find(p => p.id === prospectInfo.id)) {
                                existing.people.push({
                                    ...prospectInfo,
                                    relationship: rel.relation,
                                    relatedTo: rel.name
                                });
                            }
                        }
                    });
                }
                
                // Extract military service from career history
                if (research.careerHistory) {
                    const militaryServices = extractMilitaryService(research.careerHistory);
                    militaryServices.forEach(service => {
                        const key = service.branch.toLowerCase().replace(/[^a-z]/g, '');
                        if (!networkIntelligence.military.has(key)) {
                            networkIntelligence.military.set(key, { 
                                name: service.branch, 
                                people: [] 
                            });
                        }
                        if (!networkIntelligence.military.get(key).people.find(p => p.id === prospectInfo.id)) {
                            networkIntelligence.military.get(key).people.push({
                                ...prospectInfo,
                                role: service.role,
                                years: service.startYear && service.endYear ? `${service.startYear}-${service.endYear}` : null
                            });
                        }
                    });
                }
            });
            
            // Also extract from firm research
            Object.entries(toolData.firmResearch || {}).forEach(([normalizedName, research]) => {
                // Extract foundations from firm research
                const allText = [
                    research.keyRelationships || '',
                    research.researchNotes || '',
                    research.keyMilestones || ''
                ].join(' ');
                
                const foundations = extractFoundations(allText);
                foundations.forEach(foundation => {
                    const key = foundation.name.toLowerCase().trim();
                    if (!networkIntelligence.foundations.has(key)) {
                        networkIntelligence.foundations.set(key, { 
                            name: foundation.name, 
                            established: foundation.established,
                            people: [],
                            firmSource: normalizedName
                        });
                    }
                });
            });
            
            // Helper function to extract surname from a full name
            function extractFamilySurname(fullName) {
                if (!fullName) return null;
                const parts = fullName.trim().split(/\s+/);
                if (parts.length === 0) return null;
                // Return last part, removing any suffix like Jr., Sr., III
                let surname = parts[parts.length - 1];
                if (/^(Jr\.?|Sr\.?|II|III|IV|V)$/i.test(surname) && parts.length > 1) {
                    surname = parts[parts.length - 2];
                }
                return surname.replace(/[,\.]/g, '');
            }

            // Extract locations from firms
            toolData.firms.forEach(firm => {
                if (firm.normalizedState && firm.normalizedState.length > 0) {
                    const prospects = toolData.prospects.filter(p => p.firmId === firm.id);
                    
                    firm.normalizedState.forEach(state => {
                        const locationName = ALL_LOCATIONS.us.locations[state] || ALL_LOCATIONS.international.locations[state] || state;
                        const key = state.toLowerCase();
                        
                        if (!networkIntelligence.locations.has(key)) {
                            networkIntelligence.locations.set(key, { name: locationName, code: state, people: [] });
                        }
                        
                        prospects.forEach(p => {
                            const prospectInfo = {
                                id: p.id,
                                name: p.name,
                                title: p.title,
                                firmName: firm.name,
                                firmId: firm.id
                            };
                            if (!networkIntelligence.locations.get(key).people.find(x => x.id === p.id)) {
                                networkIntelligence.locations.get(key).people.push(prospectInfo);
                            }
                        });
                    });
                }
            });
            
            // Also extract locations mentioned in prospect research
            toolData.prospects.forEach(p => {
                const research = getProspectResearch(p.name);
                if (!research) return;
                
                const firm = toolData.firms.find(f => f.id === p.firmId);
                const prospectInfo = {
                    id: p.id,
                    name: p.name,
                    title: p.title,
                    firmName: firm?.name || p.firmName || '',
                    firmId: p.firmId
                };
                
                // Search all research text for locations
                const textToSearch = [
                    research.careerHistory || '',
                    research.education || '',
                    research.notableAchievements || '',
                    research.researchNotes || ''
                ].join(' ');
                
                const extractedLocations = extractLocationsFromText(textToSearch);
                extractedLocations.forEach(loc => {
                    const key = loc.code.toLowerCase();
                    if (!networkIntelligence.locations.has(key)) {
                        networkIntelligence.locations.set(key, { name: loc.name, code: loc.code, people: [] });
                    }
                    if (!networkIntelligence.locations.get(key).people.find(x => x.id === p.id)) {
                        networkIntelligence.locations.get(key).people.push(prospectInfo);
                    }
                });
            });

            console.log('Network Intelligence extracted:', {
                schools: networkIntelligence.schools.size,
                companies: networkIntelligence.companies.size,
                locations: networkIntelligence.locations.size,
                boards: networkIntelligence.boards.size,
                generations: networkIntelligence.generations.size,
                families: networkIntelligence.families.size,
                foundations: networkIntelligence.foundations.size,
                military: networkIntelligence.military.size
            });
        }
        
        // Extract locations from text using patterns
        function extractLocationsFromText(text) {
            const locations = [];
            if (!text) return locations;
            
            // International locations to look for
            const internationalLocations = {
                'cayman islands': { name: 'Cayman Islands', code: 'CYM' },
                'george town': { name: 'Cayman Islands', code: 'CYM' },
                'grand cayman': { name: 'Cayman Islands', code: 'CYM' },
                'bahamas': { name: 'Bahamas', code: 'BHS' },
                'nassau': { name: 'Bahamas', code: 'BHS' },
                'bermuda': { name: 'Bermuda', code: 'BMU' },
                'british virgin islands': { name: 'British Virgin Islands', code: 'VGB' },
                'bvi': { name: 'British Virgin Islands', code: 'VGB' },
                'switzerland': { name: 'Switzerland', code: 'CHE' },
                'zurich': { name: 'Switzerland', code: 'CHE' },
                'geneva': { name: 'Switzerland', code: 'CHE' },
                'london': { name: 'United Kingdom', code: 'GBR' },
                'united kingdom': { name: 'United Kingdom', code: 'GBR' },
                'england': { name: 'United Kingdom', code: 'GBR' },
                'singapore': { name: 'Singapore', code: 'SGP' },
                'hong kong': { name: 'Hong Kong', code: 'HKG' },
                'dubai': { name: 'United Arab Emirates', code: 'ARE' },
                'uae': { name: 'United Arab Emirates', code: 'ARE' },
                'abu dhabi': { name: 'United Arab Emirates', code: 'ARE' },
                'monaco': { name: 'Monaco', code: 'MCO' },
                'luxembourg': { name: 'Luxembourg', code: 'LUX' },
                'ireland': { name: 'Ireland', code: 'IRL' },
                'dublin': { name: 'Ireland', code: 'IRL' },
                'jersey': { name: 'Jersey', code: 'JEY' },
                'guernsey': { name: 'Guernsey', code: 'GGY' },
                'isle of man': { name: 'Isle of Man', code: 'IMN' },
                'canada': { name: 'Canada', code: 'CAN' },
                'toronto': { name: 'Canada', code: 'CAN' },
                'vancouver': { name: 'Canada', code: 'CAN' },
                'montreal': { name: 'Canada', code: 'CAN' },
                'calgary': { name: 'Canada', code: 'CAN' },
                'mexico': { name: 'Mexico', code: 'MEX' },
                'mexico city': { name: 'Mexico', code: 'MEX' },
                'israel': { name: 'Israel', code: 'ISR' },
                'tel aviv': { name: 'Israel', code: 'ISR' },
                'jerusalem': { name: 'Israel', code: 'ISR' },
                'india': { name: 'India', code: 'IND' },
                'mumbai': { name: 'India', code: 'IND' },
                'bangalore': { name: 'India', code: 'IND' },
                'delhi': { name: 'India', code: 'IND' },
                'germany': { name: 'Germany', code: 'DEU' },
                'berlin': { name: 'Germany', code: 'DEU' },
                'munich': { name: 'Germany', code: 'DEU' },
                'frankfurt': { name: 'Germany', code: 'DEU' },
                'france': { name: 'France', code: 'FRA' },
                'paris': { name: 'France', code: 'FRA' },
                'australia': { name: 'Australia', code: 'AUS' },
                'sydney': { name: 'Australia', code: 'AUS' },
                'melbourne': { name: 'Australia', code: 'AUS' },
                'japan': { name: 'Japan', code: 'JPN' },
                'tokyo': { name: 'Japan', code: 'JPN' },
                'china': { name: 'China', code: 'CHN' },
                'beijing': { name: 'China', code: 'CHN' },
                'shanghai': { name: 'China', code: 'CHN' },
                'south korea': { name: 'South Korea', code: 'KOR' },
                'korea': { name: 'South Korea', code: 'KOR' },
                'seoul': { name: 'South Korea', code: 'KOR' },
                'brazil': { name: 'Brazil', code: 'BRA' },
                'sao paulo': { name: 'Brazil', code: 'BRA' },
                'rio de janeiro': { name: 'Brazil', code: 'BRA' },
                'netherlands': { name: 'Netherlands', code: 'NLD' },
                'amsterdam': { name: 'Netherlands', code: 'NLD' }
            };
            
            const lowerText = text.toLowerCase();
            
            // Check for international locations with word boundary matching
            Object.entries(internationalLocations).forEach(([search, loc]) => {
                // Use word boundary regex to avoid partial matches (e.g., 'india' in 'indiana')
                const regex = new RegExp(`\\b${search}\\b`, 'i');
                if (regex.test(lowerText)) {
                    // Avoid duplicates
                    if (!locations.find(l => l.code === loc.code)) {
                        locations.push(loc);
                    }
                }
            });
            
            return locations;
        }

        // Extract schools with structured data (entity + degree + year)
        function extractAllSchools(text) {
            const schools = new Map(); // Use Map to dedupe by school name
            
            // Helper to add school with optional detail
            const addSchool = (name, detail = null, year = null) => {
                const cleanName = name.replace(/\s+/g, ' ').trim();
                if (cleanName.length < 3) return;
                if (/^(the|at|from|to|a|an)$/i.test(cleanName)) return;
                
                const key = cleanName.toLowerCase();
                if (!schools.has(key)) {
                    schools.set(key, { name: cleanName, details: [] });
                }
                if (detail) {
                    const existing = schools.get(key);
                    if (!existing.details.find(d => d.detail === detail)) {
                        existing.details.push({ detail, year });
                    }
                }
            };
            
            // Pattern: Full degree string "Bachelor of X from University"
            const fullDegreePattern = /(Bachelor|Master|Doctor|Associate)(?:'s)?(?:\s+of\s+(?:Science|Arts|Business|Laws|Engineering|Fine Arts|Education))?\s+(?:in\s+)?([\w\s&,]+?)\s+(?:from|at)\s+([\w\s\-']+?(?:University|College|Institute|School)[^,\.]*?)(?:\s*[\(\[](\d{4})[\)\]])?/gi;
            let match;
            while ((match = fullDegreePattern.exec(text)) !== null) {
                const degreeType = match[1];
                const field = match[2].trim();
                const school = match[3].trim();
                const year = match[4] || null;
                const abbrev = degreeType.startsWith('Bachelor') ? 'B' : degreeType.startsWith('Master') ? 'M' : degreeType.startsWith('Doctor') ? 'PhD' : '';
                addSchool(school, `${abbrev}${field ? ' ' + field : ''}`, year);
            }
            
            // Pattern: "MBA/JD/PhD from X (year)"
            const degreeFromPattern = /(BA|BS|MBA|JD|PhD|MD|MS|MA|BBA|MFA|LLB|LLM|MPA|MPP|MSW|MPH)\s+(?:in\s+[\w\s&]+?\s+)?(?:from|at)\s+([\w\s\-']+?)(?:\s*[\(\[](\d{4})[\)\]])?(?:\s*[,\.]|\s+(?:and|where|He|She|They|\d{4}))/gi;
            while ((match = degreeFromPattern.exec(text)) !== null) {
                const degree = match[1];
                const school = match[2].trim();
                const year = match[3] || null;
                addSchool(school, degree, year);
            }
            
            // Pattern: "X University/College (year)" or "graduated from X (year)"
            const uniYearPattern = /([\w\s\-']+?(?:University|College|Institute))\s*[\(\[](\d{4})[\)\]]/gi;
            while ((match = uniYearPattern.exec(text)) !== null) {
                addSchool(match[1].trim(), null, match[2]);
            }
            
            // Pattern: "University of X" - captures any university
            const uniOfPattern = /University of ([\w\s\-']+?)(?:\s*[,\.\(\)]|\s+(?:where|with|and|in|for|earning|received|graduated|class|degree|BA|BS|MBA|JD|PhD|MD|MS|MA))/gi;
            while ((match = uniOfPattern.exec(text)) !== null) {
                addSchool('University of ' + match[1].trim());
            }
            
            // Pattern: "X University" - captures any university
            const uniPattern = /([\w\s\-']+?)\s+University(?:\s*[,\.\(\)]|\s+(?:where|with|and|in|for|earning|received|graduated|class|degree))?/gi;
            while ((match = uniPattern.exec(text)) !== null) {
                const name = match[1].trim();
                if (name.length > 2 && !name.match(/^(the|at|from|to|a|an)$/i)) {
                    addSchool(name + ' University');
                }
            }
            
            // Pattern: "X College" 
            const collegePattern = /([\w\s\-']+?)\s+College(?:\s*[,\.\(\)]|\s+(?:where|with|and|in|for|earning|received|graduated|class|degree))?/gi;
            while ((match = collegePattern.exec(text)) !== null) {
                const name = match[1].trim();
                if (name.length > 2 && !name.match(/^(the|at|from|to|a|an|community)$/i)) {
                    addSchool(name + ' College');
                }
            }
            
            // Pattern: "X Institute" (like MIT, Caltech)
            const institutePattern = /([\w\s\-']+?)\s+Institute(?:\s+of\s+[\w\s]+)?(?:\s*[,\.\(\)])?/gi;
            while ((match = institutePattern.exec(text)) !== null) {
                addSchool(match[0].trim().replace(/[,\.\(\)]+$/, ''));
            }
            
            // Pattern: "X School of Business/Law/Medicine" (graduate schools)
            const schoolOfPattern = /([\w\s\-']+?)\s+(School\s+of\s+(?:Business|Law|Medicine|Engineering|Management|Government|Public Policy)[\w\s]*?)(?:\s*[,\.\(\)]|\s+(?:where|and|in))/gi;
            while ((match = schoolOfPattern.exec(text)) !== null) {
                // Add the graduate school as a sub-entity detail
                const gradSchool = match[1].trim() + ' ' + match[2].trim();
                addSchool(gradSchool);
            }
            
            // Pattern: Known abbreviations with expansions
            const knownSchools = {
                'MIT': 'Massachusetts Institute of Technology',
                'UCLA': 'UCLA',
                'USC': 'USC',
                'NYU': 'New York University',
                'LSE': 'London School of Economics',
                'INSEAD': 'INSEAD',
                'HBS': 'Harvard Business School',
                'CBS': 'Columbia Business School',
                'Wharton': 'Wharton School (UPenn)',
                'Kellogg': 'Kellogg School of Management',
                'Booth': 'Booth School of Business (Chicago)',
                'Sloan': 'MIT Sloan',
                'Haas': 'Haas School of Business (Berkeley)',
                'Tuck': 'Tuck School of Business (Dartmouth)',
                'Darden': 'Darden School of Business (UVA)',
                'Fuqua': 'Fuqua School of Business (Duke)',
                'Ross': 'Ross School of Business (Michigan)',
                'Stern': 'NYU Stern',
                'Anderson': 'UCLA Anderson',
                'McCombs': 'McCombs School of Business (UT Austin)',
                'Tepper': 'Tepper School of Business (CMU)',
                'Stanford GSB': 'Stanford Graduate School of Business'
            };
            
            const abbrevPattern = new RegExp('\\b(' + Object.keys(knownSchools).join('|') + ')\\b', 'gi');
            while ((match = abbrevPattern.exec(text)) !== null) {
                addSchool(knownSchools[match[1]] || match[1]);
            }
            
            // Return array of structured school objects
            return [...schools.values()];
        }
        
        // Extract family relationships from text
        function extractFamilyRelationships(text, prospectName) {
            const relationships = [];
            if (!text) return relationships;
            
            // Pattern: "Son/Daughter of X and Y"
            const childOfPattern = /(son|daughter)\s+of\s+([\w\s\.\-']+?)(?:\s+and\s+([\w\s\.\-']+?))?(?:\s*[,\.]|\s+(?:He|She|They|who|and|married))/gi;
            let match;
            while ((match = childOfPattern.exec(text)) !== null) {
                const relation = match[1].toLowerCase() === 'son' ? 'child of' : 'child of';
                if (match[2]) relationships.push({ type: 'parent', name: match[2].trim(), relation: 'Father/Mother' });
                if (match[3]) relationships.push({ type: 'parent', name: match[3].trim(), relation: 'Father/Mother' });
            }
            
            // Pattern: "Married to X" or "Spouse: X"
            const spousePattern = /(?:married to|spouse[:\s]+|wife[:\s]+|husband[:\s]+)([\w\s\.\-']+?)(?:\s*[,\.]|\s+(?:who|and|since|in|\())/gi;
            while ((match = spousePattern.exec(text)) !== null) {
                relationships.push({ type: 'spouse', name: match[1].trim(), relation: 'Spouse' });
            }
            
            // Pattern: "Brother/Sister: X" or "Brothers: X, Y"
            const siblingPattern = /(?:brother|sister)s?[:\s]+([\w\s\.\-',]+?)(?:\s*[,\.]|\s+(?:He|She|and|who))/gi;
            while ((match = siblingPattern.exec(text)) !== null) {
                const siblings = match[1].split(/[,&]/).map(s => s.trim()).filter(s => s.length > 2);
                siblings.forEach(sib => {
                    relationships.push({ type: 'sibling', name: sib, relation: 'Sibling' });
                });
            }
            
            // Pattern: "Father/Mother of X"
            const parentOfPattern = /(father|mother)\s+of\s+([\w\s\.\-']+?)(?:\s*[,\.]|\s+(?:and|who))/gi;
            while ((match = parentOfPattern.exec(text)) !== null) {
                relationships.push({ type: 'child', name: match[2].trim(), relation: 'Child' });
            }
            
            // Pattern: "Son-in-law/Daughter-in-law of X"
            const inLawPattern = /(son|daughter)-in-law\s+of\s+([\w\s\.\-']+?)(?:\s*[,\.]|\s+(?:and|who))/gi;
            while ((match = inLawPattern.exec(text)) !== null) {
                relationships.push({ type: 'in-law', name: match[2].trim(), relation: 'Parent-in-law' });
            }
            
            // Pattern: "(daughter/son of X)" in parentheses
            const parenPattern = /\((?:daughter|son)\s+of\s+([\w\s\.\-']+?)\)/gi;
            while ((match = parenPattern.exec(text)) !== null) {
                relationships.push({ type: 'parent', name: match[1].trim(), relation: 'Parent' });
            }
            
            return relationships;
        }
        
        // Extract military/government service
        function extractMilitaryService(text) {
            const services = [];
            if (!text) return services;
            
            // Military branches
            const militaryPattern = /(?:served|service|veteran|enlisted|commissioned|officer)\s+(?:in|with|as)?\s*(?:the\s+)?(United States|US|U\.S\.)?\s*(Marine Corps|Marines|Army|Navy|Air Force|Coast Guard|National Guard|Space Force)(?:\s+(?:from|as)\s+([\w\s\-]+?))?(?:\s*[\(\[](\d{4})\s*[-–]\s*(\d{4})[\)\]])?/gi;
            let match;
            while ((match = militaryPattern.exec(text)) !== null) {
                services.push({
                    type: 'military',
                    branch: (match[1] ? match[1] + ' ' : 'US ') + match[2],
                    role: match[3] ? match[3].trim() : null,
                    startYear: match[4] || null,
                    endYear: match[5] || null
                });
            }
            
            // Direct mention pattern
            const directPattern = /(US|U\.S\.|United States)\s*(Marine Corps|Marines|Army|Navy|Air Force|Coast Guard)\s*(?:veteran)?\s*(?:[\(\[](\d{4})[-–](\d{4})[\)\]])?/gi;
            while ((match = directPattern.exec(text)) !== null) {
                if (!services.find(s => s.branch.includes(match[2]))) {
                    services.push({
                        type: 'military',
                        branch: match[1] + ' ' + match[2],
                        role: null,
                        startYear: match[3] || null,
                        endYear: match[4] || null
                    });
                }
            }
            
            return services;
        }
        
        // Extract foundations from text
        function extractFoundations(text) {
            const foundations = [];
            if (!text) return foundations;
            
            // Pattern: "X Foundation"
            const foundationPattern = /([\w\s\-']+?)\s+Foundation(?:\s*[\(\[](?:established|founded|est\.?)\s*(\d{4})[\)\]])?/gi;
            let match;
            while ((match = foundationPattern.exec(text)) !== null) {
                const name = match[1].trim() + ' Foundation';
                if (name.length > 12 && !foundations.find(f => f.name.toLowerCase() === name.toLowerCase())) {
                    foundations.push({
                        name: name,
                        established: match[2] || null
                    });
                }
            }
            
            // Pattern: "The X Fund"
            const fundPattern = /(?:The\s+)?([\w\s\-']+?)\s+(?:Family\s+)?Fund(?:\s*[\(\[](?:established|founded)\s*(\d{4})[\)\]])?/gi;
            while ((match = fundPattern.exec(text)) !== null) {
                const name = match[1].trim();
                if (name.length > 3 && !name.match(/^(hedge|mutual|index|venture|private)/i)) {
                    foundations.push({
                        name: name + ' Fund',
                        established: match[2] || null
                    });
                }
            }
            
            return foundations;
        }

        // Extract ALL companies - pattern based
        function extractAllCompanies(text) {
            const companies = new Set();
            
            // Blacklist of terms that are NOT company names
            const blacklist = [
                // Generic terms
                'hedge fund', 'hedge funds', 'the firm', 'the company', 'the office',
                'family office', 'family offices', 'private equity', 'venture capital',
                'investment firm', 'investment bank', 'asset manager', 'wealth manager',
                'finance', 'financial services', 'real estate', 'technology',
                'healthcare', 'consulting', 'advisory', 'legal', 'accounting',
                // Job titles and roles
                'director of investments', 'director of finance', 'director of operations',
                'chief investment officer', 'chief financial officer', 'chief executive officer',
                'chief operating officer', 'chief technology officer',
                'investment team member', 'team member', 'board member', 'member',
                'managing director', 'managing partner', 'general partner', 'limited partner',
                'senior vice president', 'vice president', 'executive vice president',
                'co-founder', 'founder', 'president', 'chairman', 'ceo', 'cfo', 'cio', 'coo', 'cto',
                'principal', 'partner', 'associate', 'analyst', 'consultant', 'advisor',
                'portfolio manager', 'investment manager', 'fund manager', 'asset manager',
                'head of', 'director', 'senior director', 'executive director',
                // Generic business terms
                'investments', 'investment', 'management', 'holdings', 'group', 'company',
                'corporation', 'incorporated', 'limited', 'services', 'solutions',
                // Articles and prepositions that slip through
                'the', 'a', 'an', 'and', 'or', 'for', 'with', 'at', 'of', 'in', 'to',
                // Common false positives
                'his', 'her', 'their', 'various', 'several', 'multiple', 'other',
                'both', 'all', 'many', 'some', 'few', 'most', 'any',
                'new york', 'los angeles', 'san francisco', 'chicago', 'boston', // cities aren't companies
                'currently', 'previously', 'formerly', 'presently', 'now'
            ];
            
            // Function to check if a string is blacklisted
            const isBlacklisted = (str) => {
                const lower = str.toLowerCase().trim();
                // Exact match
                if (blacklist.includes(lower)) return true;
                // Starts with blacklisted job title
                if (blacklist.some(b => lower.startsWith(b + ' ') || lower === b)) return true;
                // Is just a role description
                if (/^(investment|team|board|senior|junior|executive|managing|general|assistant)\s+(member|director|partner|officer|manager|analyst)/i.test(str)) return true;
                // Too short
                if (lower.length < 3) return true;
                // Is just initials or single word generic
                if (/^[a-z]{1,2}$/i.test(lower)) return true;
                return false;
            };
            
            // Pattern: "at X" or "with X" followed by role indicators
            const atPattern = /(?:at|with|joined|for)\s+([\w\s\-'&\.]+?)(?:\s*[,\.]|\s+(?:as|where|and|before|after|from|in|until|serving|\d{4}))/gi;
            let match;
            while ((match = atPattern.exec(text)) !== null) {
                const name = match[1].trim();
                if (!isBlacklisted(name)) {
                    companies.add(name);
                }
            }
            
            // Pattern: "X Capital/Partners/Group/Management/Advisors/Associates/Investments/Ventures/Holdings"
            const firmPattern = /([\w\s\-'&]+?)\s+(Capital|Partners|Group|Management|Advisors|Associates|Investments|Ventures|Holdings|Fund|Asset|Wealth|Private Equity|LP|LLC|Inc|Corporation|Corp)(?:\s*[,\.\(\)])?/gi;
            while ((match = firmPattern.exec(text)) !== null) {
                const name = (match[1] + ' ' + match[2]).trim();
                // Make sure the prefix isn't just a blacklisted term
                if (!isBlacklisted(match[1].trim()) && !isBlacklisted(name)) {
                    companies.add(name);
                }
            }
            
            // Pattern: "founded/co-founded X"
            const foundedPattern = /(?:founded|co-founded|started|launched|created)\s+([\w\s\-'&\.]+?)(?:\s*[,\.]|\s+(?:in|which|and|a|\d{4}))/gi;
            while ((match = foundedPattern.exec(text)) !== null) {
                const name = match[1].trim();
                if (!isBlacklisted(name)) {
                    companies.add(name);
                }
            }
            
            // Pattern: Role "of/at X" - CEO of X, Partner at X
            const rolePattern = /(?:CEO|CFO|COO|CIO|CTO|President|Chairman|Partner|Director|Managing Director|Principal|VP|Vice President|Founder|Co-Founder|Head)\s+(?:of|at)\s+([\w\s\-'&\.]+?)(?:\s*[,\.\(\)]|\s+(?:and|where|before|from|in|until|\d{4}))/gi;
            while ((match = rolePattern.exec(text)) !== null) {
                const name = match[1].trim();
                if (!isBlacklisted(name)) {
                    companies.add(name);
                }
            }
            
            // Pattern: Well-known company names that might appear without context
            const knownCompanies = /\b(Goldman Sachs|Morgan Stanley|JPMorgan|Blackstone|KKR|Carlyle|Apollo|Bain Capital|Kleiner Perkins|Sequoia|Andreessen Horowitz|Berkshire Hathaway|BlackRock|Vanguard|Fidelity|State Street|PIMCO|Bridgewater|Citadel|Two Sigma|DE Shaw|Renaissance|Point72|Millennium|Elliott|Third Point|Pershing Square|Icahn Enterprises)\b/gi;
            while ((match = knownCompanies.exec(text)) !== null) {
                companies.add(match[1]);
            }
            
            // Clean up results
            return [...companies]
                .map(s => s.replace(/\s+/g, ' ').trim())
                .filter(s => !isBlacklisted(s));
        }

        // Extract board seats - more intelligent parsing
        function extractAllBoards(text) {
            const boards = new Set();
            
            // Skip if text indicates no boards
            const lowerText = text.toLowerCase();
            const noDataPhrases = [
                'none publicly', 'not specified', 'not available', 'not disclosed', 
                'no documented', 'no board', 'n/a', 'unknown', 'tbd', 'pending',
                'none identified', 'none disclosed'
            ];
            if (noDataPhrases.some(phrase => lowerText.includes(phrase))) {
                return [];
            }
            
            // If the whole text is just "None" or similar
            if (/^(none|n\/a|unknown|tbd|not available)\.?$/i.test(text.trim())) {
                return [];
            }
            
            // Look for specific patterns that indicate board positions
            
            // Pattern 1: "Director/Trustee/Member of [Organization]"
            const ofPattern = /(?:director|trustee|member|chairman|board member)\s+(?:of\s+)?(?:the\s+)?([A-Z][A-Za-z\s&']+?(?:Foundation|Trust|Fund|Institute|Association|Society|Council|Museum|Hospital|University|College|School|Center|Centre|Board|Committee|Commission|Inc|LLC|LP|Corporation|Company|Group|Partners))/gi;
            let match;
            while ((match = ofPattern.exec(text)) !== null) {
                const name = match[1].trim();
                if (name.length > 4) {
                    boards.add(name);
                }
            }
            
            // Pattern 2: "[Organization] Foundation/Trust/etc" standalone
            const orgPattern = /([A-Z][A-Za-z]+(?:\s+[A-Z][A-Za-z]+)*\s+(?:Family\s+)?(?:Foundation|Trust|Fund|Institute|Association|Society|Council|Museum|Endowment|Charity|Charitable))/g;
            while ((match = orgPattern.exec(text)) !== null) {
                const name = match[1].trim();
                if (name.length > 4 && !name.toLowerCase().startsWith('the ')) {
                    boards.add(name);
                }
            }
            
            // Pattern 3: Look for things after "Board:" or similar headers
            const afterColonPattern = /(?:boards?|directorships?|trusteeships?):\s*([^\.]+)/gi;
            while ((match = afterColonPattern.exec(text)) !== null) {
                const orgs = match[1].split(/[,;]|\band\b/i);
                orgs.forEach(org => {
                    const cleaned = org.trim().replace(/^(the|a)\s+/i, '');
                    // Must contain at least one capital letter and be reasonably long
                    if (cleaned.length > 5 && /[A-Z]/.test(cleaned) && !/^(none|not|no)\b/i.test(cleaned)) {
                        boards.add(cleaned);
                    }
                });
            }
            
            return [...boards];
        }

        // Extract family generation
        function extractGeneration(text) {
            const lowerText = text.toLowerCase();
            
            if (lowerText.includes('founder') || lowerText.includes('patriarch') || lowerText.includes('matriarch') || lowerText.includes('g1') || lowerText.includes('first generation')) {
                return 'G1 - Founder';
            }
            if (lowerText.includes('g2') || lowerText.includes('second generation') || lowerText.includes('son of founder') || lowerText.includes('daughter of founder')) {
                return 'G2 - Second Gen';
            }
            if (lowerText.includes('g3') || lowerText.includes('third generation') || lowerText.includes('grandchild')) {
                return 'G3 - Third Gen';
            }
            if (lowerText.includes('g4') || lowerText.includes('fourth generation')) {
                return 'G4 - Fourth Gen';
            }
            if (lowerText.includes('spouse') || lowerText.includes('husband') || lowerText.includes('wife')) {
                return 'Spouse';
            }
            if (lowerText.includes('in-law')) {
                return 'In-Law';
            }
            
            return null;
        }

        // ========== CONNECTION CONTEXT & SUGGESTED ASK ==========
        
        // Get connection context between a connector and prospect
        function getConnectionContext(connectorId, prospectId) {
            const connector = toolData.mutualConnections.find(c => c.id === connectorId);
            const prospect = toolData.prospects.find(p => p.id === prospectId);
            
            if (!connector || !prospect) return { overlaps: [], strength: 0, summary: '' };
            
            const overlaps = [];
            let strengthScore = 0;
            
            // Get prospect's research
            const prospectResearch = researchData[prospect.name] || researchData[normalizeName(prospect.name)] || '';
            
            // Get prospect's firm
            const firm = toolData.firms.find(f => f.id === prospect.firmId);
            
            // Check if connector is also a prospect (would have research)
            const connectorAsProspect = toolData.prospects.find(p => 
                normalizeName(p.name) === normalizeName(connector.name)
            );
            const connectorResearch = connectorAsProspect ? 
                (researchData[connectorAsProspect.name] || researchData[normalizeName(connectorAsProspect.name)] || '') : '';
            
            // Extract intel from both
            const prospectSchools = prospectResearch ? extractAllSchools(prospectResearch) : [];
            const prospectBoards = prospectResearch ? extractAllBoards(prospectResearch) : [];
            const prospectFoundations = prospectResearch ? extractFoundations(prospectResearch) : [];
            const prospectLocations = prospectResearch ? extractLocationsFromText(prospectResearch) : [];
            
            const connectorSchools = connectorResearch ? extractAllSchools(connectorResearch) : [];
            const connectorBoards = connectorResearch ? extractAllBoards(connectorResearch) : [];
            const connectorFoundations = connectorResearch ? extractFoundations(connectorResearch) : [];
            
            // 1. Check school overlap
            const schoolOverlap = findOverlap(
                prospectSchools.map(s => normalizeName(s.name)),
                connectorSchools.map(s => normalizeName(s.name))
            );
            if (schoolOverlap.length > 0) {
                const prospectSchool = prospectSchools.find(s => normalizeName(s.name) === schoolOverlap[0]);
                const connectorSchool = connectorSchools.find(s => normalizeName(s.name) === schoolOverlap[0]);
                overlaps.push({
                    type: 'school',
                    icon: '🎓',
                    label: 'Education',
                    detail: `Both attended ${prospectSchool?.name || schoolOverlap[0]}`,
                    subdetail: prospectSchool?.year && connectorSchool?.year ? 
                        `(${connector.name} '${connectorSchool.year?.slice(-2)}, ${prospect.name} '${prospectSchool.year?.slice(-2)})` : ''
                });
                strengthScore += 25;
            }
            
            // 2. Check board overlap
            const boardOverlap = findOverlap(
                prospectBoards.map(b => normalizeName(b.name)),
                connectorBoards.map(b => normalizeName(b.name))
            );
            if (boardOverlap.length > 0) {
                const boardName = prospectBoards.find(b => normalizeName(b.name) === boardOverlap[0])?.name || boardOverlap[0];
                overlaps.push({
                    type: 'board',
                    icon: '🏛️',
                    label: 'Board',
                    detail: `Both serve on ${boardName}`,
                    subdetail: ''
                });
                strengthScore += 30;
            }
            
            // 3. Check foundation overlap
            const foundationOverlap = findOverlap(
                prospectFoundations.map(f => normalizeName(f.name)),
                connectorFoundations.map(f => normalizeName(f.name))
            );
            if (foundationOverlap.length > 0) {
                const foundationName = prospectFoundations.find(f => normalizeName(f.name) === foundationOverlap[0])?.name || foundationOverlap[0];
                overlaps.push({
                    type: 'foundation',
                    icon: '🏦',
                    label: 'Foundation',
                    detail: `Both involved with ${foundationName}`,
                    subdetail: ''
                });
                strengthScore += 25;
            }
            
            // 4. Check geographic proximity
            const connectorLocation = connector.location?.toLowerCase() || '';
            const firmLocation = firm?.location?.toLowerCase() || '';
            const prospectLocationNames = prospectLocations.map(l => l.name?.toLowerCase() || '');
            
            if (connectorLocation && firmLocation) {
                // Check if same city/state
                const connectorParts = connectorLocation.split(/[,\/]/).map(s => s.trim());
                const firmParts = firmLocation.split(/[,\/]/).map(s => s.trim());
                
                const locationMatch = connectorParts.some(cp => 
                    firmParts.some(fp => cp.includes(fp) || fp.includes(cp))
                );
                
                if (locationMatch) {
                    overlaps.push({
                        type: 'location',
                        icon: '📍',
                        label: 'Location',
                        detail: `Both connected to ${firm.location || connectorLocation}`,
                        subdetail: ''
                    });
                    strengthScore += 15;
                }
            }
            
            // 5. Check if connector works at a company mentioned in prospect's history
            if (connector.company && prospectResearch) {
                const companyLower = connector.company.toLowerCase();
                const researchLower = prospectResearch.toLowerCase();
                if (researchLower.includes(companyLower) || 
                    companyLower.split(/\s+/).some(word => word.length > 4 && researchLower.includes(word))) {
                    overlaps.push({
                        type: 'company',
                        icon: '🏢',
                        label: 'Company',
                        detail: `${connector.name} works at ${connector.company}`,
                        subdetail: `which appears in ${prospect.name}'s background`
                    });
                    strengthScore += 20;
                }
            }
            
            // 6. Mutual connection strength
            const mutualCount = connector.mutualCount || 0;
            if (mutualCount >= 100) {
                strengthScore += 20;
            } else if (mutualCount >= 50) {
                strengthScore += 15;
            } else if (mutualCount >= 20) {
                strengthScore += 10;
            } else {
                strengthScore += 5;
            }
            
            // 7. Hot connector bonus
            if (isHotConnector(connectorId)) {
                strengthScore += 15;
            }
            
            // Cap at 100
            strengthScore = Math.min(strengthScore, 100);
            
            // Generate summary
            let summary = '';
            if (overlaps.length > 0) {
                summary = overlaps.map(o => o.detail).join('. ') + '.';
            } else if (mutualCount > 50) {
                summary = `${connector.name} has ${mutualCount} mutual connections with ${prospect.name}'s network.`;
            } else {
                summary = `Connected through professional network.`;
            }
            
            return {
                overlaps,
                strength: strengthScore,
                strengthLabel: getStrengthLabel(strengthScore),
                summary,
                connector,
                prospect,
                firm
            };
        }
        
        // Helper to find overlap between two arrays
        function findOverlap(arr1, arr2) {
            return arr1.filter(item => arr2.includes(item));
        }
        
        // Get strength label from score
        function getStrengthLabel(score) {
            if (score >= 80) return { label: 'Very Strong', bars: 5, color: '#059669' };
            if (score >= 60) return { label: 'Strong', bars: 4, color: '#10b981' };
            if (score >= 40) return { label: 'Good', bars: 3, color: '#f59e0b' };
            if (score >= 20) return { label: 'Moderate', bars: 2, color: '#f97316' };
            return { label: 'Weak', bars: 1, color: '#ef4444' };
        }
        
        // Generate suggested intro request email
        function generateIntroRequest(connectorId, prospectId, teamMemberId) {
            const context = getConnectionContext(connectorId, prospectId);
            const { connector, prospect, firm, overlaps, summary } = context;
            
            if (!connector || !prospect) return null;
            
            const team = toolData.teamMembers.find(t => t.id === teamMemberId);
            const teamName = team?.name?.split(' ')[0] || 'there'; // First name
            const connectorFirst = connector.name?.split(' ')[0] || connector.name;
            
            // Build the connection hook
            let connectionHook = '';
            if (overlaps.length > 0) {
                const topOverlap = overlaps[0];
                if (topOverlap.type === 'school') {
                    connectionHook = `I noticed you and ${prospect.name} both attended ${topOverlap.detail.replace('Both attended ', '')}`;
                } else if (topOverlap.type === 'board') {
                    connectionHook = `I saw that you and ${prospect.name} ${topOverlap.detail.toLowerCase().replace('both ', '')}`;
                } else if (topOverlap.type === 'foundation') {
                    connectionHook = `I noticed you're both involved with ${topOverlap.detail.replace('Both involved with ', '')}`;
                } else if (topOverlap.type === 'location') {
                    connectionHook = `Given your connections in ${firm?.location || 'the area'}`;
                } else {
                    connectionHook = `Given your network in the family office space`;
                }
            } else {
                connectionHook = `Given your network in the family office space`;
            }
            
            // Build the ask
            const firmName = firm?.name || prospect.firmName || 'their firm';
            const prospectTitle = prospect.title ? ` (${prospect.title})` : '';
            
            const subject = `Quick intro request - ${prospect.name} at ${firmName}`;
            
            const body = `Hi ${connectorFirst},

${connectionHook}, I was hoping you might be able to help with an introduction.

I'm looking to connect with ${prospect.name}${prospectTitle} at ${firmName}. ${firm?.aum ? `They're a ${firm.aum} ${firm.type || 'family office'}` : ''} and I think there could be a great fit for what we're working on.

Would you be comfortable making an introduction? Happy to send along a brief blurb you could forward, or however you prefer to handle intros.

Really appreciate any help here.

Best,
${teamName}`;

            return {
                subject,
                body,
                context,
                canGenerate: true
            };
        }
        
        // Render connection strength bar
        function renderStrengthBar(score) {
            const { label, bars, color } = getStrengthLabel(score);
            let barsHtml = '';
            for (let i = 0; i < 5; i++) {
                const filled = i < bars;
                barsHtml += `<span class="strength-bar ${filled ? 'filled' : ''}" style="${filled ? 'background:' + color : ''}"></span>`;
            }
            return `<div class="connection-strength" title="${score}/100 - ${label}">
                <span class="strength-bars">${barsHtml}</span>
                <span class="strength-label" style="color: ${color}">${label}</span>
            </div>`;
        }
        
        // Render connection context card
        function renderConnectionContext(connectorId, prospectId) {
            const context = getConnectionContext(connectorId, prospectId);
            const { overlaps, strength, strengthLabel, summary, connector, prospect, firm } = context;
            
            if (!connector || !prospect) return '';
            
            const team = toolData.relationships.find(r => r.connectorId === connectorId);
            const teamMember = team ? toolData.teamMembers.find(t => t.id === team.teamMemberId) : null;
            
            let html = `
                <div class="connection-context-card">
                    <div class="connection-context-header">
                        <span class="connection-context-title">🔗 Connection Context</span>
                        ${renderStrengthBar(strength)}
                    </div>
                    <div class="connection-context-path">
                        <span class="path-node team">${teamMember?.name || 'Team'}</span>
                        <span class="path-arrow">→</span>
                        <span class="path-node connector ${isHotConnector(connectorId) ? 'hot' : ''}">${connector.name}</span>
                        <span class="path-arrow">→</span>
                        <span class="path-node prospect">${prospect.name}</span>
                    </div>
            `;
            
            if (overlaps.length > 0) {
                html += `<div class="connection-overlaps">`;
                overlaps.forEach(o => {
                    html += `
                        <div class="connection-overlap-item">
                            <span class="overlap-icon">${o.icon}</span>
                            <div class="overlap-info">
                                <span class="overlap-detail">${o.detail}</span>
                                ${o.subdetail ? `<span class="overlap-subdetail">${o.subdetail}</span>` : ''}
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            } else {
                html += `
                    <div class="connection-summary">
                        <p>${summary}</p>
                    </div>
                `;
            }
            
            html += `
                    <div class="connection-context-actions">
                        <button class="btn-generate-intro" onclick="showIntroRequestModal('${connectorId}', '${prospectId}', '${teamMember?.id || ''}')">
                            📝 Generate Intro Request
                        </button>
                    </div>
                </div>
            `;
            
            return html;
        }
        
        // Show intro request modal
        function showIntroRequestModal(connectorId, prospectId, teamMemberId) {
            const intro = generateIntroRequest(connectorId, prospectId, teamMemberId);
            if (!intro) return;
            
            const modal = document.getElementById('brief-modal');
            const title = document.getElementById('brief-modal-title');
            const subtitle = document.getElementById('brief-modal-subtitle');
            const body = document.getElementById('brief-modal-body');
            
            title.textContent = '📝 Intro Request Draft';
            subtitle.textContent = `${intro.context.connector?.name} → ${intro.context.prospect?.name}`;
            
            body.innerHTML = `
                <div class="intro-request-container">
                    <div class="brief-section">
                        <div class="brief-section-title"><span class="icon">🔗</span> Why This Path</div>
                        <div class="intro-context-summary">
                            ${renderStrengthBar(intro.context.strength)}
                            <p>${intro.context.summary}</p>
                            ${intro.context.overlaps.length > 0 ? `
                                <div class="intro-overlaps">
                                    ${intro.context.overlaps.map(o => `
                                        <span class="intro-overlap-tag">${o.icon} ${o.detail}</span>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="brief-section">
                        <div class="brief-section-title"><span class="icon">✉️</span> Draft Email</div>
                        <div class="intro-email-field">
                            <label>Subject:</label>
                            <input type="text" id="intro-subject" value="${intro.subject}" />
                        </div>
                        <div class="intro-email-field">
                            <label>Body:</label>
                            <textarea id="intro-body" rows="12">${intro.body}</textarea>
                        </div>
                        <div class="intro-email-actions">
                            <button onclick="copyIntroEmail()" class="btn-copy-intro">📋 Copy to Clipboard</button>
                            <button onclick="closeBriefModal()" class="btn-clear">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
        }
        
        // Copy intro email to clipboard
        function copyIntroEmail() {
            const subject = document.getElementById('intro-subject')?.value || '';
            const body = document.getElementById('intro-body')?.value || '';
            
            const fullEmail = `Subject: ${subject}\n\n${body}`;
            
            navigator.clipboard.writeText(fullEmail).then(() => {
                showToast('📋 Email copied to clipboard!');
            }).catch(() => {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = fullEmail;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('📋 Email copied!');
            });
        }

        function renderNetworkIntelligence() {
            extractNetworkIntelligence();
            
            // Update stats
            document.getElementById('intel-school-count').textContent = networkIntelligence.schools.size;
            document.getElementById('intel-company-count').textContent = networkIntelligence.companies.size;
            document.getElementById('intel-board-count').textContent = networkIntelligence.boards.size;
            document.getElementById('intel-foundation-count').textContent = networkIntelligence.foundations.size;
            document.getElementById('intel-family-count').textContent = networkIntelligence.families.size;
            document.getElementById('intel-generation-count').textContent = networkIntelligence.generations.size;
            document.getElementById('intel-military-count').textContent = networkIntelligence.military.size;
            document.getElementById('intel-location-count').textContent = networkIntelligence.locations.size;
            
            // Render cards
            renderIntelCards();
        }

        function renderIntelCards() {
            const grid = document.getElementById('intel-grid');
            const searchTerm = (document.getElementById('intel-search')?.value || '').toLowerCase();
            
            let cards = [];
            
            // Build cards based on category
            if (currentIntelCategory === 'all' || currentIntelCategory === 'schools') {
                networkIntelligence.schools.forEach((data, key) => {
                    // Skip too short names
                    if (data.name.length < 3) return;
                    
                    if (data.people.length > 0 && (!searchTerm || data.name.toLowerCase().includes(searchTerm) || data.people.some(p => p.name.toLowerCase().includes(searchTerm)))) {
                        cards.push({
                            type: 'school',
                            name: data.name,
                            people: data.people,
                            count: data.people.length,
                            details: data.details || []
                        });
                    }
                });
            }
            
            if (currentIntelCategory === 'all' || currentIntelCategory === 'companies') {
                // Comprehensive blacklist for company cards
                const companyBlacklist = [
                    // Generic terms
                    'hedge fund', 'hedge funds', 'the firm', 'the company', 'the office',
                    'family office', 'private equity', 'venture capital', 'asset management',
                    'investment firm', 'investment bank', 'wealth manager', 'finance',
                    'financial services', 'real estate', 'technology', 'healthcare',
                    // Job titles and roles
                    'director of investments', 'director of finance', 'director of operations',
                    'chief investment officer', 'investment team member', 'team member',
                    'managing director', 'managing partner', 'portfolio manager',
                    'senior vice president', 'vice president', 'co-founder', 'founder',
                    'president', 'chairman', 'ceo', 'cfo', 'cio', 'coo', 'principal',
                    'partner', 'associate', 'analyst', 'consultant', 'advisor', 'head of',
                    // Generic business terms (standalone)
                    'investments', 'investment', 'management', 'holdings', 'group',
                    'company', 'corporation', 'services', 'solutions', 'advisory',
                    // Articles
                    'the', 'a', 'an', 'and', 'or', 'for', 'with', 'at', 'of', 'in',
                    'inc', 'llc', 'corp', 'ltd', 'none', 'not', 'no', 'n/a', 'unknown'
                ];
                
                networkIntelligence.companies.forEach((data, key) => {
                    const nameLower = data.name.toLowerCase().trim();
                    
                    // Skip if too short
                    if (nameLower.length < 3) return;
                    
                    // Skip if exact match to blacklist
                    if (companyBlacklist.includes(nameLower)) return;
                    
                    // Skip if starts with common job title pattern
                    if (/^(director|chief|senior|junior|vice|executive|managing|general|head|investment team|team member)/i.test(nameLower)) return;
                    
                    // Skip if it's a role description pattern
                    if (/^(.*\s+of\s+(investments|finance|operations|marketing|sales|hr|it|technology))$/i.test(nameLower)) return;
                    
                    // Skip generic "X at Company" patterns where X is a role
                    if (/^(investment team member|team member|member|director|manager|partner|analyst|associate)\s+(at|of)\s+/i.test(nameLower)) return;
                    
                    if (data.people.length > 0 && (!searchTerm || data.name.toLowerCase().includes(searchTerm) || data.people.some(p => p.name.toLowerCase().includes(searchTerm)))) {
                        cards.push({
                            type: 'company',
                            name: data.name,
                            people: data.people,
                            count: data.people.length
                        });
                    }
                });
            }
            
            if (currentIntelCategory === 'all' || currentIntelCategory === 'boards') {
                // Additional filter for board names - skip common non-organization phrases
                const invalidBoardNames = ['none', 'inc', 'llc', 'corp', 'chairman', 'director', 'member', 'trustee', 'board', 'not specified', 'not available', 'none publicly', 'no documented', 'none disclosed', 'unknown'];
                
                networkIntelligence.boards.forEach((data, key) => {
                    const nameLower = data.name.toLowerCase().trim();
                    // Skip invalid names
                    if (nameLower.length < 5) return;
                    if (invalidBoardNames.some(invalid => nameLower === invalid || nameLower.startsWith(invalid))) return;
                    if (/^(none|not|no|inc|llc|corp|the)\b/i.test(data.name)) return;
                    
                    if (data.people.length > 0 && (!searchTerm || data.name.toLowerCase().includes(searchTerm) || data.people.some(p => p.name.toLowerCase().includes(searchTerm)))) {
                        cards.push({
                            type: 'board',
                            name: data.name,
                            people: data.people,
                            count: data.people.length
                        });
                    }
                });
            }
            
            // NEW: Foundations
            if (currentIntelCategory === 'all' || currentIntelCategory === 'foundations') {
                networkIntelligence.foundations.forEach((data, key) => {
                    if (data.name.length < 5) return;
                    if (data.people.length > 0 && (!searchTerm || data.name.toLowerCase().includes(searchTerm) || data.people.some(p => p.name.toLowerCase().includes(searchTerm)))) {
                        cards.push({
                            type: 'foundation',
                            name: data.name,
                            people: data.people,
                            count: data.people.length,
                            established: data.established
                        });
                    }
                });
            }
            
            // NEW: Families
            if (currentIntelCategory === 'all' || currentIntelCategory === 'families') {
                networkIntelligence.families.forEach((data, key) => {
                    if (data.name.length < 3) return;
                    if (data.people.length > 0 && (!searchTerm || data.name.toLowerCase().includes(searchTerm) || data.people.some(p => p.name.toLowerCase().includes(searchTerm)))) {
                        cards.push({
                            type: 'family',
                            name: data.name,
                            people: data.people,
                            count: data.people.length,
                            connections: data.connections
                        });
                    }
                });
            }
            
            if (currentIntelCategory === 'all' || currentIntelCategory === 'generations') {
                networkIntelligence.generations.forEach((data, key) => {
                    if (data.people.length > 0 && (!searchTerm || data.name.toLowerCase().includes(searchTerm) || data.people.some(p => p.name.toLowerCase().includes(searchTerm)))) {
                        cards.push({
                            type: 'generation',
                            name: data.name,
                            people: data.people,
                            count: data.people.length
                        });
                    }
                });
            }
            
            // NEW: Military
            if (currentIntelCategory === 'all' || currentIntelCategory === 'military') {
                networkIntelligence.military.forEach((data, key) => {
                    if (data.people.length > 0 && (!searchTerm || data.name.toLowerCase().includes(searchTerm) || data.people.some(p => p.name.toLowerCase().includes(searchTerm)))) {
                        cards.push({
                            type: 'military',
                            name: data.name,
                            people: data.people,
                            count: data.people.length
                        });
                    }
                });
            }
            
            if (currentIntelCategory === 'all' || currentIntelCategory === 'locations') {
                networkIntelligence.locations.forEach((data, key) => {
                    if (data.people.length > 0 && (!searchTerm || data.name.toLowerCase().includes(searchTerm) || data.people.some(p => p.name.toLowerCase().includes(searchTerm)))) {
                        cards.push({
                            type: 'location',
                            name: data.name,
                            people: data.people,
                            count: data.people.length
                        });
                    }
                });
            }
            
            // Sort by count descending
            cards.sort((a, b) => b.count - a.count);
            
            if (cards.length === 0) {
                grid.innerHTML = `
                    <div class="intel-empty" style="grid-column: 1 / -1;">
                        <div class="intel-empty-icon">🔍</div>
                        <div>No matching results found</div>
                        <div style="font-size: 13px; margin-top: 8px;">Try adjusting your search or add more prospect research data</div>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = cards.slice(0, 60).map((card, cardIdx) => {
                const typeLabels = { 
                    school: '🎓 School', 
                    company: '🏢 Company', 
                    location: '📍 Location', 
                    board: '📋 Board', 
                    generation: '📊 Generation',
                    foundation: '❤️ Foundation',
                    family: '👨‍👩‍👧 Family',
                    military: '🎖️ Military'
                };
                const typeColors = { 
                    school: 'background: linear-gradient(135deg, #004D4D 0%, #006666 100%);',
                    company: 'background: linear-gradient(135deg, #2c5282 0%, #3182ce 100%);',
                    location: 'background: linear-gradient(135deg, #744210 0%, #975a16 100%);',
                    board: 'background: linear-gradient(135deg, #553c9a 0%, #6b46c1 100%);',
                    generation: 'background: linear-gradient(135deg, #9c4221 0%, #c05621 100%);',
                    foundation: 'background: linear-gradient(135deg, #b83280 0%, #d53f8c 100%);',
                    family: 'background: linear-gradient(135deg, #276749 0%, #38a169 100%);',
                    military: 'background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);'
                };
                
                const showInitial = 5;
                const hasMore = card.count > showInitial;
                
                return `
                    <div class="intel-card" id="intel-card-${cardIdx}">
                        <div class="intel-card-header" style="${typeColors[card.type]}">
                            <div class="intel-card-title">${card.name}</div>
                            <div class="intel-card-type">${typeLabels[card.type]}</div>
                        </div>
                        <div class="intel-card-body">
                            <div class="intel-card-people-list" id="intel-people-${cardIdx}">
                                ${card.people.slice(0, showInitial).map(p => {
                                    const firm = toolData.firms.find(f => f.id === p.firmId);
                                    const firmLocation = firm?.location || '';
                                    return `
                                    <div class="intel-person" onclick="showProspectDetail('${p.id}')">
                                        <div class="intel-person-info">
                                            <div class="intel-person-name">${p.name}</div>
                                            <div class="intel-person-detail">${p.title}</div>
                                        </div>
                                        <div class="intel-person-right">
                                            <div class="intel-person-firm" onclick="event.stopPropagation(); showFirmDetail(toolData.firms.find(f=>f.id==='${p.firmId}'))">${p.firmName}</div>
                                            ${firmLocation ? `<div class="intel-person-location">${firmLocation}</div>` : ''}
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                            ${hasMore ? `
                                <div class="intel-card-more-container" id="intel-more-${cardIdx}">
                                    <!-- Hidden expanded list -->
                                    <div class="intel-card-expanded" id="intel-expanded-${cardIdx}" style="display: none;">
                                        ${card.people.slice(showInitial).map(p => {
                                            const firm = toolData.firms.find(f => f.id === p.firmId);
                                            const firmLocation = firm?.location || '';
                                            return `
                                            <div class="intel-person" onclick="showProspectDetail('${p.id}')">
                                                <div class="intel-person-info">
                                                    <div class="intel-person-name">${p.name}</div>
                                                    <div class="intel-person-detail">${p.title}</div>
                                                </div>
                                                <div class="intel-person-right">
                                                    <div class="intel-person-firm" onclick="event.stopPropagation(); showFirmDetail(toolData.firms.find(f=>f.id==='${p.firmId}'))">${p.firmName}</div>
                                                    ${firmLocation ? `<div class="intel-person-location">${firmLocation}</div>` : ''}
                                                </div>
                                            </div>
                                        `}).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        ${hasMore ? `
                            <div class="intel-card-count intel-card-toggle" onclick="toggleIntelCard(${cardIdx}, ${card.count - showInitial})">
                                <span id="intel-toggle-text-${cardIdx}">+${card.count - showInitial} more</span>
                                <span class="intel-toggle-icon" id="intel-toggle-icon-${cardIdx}">▼</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function switchIntelCategory(category) {
            currentIntelCategory = category;
            document.querySelectorAll('.intel-pill').forEach(p => p.classList.remove('active'));
            event.target.classList.add('active');
            renderIntelCards();
        }

        function filterIntelligence() {
            renderIntelCards();
        }

        function toggleIntelCard(cardIdx, moreCount) {
            const expanded = document.getElementById(`intel-expanded-${cardIdx}`);
            const toggleText = document.getElementById(`intel-toggle-text-${cardIdx}`);
            const toggleIcon = document.getElementById(`intel-toggle-icon-${cardIdx}`);
            const card = document.getElementById(`intel-card-${cardIdx}`);
            
            if (!expanded) return;
            
            const isExpanded = expanded.style.display !== 'none';
            
            if (isExpanded) {
                // Collapse
                expanded.style.display = 'none';
                toggleText.textContent = `+${moreCount} more`;
                toggleIcon.textContent = '▼';
                card.classList.remove('expanded');
            } else {
                // Expand
                expanded.style.display = 'block';
                toggleText.textContent = 'Show less';
                toggleIcon.textContent = '▲';
                card.classList.add('expanded');
            }
        }

        function findProspectAffiliations(prospect) {
            const affiliations = { schools: [], companies: [], boards: [], generation: null, military: [], families: [] };
            const research = getProspectResearch(prospect.name);
            if (!research) return affiliations;

            // Extract schools - now returns structured objects with {name, details}
            if (research.education) {
                const schoolData = extractAllSchools(research.education);
                // For display, we want clean school names, not full degree sentences
                affiliations.schools = schoolData
                    .map(s => s.name)
                    .filter(name => {
                        // Filter out sentence fragments
                        if (name.length > 80) return false; // Too long to be just a school name
                        if (/^(bachelor|master|doctor|mba|bs|ba|phd|jd|md|ms|ma)\s/i.test(name)) return false; // Starts with degree
                        if (name.includes(' from ') || name.includes(' at ') || name.includes(' in ')) return false; // Sentence structure
                        return true;
                    })
                    .slice(0, 5);
            }

            // Extract companies with filtering
            if (research.careerHistory) {
                const companies = extractAllCompanies(research.careerHistory);
                affiliations.companies = companies
                    .filter(name => {
                        const lower = name.toLowerCase();
                        // Filter out fragments and job titles
                        if (name.length > 60) return false;
                        if (/^(director|chief|senior|vice|managing|general|head|investment|team|board)/i.test(lower)) return false;
                        if (/\s(of investments|of finance|of operations)\s*$/i.test(lower)) return false;
                        if (/^(formerly|previously|currently|presently)/i.test(lower)) return false;
                        return true;
                    })
                    .slice(0, 5);
            }
            
            // Extract boards with filtering
            if (research.boardSeats) {
                const boards = extractAllBoards(research.boardSeats);
                affiliations.boards = boards
                    .filter(name => {
                        const lower = name.toLowerCase();
                        if (name.length > 60) return false;
                        if (/^(none|not|no|inc|llc|corp|chairman|director|member|trustee)/i.test(lower)) return false;
                        return true;
                    })
                    .slice(0, 3);
            }
            
            // Extract generation
            if (research.familyRole) {
                affiliations.generation = extractGeneration(research.familyRole);
            }
            
            // Extract military service
            if (research.careerHistory) {
                const militaryServices = extractMilitaryService(research.careerHistory);
                affiliations.military = militaryServices.map(s => s.branch).slice(0, 2);
            }
            
            // Extract family connections
            if (research.familyRole) {
                const familyRels = extractFamilyRelationships(research.familyRole, prospect.name);
                // Get unique family surnames
                const familySurnames = [...new Set(familyRels.map(r => {
                    const parts = r.name.split(/\s+/);
                    return parts[parts.length - 1];
                }).filter(s => s && s.length > 2))];
                affiliations.families = familySurnames.slice(0, 3);
            }

            return affiliations;
        }

        // ========== FIRM GROUPS ==========
        let firmGroups = {}; // { groupName: { name: string, firmIds: string[] } }
        let selectedFirmForGrouping = null;

        function loadFirmGroups() {
            try {
                const stored = localStorage.getItem('fourbridge_firm_groups');
                if (stored) {
                    firmGroups = JSON.parse(stored);
                }
            } catch (e) {
                console.log('Could not load firm groups:', e);
            }
        }

        function saveFirmGroups() {
            try {
                localStorage.setItem('fourbridge_firm_groups', JSON.stringify(firmGroups));
            } catch (e) {
                console.log('Could not save firm groups:', e);
            }
        }

        function renderFirmGroups() {
            renderUngroupedFirms();
            renderGroupsList();
        }

        function renderUngroupedFirms() {
            const list = document.getElementById('fg-ungrouped-list');
            const countEl = document.getElementById('fg-ungrouped-count');
            const searchTerm = (document.getElementById('fg-ungrouped-search')?.value || '').toLowerCase();
            
            if (!list) return;
            
            // Get firms that are NOT in any group
            const groupedFirmIds = new Set();
            Object.values(firmGroups).forEach(group => {
                group.firmIds.forEach(id => groupedFirmIds.add(id));
            });
            
            let ungroupedFirms = toolData.firms.filter(f => !groupedFirmIds.has(f.id));
            
            // Filter by search
            if (searchTerm) {
                ungroupedFirms = ungroupedFirms.filter(f => 
                    f.name.toLowerCase().includes(searchTerm) ||
                    (f.type || '').toLowerCase().includes(searchTerm) ||
                    (f.location || '').toLowerCase().includes(searchTerm)
                );
            }
            
            // Sort alphabetically
            ungroupedFirms.sort((a, b) => a.name.localeCompare(b.name));
            
            if (countEl) countEl.textContent = ungroupedFirms.length;
            
            if (ungroupedFirms.length === 0) {
                list.innerHTML = `<div style="text-align: center; padding: 20px; color: #6c757d; font-size: 13px;">
                    ${searchTerm ? 'No matching firms found' : 'All firms are grouped!'}
                </div>`;
                return;
            }
            
            list.innerHTML = ungroupedFirms.slice(0, 100).map(f => {
                const prospectCount = toolData.prospects.filter(p => p.firmId === f.id).length;
                return `
                    <div class="fg-firm-item" onclick="selectFirmForGrouping('${f.id}')" id="fg-firm-${f.id}">
                        <div class="fg-firm-info">
                            <div class="fg-firm-name">${f.name}</div>
                            <div class="fg-firm-meta">
                                <span class="fg-firm-type">${f.type || 'Unknown'}</span>
                                <span>${prospectCount} prospect${prospectCount !== 1 ? 's' : ''}</span>
                                ${f.location ? `<span>${f.location}</span>` : ''}
                            </div>
                        </div>
                        <button class="fg-firm-add-btn" onclick="event.stopPropagation(); promptAddToGroup('${f.id}')" title="Add to group">+</button>
                    </div>
                `;
            }).join('');
        }

        function filterUngroupedFirms() {
            renderUngroupedFirms();
        }

        function selectFirmForGrouping(firmId) {
            // Toggle selection
            if (selectedFirmForGrouping === firmId) {
                selectedFirmForGrouping = null;
                document.querySelectorAll('.fg-firm-item').forEach(el => el.classList.remove('selected'));
            } else {
                selectedFirmForGrouping = firmId;
                document.querySelectorAll('.fg-firm-item').forEach(el => el.classList.remove('selected'));
                document.getElementById(`fg-firm-${firmId}`)?.classList.add('selected');
            }
        }

        function promptAddToGroup(firmId) {
            const firm = toolData.firms.find(f => f.id === firmId);
            if (!firm) return;
            
            const groupNames = Object.keys(firmGroups);
            
            if (groupNames.length === 0) {
                // No groups exist, create one
                const groupName = prompt(`Create a new group for "${firm.name}".\n\nEnter group name (e.g., "Smith Family"):`, extractFamilyName(firm.name));
                if (groupName && groupName.trim()) {
                    createFirmGroup(groupName.trim(), [firmId]);
                }
            } else {
                // Let user choose existing group or create new
                const choice = prompt(
                    `Add "${firm.name}" to which group?\n\n` +
                    `Existing groups:\n${groupNames.map((g, i) => `  ${i + 1}. ${g}`).join('\n')}\n\n` +
                    `Enter group number, or type a new group name:`
                );
                
                if (!choice) return;
                
                const choiceNum = parseInt(choice);
                if (!isNaN(choiceNum) && choiceNum >= 1 && choiceNum <= groupNames.length) {
                    // Add to existing group
                    addFirmToGroup(firmId, groupNames[choiceNum - 1]);
                } else {
                    // Create new group
                    createFirmGroup(choice.trim(), [firmId]);
                }
            }
        }

        function extractFamilyName(firmName) {
            // Try to extract family name from firm name
            // "Smith Family Office LLC" -> "Smith Family"
            // "Johnson Holdings LP" -> "Johnson Family"
            const match = firmName.match(/^([A-Z][a-z]+)/);
            if (match) {
                return match[1] + ' Family';
            }
            return firmName.split(/\s+/)[0] + ' Family';
        }

        function createFirmGroup(name, firmIds = []) {
            if (firmGroups[name]) {
                showToast(`Group "${name}" already exists`);
                return;
            }
            
            firmGroups[name] = {
                name: name,
                firmIds: firmIds,
                createdAt: new Date().toISOString()
            };
            
            saveFirmGroups();
            renderFirmGroups();
            showToast(`Created group "${name}"`);
        }

        function createNewFirmGroup() {
            const name = prompt('Enter new group name:');
            if (name && name.trim()) {
                createFirmGroup(name.trim());
            }
        }

        function addFirmToGroup(firmId, groupName) {
            if (!firmGroups[groupName]) return;
            
            if (!firmGroups[groupName].firmIds.includes(firmId)) {
                firmGroups[groupName].firmIds.push(firmId);
                saveFirmGroups();
                renderFirmGroups();
                
                const firm = toolData.firms.find(f => f.id === firmId);
                showToast(`Added "${firm?.name}" to ${groupName}`);
            }
        }

        function removeFirmFromGroup(firmId, groupName) {
            if (!firmGroups[groupName]) return;
            
            firmGroups[groupName].firmIds = firmGroups[groupName].firmIds.filter(id => id !== firmId);
            saveFirmGroups();
            renderFirmGroups();
        }

        function deleteGroup(groupName) {
            if (confirm(`Delete group "${groupName}"? The firms will be ungrouped.`)) {
                delete firmGroups[groupName];
                saveFirmGroups();
                renderFirmGroups();
                showToast(`Deleted group "${groupName}"`);
            }
        }

        function renameGroup(oldName) {
            const newName = prompt(`Rename "${oldName}" to:`, oldName);
            if (newName && newName.trim() && newName !== oldName) {
                if (firmGroups[newName]) {
                    showToast(`Group "${newName}" already exists`);
                    return;
                }
                firmGroups[newName] = { ...firmGroups[oldName], name: newName };
                delete firmGroups[oldName];
                saveFirmGroups();
                renderFirmGroups();
            }
        }

        function renderGroupsList() {
            const list = document.getElementById('fg-groups-list');
            const empty = document.getElementById('fg-groups-empty');
            
            if (!list) return;
            
            const groupNames = Object.keys(firmGroups).sort();
            
            if (groupNames.length === 0) {
                list.innerHTML = '';
                if (empty) empty.style.display = 'block';
                return;
            }
            
            if (empty) empty.style.display = 'none';
            
            list.innerHTML = groupNames.map(groupName => {
                const group = firmGroups[groupName];
                const firms = group.firmIds.map(id => toolData.firms.find(f => f.id === id)).filter(Boolean);
                
                // Calculate aggregate stats
                const totalProspects = firms.reduce((sum, f) => {
                    return sum + toolData.prospects.filter(p => p.firmId === f.id).length;
                }, 0);
                
                const totalPaths = firms.reduce((sum, f) => {
                    return sum + toolData.relationships.filter(r => r.firmId === f.id).length;
                }, 0);
                
                const locations = [...new Set(firms.map(f => f.location).filter(Boolean))];
                
                return `
                    <div class="fg-group-card">
                        <div class="fg-group-header">
                            <span class="fg-group-name" onclick="renameGroup('${groupName}')">${groupName}</span>
                            <div class="fg-group-actions">
                                <button class="fg-group-action-btn" onclick="renameGroup('${groupName}')">Rename</button>
                                <button class="fg-group-action-btn" onclick="deleteGroup('${groupName}')">Delete</button>
                            </div>
                        </div>
                        <div class="fg-group-body">
                            ${firms.map(f => `
                                <div class="fg-group-entity">
                                    <div class="fg-entity-info">
                                        <div class="fg-entity-name" onclick="showFirmDetail(toolData.firms.find(x=>x.id==='${f.id}'))">${f.name}</div>
                                        <div class="fg-entity-meta">${f.type || 'Unknown'}${f.location ? ' • ' + f.location : ''}</div>
                                    </div>
                                    <button class="fg-entity-remove" onclick="removeFirmFromGroup('${f.id}', '${groupName}')" title="Remove from group">×</button>
                                </div>
                            `).join('')}
                            ${firms.length === 0 ? '<div style="text-align: center; padding: 12px; color: #6c757d; font-size: 13px;">No firms in this group</div>' : ''}
                        </div>
                        <div class="fg-group-stats">
                            <div class="fg-group-stat">
                                <span class="fg-group-stat-value">${firms.length}</span> entities
                            </div>
                            <div class="fg-group-stat">
                                <span class="fg-group-stat-value">${totalProspects}</span> prospects
                            </div>
                            <div class="fg-group-stat">
                                <span class="fg-group-stat-value">${totalPaths}</span> warm paths
                            </div>
                            ${locations.length > 0 ? `<div class="fg-group-stat">${locations.slice(0, 2).join(', ')}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function autoSuggestFirmGroups() {
            const suggestions = findSuggestedGroups();
            
            if (suggestions.length === 0) {
                showToast('No automatic groupings found. Try grouping manually.');
                return;
            }
            
            renderSuggestions(suggestions);
        }

        function findSuggestedGroups() {
            const suggestions = [];
            const firmNames = toolData.firms.map(f => ({ id: f.id, name: f.name }));
            const processed = new Set();
            
            // Get already grouped firms
            const groupedFirmIds = new Set();
            Object.values(firmGroups).forEach(group => {
                group.firmIds.forEach(id => groupedFirmIds.add(id));
            });
            
            firmNames.forEach(firm => {
                if (processed.has(firm.id) || groupedFirmIds.has(firm.id)) return;
                
                // Extract potential family/company name
                const baseName = extractBaseName(firm.name);
                if (!baseName || baseName.length < 3) return;
                
                // Find other firms with same base name
                const relatedFirms = firmNames.filter(other => {
                    if (other.id === firm.id || processed.has(other.id) || groupedFirmIds.has(other.id)) return false;
                    const otherBase = extractBaseName(other.name);
                    return otherBase && (
                        otherBase.toLowerCase() === baseName.toLowerCase() ||
                        other.name.toLowerCase().includes(baseName.toLowerCase()) ||
                        firm.name.toLowerCase().includes(otherBase.toLowerCase())
                    );
                });
                
                if (relatedFirms.length > 0) {
                    const allFirms = [firm, ...relatedFirms];
                    allFirms.forEach(f => processed.add(f.id));
                    
                    suggestions.push({
                        suggestedName: baseName + ' Family',
                        firms: allFirms
                    });
                }
            });
            
            return suggestions;
        }

        function extractBaseName(firmName) {
            // Remove common suffixes and extract the core name
            let name = firmName
                .replace(/\s*(LLC|LP|Inc\.?|Corporation|Corp\.?|Ltd\.?|LLP|Family Office|Holdings|Partners|Capital|Management|Advisors|Foundation|Trust|Investments|Ventures|Group)\s*/gi, ' ')
                .replace(/\s*\([^)]+\)\s*/g, '') // Remove parentheticals
                .replace(/\s*\/\s*.*/g, '') // Remove everything after /
                .trim();
            
            // Get first word(s) - usually the family name
            const words = name.split(/\s+/);
            if (words.length >= 1) {
                // Return first word if it looks like a name
                if (words[0].length >= 3 && /^[A-Z]/.test(words[0])) {
                    return words[0];
                }
            }
            
            return null;
        }

        function renderSuggestions(suggestions) {
            const panel = document.getElementById('fg-suggestions');
            const list = document.getElementById('fg-suggestions-list');
            
            if (!panel || !list) return;
            
            list.innerHTML = suggestions.map((suggestion, idx) => `
                <div class="fg-suggestion-card">
                    <div class="fg-suggestion-header">
                        <span class="fg-suggestion-name">${suggestion.suggestedName}</span>
                        <div class="fg-suggestion-actions">
                            <button class="action-btn primary small" onclick="acceptSuggestion(${idx})">Accept</button>
                            <button class="action-btn secondary small" onclick="dismissSuggestion(${idx})">Dismiss</button>
                        </div>
                    </div>
                    <div class="fg-suggestion-body">
                        ${suggestion.firms.map(f => `
                            <div class="fg-suggestion-firm">${f.name}</div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            
            // Store suggestions for reference
            window.currentSuggestions = suggestions;
            
            panel.style.display = 'block';
        }

        function acceptSuggestion(idx) {
            const suggestion = window.currentSuggestions?.[idx];
            if (!suggestion) return;
            
            // Check if name exists, if so modify it
            let groupName = suggestion.suggestedName;
            let counter = 1;
            while (firmGroups[groupName]) {
                groupName = suggestion.suggestedName + ' ' + counter;
                counter++;
            }
            
            createFirmGroup(groupName, suggestion.firms.map(f => f.id));
            
            // Remove this suggestion
            window.currentSuggestions.splice(idx, 1);
            
            if (window.currentSuggestions.length === 0) {
                closeFirmSuggestions();
            } else {
                renderSuggestions(window.currentSuggestions);
            }
        }

        function dismissSuggestion(idx) {
            window.currentSuggestions?.splice(idx, 1);
            
            if (window.currentSuggestions?.length === 0) {
                closeFirmSuggestions();
            } else {
                renderSuggestions(window.currentSuggestions);
            }
        }

        function closeFirmSuggestions() {
            const panel = document.getElementById('fg-suggestions');
            if (panel) panel.style.display = 'none';
            window.currentSuggestions = null;
        }

        function clearAllFirmGroups() {
            if (confirm('Clear all firm groups? This cannot be undone.')) {
                firmGroups = {};
                saveFirmGroups();
                renderFirmGroups();
                showToast('All firm groups cleared');
            }
        }

        // Get group for a firm (if any)
        function getFirmGroup(firmId) {
            for (const [groupName, group] of Object.entries(firmGroups)) {
                if (group.firmIds.includes(firmId)) {
                    return { name: groupName, ...group };
                }
            }
            return null;
        }

        // Get all firms in same group
        function getRelatedFirms(firmId) {
            const group = getFirmGroup(firmId);
            if (!group) return [];
            return group.firmIds
                .filter(id => id !== firmId)
                .map(id => toolData.firms.find(f => f.id === id))
                .filter(Boolean);
        }

        // Initialize action center on load
        function initActionCenter() {
            loadSavedPaths(); // Load existing saved paths
            loadEntityNotes(); // Load existing notes
            renderIntroQueue();
            renderHotConnectors();
            initTripPlanner();
            initKeyboardShortcuts();
            
            // Initialize new team panels
            renderTeamPanels();
            
            // Initialize named buckets system
            initBuckets();
            
            // Initialize saved intros sidebar
            renderSavedIntrosSidebar();
            
            // Initialize network intelligence
            renderNetworkIntelligence();
            
            // Initialize firm groups
            loadFirmGroups();
            renderFirmGroups();
        }

        // ========== TEAM PANELS FOR HOT CONNECTORS ==========
        function renderTeamPanels() {
            const teamNames = ['Ted', 'Jon', 'Chris'];
            
            teamNames.forEach(team => {
                renderTeamPanel(team.toLowerCase(), team);
            });
        }

        function renderTeamPanel(panelId, teamName) {
            const list = document.getElementById(`${panelId}-connectors-list`);
            const countEl = document.getElementById(`${panelId}-hot-count`);
            if (!list) return;
            
            // Get connectors for this team member
            let connectors = toolData.mutualConnections.filter(c => {
                return c.teamConnections && c.teamConnections.some(t => 
                    t.toLowerCase().includes(teamName.toLowerCase())
                );
            }).map(c => ({
                ...c,
                reach: getConnectorReachCount(c.id),
                isHot: isHotConnector(c.id)
            })).sort((a, b) => {
                if (a.isHot && !b.isHot) return -1;
                if (!a.isHot && b.isHot) return 1;
                return b.reach - a.reach;
            });
            
            // Count hot connectors for this team
            const hotCount = connectors.filter(c => c.isHot).length;
            if (countEl) countEl.textContent = `${hotCount} hot`;
            
            list.innerHTML = connectors.map(c => `
                <div class="ac-connector-row ${c.isHot ? 'is-hot' : ''}" onclick="showConnectorDetail('${c.id}')">
                    <button class="ac-connector-hot-btn ${c.isHot ? 'is-hot' : ''}" 
                            onclick="event.stopPropagation(); toggleHotFromPanel('${c.id}', '${panelId}')"
                            title="${c.isHot ? 'Remove from hot' : 'Mark as hot'}">
                        ${c.isHot ? '🔥' : '☆'}
                    </button>
                    <div class="ac-connector-info">
                        <div class="ac-connector-name">${c.name}</div>
                        <div class="ac-connector-meta">${c.company || c.title || ''}</div>
                        ${c.location ? `<div class="ac-connector-location">${c.location}</div>` : ''}
                    </div>
                    <div class="ac-connector-reach">${c.reach}</div>
                </div>
            `).join('');
        }

        function filterTeamPanel(panelId) {
            const teamName = panelId.charAt(0).toUpperCase() + panelId.slice(1);
            const searchInput = document.querySelector(`#panel-${panelId} .ac-panel-search`);
            const searchTerm = (searchInput?.value || '').toLowerCase();
            const list = document.getElementById(`${panelId}-connectors-list`);
            
            if (!list) return;
            
            let connectors = toolData.mutualConnections.filter(c => {
                const matchesTeam = c.teamConnections && c.teamConnections.some(t => 
                    t.toLowerCase().includes(teamName.toLowerCase())
                );
                const matchesSearch = !searchTerm || 
                    c.name.toLowerCase().includes(searchTerm) ||
                    (c.company || '').toLowerCase().includes(searchTerm) ||
                    (c.location || '').toLowerCase().includes(searchTerm);
                return matchesTeam && matchesSearch;
            }).map(c => ({
                ...c,
                reach: getConnectorReachCount(c.id),
                isHot: isHotConnector(c.id)
            })).sort((a, b) => {
                if (a.isHot && !b.isHot) return -1;
                if (!a.isHot && b.isHot) return 1;
                return b.reach - a.reach;
            });
            
            list.innerHTML = connectors.map(c => `
                <div class="ac-connector-row ${c.isHot ? 'is-hot' : ''}" onclick="showConnectorDetail('${c.id}')">
                    <button class="ac-connector-hot-btn ${c.isHot ? 'is-hot' : ''}" 
                            onclick="event.stopPropagation(); toggleHotFromPanel('${c.id}', '${panelId}')"
                            title="${c.isHot ? 'Remove from hot' : 'Mark as hot'}">
                        ${c.isHot ? '🔥' : '☆'}
                    </button>
                    <div class="ac-connector-info">
                        <div class="ac-connector-name">${c.name}</div>
                        <div class="ac-connector-meta">${c.company || c.title || ''}</div>
                        ${c.location ? `<div class="ac-connector-location">${c.location}</div>` : ''}
                    </div>
                    <div class="ac-connector-reach">${c.reach}</div>
                </div>
            `).join('');
        }

        function toggleHotFromPanel(connectorId, panelId) {
            toggleHotConnector(connectorId);
            renderTeamPanels();
            renderProspectsView();
            showToast(isHotConnector(connectorId) ? '🔥 Marked as hot!' : 'Removed from hot');
        }

        // ========== TRIP BUILDER ==========
        let currentTBDataTab = 'firms';

        function switchTBDataTab(tab) {
            currentTBDataTab = tab;
            document.querySelectorAll('.tb-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tb-tab[onclick*="${tab}"]`)?.classList.add('active');
            
            document.querySelectorAll('.trip-content').forEach(c => c.style.display = 'none');
            document.getElementById(`tb-${tab}-content`).style.display = 'block';
        }

        function switchTripTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.trip-tab').forEach(t => t.classList.remove('active'));
            event.target.closest('.trip-tab').classList.add('active');
            
            // Hide all content panels
            document.getElementById('tb-firms-content').style.display = 'none';
            document.getElementById('tb-prospects-content').style.display = 'none';
            document.getElementById('tb-connectors-content').style.display = 'none';
            
            // Show selected content
            document.getElementById(`tb-${tab}-content`).style.display = 'block';
        }

        function updateTripBuilder() {
            const location = document.getElementById('trip-location').value;
            const emptyEl = document.getElementById('trip-empty');
            const tabsEl = document.getElementById('trip-tabs');
            const firmsContent = document.getElementById('tb-firms-content');
            const prospectsContent = document.getElementById('tb-prospects-content');
            const connectorsContent = document.getElementById('tb-connectors-content');
            
            console.log('updateTripBuilder called with location:', location);
            
            if (!location) {
                // Show empty state, hide tabs and content
                if (emptyEl) emptyEl.style.display = 'block';
                if (tabsEl) tabsEl.style.display = 'none';
                if (firmsContent) firmsContent.style.display = 'none';
                if (prospectsContent) prospectsContent.style.display = 'none';
                if (connectorsContent) connectorsContent.style.display = 'none';
                
                // Clear the table bodies
                const firmsBody = document.getElementById('tb-firms-body');
                const prospectsBody = document.getElementById('tb-prospects-body');
                const connectorsBody = document.getElementById('tb-connectors-body');
                if (firmsBody) firmsBody.innerHTML = '';
                if (prospectsBody) prospectsBody.innerHTML = '';
                if (connectorsBody) connectorsBody.innerHTML = '';
                
                // Reset counts
                document.getElementById('tb-firm-count').textContent = '0';
                document.getElementById('tb-prospect-count').textContent = '0';
                document.getElementById('tb-connector-count').textContent = '0';
                return;
            }
            
            // Hide empty state, show tabs and first content panel
            if (emptyEl) emptyEl.style.display = 'none';
            if (tabsEl) tabsEl.style.display = 'flex';
            if (firmsContent) firmsContent.style.display = 'block';
            if (prospectsContent) prospectsContent.style.display = 'none';
            if (connectorsContent) connectorsContent.style.display = 'none';
            
            // Reset tab active states
            document.querySelectorAll('.trip-tab').forEach((t, i) => {
                t.classList.toggle('active', i === 0);
            });
            
            // Get the location name (US or international)
            const locationName = ALL_LOCATIONS.us.locations[location] || ALL_LOCATIONS.international.locations[location] || location;
            
            // Get firms in this location
            const firms = toolData.firms.filter(f => 
                f.normalizedState && f.normalizedState.includes(location)
            ).map(f => ({
                ...f,
                pathCount: getFirmPathCount(f.id)
            })).sort((a, b) => b.pathCount - a.pathCount);
            
            console.log('Firms found for', location, ':', firms.length);
            if (firms.length > 0) {
                console.log('First 3 firms:', firms.slice(0, 3).map(f => f.name));
            } else {
                // Debug: show what locations firms have
                const sampleFirms = toolData.firms.slice(0, 5);
                console.log('No firms found. Sample firm locations:', sampleFirms.map(f => `${f.name}: [${f.normalizedState?.join(', ') || 'none'}]`));
            }
            
            // Get prospects at these firms
            const firmIds = new Set(firms.map(f => f.id));
            const prospects = toolData.prospects.filter(p => firmIds.has(p.firmId)).map(p => {
                const firm = toolData.firms.find(f => f.id === p.firmId);
                return {
                    ...p,
                    firmName: firm?.name || '',
                    pathCount: toolData.relationships.filter(r => r.prospectId === p.id).length
                };
            }).sort((a, b) => b.pathCount - a.pathCount);
            
            // Get connectors in area
            const connectors = toolData.mutualConnections.filter(c => {
                if (!c.location) return false;
                const loc = c.location.toLowerCase();
                return loc.includes(locationName.toLowerCase()) || loc.includes(location.toLowerCase());
            }).map(c => ({
                ...c,
                reach: getConnectorReachCount(c.id),
                isHot: isHotConnector(c.id)
            })).sort((a, b) => b.reach - a.reach);
            
            // Total paths
            const totalPaths = firms.reduce((sum, f) => sum + f.pathCount, 0);
            
            // Update stats
            document.getElementById('tb-firm-count').textContent = firms.length;
            document.getElementById('tb-prospect-count').textContent = prospects.length;
            document.getElementById('tb-connector-count').textContent = connectors.length;
            
            // Render firms
            document.getElementById('tb-firms-body').innerHTML = firms.map(f => `
                <tr>
                    <td>
                        <button class="tb-add-btn ${isFirmInBucket(f.id) ? 'added' : ''}" 
                                onclick="event.stopPropagation(); toggleFirmInBucket('${f.id}')">
                            ${isFirmInBucket(f.id) ? '✓' : '+'}
                        </button>
                    </td>
                    <td onclick="showFirmDetail(toolData.firms.find(x=>x.id==='${f.id}'))" style="cursor:pointer;">
                        <strong class="clickable-name">${f.name}</strong>
                        ${f.location ? `<div class="tb-location-hint">${f.location}</div>` : ''}
                    </td>
                    <td><span class="badge badge-${(f.type||'').toLowerCase().replace(/[^a-z]/g,'-')}">${f.type || '—'}</span></td>
                    <td>${formatAUM(f.aum)}</td>
                    <td>${getWarmPathBadge(f.pathCount)}</td>
                </tr>
            `).join('');
            
            // Render prospects - Make names clickable
            document.getElementById('tb-prospects-body').innerHTML = prospects.slice(0, 100).map(p => {
                const firm = toolData.firms.find(f => f.id === p.firmId);
                const firmLocation = firm?.location || '';
                return `
                <tr>
                    <td>
                        <button class="tb-add-btn ${isProspectInBucket(p.id) ? 'added' : ''}" 
                                onclick="event.stopPropagation(); toggleProspectInBucket('${p.id}')">
                            ${isProspectInBucket(p.id) ? '✓' : '+'}
                        </button>
                    </td>
                    <td onclick="showProspectDetail('${p.id}')" style="cursor:pointer;">
                        <strong class="clickable-name">${p.name}</strong>
                    </td>
                    <td>${p.title || '—'}</td>
                    <td onclick="showFirmDetail(toolData.firms.find(f=>f.id==='${p.firmId}'))" style="cursor:pointer;">
                        <span class="clickable-name">${p.firmName}</span>
                        ${firmLocation ? `<div class="tb-location-hint">${firmLocation}</div>` : ''}
                    </td>
                    <td>${p.pathCount}</td>
                </tr>
            `}).join('');
            
            // Render connectors WITH firms they can reach in this location
            const connectorsWithFirms = toolData.mutualConnections.map(c => {
                // Get all relationships for this connector
                const rels = toolData.relationships.filter(r => r.connectorId === c.id);
                // Get firms in selected location that this connector can reach
                const reachableFirms = rels
                    .map(r => toolData.firms.find(f => f.id === r.firmId))
                    .filter(f => f && f.normalizedState && f.normalizedState.includes(location))
                    .filter((f, i, arr) => arr.findIndex(x => x.id === f.id) === i); // unique
                
                return {
                    ...c,
                    reach: getConnectorReachCount(c.id),
                    isHot: isHotConnector(c.id),
                    firmsInLocation: reachableFirms,
                    localReach: reachableFirms.length
                };
            })
            .filter(c => c.localReach > 0) // Only show connectors who can reach firms here
            .sort((a, b) => {
                // Hot connectors always first
                if (a.isHot && !b.isHot) return -1;
                if (b.isHot && !a.isHot) return 1;
                // Then by local reach
                return b.localReach - a.localReach;
            });
            
            // Update connector count to show local connectors
            document.getElementById('tb-connector-count').textContent = connectorsWithFirms.length;
            
            document.getElementById('tb-connectors-body').innerHTML = connectorsWithFirms.map((c, idx) => `
                <tr class="tb-connector-row ${c.isHot ? 'hot-connector-row' : ''}">
                    <td>
                        <button class="tb-add-btn ${isConnectorInBucket(c.id) ? 'added' : ''}" 
                                onclick="event.stopPropagation(); toggleConnectorInBucket('${c.id}')">
                            ${isConnectorInBucket(c.id) ? '✓' : '+'}
                        </button>
                    </td>
                    <td>
                        <button class="ac-connector-hot-btn ${c.isHot ? 'is-hot' : ''}" 
                                onclick="event.stopPropagation(); toggleHotConnector('${c.id}'); updateTripBuilder();">
                            ${c.isHot ? '🔥' : '☆'}
                        </button>
                    </td>
                    <td onclick="showConnectorDetail('${c.id}')" style="cursor:pointer;">
                        <strong class="clickable-name">${c.name}</strong>
                        <div style="font-size:11px;color:#6c757d;">${c.company || ''}</div>
                        ${c.location ? `<div class="tb-location-hint">${c.location}</div>` : ''}
                    </td>
                    <td onclick="toggleTBConnectorExpand(${idx})" style="cursor:pointer;">
                        <span class="tb-local-reach">${c.localReach} firm${c.localReach !== 1 ? 's' : ''} here</span>
                    </td>
                    <td style="text-align:right;" onclick="toggleTBConnectorExpand(${idx})" style="cursor:pointer;">
                        <span class="tb-expand-icon">▼</span>
                    </td>
                </tr>
                <tr class="tb-connector-firms" id="tb-connector-firms-${idx}" style="display:none;">
                    <td colspan="5" style="padding:0;">
                        <div class="tb-firms-list">
                            ${c.firmsInLocation.map(f => {
                                const firmPathCount = getFirmPathCount(f.id);
                                const isInBucket = isFirmInBucket(f.id);
                                return `
                                <div class="tb-firm-chip ${isInBucket ? 'in-bucket' : ''}" onclick="event.stopPropagation(); addFirmFromConnector('${f.id}', '${c.id}', '${c.name.replace(/'/g, "\\'")}')">
                                    <span class="tb-firm-chip-name">${f.name}</span>
                                    <span class="tb-firm-chip-type">${f.type || ''}</span>
                                    <span class="tb-firm-chip-paths">${firmPathCount} paths</span>
                                </div>
                            `}).join('')}
                        </div>
                    </td>
                </tr>
            `).join('');
            
            // Store for toggle function
            window.currentTBConnectors = connectorsWithFirms;
            
            // Show first tab
            document.getElementById('tb-firms-content').style.display = 'block';
            
            // Store for export
            window.currentTripData = { location: locationName, firms, prospects, connectors: connectorsWithFirms };
        }

        // Toggle connector expansion in Trip Builder
        function toggleTBConnectorExpand(idx) {
            const row = document.getElementById(`tb-connector-firms-${idx}`);
            if (row) {
                const isHidden = row.style.display === 'none';
                row.style.display = isHidden ? 'table-row' : 'none';
                // Update arrow
                const mainRow = row.previousElementSibling;
                if (mainRow) {
                    const icon = mainRow.querySelector('.tb-expand-icon');
                    if (icon) icon.textContent = isHidden ? '▲' : '▼';
                }
            }
        }

        function exportTripBucket() {
            exportCurrentBucket();
        }

        // ========== NAMED BUCKETS SYSTEM ==========
        // Structure: { bucketName: { items: [], location: '', createdAt: '' }, ... }
        let allBuckets = JSON.parse(localStorage.getItem('fourbridge_all_buckets') || '{}');
        let activeBucketName = localStorage.getItem('fourbridge_active_bucket') || '';

        function createNewBucket() {
            const name = prompt('Name this bucket (e.g., "NYC Trip Jan 2025", "Q1 Priority"):');
            if (!name || !name.trim()) return;
            
            const bucketName = name.trim();
            
            if (allBuckets[bucketName]) {
                if (!confirm(`"${bucketName}" already exists. Switch to it?`)) return;
            } else {
                allBuckets[bucketName] = {
                    items: [],
                    location: document.getElementById('trip-location')?.value || '',
                    createdAt: new Date().toISOString()
                };
                saveBucketsToStorage();
            }
            
            activeBucketName = bucketName;
            localStorage.setItem('fourbridge_active_bucket', activeBucketName);
            
            updateBucketDropdown();
            renderActiveBucket();
            showToast(`📁 Bucket "${bucketName}" is now active`);
        }

        function switchBucket() {
            const select = document.getElementById('active-bucket-select');
            const name = select.value;
            
            if (!name) {
                activeBucketName = '';
                localStorage.setItem('fourbridge_active_bucket', '');
                renderActiveBucket();
                return;
            }
            
            activeBucketName = name;
            localStorage.setItem('fourbridge_active_bucket', name);
            
            // If bucket has a saved location, set it
            const bucket = allBuckets[name];
            if (bucket && bucket.location) {
                const locSelect = document.getElementById('trip-location');
                if (locSelect && locSelect.value !== bucket.location) {
                    locSelect.value = bucket.location;
                    updateTripBuilder();
                }
            }
            
            renderActiveBucket();
            showToast(`📂 Switched to "${name}"`);
        }

        function getActiveBucketItems() {
            if (!activeBucketName || !allBuckets[activeBucketName]) return [];
            return allBuckets[activeBucketName].items || [];
        }

        function addToBucket(type, id, name, extra = {}) {
            if (!activeBucketName) {
                // Prompt to create a bucket first
                if (confirm('No active bucket. Create one now?')) {
                    createNewBucket();
                    if (!activeBucketName) return; // User cancelled
                } else {
                    return;
                }
            }
            
            const bucket = allBuckets[activeBucketName];
            if (!bucket) return;
            
            // Check if already in bucket
            const exists = bucket.items.some(b => b.type === type && b.id === id);
            if (exists) {
                showToast('Already in bucket');
                return;
            }
            
            bucket.items.push({
                type,
                id,
                name,
                firmName: extra.firmName || '',
                company: extra.company || '',
                firms: extra.firms || [],
                viaConnector: extra.viaConnector || '',
                viaConnectorId: extra.viaConnectorId || '',
                viaConnectorHot: extra.viaConnectorHot || false,
                addedAt: new Date().toISOString()
            });
            
            saveBucketsToStorage();
            renderActiveBucket();
            updateTripBuilder(); // Refresh to show checkmarks
            showToast(`Added to "${activeBucketName}"`);
        }

        function removeFromBucket(index) {
            if (!activeBucketName || !allBuckets[activeBucketName]) return;
            
            allBuckets[activeBucketName].items.splice(index, 1);
            saveBucketsToStorage();
            renderActiveBucket();
            updateTripBuilder();
        }

        function clearCurrentBucket() {
            if (!activeBucketName || !allBuckets[activeBucketName]) return;
            
            if (!confirm(`Clear all items from "${activeBucketName}"?`)) return;
            
            allBuckets[activeBucketName].items = [];
            saveBucketsToStorage();
            renderActiveBucket();
            updateTripBuilder();
            showToast('Bucket cleared');
        }

        function deleteCurrentBucket() {
            if (!activeBucketName) return;
            
            if (!confirm(`Delete bucket "${activeBucketName}"? This cannot be undone.`)) return;
            
            delete allBuckets[activeBucketName];
            activeBucketName = '';
            localStorage.setItem('fourbridge_active_bucket', '');
            saveBucketsToStorage();
            updateBucketDropdown();
            renderActiveBucket();
            showToast('Bucket deleted');
        }

        function exportCurrentBucket() {
            if (!activeBucketName || !allBuckets[activeBucketName]) {
                showToast('No active bucket');
                return;
            }
            
            const bucket = allBuckets[activeBucketName];
            const items = bucket.items || [];
            
            if (items.length === 0) {
                showToast('Bucket is empty');
                return;
            }
            
            let text = `═══════════════════════════════════════════════════════════\n`;
            text += `TRIP BUCKET: ${activeBucketName}\n`;
            text += `Generated: ${new Date().toLocaleDateString()}\n`;
            text += `Location: ${bucket.location || 'Not specified'}\n`;
            text += `═══════════════════════════════════════════════════════════\n\n`;
            
            const connectors = items.filter(b => b.type === 'connector');
            const firms = items.filter(b => b.type === 'firm');
            
            // CONNECTORS SECTION - Action items
            if (connectors.length > 0) {
                text += `📞 REACH OUT TO (${connectors.length})\n`;
                text += `───────────────────────────────────────────────────────────\n`;
                connectors.forEach((c, idx) => {
                    const connector = toolData.mutualConnections.find(x => x.id === c.id);
                    const isHot = isHotConnector(c.id);
                    text += `${idx + 1}. ${isHot ? '🔥 ' : ''}${c.name}\n`;
                    if (c.company) text += `   ${c.company}\n`;
                    if (connector?.location) text += `   ${connector.location}\n`;
                    if (c.firms && c.firms.length > 0) {
                        text += `   Can intro to: ${c.firms.map(f => f.name).join(', ')}\n`;
                    }
                    text += `\n`;
                });
                text += `\n`;
            }
            
            // Calculate totals
            let totalProspects = 0;
            let totalPaths = 0;
            
            // FIRMS SECTION
            if (firms.length > 0) {
                text += `🏢 FIRMS TO VISIT (${firms.length})\n`;
                text += `───────────────────────────────────────────────────────────\n`;
                firms.forEach((f, idx) => {
                    const firm = toolData.firms.find(x => x.id === f.id);
                    const location = firm?.location || '';
                    const firmProspects = toolData.prospects.filter(p => p.firmId === f.id);
                    totalProspects += firmProspects.length;
                    
                    text += `${idx + 1}. ${f.name}\n`;
                    if (f.viaConnector) text += `   Via: ${f.viaConnector}${f.viaConnectorHot ? ' 🔥' : ''}\n`;
                    if (location) text += `   Location: ${location}\n`;
                    text += `   Prospects: ${firmProspects.length}\n\n`;
                    
                    firmProspects.forEach(p => {
                        const paths = getProspectPaths(p.id);
                        totalPaths += paths.length;
                        const hasResearch = hasProspectResearch(p.name);
                        
                        text += `   👤 ${p.name}${hasResearch ? ' ★' : ''}\n`;
                        text += `      ${p.title || 'No title'}\n`;
                        
                        if (paths.length > 0) {
                            // Sort hot connectors first
                            const sortedPaths = paths.sort((a, b) => {
                                const aHot = isHotConnector(a.connector?.id) ? 1 : 0;
                                const bHot = isHotConnector(b.connector?.id) ? 1 : 0;
                                return bHot - aHot;
                            });
                            
                            text += `      Intro paths (${paths.length}):\n`;
                            sortedPaths.slice(0, 5).forEach(path => {
                                const isHot = isHotConnector(path.connector?.id);
                                text += `         ${isHot ? '🔥 ' : '• '}${path.connector?.name || 'Unknown'} (via ${path.team?.name || 'Unknown'})\n`;
                            });
                            if (paths.length > 5) {
                                text += `         ...and ${paths.length - 5} more\n`;
                            }
                        } else {
                            text += `      No intro paths\n`;
                        }
                        text += `\n`;
                    });
                    
                    text += `\n`;
                });
            }
            
            // Summary
            text += `═══════════════════════════════════════════════════════════\n`;
            text += `SUMMARY\n`;
            text += `═══════════════════════════════════════════════════════════\n`;
            text += `Connectors to Contact: ${connectors.length}\n`;
            text += `Firms: ${firms.length}\n`;
            text += `Total Prospects: ${totalProspects}\n`;
            text += `Total Intro Paths: ${totalPaths}\n`;
            
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${activeBucketName.replace(/[^a-z0-9]/gi, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function saveBucketsToStorage() {
            localStorage.setItem('fourbridge_all_buckets', JSON.stringify(allBuckets));
        }

        function updateBucketDropdown() {
            const select = document.getElementById('active-bucket-select');
            if (!select) return;
            
            const names = Object.keys(allBuckets).sort();
            
            select.innerHTML = '<option value="">Select a bucket...</option>';
            
            names.forEach(name => {
                const bucket = allBuckets[name];
                const count = bucket.items?.length || 0;
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = `${name} (${count} items)`;
                if (name === activeBucketName) opt.selected = true;
                select.appendChild(opt);
            });
        }

        function renderActiveBucket() {
            const list = document.getElementById('bucket-list');
            const empty = document.getElementById('bucket-empty');
            const actions = document.getElementById('bucket-actions');
            const count = document.getElementById('bucket-count');
            const nameLabel = document.getElementById('current-bucket-label');
            const nameContainer = document.getElementById('active-bucket-name');
            
            if (!list) return;
            
            // No active bucket
            if (!activeBucketName || !allBuckets[activeBucketName]) {
                if (empty) empty.style.display = 'block';
                if (actions) actions.style.display = 'none';
                if (nameContainer) nameContainer.style.display = 'none';
                list.innerHTML = '';
                return;
            }
            
            const items = allBuckets[activeBucketName].items || [];
            
            // Show bucket name
            if (nameContainer) nameContainer.style.display = 'flex';
            if (nameLabel) nameLabel.textContent = activeBucketName;
            
            // Separate connectors and firms
            const connectors = items.filter(b => b.type === 'connector');
            const firms = items.filter(b => b.type === 'firm');
            
            // Count total items for badge
            if (count) count.textContent = connectors.length + firms.length;
            
            if (items.length === 0) {
                if (empty) {
                    empty.style.display = 'block';
                    empty.innerHTML = '<p>Add connectors or firms to build your trip plan</p>';
                }
                if (actions) actions.style.display = 'none';
                list.innerHTML = '';
                return;
            }
            
            if (empty) empty.style.display = 'none';
            if (actions) actions.style.display = 'flex';
            
            let html = '';
            
            // CONNECTORS SECTION - "Who to reach out to"
            if (connectors.length > 0) {
                html += `
                    <div class="bucket-section connectors-section">
                        <div class="bucket-section-header">
                            <span class="bucket-section-icon">📞</span>
                            <span class="bucket-section-title">Reach Out To (${connectors.length})</span>
                        </div>
                        <div class="bucket-tree">
                `;
                
                connectors.forEach((c, connIdx) => {
                    const connector = toolData.mutualConnections.find(x => x.id === c.id);
                    const isHot = isHotConnector(c.id);
                    const actualIdx = items.findIndex(b => b.type === 'connector' && b.id === c.id);
                    
                    // Get firms this connector can intro to (in current trip location or all)
                    const connectorFirms = c.firms || [];
                    
                    html += `
                        <div class="bucket-tree-connector-block ${isHot ? 'hot' : ''}" id="bucket-conn-${connIdx}">
                            <div class="bucket-tree-connector-header" onclick="toggleBucketConnector(${connIdx})">
                                <span class="bucket-tree-toggle" id="bucket-conn-toggle-${connIdx}">${connectorFirms.length > 0 ? '▶' : ''}</span>
                                <span class="bucket-tree-icon">${isHot ? '🔥' : '🤝'}</span>
                                <div class="bucket-tree-connector-main">
                                    <div class="bucket-tree-connector-name" onclick="event.stopPropagation(); showConnectorDetail('${c.id}')">${c.name}</div>
                                    <div class="bucket-tree-connector-company">${connector?.company || ''}</div>
                                    ${connector?.location ? `<div class="bucket-tree-connector-location">${connector.location}</div>` : ''}
                                </div>
                                <div class="bucket-tree-meta">
                                    ${connectorFirms.length > 0 ? `<span class="bucket-tree-firm-count">${connectorFirms.length} firm${connectorFirms.length > 1 ? 's' : ''}</span>` : ''}
                                    <button class="bucket-remove-btn" onclick="event.stopPropagation(); removeFromBucket(${actualIdx})">×</button>
                                </div>
                            </div>
                            ${connectorFirms.length > 0 ? `
                                <div class="bucket-tree-connector-firms" id="bucket-conn-firms-${connIdx}" style="display:none;">
                                    ${connectorFirms.map(f => {
                                        const firm = toolData.firms.find(x => x.id === f.id);
                                        return `
                                            <div class="bucket-connector-firm-row" onclick="showFirmDetail(toolData.firms.find(x=>x.id==='${f.id}'))">
                                                <span class="bucket-tree-icon">🏢</span>
                                                <div class="bucket-connector-firm-info">
                                                    <div class="bucket-connector-firm-name">${f.name}</div>
                                                    ${firm?.location ? `<div class="bucket-connector-firm-location">${firm.location}</div>` : ''}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            }
            
            // FIRMS SECTION with drill-down (firms added directly, not via connector)
            if (firms.length > 0) {
                html += `
                    <div class="bucket-section firms-section">
                        <div class="bucket-section-header">
                            <span class="bucket-section-icon">🏢</span>
                            <span class="bucket-section-title">Firms (${firms.length})</span>
                        </div>
                        <div class="bucket-tree">
                `;
                
                firms.forEach((f, firmIdx) => {
                    const firm = toolData.firms.find(x => x.id === f.id);
                    const location = firm?.location || '';
                    const firmProspects = toolData.prospects.filter(p => p.firmId === f.id);
                    const actualIdx = items.findIndex(b => b.type === 'firm' && b.id === f.id);
                    const hasHotPath = firmProspects.some(p => {
                        const paths = getProspectPaths(p.id);
                        return paths.some(path => isHotConnector(path.connector?.id));
                    });
                    
                    html += `
                        <div class="bucket-tree-firm" id="bucket-firm-${firmIdx}">
                            <div class="bucket-tree-firm-header ${hasHotPath ? 'has-hot' : ''}" onclick="toggleBucketFirm(${firmIdx})">
                                <span class="bucket-tree-toggle" id="bucket-firm-toggle-${firmIdx}">▶</span>
                                <span class="bucket-tree-icon">🏢</span>
                                <div class="bucket-tree-firm-info">
                                    <div class="bucket-tree-firm-name">${f.name}</div>
                                    ${f.viaConnector ? `<div class="bucket-tree-via">via ${f.viaConnector}${f.viaConnectorHot ? ' 🔥' : ''}</div>` : ''}
                                    ${location ? `<div class="bucket-tree-location">${location}</div>` : ''}
                                </div>
                                <div class="bucket-tree-meta">
                                    <span class="bucket-tree-count">${firmProspects.length}</span>
                                    <button class="bucket-remove-btn" onclick="event.stopPropagation(); removeFromBucket(${actualIdx})">×</button>
                                </div>
                            </div>
                            <div class="bucket-tree-prospects" id="bucket-prospects-${firmIdx}" style="display:none;">
                                ${firmProspects.map((p, pIdx) => {
                                    const prospectPaths = getProspectPaths(p.id);
                                    const hasResearch = hasProspectResearch(p.name);
                                    const prospectHasHot = prospectPaths.some(path => isHotConnector(path.connector?.id));
                                    
                                    return `
                                        <div class="bucket-tree-prospect" id="bucket-prospect-${firmIdx}-${pIdx}">
                                            <div class="bucket-tree-prospect-header ${prospectHasHot ? 'has-hot' : ''}" onclick="toggleBucketProspect(${firmIdx}, ${pIdx})">
                                                <span class="bucket-tree-toggle" id="bucket-prospect-toggle-${firmIdx}-${pIdx}">${prospectPaths.length > 0 ? '▶' : ''}</span>
                                                <span class="bucket-tree-icon">👤</span>
                                                <div class="bucket-tree-prospect-info">
                                                    <div class="bucket-tree-prospect-name ${hasResearch ? 'has-research' : ''}" onclick="event.stopPropagation(); showProspectDetail('${p.id}')">${p.name}</div>
                                                    <div class="bucket-tree-prospect-title">${p.title || ''}</div>
                                                </div>
                                                ${prospectPaths.length > 0 ? `<span class="bucket-tree-path-count">${prospectPaths.length} path${prospectPaths.length > 1 ? 's' : ''}</span>` : '<span class="bucket-tree-no-paths">No paths</span>'}
                                            </div>
                                            ${prospectPaths.length > 0 ? `
                                                <div class="bucket-tree-connectors" id="bucket-connectors-${firmIdx}-${pIdx}" style="display:none;">
                                                    ${prospectPaths.sort((a, b) => {
                                                        const aHot = isHotConnector(a.connector?.id) ? 1 : 0;
                                                        const bHot = isHotConnector(b.connector?.id) ? 1 : 0;
                                                        return bHot - aHot;
                                                    }).slice(0, 10).map(path => {
                                                        const connIsHot = isHotConnector(path.connector?.id);
                                                        return `
                                                            <div class="bucket-tree-connector ${connIsHot ? 'hot' : ''}" onclick="event.stopPropagation(); showConnectorDetail('${path.connector?.id}')">
                                                                <span class="bucket-tree-icon">${connIsHot ? '🔥' : '🤝'}</span>
                                                                <div class="bucket-tree-connector-info">
                                                                    <div class="bucket-tree-connector-name">${path.connector?.name || 'Unknown'}</div>
                                                                    <div class="bucket-tree-connector-detail">via ${path.team?.name || 'Unknown'} • ${path.connector?.mutualCount || 0} mutual</div>
                                                                </div>
                                                            </div>
                                                        `;
                                                    }).join('')}
                                                    ${prospectPaths.length > 10 ? `<div class="bucket-tree-more">+${prospectPaths.length - 10} more connectors</div>` : ''}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            }
            
            // Summary stats at bottom
            const totalProspects = firms.reduce((sum, f) => {
                return sum + toolData.prospects.filter(p => p.firmId === f.id).length;
            }, 0);
            
            if (connectors.length > 0 || firms.length > 0) {
                html += `
                    <div class="bucket-summary">
                        ${connectors.length > 0 ? `
                            <div class="bucket-summary-stat">
                                <span class="bucket-summary-value">${connectors.length}</span>
                                <span class="bucket-summary-label">Connectors</span>
                            </div>
                        ` : ''}
                        <div class="bucket-summary-stat">
                            <span class="bucket-summary-value">${firms.length}</span>
                            <span class="bucket-summary-label">Firms</span>
                        </div>
                        <div class="bucket-summary-stat">
                            <span class="bucket-summary-value">${totalProspects}</span>
                            <span class="bucket-summary-label">Prospects</span>
                        </div>
                    </div>
                `;
            }
            
            list.innerHTML = html;
        }
        
        // Toggle connector expansion in bucket
        function toggleBucketConnector(connIdx) {
            const firms = document.getElementById(`bucket-conn-firms-${connIdx}`);
            const toggle = document.getElementById(`bucket-conn-toggle-${connIdx}`);
            if (firms && toggle) {
                const isHidden = firms.style.display === 'none';
                firms.style.display = isHidden ? 'block' : 'none';
                toggle.textContent = isHidden ? '▼' : '▶';
            }
        }
        
        // Helper to get paths for a prospect
        function getProspectPaths(prospectId) {
            const prospect = toolData.prospects.find(p => p.id === prospectId);
            if (!prospect) return [];
            
            const relationships = toolData.relationships.filter(r => r.firmId === prospect.firmId);
            return relationships.map(r => {
                const connector = toolData.mutualConnections.find(c => c.id === r.connectorId);
                const team = toolData.teamMembers.find(t => t.id === r.teamMemberId);
                return { connector, team, relationship: r };
            }).filter(p => p.connector);
        }
        
        // Toggle firm expansion
        function toggleBucketFirm(firmIdx) {
            const prospects = document.getElementById(`bucket-prospects-${firmIdx}`);
            const toggle = document.getElementById(`bucket-firm-toggle-${firmIdx}`);
            if (prospects && toggle) {
                const isHidden = prospects.style.display === 'none';
                prospects.style.display = isHidden ? 'block' : 'none';
                toggle.textContent = isHidden ? '▼' : '▶';
            }
        }
        
        // Toggle prospect expansion
        function toggleBucketProspect(firmIdx, prospectIdx) {
            const connectors = document.getElementById(`bucket-connectors-${firmIdx}-${prospectIdx}`);
            const toggle = document.getElementById(`bucket-prospect-toggle-${firmIdx}-${prospectIdx}`);
            if (connectors && toggle) {
                const isHidden = connectors.style.display === 'none';
                connectors.style.display = isHidden ? 'block' : 'none';
                toggle.textContent = isHidden ? '▼' : '▶';
            }
        }

        // Check if item is in active bucket
        function isInActiveBucket(type, id) {
            const items = getActiveBucketItems();
            return items.some(b => b.type === type && b.id === id);
        }

        // Legacy compatibility - redirect old functions
        function isFirmInBucket(firmId) {
            return isInActiveBucket('firm', firmId);
        }

        function isProspectInBucket(prospectId) {
            return isInActiveBucket('prospect', prospectId);
        }

        function toggleFirmInBucket(firmId) {
            if (isInActiveBucket('firm', firmId)) {
                // Remove it
                const items = getActiveBucketItems();
                const idx = items.findIndex(b => b.type === 'firm' && b.id === firmId);
                if (idx >= 0) removeFromBucket(idx);
            } else {
                const firm = toolData.firms.find(f => f.id === firmId);
                if (firm) addToBucket('firm', firmId, firm.name);
            }
        }

        function toggleProspectInBucket(prospectId) {
            if (isInActiveBucket('prospect', prospectId)) {
                // Remove it
                const items = getActiveBucketItems();
                const idx = items.findIndex(b => b.type === 'prospect' && b.id === prospectId);
                if (idx >= 0) removeFromBucket(idx);
            } else {
                const prospect = toolData.prospects.find(p => p.id === prospectId);
                const firm = prospect ? toolData.firms.find(f => f.id === prospect.firmId) : null;
                if (prospect) addToBucket('prospect', prospectId, prospect.name, { firmName: firm?.name || '' });
            }
        }

        function isConnectorInBucket(connectorId) {
            return isInActiveBucket('connector', connectorId);
        }

        function toggleConnectorInBucket(connectorId) {
            if (isInActiveBucket('connector', connectorId)) {
                // Remove it
                const items = getActiveBucketItems();
                const idx = items.findIndex(b => b.type === 'connector' && b.id === connectorId);
                if (idx >= 0) removeFromBucket(idx);
            } else {
                const connector = toolData.mutualConnections.find(c => c.id === connectorId);
                if (connector) {
                    // Get firms this connector can intro to in current trip location
                    const tripLocation = document.getElementById('trip-location')?.value;
                    const rels = toolData.relationships.filter(r => r.connectorId === connectorId);
                    let reachableFirms = rels
                        .map(r => toolData.firms.find(f => f.id === r.firmId))
                        .filter(f => f)
                        .filter((f, i, arr) => arr.findIndex(x => x.id === f.id) === i); // unique
                    
                    // Filter by trip location if set
                    if (tripLocation) {
                        reachableFirms = reachableFirms.filter(f => 
                            f.normalizedState && f.normalizedState.includes(tripLocation)
                        );
                    }
                    
                    // Store connector with firms they can reach
                    addToBucket('connector', connectorId, connector.name, { 
                        company: connector.company || '',
                        firms: reachableFirms.map(f => ({ id: f.id, name: f.name }))
                    });
                }
            }
        }
        
        // Add firm from connector chip - includes connector info and auto-loads prospects
        function addFirmFromConnector(firmId, connectorId, connectorName) {
            if (!activeBucketName) {
                if (confirm('No active bucket. Create one now?')) {
                    createNewBucket();
                    if (!activeBucketName) return;
                } else {
                    return;
                }
            }
            
            const bucket = allBuckets[activeBucketName];
            if (!bucket) return;
            
            const firm = toolData.firms.find(f => f.id === firmId);
            if (!firm) return;
            
            // Check if firm already in bucket
            const firmExists = bucket.items.some(b => b.type === 'firm' && b.id === firmId);
            
            if (firmExists) {
                showToast('Firm already in bucket');
                return;
            }
            
            // Add the firm with connector info
            bucket.items.push({
                type: 'firm',
                id: firmId,
                name: firm.name,
                viaConnector: connectorName,
                viaConnectorId: connectorId,
                addedAt: new Date().toISOString()
            });
            
            saveBucketsToStorage();
            renderActiveBucket();
            updateTripBuilder();
            showToast(`Added ${firm.name} to bucket`);
        }

        function renderTripBucket() {
            renderActiveBucket();
        }

        function clearTripBucket() {
            clearCurrentBucket();
        }

        // Initialize buckets on load
        function initBuckets() {
            updateBucketDropdown();
            renderActiveBucket();
        }

        // Note: initBuckets is called from initActionCenter() after authentication

        // ========== ROW ACTIONS MENU ==========
        let activeRowMenu = null;

        function showRowMenu(event, type, id) {
            event.stopPropagation();
            
            // Close any open menu
            closeRowMenu();
            
            const btn = event.currentTarget;
            const menu = btn.nextElementSibling;
            
            if (menu) {
                menu.classList.add('show');
                activeRowMenu = menu;
            }
        }

        function closeRowMenu() {
            if (activeRowMenu) {
                activeRowMenu.classList.remove('show');
                activeRowMenu = null;
            }
            document.querySelectorAll('.row-actions-menu.show').forEach(m => m.classList.remove('show'));
        }

        // Close menu when clicking elsewhere
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.row-actions')) {
                closeRowMenu();
            }
        });

        // Row action handlers
        function rowAction(action, type, id, name) {
            closeRowMenu();
            
            switch(action) {
                case 'view':
                    if (type === 'firm') {
                        const firm = toolData.firms.find(f => f.id === id);
                        if (firm) showFirmDetail(firm);
                    } else if (type === 'prospect') {
                        showProspectDetail(id);
                    } else if (type === 'connector') {
                        showConnectorDetail(id);
                    }
                    break;
                    
                case 'hot':
                    toggleHotConnector(id);
                    // Refresh views
                    renderProspectsView();
                    if (typeof renderACConnectorsList === 'function') renderACConnectorsList();
                    if (typeof renderACHotSidebar === 'function') renderACHotSidebar();
                    showToast(isHotConnector(id) ? '🔥 Marked as hot!' : 'Removed from hot');
                    break;
                    
                case 'addBestPath':
                    addBestPathToQueue(id);
                    break;
                    
                case 'addAllHotPaths':
                    addAllHotPathsToQueue(id);
                    break;
                    
                case 'addProspectPath':
                    addProspectBestPathToQueue(id);
                    break;
                    
                case 'planTrip':
                    // Switch to Action Center and set location
                    switchView('actions');
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelector('.tab[onclick*="actions"]')?.classList.add('active');
                    switchACTab('trip');
                    const select = document.getElementById('trip-location');
                    if (select) {
                        select.value = name; // name contains the state code
                        updateTripBuilder();
                    }
                    showToast('✈️ Trip planner loaded');
                    break;
                    
                case 'viewFirm':
                    const prospect = toolData.prospects.find(p => p.id === id);
                    if (prospect) {
                        const firm = toolData.firms.find(f => f.id === prospect.firmId);
                        if (firm) showFirmDetail(firm);
                    }
                    break;
                    
                case 'copyName':
                    navigator.clipboard.writeText(name).then(() => {
                        showToast('📋 Copied to clipboard');
                    });
                    break;
                    
                case 'linkedin':
                    if (type === 'connector') {
                        const connector = toolData.mutualConnections.find(c => c.id === id);
                        if (connector && connector.linkedin) {
                            window.open(connector.linkedin, '_blank');
                        }
                    }
                    break;
                    
                case 'priority':
                    togglePriorityFirm(id);
                    break;
            }
        }

        // Add the best path for a firm to the queue
        function addBestPathToQueue(firmId) {
            const paths = toolData.relationships.filter(r => r.firmId === firmId);
            if (paths.length === 0) {
                showToast('No paths available');
                return;
            }
            
            // Find best path - prefer hot connectors, then by connector reach
            let bestPath = paths[0];
            let bestScore = 0;
            
            paths.forEach(p => {
                let score = 0;
                const connector = toolData.mutualConnections.find(c => c.id === p.connectorId);
                if (isHotConnector(p.connectorId)) score += 100;
                if (connector) score += getConnectorReachCount(connector.id);
                if (score > bestScore) {
                    bestScore = score;
                    bestPath = p;
                }
            });
            
            // Add to queue
            const firm = toolData.firms.find(f => f.id === firmId);
            const team = toolData.teamMembers.find(t => t.id === bestPath.teamMemberId);
            const connector = toolData.mutualConnections.find(c => c.id === bestPath.connectorId);
            const prospect = toolData.prospects.find(pr => pr.id === bestPath.prospectId);
            
            if (!firm || !team || !connector || !prospect) return;
            
            const pathId = `${team.id}-${connector.id}-${prospect.id}`;
            
            if (!isPathSaved(pathId)) {
                toggleSavePath(pathId, firm.name, team.name, connector.name, prospect.name);
                showToast(`⭐ Added: ${team.name} → ${connector.name} → ${prospect.name}`);
            } else {
                showToast('Path already in queue');
            }
        }

        // Add all hot connector paths for a firm
        function addAllHotPathsToQueue(firmId) {
            const paths = toolData.relationships.filter(r => r.firmId === firmId && isHotConnector(r.connectorId));
            if (paths.length === 0) {
                showToast('No hot paths available');
                return;
            }
            
            const firm = toolData.firms.find(f => f.id === firmId);
            let added = 0;
            
            paths.forEach(p => {
                const team = toolData.teamMembers.find(t => t.id === p.teamMemberId);
                const connector = toolData.mutualConnections.find(c => c.id === p.connectorId);
                const prospect = toolData.prospects.find(pr => pr.id === p.prospectId);
                
                if (!team || !connector || !prospect) return;
                
                const pathId = `${team.id}-${connector.id}-${prospect.id}`;
                if (!isPathSaved(pathId)) {
                    toggleSavePath(pathId, firm.name, team.name, connector.name, prospect.name);
                    added++;
                }
            });
            
            showToast(`🔥 Added ${added} hot paths to queue`);
        }

        // Add best path for a prospect
        function addProspectBestPathToQueue(prospectId) {
            const paths = toolData.relationships.filter(r => r.prospectId === prospectId);
            if (paths.length === 0) {
                showToast('No paths available');
                return;
            }
            
            // Find best path
            let bestPath = paths[0];
            let bestScore = 0;
            
            paths.forEach(p => {
                let score = 0;
                if (isHotConnector(p.connectorId)) score += 100;
                const connector = toolData.mutualConnections.find(c => c.id === p.connectorId);
                if (connector) score += getConnectorReachCount(connector.id);
                if (score > bestScore) {
                    bestScore = score;
                    bestPath = p;
                }
            });
            
            const firm = toolData.firms.find(f => f.id === bestPath.firmId);
            const team = toolData.teamMembers.find(t => t.id === bestPath.teamMemberId);
            const connector = toolData.mutualConnections.find(c => c.id === bestPath.connectorId);
            const prospect = toolData.prospects.find(pr => pr.id === prospectId);
            
            if (!firm || !team || !connector || !prospect) return;
            
            const pathId = `${team.id}-${connector.id}-${prospect.id}`;
            
            if (!isPathSaved(pathId)) {
                toggleSavePath(pathId, firm.name, team.name, connector.name, prospect.name);
                showToast(`⭐ Added: ${team.name} → ${connector.name} → ${prospect.name}`);
            } else {
                showToast('Path already in queue');
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #2d3748;
                color: white;
                padding: 10px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 10000;
                animation: fadeInOut 2s ease-in-out;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // Helper to generate row actions HTML
        function getRowActionsHTML(type, id, name, extras = {}) {
            const safeName = name.replace(/'/g, "\\'");
            
            let menuItems = `
                <button class="row-actions-menu-item" onclick="rowAction('view', '${type}', '${id}', '${safeName}')">
                    👁️ View Details
                </button>
            `;
            
            if (type === 'firm') {
                const firm = toolData.firms.find(f => f.id === id);
                const hasHotPath = firmHasHotPath(id);
                const pathCount = getFirmPathCount(id);
                
                if (pathCount > 0) {
                    menuItems += `
                        <button class="row-actions-menu-item" onclick="rowAction('addBestPath', '${type}', '${id}', '${safeName}')">
                            ⭐ Add Best Path to Queue
                        </button>
                    `;
                }
                
                if (hasHotPath) {
                    menuItems += `
                        <button class="row-actions-menu-item hot" onclick="rowAction('addAllHotPaths', '${type}', '${id}', '${safeName}')">
                            🔥 Add All Hot Paths
                        </button>
                    `;
                }
                
                if (firm && firm.normalizedState && firm.normalizedState.length > 0) {
                    const state = firm.normalizedState[0];
                    menuItems += `
                        <div class="row-actions-menu-divider"></div>
                        <button class="row-actions-menu-item" onclick="rowAction('planTrip', '${type}', '${id}', '${state}')">
                            ✈️ Plan Trip to ${ALL_LOCATIONS.us.locations[state] || state}
                        </button>
                    `;
                }
                
                // Add priority toggle
                const isPriority = isPriorityFirm(id);
                menuItems += `
                    <button class="row-actions-menu-item ${isPriority ? 'priority' : ''}" onclick="rowAction('priority', '${type}', '${id}', '${safeName}')">
                        ${isPriority ? '✖️ Remove Priority' : '🎯 Mark High Priority'}
                    </button>
                `;
            }
            
            if (type === 'connector') {
                const isHot = isHotConnector(id);
                const connector = toolData.mutualConnections.find(c => c.id === id);
                
                menuItems += `
                    <div class="row-actions-menu-divider"></div>
                    <button class="row-actions-menu-item ${isHot ? 'hot' : ''}" onclick="rowAction('hot', '${type}', '${id}', '${safeName}')">
                        ${isHot ? '❄️ Remove from Hot' : '🔥 Mark as Hot'}
                    </button>
                `;
                
                if (connector && connector.linkedin) {
                    menuItems += `
                        <button class="row-actions-menu-item" onclick="rowAction('linkedin', '${type}', '${id}', '')">
                            🔗 Open LinkedIn
                        </button>
                    `;
                }
            }
            
            if (type === 'prospect') {
                const paths = toolData.relationships.filter(r => r.prospectId === id);
                if (paths.length > 0) {
                    menuItems += `
                        <div class="row-actions-menu-divider"></div>
                        <button class="row-actions-menu-item" onclick="rowAction('addProspectPath', '${type}', '${id}', '${safeName}')">
                            ⭐ Save Best Intro Path
                        </button>
                    `;
                }
                
                if (extras.firmId) {
                    menuItems += `
                        <button class="row-actions-menu-item" onclick="rowAction('viewFirm', '${type}', '${id}', '')">
                            🏢 View Firm
                        </button>
                    `;
                }
            }
            
            menuItems += `
                <div class="row-actions-menu-divider"></div>
                <button class="row-actions-menu-item" onclick="rowAction('copyName', '${type}', '${id}', '${safeName}')">
                    📋 Copy Name
                </button>
            `;
            
            return `
                <td class="row-actions" style="width: 40px; text-align: center; position: relative;">
                    <button class="row-actions-btn" onclick="showRowMenu(event, '${type}', '${id}')" title="Actions">⋮</button>
                    <div class="row-actions-menu">
                        ${menuItems}
                    </div>
                </td>
            `;
        }

        // ========== ACTION CENTER TAB SWITCHING ==========
        function switchACTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.ac-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.ac-tab[onclick*="${tabName}"]`)?.classList.add('active');
            
            // Update content
            document.querySelectorAll('.ac-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`ac-${tabName}`)?.classList.add('active');
        }

        // ========== CONNECTORS LIST (Action Center) ==========
        let acConnectorTeamFilter = 'all';
        
        function filterConnectorsByTeam(team) {
            acConnectorTeamFilter = team;
            document.querySelectorAll('.team-filter-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.team-filter-btn[onclick*="${team}"]`)?.classList.add('active');
            renderACConnectorsList();
        }

        function filterConnectorsList() {
            renderACConnectorsList();
        }

        function renderACConnectorsList() {
            const tbody = document.getElementById('ac-connectors-body');
            if (!tbody) return;
            
            const searchTerm = (document.getElementById('ac-connector-search')?.value || '').toLowerCase();
            
            // Filter connectors
            let connectors = toolData.mutualConnections.filter(c => {
                // Team filter
                if (acConnectorTeamFilter !== 'all') {
                    if (!c.teamConnections || !c.teamConnections.some(t => t.toLowerCase().includes(acConnectorTeamFilter.toLowerCase()))) {
                        return false;
                    }
                }
                // Search filter
                if (searchTerm) {
                    const searchable = `${c.name} ${c.company} ${c.location}`.toLowerCase();
                    if (!searchable.includes(searchTerm)) return false;
                }
                return true;
            });
            
            // Sort by reach (most intros first)
            connectors = connectors.map(c => ({
                ...c,
                reach: getConnectorReachCount(c.id),
                isHot: isHotConnector(c.id)
            })).sort((a, b) => {
                // Hot first, then by reach
                if (a.isHot && !b.isHot) return -1;
                if (!a.isHot && b.isHot) return 1;
                return b.reach - a.reach;
            });
            
            tbody.innerHTML = connectors.slice(0, 100).map(c => `
                <tr onclick="showConnectorDetail('${c.id}')">
                    <td>
                        <button class="hot-btn ${c.isHot ? 'is-hot' : ''}" 
                                onclick="event.stopPropagation(); toggleHotConnectorAC('${c.id}')"
                                title="${c.isHot ? 'Remove from hot' : 'Mark as hot'}">
                            ${c.isHot ? '🔥' : '☆'}
                        </button>
                    </td>
                    <td><strong>${c.name}</strong></td>
                    <td>${c.company || '—'}</td>
                    <td>${c.location || '—'}</td>
                    <td><span style="color: #004D4D; font-weight: 600;">${c.reach}</span></td>
                    <td>${(c.teamConnections || []).join(', ') || '—'}</td>
                </tr>
            `).join('');
        }

        function toggleHotConnectorAC(connectorId) {
            toggleHotConnector(connectorId);
            renderACConnectorsList();
            renderACHotSidebar();
        }

        function renderACHotSidebar() {
            const list = document.getElementById('hot-connectors-sidebar');
            const empty = document.getElementById('hot-sidebar-empty');
            const countEl = document.getElementById('hot-count');
            
            if (!list) return;
            
            if (hotConnectors.length === 0) {
                if (empty) empty.style.display = 'block';
                list.innerHTML = '';
                if (countEl) countEl.textContent = '0';
                return;
            }
            
            if (empty) empty.style.display = 'none';
            if (countEl) countEl.textContent = hotConnectors.length;
            
            list.innerHTML = hotConnectors.map(id => {
                const connector = toolData.mutualConnections.find(c => c.id === id);
                if (!connector) return '';
                const reach = getConnectorReachCount(id);
                return `
                    <div class="ac-sidebar-item hot">
                        <div class="ac-sidebar-item-info">
                            <div class="ac-sidebar-item-name">🔥 ${connector.name}</div>
                            <div class="ac-sidebar-item-meta">${connector.company || ''} • ${reach} prospects</div>
                        </div>
                        <button class="ac-sidebar-item-remove" onclick="toggleHotConnectorAC('${id}')" title="Remove">×</button>
                    </div>
                `;
            }).join('');
        }

        // ========== QUEUE FIRMS LIST (Action Center) ==========
        function filterQueueFirmsList() {
            renderACQueueFirmsList();
        }

        function renderACQueueFirmsList() {
            const tbody = document.getElementById('ac-queue-firms-body');
            if (!tbody) return;
            
            const searchTerm = (document.getElementById('ac-queue-search')?.value || '').toLowerCase();
            const filter = document.getElementById('ac-queue-filter')?.value || 'all';
            
            let firms = toolData.firms.map(f => ({
                ...f,
                pathCount: getFirmPathCount(f.id),
                hasHotPath: firmHasHotPath(f.id)
            })).filter(f => {
                // Search filter
                if (searchTerm) {
                    const searchable = `${f.name} ${f.type} ${f.location}`.toLowerCase();
                    if (!searchable.includes(searchTerm)) return false;
                }
                // Type filter
                if (filter === 'hot' && !f.hasHotPath) return false;
                if (filter === 'paths' && f.pathCount === 0) return false;
                return true;
            }).sort((a, b) => {
                if (a.hasHotPath && !b.hasHotPath) return -1;
                if (!a.hasHotPath && b.hasHotPath) return 1;
                return b.pathCount - a.pathCount;
            });
            
            tbody.innerHTML = firms.slice(0, 100).map(f => `
                <tr onclick="showFirmDetail(toolData.firms.find(x => x.id === '${f.id}'))">
                    <td>
                        <strong>${f.name}</strong>
                        ${f.hasHotPath ? '<span class="hot-connector-badge" style="margin-left: 6px;">🔥</span>' : ''}
                    </td>
                    <td><span class="badge badge-${(f.type || 'unknown').toLowerCase().replace(/[^a-z]/g, '-')}">${f.type || '—'}</span></td>
                    <td>${f.location || '—'}</td>
                    <td>${formatAUM(f.aum)}</td>
                    <td>${getWarmPathBadge(f.pathCount)}</td>
                </tr>
            `).join('');
        }

        function renderACQueueSidebar() {
            const list = document.getElementById('queue-sidebar');
            const empty = document.getElementById('queue-sidebar-empty');
            const actions = document.getElementById('queue-actions');
            const countEl = document.getElementById('queue-count');
            const countTabEl = document.getElementById('queue-count-tab');
            
            if (!list) return;
            
            if (savedPaths.length === 0) {
                if (empty) empty.style.display = 'block';
                if (actions) actions.style.display = 'none';
                list.innerHTML = '';
                if (countEl) countEl.textContent = '0';
                if (countTabEl) countTabEl.textContent = '0';
                return;
            }
            
            if (empty) empty.style.display = 'none';
            if (actions) actions.style.display = 'flex';
            if (countEl) countEl.textContent = savedPaths.length;
            if (countTabEl) countTabEl.textContent = savedPaths.length;
            
            // Group by firm
            const byFirm = {};
            savedPaths.forEach(p => {
                const firm = toolData.firms.find(f => f.id === p.firmId);
                if (!firm) return;
                if (!byFirm[firm.id]) {
                    byFirm[firm.id] = { firm, paths: [] };
                }
                byFirm[firm.id].paths.push(p);
            });
            
            list.innerHTML = Object.values(byFirm).map(({ firm, paths }) => `
                <div class="queue-sidebar-item">
                    <div class="queue-sidebar-firm">${firm.name}</div>
                    ${paths.map(p => `
                        <div class="queue-sidebar-path">
                            ${p.teamMemberName} <span class="arrow">→</span> 
                            ${p.connectorName} <span class="arrow">→</span> 
                            ${p.prospectName}
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        // ========== TRIP PLANNER ==========
        function initTripPlanner() {
            const select = document.getElementById('trip-location');
            if (!select) {
                console.warn('Trip location select not found');
                return;
            }
            
            console.log('=== Initializing Trip Planner ===');
            console.log('Total firms:', toolData.firms.length);
            
            // Debug: show some firm locations
            const sampleFirms = toolData.firms.slice(0, 5);
            sampleFirms.forEach(f => {
                console.log(`  Firm "${f.name}": location="${f.location}", normalizedState=[${f.normalizedState?.join(', ') || 'none'}]`);
            });
            
            // Get all unique locations from firms and connectors
            const locations = new Map();
            
            // Combine US and international locations
            const allLocationMappings = {
                ...ALL_LOCATIONS.us.locations,
                ...ALL_LOCATIONS.international.locations
            };
            
            // Add firm locations
            let firmsWithLocation = 0;
            toolData.firms.forEach(firm => {
                if (firm.normalizedState && firm.normalizedState.length > 0) {
                    firmsWithLocation++;
                    firm.normalizedState.forEach(state => {
                        const name = allLocationMappings[state] || state;
                        if (!locations.has(state)) {
                            locations.set(state, { code: state, name, firmCount: 0, connectorCount: 0, isUS: !!ALL_LOCATIONS.us.locations[state] });
                        }
                        locations.get(state).firmCount++;
                    });
                }
            });
            
            console.log('Firms with normalized location:', firmsWithLocation);
            
            // Add connector locations
            toolData.mutualConnections.forEach(connector => {
                if (connector.location) {
                    const loc = connector.location.trim();
                    // Try to match to any location (US or international)
                    Object.entries(allLocationMappings).forEach(([code, name]) => {
                        if (loc.toLowerCase().includes(name.toLowerCase()) || loc.toUpperCase().includes(code)) {
                            if (!locations.has(code)) {
                                locations.set(code, { code, name, firmCount: 0, connectorCount: 0, isUS: !!ALL_LOCATIONS.us.locations[code] });
                            }
                            locations.get(code).connectorCount++;
                        }
                    });
                }
            });
            
            console.log('Unique locations found:', locations.size);
            
            // Sort by total count
            const sortedLocations = [...locations.values()]
                .filter(l => l.firmCount > 0 || l.connectorCount > 0)
                .sort((a, b) => (b.firmCount + b.connectorCount) - (a.firmCount + a.connectorCount));
            
            console.log('Sorted locations (top 5):', sortedLocations.slice(0, 5).map(l => `${l.name}: ${l.firmCount} firms`));
            
            // Separate US and international
            const usLocations = sortedLocations.filter(l => l.isUS);
            const intlLocations = sortedLocations.filter(l => !l.isUS);
            
            console.log('US locations:', usLocations.length, 'International:', intlLocations.length);
            
            // Build options with grouping
            let optionsHtml = '<option value="">Select a location...</option>';
            
            if (usLocations.length > 0) {
                optionsHtml += '<optgroup label="🇺🇸 United States">';
                optionsHtml += usLocations.map(l => `
                    <option value="${l.code}">${l.name} (${l.firmCount} firms)</option>
                `).join('');
                optionsHtml += '</optgroup>';
            }
            
            if (intlLocations.length > 0) {
                optionsHtml += '<optgroup label="🌍 International">';
                optionsHtml += intlLocations.map(l => `
                    <option value="${l.code}">${l.name} (${l.firmCount} firms)</option>
                `).join('');
                optionsHtml += '</optgroup>';
            }
            
            select.innerHTML = optionsHtml;
            console.log('Trip Planner dropdown populated with', sortedLocations.length, 'locations');
        }

        function updateTripPlan() {
            const location = document.getElementById('trip-location').value;
            const emptyEl = document.getElementById('trip-empty');
            const contentEl = document.getElementById('trip-content');
            const summaryEl = document.getElementById('trip-summary');
            
            if (!location) {
                if (emptyEl) emptyEl.style.display = 'block';
                if (contentEl) contentEl.style.display = 'none';
                if (summaryEl) summaryEl.style.display = 'none';
                return;
            }
            
            if (emptyEl) emptyEl.style.display = 'none';
            if (contentEl) contentEl.style.display = 'block';
            if (summaryEl) summaryEl.style.display = 'flex';
            
            // Get firms in this location
            const firms = toolData.firms.filter(firm => 
                firm.normalizedState && firm.normalizedState.includes(location)
            ).map(firm => ({
                ...firm,
                pathCount: getFirmPathCount(firm.id),
                hasHotPath: firmHasHotPath(firm.id),
                contactCount: toolData.prospects.filter(p => p.firmId === firm.id).length,
                opportunityScore: calculateOpportunityScore(firm)
            })).sort((a, b) => {
                // Hot paths first, then by score
                if (a.hasHotPath && !b.hasHotPath) return -1;
                if (!a.hasHotPath && b.hasHotPath) return 1;
                return b.opportunityScore - a.opportunityScore;
            });
            
            // Get connectors in this location
            const locationName = ALL_LOCATIONS.us.locations[location] || location;
            const connectors = toolData.mutualConnections.filter(c => {
                if (!c.location) return false;
                const loc = c.location.toLowerCase();
                return loc.includes(locationName.toLowerCase()) || loc.includes(location.toLowerCase());
            }).map(c => ({
                ...c,
                reach: getConnectorReachCount(c.id),
                isHot: isHotConnector(c.id)
            })).sort((a, b) => {
                if (a.isHot && !b.isHot) return -1;
                if (!a.isHot && b.isHot) return 1;
                return b.reach - a.reach;
            });
            
            // Update summary stats
            const totalPaths = firms.reduce((sum, f) => sum + f.pathCount, 0);
            const firmCountEl = document.getElementById('trip-firm-count');
            const connectorCountEl = document.getElementById('trip-connector-count');
            const pathCountEl = document.getElementById('trip-path-count');
            
            if (firmCountEl) firmCountEl.textContent = firms.length;
            if (connectorCountEl) connectorCountEl.textContent = connectors.length;
            if (pathCountEl) pathCountEl.textContent = totalPaths;
            
            // Render connectors bar
            const connectorsBar = document.getElementById('trip-connectors-bar');
            const connectorsChips = document.getElementById('trip-connectors-chips');
            if (connectors.length === 0) {
                if (connectorsBar) connectorsBar.style.display = 'none';
            } else {
                if (connectorsBar) connectorsBar.style.display = 'flex';
                if (connectorsChips) {
                    connectorsChips.innerHTML = connectors.slice(0, 15).map(c => `
                        <div class="trip-connector-chip ${c.isHot ? 'is-hot' : ''}" onclick="showConnectorDetail('${c.id}')">
                            ${c.name} <span style="opacity: 0.7; margin-left: 4px;">${c.reach}</span>
                        </div>
                    `).join('');
                }
            }
            
            // Render firms table
            const firmsBody = document.getElementById('trip-firms-body');
            if (firmsBody) {
                firmsBody.innerHTML = firms.map(f => `
                    <tr onclick="showFirmDetail(toolData.firms.find(x => x.id === '${f.id}')); event.stopPropagation();" style="cursor: pointer;">
                        <td>
                            <strong>${f.name}</strong>
                            ${f.hasHotPath ? '<span class="hot-connector-badge" style="margin-left: 6px;">🔥</span>' : ''}
                        </td>
                        <td><span class="badge badge-${(f.type || 'unknown').toLowerCase().replace(/[^a-z]/g, '-')}">${f.type || '—'}</span></td>
                        <td>${formatAUM(f.aum)}</td>
                        <td>${f.contactCount}</td>
                        <td>${getWarmPathBadge(f.pathCount)}</td>
                        <td>${f.opportunityScore > 0 ? f.opportunityScore : '—'}</td>
                    </tr>
                `).join('');
            }
            
            // Store for export
            window.currentTripData = { location: locationName, firms, connectors };
        }

        function exportTripBrief() {
            const data = window.currentTripData;
            if (!data) return;
            
            let brief = `TRIP BRIEF: ${data.location}\n`;
            brief += `Generated: ${new Date().toLocaleDateString()}\n`;
            brief += `${'='.repeat(50)}\n\n`;
            
            if (data.connectors.length > 0) {
                brief += `CONNECTORS IN AREA (${data.connectors.length})\n`;
                brief += `${'-'.repeat(30)}\n`;
                data.connectors.forEach(c => {
                    brief += `• ${c.name}${c.isHot ? ' 🔥' : ''} - ${c.company || 'N/A'} (can intro to ${c.reach} prospects)\n`;
                });
                brief += `\n`;
            }
            
            brief += `TARGET FIRMS (${data.firms.length})\n`;
            brief += `${'-'.repeat(30)}\n`;
            data.firms.forEach(f => {
                brief += `• ${f.name}${f.hasHotPath ? ' 🔥' : ''}\n`;
                brief += `  Type: ${f.type || 'N/A'} | AUM: ${formatAUM(f.aum)} | Warm Paths: ${f.pathCount}\n`;
            });
            
            const blob = new Blob([brief], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trip-brief-${data.location.replace(/\s+/g, '-').toLowerCase()}.txt`;
            a.click();
        }

        // ========== RECENTLY VIEWED ==========
        let recentlyViewed = JSON.parse(localStorage.getItem('fourbridge_recently_viewed') || '[]');
        const MAX_RECENT = 8;

        function trackView(type, id, name, extra = {}) {
            // Remove if already exists
            recentlyViewed = recentlyViewed.filter(r => !(r.type === type && r.id === id));
            
            // Add to front
            recentlyViewed.unshift({
                type,
                id,
                name,
                ...extra,
                viewedAt: new Date().toISOString()
            });
            
            // Limit size
            recentlyViewed = recentlyViewed.slice(0, MAX_RECENT);
            
            localStorage.setItem('fourbridge_recently_viewed', JSON.stringify(recentlyViewed));
            renderRecentlyViewed();
        }

        function initRecentlyViewed() {
            renderRecentlyViewed();
        }

        function renderRecentlyViewed() {
            const section = document.getElementById('recently-viewed-section');
            const list = document.getElementById('recently-viewed-list');
            
            if (!section || !list) return;
            
            if (recentlyViewed.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            
            list.innerHTML = recentlyViewed.map(r => {
                const icon = r.type === 'firm' ? '🏢' : r.type === 'prospect' ? '👤' : '🤝';
                return `
                    <div class="recent-item" onclick="openRecentItem('${r.type}', '${r.id}')">
                        <div class="recent-item-icon">${icon}</div>
                        <div class="recent-item-name">${r.name}</div>
                        <div class="recent-item-type">${r.type}</div>
                    </div>
                `;
            }).join('');
        }

        function openRecentItem(type, id) {
            if (type === 'firm') {
                const firm = toolData.firms.find(f => f.id === id);
                if (firm) showFirmDetail(firm);
            } else if (type === 'prospect') {
                showProspectDetail(id);
            } else if (type === 'connector') {
                showConnectorDetail(id);
            }
        }

        function clearRecentlyViewed() {
            recentlyViewed = [];
            localStorage.setItem('fourbridge_recently_viewed', '[]');
            renderRecentlyViewed();
        }

        // ========== KEYBOARD SHORTCUTS ==========
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Escape to close modal
                if (e.key === 'Escape') {
                    const modal = document.getElementById('detail-modal');
                    if (modal && modal.style.display === 'block') {
                        closeModal();
                        e.preventDefault();
                    }
                    // Also close add hot connector modal
                    closeAddHotModal();
                }
                
                // "/" to focus search (when not in input)
                if (e.key === '/' && !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
                    e.preventDefault();
                    // Focus the appropriate search based on current view
                    const searchInputs = {
                        'prospects': 'prospects-search',
                        'connections': 'connections-search',
                        'firms': 'firms-search',
                        'team': 'team-search'
                    };
                    const inputId = searchInputs[currentView];
                    if (inputId) {
                        const input = document.getElementById(inputId);
                        if (input) input.focus();
                    }
                }
            });
        }

        let navigationHistory = [];
        
        function pushNavigationHistory() {
            // Save current modal state
            const currentState = {
                name: document.getElementById('modal-name').textContent,
                subtitle: document.getElementById('modal-subtitle').innerHTML,
                body: document.getElementById('modal-body').innerHTML
            };
            navigationHistory.push(currentState);
        }
        
        function navigateBack() {
            if (navigationHistory.length === 0) return;
            
            const prevState = navigationHistory.pop();
            document.getElementById('modal-name').textContent = prevState.name;
            document.getElementById('modal-subtitle').innerHTML = prevState.subtitle;
            document.getElementById('modal-body').innerHTML = prevState.body;
            
            // Re-initialize Sankey if we're going back to a firm view
            if (window.currentFirmData && prevState.body.includes('sankey-chart')) {
                setTimeout(() => filterSankey('top5'), 100);
            }
        }

        // ========== SAVED PATHS MANAGEMENT ==========
        let savedPaths = [];

        // Load saved paths from localStorage on init
        function loadSavedPaths() {
            try {
                const stored = localStorage.getItem('fourbridge_saved_paths');
                if (stored) {
                    savedPaths = JSON.parse(stored);
                }
            } catch (e) {
                console.log('Could not load saved paths:', e);
            }
            updateSavedPathsCount();
            updateQueueCount();
        }

        // Save to localStorage
        function persistSavedPaths() {
            try {
                localStorage.setItem('fourbridge_saved_paths', JSON.stringify(savedPaths));
            } catch (e) {
                console.log('Could not save paths:', e);
            }
            updateSavedPathsCount();
            updateQueueCount();
            renderSavedPathsPanel();
            renderIntroQueue();
            renderSavedIntrosSidebar();
        }

        // ========== NOTES MANAGEMENT ==========
        // Notes stored by type and ID: { prospect_id123: "note text", firm_id456: "note text", connector_id789: "note text" }
        let entityNotes = {};
        
        // Load notes from localStorage
        function loadEntityNotes() {
            try {
                const stored = localStorage.getItem('fourbridge_entity_notes');
                if (stored) {
                    entityNotes = JSON.parse(stored);
                }
            } catch (e) {
                console.log('Could not load notes:', e);
            }
        }
        
        // Save notes to localStorage
        function persistEntityNotes() {
            try {
                localStorage.setItem('fourbridge_entity_notes', JSON.stringify(entityNotes));
            } catch (e) {
                console.log('Could not save notes:', e);
            }
        }
        
        // Get note for an entity
        function getEntityNote(type, id) {
            const key = `${type}_${id}`;
            return entityNotes[key] || '';
        }
        
        // Set note for an entity
        function setEntityNote(type, id, note) {
            const key = `${type}_${id}`;
            if (note && note.trim()) {
                entityNotes[key] = note.trim();
            } else {
                delete entityNotes[key];
            }
            persistEntityNotes();
        }
        
        // Save note from textarea (called by UI)
        function saveNote(type, id) {
            const textarea = document.getElementById(`note-input-${type}-${id}`);
            if (textarea) {
                setEntityNote(type, id, textarea.value);
                showToast('📝 Note saved!');
                
                // Update the "has note" indicator if present
                const indicator = document.getElementById(`note-indicator-${type}-${id}`);
                if (indicator) {
                    indicator.style.display = textarea.value.trim() ? 'inline' : 'none';
                }
            }
        }
        
        // Render notes section HTML for any entity
        function renderNotesSection(type, id, entityName) {
            const existingNote = getEntityNote(type, id);
            const hasNote = existingNote && existingNote.trim();
            
            return `
                <div class="brief-section notes-section">
                    <div class="brief-section-title">
                        <span class="icon">📝</span> Your Notes
                        ${hasNote ? '<span class="note-saved-badge">Saved</span>' : ''}
                    </div>
                    <div class="notes-input-container">
                        <textarea 
                            id="note-input-${type}-${id}" 
                            class="note-textarea" 
                            placeholder="Add your notes about ${entityName}... (e.g., meeting notes, follow-up reminders, personal context)"
                            rows="3"
                        >${existingNote}</textarea>
                        <div class="notes-actions">
                            <button onclick="saveNote('${type}', '${id}')" class="btn-save-note">
                                💾 Save Note
                            </button>
                            <span class="note-hint">Notes are saved locally in your browser</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Render saved intros in Action Center sidebar
        function renderSavedIntrosSidebar() {
            const list = document.getElementById('saved-intros-list');
            const empty = document.getElementById('saved-intros-empty');
            const actions = document.getElementById('saved-intros-actions');
            const count = document.getElementById('saved-intros-count');
            
            if (!list) return;
            
            if (savedPaths.length === 0) {
                if (empty) empty.style.display = 'block';
                if (actions) actions.style.display = 'none';
                list.innerHTML = '';
                if (count) count.textContent = '0';
                return;
            }
            
            if (empty) empty.style.display = 'none';
            if (actions) actions.style.display = 'flex';
            if (count) count.textContent = savedPaths.length;
            
            // Group by firm
            const byFirm = {};
            savedPaths.forEach(p => {
                const firmKey = p.firmName || 'Unknown';
                if (!byFirm[firmKey]) {
                    byFirm[firmKey] = { paths: [], firmId: null, location: '' };
                }
                byFirm[firmKey].paths.push(p);
                
                // Try to get firm ID and location
                if (!byFirm[firmKey].firmId) {
                    const firm = toolData.firms.find(f => f.name === firmKey);
                    if (firm) {
                        byFirm[firmKey].firmId = firm.id;
                        byFirm[firmKey].location = firm.location || '';
                    }
                }
            });
            
            list.innerHTML = Object.entries(byFirm).map(([firmName, data]) => `
                <div class="saved-intro-group">
                    <div class="saved-intro-firm" onclick="${data.firmId ? `showFirmDetail(toolData.firms.find(f=>f.id==='${data.firmId}'))` : ''}" style="${data.firmId ? 'cursor: pointer;' : ''}">
                        <span class="clickable-name">${firmName}</span>
                        ${data.location ? `<span class="saved-intro-location">${data.location}</span>` : ''}
                    </div>
                    ${data.paths.map(p => {
                        // Parse the path ID to get connector ID
                        const pathParts = p.id.split('-');
                        const connectorId = pathParts.length >= 3 ? pathParts[2] : null;
                        const prospectId = pathParts.length >= 2 ? pathParts[1] : null;
                        
                        return `
                        <div class="saved-intro-path">
                            <span>
                                ${p.teamName || ''} → 
                                <span class="clickable-name" onclick="${connectorId ? `event.stopPropagation(); showConnectorDetail('${connectorId}')` : ''}">${p.connectorName || ''}</span> → 
                                <span class="clickable-name" onclick="${prospectId ? `event.stopPropagation(); showProspectDetail('${prospectId}')` : ''}">${p.contactName || ''}</span>
                            </span>
                            <button class="ac-sidebar-item-remove" onclick="event.stopPropagation(); toggleSavePath('${p.id}')">×</button>
                        </div>
                    `}).join('')}
                </div>
            `).join('');
        }

        // Check if path is saved
        function isPathSaved(pathId) {
            return savedPaths.some(p => p.id === pathId);
        }

        // Toggle save/unsave a path
        function toggleSavePath(pathId, firmName, teamName, connectorName, contactName) {
            const existingIdx = savedPaths.findIndex(p => p.id === pathId);
            
            if (existingIdx >= 0) {
                // Remove
                savedPaths.splice(existingIdx, 1);
                showToast('Removed from saved intros');
            } else {
                // Add
                savedPaths.push({
                    id: pathId,
                    firmName: firmName,
                    teamName: teamName,
                    connectorName: connectorName,
                    contactName: contactName,
                    savedAt: new Date().toISOString()
                });
                showToast('⭐ Saved to intro queue!');
            }
            
            persistSavedPaths();
            
            // Update button state if available
            if (event && event.target) {
                const btn = event.target;
                btn.classList.toggle('saved');
                btn.textContent = btn.classList.contains('saved') ? '★' : '☆';
            }
        }

        // Remove a specific saved path
        function removeSavedPath(pathId) {
            savedPaths = savedPaths.filter(p => p.id !== pathId);
            persistSavedPaths();
        }

        // Update count in floating button
        function updateSavedPathsCount() {
            const countEl = document.getElementById('saved-paths-count');
            if (countEl) {
                countEl.textContent = savedPaths.length;
            }
        }

        // Toggle saved paths panel visibility
        function toggleSavedPathsPanel() {
            const panel = document.getElementById('saved-paths-panel');
            panel.classList.toggle('visible');
            if (panel.classList.contains('visible')) {
                renderSavedPathsPanel();
            }
        }

        function showSavedPaths() {
            const panel = document.getElementById('saved-paths-panel');
            panel.classList.add('visible');
            renderSavedPathsPanel();
        }

        // Render the saved paths panel content - PATH-CENTRIC Briefing Book
        function renderSavedPathsPanel() {
            const body = document.getElementById('saved-paths-body');
            
            if (savedPaths.length === 0) {
                body.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 20px;">No paths saved yet.<br>Star ☆ a connector path to add it to your briefing book.</p>';
                return;
            }
            
            // Group paths by firm for organization
            const byFirm = {};
            savedPaths.forEach(p => {
                const key = p.firmName || 'Unknown';
                if (!byFirm[key]) byFirm[key] = [];
                byFirm[key].push(p);
            });
            
            let html = `<div class="briefing-paths-list">`;
            
            Object.entries(byFirm).forEach(([firmName, paths]) => {
                const firm = toolData.firms.find(f => f.name === firmName);
                
                html += `
                    <div class="briefing-firm-group">
                        <div class="briefing-firm-header">
                            <span class="briefing-firm-icon">🏢</span>
                            <span class="briefing-firm-name">${firmName}</span>
                            <span class="briefing-firm-location">${firm?.location || ''}</span>
                        </div>
                        <div class="briefing-firm-paths">
                `;
                
                paths.forEach(p => {
                    const pathNote = getEntityNote('path', p.id);
                    const notePreview = pathNote ? pathNote.substring(0, 40) + (pathNote.length > 40 ? '...' : '') : '';
                    const connector = toolData.mutualConnections.find(c => 
                        c.name === p.connectorName || normalizeName(c.name) === normalizeName(p.connectorName)
                    );
                    const isHot = connector ? isHotConnector(connector.id) : false;
                    const safeId = (p.id || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    
                    html += `
                        <div class="briefing-path-card ${isHot ? 'hot' : ''}" onclick="showPathBrief('${safeId}')" style="cursor: pointer;">
                            <div class="briefing-path-chain">
                                <span class="path-step team">${p.teamName}</span>
                                <span class="path-arrow">→</span>
                                <span class="path-step connector ${isHot ? 'hot' : ''}">${isHot ? '🔥 ' : ''}${p.connectorName}</span>
                                <span class="path-arrow">→</span>
                                <span class="path-step prospect">${p.contactName}</span>
                            </div>
                            ${notePreview ? `<div class="briefing-path-note">📝 ${notePreview}</div>` : ''}
                            <button class="briefing-path-remove" onclick="event.stopPropagation(); removeSavedPath('${safeId}')">&times;</button>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            
            body.innerHTML = html;
        }
        
        // Remove a prospect from briefing book
        function removeProspectFromBriefing(name, firmName) {
            savedPaths = savedPaths.filter(p => !(p.contactName === name && p.firmName === firmName));
            persistSavedPaths();
        }
        
        // Current brief data for export
        let currentBriefData = null;
        
        // Show Path Brief Modal - THE MAIN BRIEF VIEW
        function showPathBrief(pathId) {
            const modal = document.getElementById('brief-modal');
            const title = document.getElementById('brief-modal-title');
            const subtitle = document.getElementById('brief-modal-subtitle');
            const body = document.getElementById('brief-modal-body');
            
            // Find the saved path
            const path = savedPaths.find(p => p.id === pathId);
            if (!path) {
                console.error('Path not found:', pathId);
                return;
            }
            
            // Get all related entities
            const prospect = toolData.prospects.find(p => 
                p.name === path.contactName || normalizeName(p.name) === normalizeName(path.contactName)
            );
            const firm = toolData.firms.find(f => f.name === path.firmName);
            const connector = toolData.mutualConnections.find(c => 
                c.name === path.connectorName || normalizeName(c.name) === normalizeName(path.connectorName)
            );
            const team = toolData.teamMembers.find(t => 
                t.name === path.teamName || normalizeName(t.name) === normalizeName(path.teamName)
            );
            
            const isHot = connector ? isHotConnector(connector.id) : false;
            
            // Get research/intel on prospect
            const research = researchData[path.contactName] || researchData[normalizeName(path.contactName)] || '';
            const schools = research ? extractAllSchools(research) : [];
            const boards = research ? extractAllBoards(research) : [];
            const foundations = research ? extractFoundations(research) : [];
            
            // Get connection context
            const context = connector && prospect ? getConnectionContext(connector.id, prospect.id) : null;
            
            // Generate intro request
            const introRequest = connector && prospect ? generateIntroRequest(connector.id, prospect.id, team?.id) : null;
            
            // Set modal header
            title.textContent = `${path.contactName}`;
            subtitle.textContent = `via ${path.connectorName} ${isHot ? '🔥' : ''}`;
            
            // Store for export
            currentBriefData = { 
                type: 'path', 
                path, 
                prospect, 
                firm, 
                connector, 
                team, 
                isHot, 
                research, 
                schools, 
                boards, 
                foundations, 
                context, 
                introRequest 
            };
            
            let html = '';
            
            // PATH VISUALIZATION
            html += `
                <div class="brief-section">
                    <div class="brief-section-title"><span class="icon">🔗</span> Introduction Path</div>
                    <div class="connection-context-path" style="margin: 0;">
                        <span class="path-node team">${path.teamName}</span>
                        <span class="path-arrow">→</span>
                        <span class="path-node connector ${isHot ? 'hot' : ''}">${isHot ? '🔥 ' : ''}${path.connectorName}</span>
                        <span class="path-arrow">→</span>
                        <span class="path-node prospect">${path.contactName}</span>
                    </div>
                </div>
            `;
            
            // TARGET SECTION
            html += `
                <div class="brief-section">
                    <div class="brief-section-title"><span class="icon">🎯</span> Target</div>
                    <div class="path-brief-target">
                        <div class="path-brief-target-name">${path.contactName}</div>
                        <div class="path-brief-target-title">${prospect?.title || 'No title'}</div>
                        <div class="path-brief-target-firm">
                            <span>🏢</span>
                            <div>
                                <div class="path-brief-target-firm-name">${firm?.name || path.firmName}</div>
                                <div class="path-brief-target-firm-detail">${firm?.aum || ''} ${firm?.type || ''} • ${firm?.location || ''}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // CONNECTOR SECTION with Connection Context
            html += `
                <div class="brief-section">
                    <div class="brief-section-title"><span class="icon">${isHot ? '🔥' : '🤝'}</span> Your Connector</div>
                    <div class="path-brief-connector ${isHot ? 'hot' : ''}">
                        <div class="path-brief-connector-header">
                            <div>
                                <div class="path-brief-connector-name">${connector?.name || path.connectorName}</div>
                                <div class="path-brief-connector-company">${connector?.company || ''} ${connector?.location ? '• ' + connector.location : ''}</div>
                            </div>
                            <span class="path-brief-via">via ${team?.name || path.teamName}</span>
                        </div>
                        ${context ? `
                            <div style="margin-top: 12px;">
                                ${renderStrengthBar(context.strength)}
                                ${context.overlaps.length > 0 ? `
                                    <div class="connection-overlaps" style="margin-top: 10px;">
                                        ${context.overlaps.map(o => `
                                            <div class="connection-overlap-item">
                                                <span class="overlap-icon">${o.icon}</span>
                                                <div class="overlap-info">
                                                    <span class="overlap-detail">${o.detail}</span>
                                                    ${o.subdetail ? `<span class="overlap-subdetail">${o.subdetail}</span>` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <p style="font-size: 12px; color: #6c757d; margin: 10px 0 0 0;">${context.summary}</p>
                                `}
                            </div>
                        ` : `
                            <p style="font-size: 12px; color: #6c757d; margin-top: 10px;">
                                ${connector?.mutualCount || 0} mutual connections
                            </p>
                        `}
                    </div>
                </div>
            `;
            
            // INTEL SECTION (if available)
            const hasIntel = schools.length > 0 || boards.length > 0 || foundations.length > 0;
            if (hasIntel) {
                html += `
                    <div class="brief-section">
                        <div class="brief-section-title"><span class="icon">🧠</span> Target Intel</div>
                        <div class="brief-intel-grid">
                            ${schools.length > 0 ? `
                                <div class="brief-intel-card">
                                    <div class="brief-intel-label">🎓 Education</div>
                                    <ul class="brief-intel-list">
                                        ${schools.slice(0, 4).map(s => `<li>${s.name}${s.year ? ' ' + s.year : ''}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${boards.length > 0 ? `
                                <div class="brief-intel-card">
                                    <div class="brief-intel-label">🏛️ Boards</div>
                                    <ul class="brief-intel-list">
                                        ${boards.slice(0, 4).map(b => `<li>${b.name}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${foundations.length > 0 ? `
                                <div class="brief-intel-card">
                                    <div class="brief-intel-label">🏦 Foundations</div>
                                    <ul class="brief-intel-list">
                                        ${foundations.slice(0, 4).map(f => `<li>${f.name}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // NOTES SECTION
            html += renderNotesSection('path', pathId, `this intro to ${path.contactName}`);
            
            // RAW RESEARCH (collapsed by default)
            if (research) {
                html += `
                    <div class="brief-section">
                        <div class="brief-section-title" style="cursor: pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                            <span class="icon">📄</span> Raw Research <span style="font-size: 10px; color: #6c757d;">(click to expand)</span>
                        </div>
                        <div class="brief-research-text" style="display: none;">${research}</div>
                    </div>
                `;
            }
            
            body.innerHTML = html;
            modal.style.display = 'flex';
        }
        
        // Show Prospect Brief Modal
        function showProspectBrief(prospectName, firmName) {
            const modal = document.getElementById('brief-modal');
            const title = document.getElementById('brief-modal-title');
            const subtitle = document.getElementById('brief-modal-subtitle');
            const body = document.getElementById('brief-modal-body');
            
            // Find prospect
            const prospect = toolData.prospects.find(p => 
                p.name === prospectName || normalizeName(p.name) === normalizeName(prospectName)
            );
            const firm = toolData.firms.find(f => f.name === firmName);
            
            title.textContent = prospectName;
            subtitle.textContent = prospect?.title ? `${prospect.title} @ ${firmName}` : firmName;
            
            // Get research data
            const research = researchData[prospectName] || researchData[normalizeName(prospectName)] || '';
            
            // Extract intelligence from research
            const schools = research ? extractAllSchools(research) : [];
            const boards = research ? extractAllBoards(research) : [];
            const foundations = research ? extractFoundations(research) : [];
            const family = research ? extractFamilyRelationships(research, prospectName) : [];
            const military = research ? extractMilitaryService(research) : [];
            const locations = research ? extractLocationsFromText(research) : [];
            
            // Get warm paths
            const paths = prospect ? toolData.relationships
                .filter(r => r.firmId === prospect.firmId)
                .map(r => {
                    const connector = toolData.mutualConnections.find(c => c.id === r.connectorId);
                    const team = toolData.teamMembers.find(t => t.id === r.teamMemberId);
                    return { connector, team, relationship: r };
                })
                .filter(p => p.connector)
                .sort((a, b) => {
                    const aHot = isHotConnector(a.connector?.id) ? 1 : 0;
                    const bHot = isHotConnector(b.connector?.id) ? 1 : 0;
                    if (bHot !== aHot) return bHot - aHot;
                    return (b.connector?.mutualCount || 0) - (a.connector?.mutualCount || 0);
                }) : [];
            
            // Store for export
            currentBriefData = { type: 'prospect', name: prospectName, firm: firmName, prospect, research, schools, boards, foundations, family, military, locations, paths };
            
            let html = '';
            
            // FIRM SECTION
            if (firm) {
                html += `
                    <div class="brief-section">
                        <div class="brief-section-title"><span class="icon">🏢</span> Firm</div>
                        <div class="brief-firm-card">
                            <div class="brief-firm-name">${firm.name}</div>
                            <div class="brief-firm-details">
                                ${firm.aum || ''} ${firm.type || ''}<br>
                                ${firm.location || 'Location unknown'}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // WARM PATHS SECTION with Connection Context
            if (paths.length > 0) {
                const hotPaths = paths.filter(p => isHotConnector(p.connector?.id));
                const regularPaths = paths.filter(p => !isHotConnector(p.connector?.id));
                
                // Get best path (first hot or first regular)
                const bestPath = hotPaths[0] || regularPaths[0];
                const bestConnectorId = bestPath?.connector?.id;
                const bestTeamId = bestPath?.team?.id;
                
                html += `
                    <div class="brief-section">
                        <div class="brief-section-title"><span class="icon">⭐</span> Recommended Path</div>
                        ${bestPath ? renderConnectionContext(bestConnectorId, prospect?.id) : ''}
                    </div>
                    
                    <div class="brief-section">
                        <div class="brief-section-title"><span class="icon">🔗</span> All Warm Paths (${paths.length})</div>
                        <div class="brief-paths-list">
                            ${hotPaths.length > 0 ? `
                                <div style="font-size: 11px; font-weight: 600; color: #c05621; margin-bottom: 4px;">🔥 HOT CONNECTORS</div>
                                ${hotPaths.slice(0, 5).map(p => `
                                    <div class="brief-path-item hot" onclick="showIntroRequestModal('${p.connector?.id}', '${prospect?.id}', '${p.team?.id}')" style="cursor: pointer;">
                                        <span class="brief-path-icon">🔥</span>
                                        <div class="brief-path-info">
                                            <div class="brief-path-name">${p.connector?.name || 'Unknown'}</div>
                                            <div class="brief-path-detail">via ${p.team?.name || 'Unknown'} • ${p.connector?.company || ''}</div>
                                        </div>
                                        <span class="brief-path-badge mutual">${p.connector?.mutualCount || 0} mutual</span>
                                    </div>
                                `).join('')}
                            ` : ''}
                            ${regularPaths.slice(0, 10).map(p => `
                                <div class="brief-path-item" onclick="showIntroRequestModal('${p.connector?.id}', '${prospect?.id}', '${p.team?.id}')" style="cursor: pointer;">
                                    <span class="brief-path-icon">🤝</span>
                                    <div class="brief-path-info">
                                        <div class="brief-path-name">${p.connector?.name || 'Unknown'}</div>
                                        <div class="brief-path-detail">via ${p.team?.name || 'Unknown'} • ${p.connector?.company || ''}</div>
                                    </div>
                                    <span class="brief-path-badge mutual">${p.connector?.mutualCount || 0} mutual</span>
                                </div>
                            `).join('')}
                            ${paths.length > 15 ? `<div style="font-size: 11px; color: #6c757d; text-align: center; padding: 8px;">+${paths.length - 15} more paths</div>` : ''}
                        </div>
                        <p style="font-size: 11px; color: #6c757d; text-align: center; margin-top: 8px;">Click any path to generate intro request</p>
                    </div>
                `;
            }
            
            // INTELLIGENCE SECTION
            const hasIntel = schools.length > 0 || boards.length > 0 || foundations.length > 0 || family.length > 0 || military.length > 0 || locations.length > 0;
            
            if (hasIntel) {
                html += `
                    <div class="brief-section">
                        <div class="brief-section-title"><span class="icon">🧠</span> Network Intelligence</div>
                        <div class="brief-intel-grid">
                            ${schools.length > 0 ? `
                                <div class="brief-intel-card">
                                    <div class="brief-intel-label">🎓 Education</div>
                                    <ul class="brief-intel-list">
                                        ${schools.slice(0, 5).map(s => `<li>${s.name}${s.detail ? ' (' + s.detail + ')' : ''}${s.year ? ' ' + s.year : ''}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${boards.length > 0 ? `
                                <div class="brief-intel-card">
                                    <div class="brief-intel-label">🏛️ Boards</div>
                                    <ul class="brief-intel-list">
                                        ${boards.slice(0, 5).map(b => `<li>${b.name}${b.role ? ' - ' + b.role : ''}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${foundations.length > 0 ? `
                                <div class="brief-intel-card">
                                    <div class="brief-intel-label">🏦 Foundations</div>
                                    <ul class="brief-intel-list">
                                        ${foundations.slice(0, 5).map(f => `<li>${f.name}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${family.length > 0 ? `
                                <div class="brief-intel-card">
                                    <div class="brief-intel-label">👥 Family</div>
                                    <ul class="brief-intel-list">
                                        ${family.slice(0, 5).map(f => `<li>${f.name}${f.relationship ? ' (' + f.relationship + ')' : ''}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${military.length > 0 ? `
                                <div class="brief-intel-card">
                                    <div class="brief-intel-label">🎖️ Military</div>
                                    <ul class="brief-intel-list">
                                        ${military.slice(0, 3).map(m => `<li>${m.branch}${m.rank ? ' - ' + m.rank : ''}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${locations.length > 0 ? `
                                <div class="brief-intel-card">
                                    <div class="brief-intel-label">📍 Locations</div>
                                    <ul class="brief-intel-list">
                                        ${locations.slice(0, 5).map(l => `<li>${l.name}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // RAW RESEARCH SECTION
            if (research) {
                html += `
                    <div class="brief-section">
                        <div class="brief-section-title"><span class="icon">📄</span> Research Notes</div>
                        <div class="brief-research-text">${research}</div>
                    </div>
                `;
            }
            
            // YOUR NOTES SECTION
            const prospectId = prospect?.id || prospectName.replace(/\s+/g, '_').toLowerCase();
            html += renderNotesSection('prospect', prospectId, prospectName);
            
            // OTHER PEOPLE AT FIRM
            if (firm) {
                const otherProspects = toolData.prospects.filter(p => p.firmId === firm.id && p.name !== prospectName);
                if (otherProspects.length > 0) {
                    html += `
                        <div class="brief-section">
                            <div class="brief-section-title"><span class="icon">👥</span> Other People at ${firm.name} (${otherProspects.length})</div>
                            <div class="brief-people-list">
                                ${otherProspects.slice(0, 8).map(p => {
                                    const pPaths = toolData.relationships.filter(r => r.firmId === p.firmId).length;
                                    return `
                                        <div class="brief-person-item" onclick="showProspectBrief('${p.name}', '${firm.name}')">
                                            <span class="brief-person-icon">👤</span>
                                            <div class="brief-person-info">
                                                <div class="brief-person-name">${p.name}</div>
                                                <div class="brief-person-title">${p.title || 'No title'}</div>
                                            </div>
                                            <span class="brief-person-paths">${pPaths} paths</span>
                                        </div>
                                    `;
                                }).join('')}
                                ${otherProspects.length > 8 ? `<div style="font-size: 11px; color: #6c757d; text-align: center; padding: 8px;">+${otherProspects.length - 8} more</div>` : ''}
                            </div>
                        </div>
                    `;
                }
            }
            
            body.innerHTML = html || '<p style="color: #6c757d; text-align: center;">No additional information available.</p>';
            modal.style.display = 'flex';
        }
        
        // Show Firm Brief Modal
        function showFirmBrief(firmId) {
            const modal = document.getElementById('brief-modal');
            const title = document.getElementById('brief-modal-title');
            const subtitle = document.getElementById('brief-modal-subtitle');
            const body = document.getElementById('brief-modal-body');
            
            const firm = toolData.firms.find(f => f.id === firmId);
            if (!firm) return;
            
            title.textContent = firm.name;
            subtitle.textContent = `${firm.aum || ''} ${firm.type || ''} • ${firm.location || 'Location unknown'}`;
            
            // Get all prospects at firm
            const firmProspects = toolData.prospects.filter(p => p.firmId === firmId);
            
            // Get all paths to this firm
            const firmRels = toolData.relationships.filter(r => r.firmId === firmId);
            const connectorIds = [...new Set(firmRels.map(r => r.connectorId))];
            const connectors = connectorIds.map(cid => {
                const c = toolData.mutualConnections.find(x => x.id === cid);
                const prospectsReached = firmRels.filter(r => r.connectorId === cid).length;
                return { ...c, prospectsReached, isHot: isHotConnector(cid) };
            }).sort((a, b) => {
                if (a.isHot !== b.isHot) return b.isHot ? 1 : -1;
                return b.prospectsReached - a.prospectsReached;
            });
            
            // Aggregate intelligence across all prospects
            let allSchools = new Map();
            let allBoards = new Map();
            let allFoundations = new Map();
            
            firmProspects.forEach(p => {
                const research = researchData[p.name] || '';
                if (research) {
                    extractAllSchools(research).forEach(s => allSchools.set(s.name, s));
                    extractAllBoards(research).forEach(b => allBoards.set(b.name, b));
                    extractFoundations(research).forEach(f => allFoundations.set(f.name, f));
                }
            });
            
            // Store for export
            currentBriefData = { type: 'firm', firm, firmProspects, connectors, schools: [...allSchools.values()], boards: [...allBoards.values()], foundations: [...allFoundations.values()] };
            
            let html = '';
            
            // CONTACTS SECTION
            if (firmProspects.length > 0) {
                html += `
                    <div class="brief-section">
                        <div class="brief-section-title"><span class="icon">👥</span> Contacts (${firmProspects.length})</div>
                        <div class="brief-people-list">
                            ${firmProspects.map(p => {
                                const pPaths = toolData.relationships.filter(r => r.firmId === p.firmId).length;
                                const hasResearch = hasProspectResearch(p.name);
                                const hotPaths = toolData.relationships.filter(r => r.firmId === p.firmId && isHotConnector(r.connectorId)).length;
                                return `
                                    <div class="brief-person-item" onclick="showProspectBrief('${p.name}', '${firm.name}')">
                                        <span class="brief-person-icon">${hasResearch ? '📋' : '👤'}</span>
                                        <div class="brief-person-info">
                                            <div class="brief-person-name">${p.name}${hotPaths > 0 ? ' 🔥' : ''}</div>
                                            <div class="brief-person-title">${p.title || 'No title'}</div>
                                        </div>
                                        <span class="brief-person-paths">${pPaths} paths</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            // BEST CONNECTORS TO THIS FIRM
            if (connectors.length > 0) {
                const hotConns = connectors.filter(c => c.isHot);
                const regularConns = connectors.filter(c => !c.isHot);
                
                html += `
                    <div class="brief-section">
                        <div class="brief-section-title"><span class="icon">🔗</span> Best Connectors (${connectors.length})</div>
                        <div class="brief-paths-list">
                            ${hotConns.length > 0 ? `
                                <div style="font-size: 11px; font-weight: 600; color: #c05621; margin-bottom: 4px;">🔥 HOT CONNECTORS</div>
                                ${hotConns.slice(0, 5).map(c => `
                                    <div class="brief-path-item hot" onclick="showConnectorBrief('${c.id}')" style="cursor:pointer;">
                                        <span class="brief-path-icon">🔥</span>
                                        <div class="brief-path-info">
                                            <div class="brief-path-name">${c.name}</div>
                                            <div class="brief-path-detail">${c.company || ''}</div>
                                        </div>
                                        <span class="brief-path-badge mutual">reaches ${c.prospectsReached} contacts</span>
                                    </div>
                                `).join('')}
                            ` : ''}
                            ${regularConns.slice(0, 10).map(c => `
                                <div class="brief-path-item" onclick="showConnectorBrief('${c.id}')" style="cursor:pointer;">
                                    <span class="brief-path-icon">🤝</span>
                                    <div class="brief-path-info">
                                        <div class="brief-path-name">${c.name}</div>
                                        <div class="brief-path-detail">${c.company || ''}</div>
                                    </div>
                                    <span class="brief-path-badge mutual">reaches ${c.prospectsReached} contacts</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // AGGREGATED INTELLIGENCE
            const hasIntel = allSchools.size > 0 || allBoards.size > 0 || allFoundations.size > 0;
            if (hasIntel) {
                html += `
                    <div class="brief-section">
                        <div class="brief-section-title"><span class="icon">🧠</span> Aggregated Intelligence</div>
                        <div class="brief-intel-grid">
                            ${allSchools.size > 0 ? `
                                <div class="brief-intel-card">
                                    <div class="brief-intel-label">🎓 Schools Represented</div>
                                    <ul class="brief-intel-list">
                                        ${[...allSchools.values()].slice(0, 6).map(s => `<li>${s.name}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${allBoards.size > 0 ? `
                                <div class="brief-intel-card">
                                    <div class="brief-intel-label">🏛️ Board Connections</div>
                                    <ul class="brief-intel-list">
                                        ${[...allBoards.values()].slice(0, 6).map(b => `<li>${b.name}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${allFoundations.size > 0 ? `
                                <div class="brief-intel-card">
                                    <div class="brief-intel-label">🏦 Foundations</div>
                                    <ul class="brief-intel-list">
                                        ${[...allFoundations.values()].slice(0, 6).map(f => `<li>${f.name}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // FIRM RESEARCH
            if (firm.research) {
                html += `
                    <div class="brief-section">
                        <div class="brief-section-title"><span class="icon">📄</span> Firm Research</div>
                        <div class="brief-research-text">${firm.research}</div>
                    </div>
                `;
            }
            
            // YOUR NOTES SECTION
            html += renderNotesSection('firm', firmId, firm.name);
            
            body.innerHTML = html || '<p style="color: #6c757d; text-align: center;">No additional information available.</p>';
            modal.style.display = 'flex';
        }
        
        // Show Connector Brief Modal
        function showConnectorBrief(connectorId) {
            const modal = document.getElementById('brief-modal');
            const title = document.getElementById('brief-modal-title');
            const subtitle = document.getElementById('brief-modal-subtitle');
            const body = document.getElementById('brief-modal-body');
            
            const connector = toolData.mutualConnections.find(c => c.id === connectorId);
            if (!connector) return;
            
            const isHot = isHotConnector(connectorId);
            const team = toolData.teamMembers.find(t => {
                const rel = toolData.relationships.find(r => r.connectorId === connectorId);
                return rel && t.id === rel.teamMemberId;
            });
            
            title.textContent = `${isHot ? '🔥 ' : ''}${connector.name}`;
            subtitle.textContent = `${connector.company || ''} ${connector.location ? '• ' + connector.location : ''}`;
            
            // Get all firms/prospects this connector reaches
            const rels = toolData.relationships.filter(r => r.connectorId === connectorId);
            const firmIds = [...new Set(rels.map(r => r.firmId))];
            const reachableFirms = firmIds.map(fid => {
                const firm = toolData.firms.find(f => f.id === fid);
                const prospects = toolData.prospects.filter(p => p.firmId === fid);
                return { firm, prospects, contactCount: prospects.length };
            }).sort((a, b) => b.contactCount - a.contactCount);
            
            const totalProspects = reachableFirms.reduce((sum, f) => sum + f.contactCount, 0);
            
            // Store for export
            currentBriefData = { type: 'connector', connector, team, isHot, reachableFirms, totalProspects };
            
            let html = '';
            
            // CONNECTION INFO
            html += `
                <div class="brief-section">
                    <div class="brief-section-title"><span class="icon">🔗</span> Connection Details</div>
                    <div class="brief-intel-grid">
                        <div class="brief-intel-card" style="${isHot ? 'border-left-color: #FF6B35;' : ''}">
                            <div class="brief-intel-label">Status</div>
                            <div class="brief-intel-value">${isHot ? '🔥 Hot Connector' : 'Active Connector'}</div>
                        </div>
                        <div class="brief-intel-card">
                            <div class="brief-intel-label">Connected Via</div>
                            <div class="brief-intel-value">${team?.name || 'Unknown'}</div>
                        </div>
                        <div class="brief-intel-card">
                            <div class="brief-intel-label">Mutual Connections</div>
                            <div class="brief-intel-value">${formatNumber(connector.mutualCount || 0)}</div>
                        </div>
                        <div class="brief-intel-card">
                            <div class="brief-intel-label">Reach</div>
                            <div class="brief-intel-value">${reachableFirms.length} firms • ${totalProspects} contacts</div>
                        </div>
                    </div>
                </div>
            `;
            
            // FIRMS REACHABLE
            if (reachableFirms.length > 0) {
                html += `
                    <div class="brief-section">
                        <div class="brief-section-title"><span class="icon">🏢</span> Firms Reachable (${reachableFirms.length})</div>
                        <div class="brief-people-list">
                            ${reachableFirms.slice(0, 15).map(rf => `
                                <div class="brief-person-item" onclick="showFirmBrief('${rf.firm?.id}')" style="cursor:pointer;">
                                    <span class="brief-person-icon">🏢</span>
                                    <div class="brief-person-info">
                                        <div class="brief-person-name">${rf.firm?.name || 'Unknown'}</div>
                                        <div class="brief-person-title">${rf.firm?.location || ''}</div>
                                    </div>
                                    <span class="brief-person-paths">${rf.contactCount} contacts</span>
                                </div>
                            `).join('')}
                            ${reachableFirms.length > 15 ? `<div style="font-size: 11px; color: #6c757d; text-align: center; padding: 8px;">+${reachableFirms.length - 15} more firms</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // TOP PROSPECTS REACHABLE
            const allProspects = reachableFirms.flatMap(rf => rf.prospects.map(p => ({ ...p, firmName: rf.firm?.name })));
            if (allProspects.length > 0) {
                html += `
                    <div class="brief-section">
                        <div class="brief-section-title"><span class="icon">👥</span> Top Prospects Reachable</div>
                        <div class="brief-people-list">
                            ${allProspects.slice(0, 12).map(p => `
                                <div class="brief-person-item" onclick="showProspectBrief('${p.name}', '${p.firmName}')">
                                    <span class="brief-person-icon">👤</span>
                                    <div class="brief-person-info">
                                        <div class="brief-person-name">${p.name}</div>
                                        <div class="brief-person-title">${p.title || 'No title'} @ ${p.firmName}</div>
                                    </div>
                                </div>
                            `).join('')}
                            ${allProspects.length > 12 ? `<div style="font-size: 11px; color: #6c757d; text-align: center; padding: 8px;">+${allProspects.length - 12} more prospects</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // YOUR NOTES SECTION
            html += renderNotesSection('connector', connectorId, connector.name);
            
            body.innerHTML = html;
            modal.style.display = 'flex';
        }
        
        // Close brief modal
        function closeBriefModal(event) {
            if (event && event.target !== document.getElementById('brief-modal')) return;
            document.getElementById('brief-modal').style.display = 'none';
            // Reset expanded state when closing
            document.getElementById('brief-modal-content')?.classList.remove('expanded');
            const expandBtn = document.getElementById('btn-expand-brief');
            if (expandBtn) expandBtn.textContent = '⬌ Expand';
        }
        
        // Toggle brief modal size
        function toggleBriefModalSize() {
            const modalContent = document.getElementById('brief-modal-content');
            const expandBtn = document.getElementById('btn-expand-brief');
            
            if (modalContent.classList.contains('expanded')) {
                modalContent.classList.remove('expanded');
                expandBtn.textContent = '⬌ Expand';
            } else {
                modalContent.classList.add('expanded');
                expandBtn.textContent = '⬌ Shrink';
            }
        }
        
        // Export current brief to text
        function exportCurrentBrief() {
            if (!currentBriefData) return;
            
            let text = '';
            const d = currentBriefData;
            
            if (d.type === 'path') {
                text += `═══════════════════════════════════════════════════════════\n`;
                text += `PATH BRIEF: ${d.path.contactName}\n`;
                text += `via ${d.path.connectorName} ${d.isHot ? '🔥' : ''}\n`;
                text += `═══════════════════════════════════════════════════════════\n\n`;
                
                text += `INTRODUCTION PATH\n`;
                text += `────────────────────────────────────────\n`;
                text += `${d.path.teamName} → ${d.path.connectorName} → ${d.path.contactName}\n\n`;
                
                text += `TARGET\n`;
                text += `────────────────────────────────────────\n`;
                text += `${d.prospect?.name || d.path.contactName}\n`;
                text += `${d.prospect?.title || 'No title'}\n`;
                text += `${d.firm?.name || d.path.firmName}\n`;
                text += `${d.firm?.aum || ''} ${d.firm?.type || ''} • ${d.firm?.location || ''}\n\n`;
                
                text += `CONNECTOR\n`;
                text += `────────────────────────────────────────\n`;
                text += `${d.isHot ? '🔥 ' : ''}${d.connector?.name || d.path.connectorName}\n`;
                text += `${d.connector?.company || ''} ${d.connector?.location ? '• ' + d.connector.location : ''}\n`;
                text += `Via: ${d.team?.name || d.path.teamName}\n`;
                text += `Mutual: ${d.connector?.mutualCount || 0}\n`;
                if (d.context?.overlaps?.length > 0) {
                    text += `\nConnection Context:\n`;
                    d.context.overlaps.forEach(o => {
                        text += `  ${o.icon} ${o.detail}\n`;
                    });
                }
                text += `\n`;
                
                if (d.schools?.length > 0 || d.boards?.length > 0) {
                    text += `TARGET INTEL\n`;
                    text += `────────────────────────────────────────\n`;
                    if (d.schools?.length > 0) {
                        text += `Education: ${d.schools.map(s => s.name).join(', ')}\n`;
                    }
                    if (d.boards?.length > 0) {
                        text += `Boards: ${d.boards.map(b => b.name).join(', ')}\n`;
                    }
                    text += `\n`;
                }
                
                if (d.introRequest) {
                    text += `SUGGESTED ASK\n`;
                    text += `────────────────────────────────────────\n`;
                    text += `Subject: ${d.introRequest.subject}\n\n`;
                    text += `${d.introRequest.body}\n\n`;
                }
                
                const pathNote = getEntityNote('path', d.path.id);
                if (pathNote) {
                    text += `YOUR NOTES\n`;
                    text += `────────────────────────────────────────\n`;
                    text += `${pathNote}\n`;
                }
            } else if (d.type === 'prospect') {
                text += `═══════════════════════════════════════════════════════════\n`;
                text += `${d.name}\n`;
                text += `${d.prospect?.title || ''} @ ${d.firm}\n`;
                text += `═══════════════════════════════════════════════════════════\n\n`;
                
                if (d.paths.length > 0) {
                    text += `WARM PATHS (${d.paths.length})\n`;
                    text += `────────────────────────────────────────\n`;
                    d.paths.slice(0, 15).forEach(p => {
                        const hot = isHotConnector(p.connector?.id) ? '🔥 ' : '   ';
                        text += `${hot}${p.connector?.name} (via ${p.team?.name}) - ${p.connector?.mutualCount || 0} mutual\n`;
                    });
                    text += `\n`;
                }
                
                if (d.schools.length > 0 || d.boards.length > 0) {
                    text += `INTELLIGENCE\n`;
                    text += `────────────────────────────────────────\n`;
                    if (d.schools.length > 0) {
                        text += `Education: ${d.schools.map(s => s.name).join(', ')}\n`;
                    }
                    if (d.boards.length > 0) {
                        text += `Boards: ${d.boards.map(b => b.name).join(', ')}\n`;
                    }
                    if (d.family.length > 0) {
                        text += `Family: ${d.family.map(f => f.name).join(', ')}\n`;
                    }
                    text += `\n`;
                }
                
                if (d.research) {
                    text += `RESEARCH NOTES\n`;
                    text += `────────────────────────────────────────\n`;
                    text += `${d.research}\n\n`;
                }
                
                // Add user notes if present
                const prospectId = d.prospect?.id || d.name.replace(/\s+/g, '_').toLowerCase();
                const prospectNote = getEntityNote('prospect', prospectId);
                if (prospectNote) {
                    text += `YOUR NOTES\n`;
                    text += `────────────────────────────────────────\n`;
                    text += `${prospectNote}\n`;
                }
            } else if (d.type === 'firm') {
                text += `═══════════════════════════════════════════════════════════\n`;
                text += `${d.firm.name}\n`;
                text += `${d.firm.aum || ''} ${d.firm.type || ''} • ${d.firm.location || ''}\n`;
                text += `═══════════════════════════════════════════════════════════\n\n`;
                
                text += `CONTACTS (${d.firmProspects.length})\n`;
                text += `────────────────────────────────────────\n`;
                d.firmProspects.forEach(p => {
                    text += `• ${p.name} - ${p.title || 'No title'}\n`;
                });
                text += `\n`;
                
                text += `BEST CONNECTORS (${d.connectors.length})\n`;
                text += `────────────────────────────────────────\n`;
                d.connectors.slice(0, 10).forEach(c => {
                    const hot = c.isHot ? '🔥 ' : '   ';
                    text += `${hot}${c.name} - reaches ${c.prospectsReached} contacts\n`;
                });
                text += `\n`;
                
                // Add user notes if present
                const firmNote = getEntityNote('firm', d.firm.id);
                if (firmNote) {
                    text += `YOUR NOTES\n`;
                    text += `────────────────────────────────────────\n`;
                    text += `${firmNote}\n`;
                }
            } else if (d.type === 'connector') {
                text += `═══════════════════════════════════════════════════════════\n`;
                text += `${d.isHot ? '🔥 ' : ''}${d.connector.name}\n`;
                text += `${d.connector.company || ''} • ${d.connector.location || ''}\n`;
                text += `═══════════════════════════════════════════════════════════\n\n`;
                
                text += `CONNECTION\n`;
                text += `────────────────────────────────────────\n`;
                text += `Via: ${d.team?.name || 'Unknown'}\n`;
                text += `Mutual: ${d.connector.mutualCount || 0}\n`;
                text += `Reach: ${d.reachableFirms.length} firms, ${d.totalProspects} prospects\n\n`;
                
                text += `FIRMS REACHABLE\n`;
                text += `────────────────────────────────────────\n`;
                d.reachableFirms.slice(0, 15).forEach(rf => {
                    text += `• ${rf.firm?.name} (${rf.contactCount} contacts)\n`;
                });
                text += `\n`;
                
                // Add user notes if present
                const connectorNote = getEntityNote('connector', d.connector.id);
                if (connectorNote) {
                    text += `YOUR NOTES\n`;
                    text += `────────────────────────────────────────\n`;
                    text += `${connectorNote}\n`;
                }
            }
            
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `brief-${d.name || d.firm?.name || d.connector?.name || 'export'}.txt`.replace(/[^a-z0-9-]/gi, '-');
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Export all briefs
        function exportAllBriefs() {
            if (savedPaths.length === 0) {
                alert('No items in briefing book!');
                return;
            }
            
            let text = `═══════════════════════════════════════════════════════════\n`;
            text += `FOURBRIDGE BRIEFING BOOK\n`;
            text += `Generated: ${new Date().toLocaleDateString()}\n`;
            text += `Items: ${savedPaths.length}\n`;
            text += `═══════════════════════════════════════════════════════════\n\n`;
            
            // Group by firm for organized export
            const byFirm = {};
            savedPaths.forEach(p => {
                if (!byFirm[p.firmName]) byFirm[p.firmName] = [];
                byFirm[p.firmName].push(p);
            });
            
            Object.entries(byFirm).forEach(([firmName, paths]) => {
                const firm = toolData.firms.find(f => f.name === firmName);
                text += `\n═══════════════════════════════════════════════════════════\n`;
                text += `🏢 ${firmName}\n`;
                if (firm) {
                    text += `${firm.aum || ''} ${firm.type || ''} • ${firm.location || ''}\n`;
                }
                text += `═══════════════════════════════════════════════════════════\n`;
                
                // Unique prospects at this firm
                const seenProspects = new Set();
                paths.forEach(p => {
                    if (seenProspects.has(p.contactName)) return;
                    seenProspects.add(p.contactName);
                    
                    const prospect = toolData.prospects.find(pr => pr.name === p.contactName);
                    const research = researchData[p.contactName] || '';
                    
                    text += `\n👤 ${p.contactName}\n`;
                    text += `   ${prospect?.title || 'No title'}\n`;
                    
                    if (research) {
                        const schools = extractAllSchools(research);
                        const boards = extractAllBoards(research);
                        if (schools.length > 0) {
                            text += `   🎓 ${schools.map(s => s.name).slice(0, 3).join(', ')}\n`;
                        }
                        if (boards.length > 0) {
                            text += `   🏛️ ${boards.map(b => b.name).slice(0, 3).join(', ')}\n`;
                        }
                    }
                    
                    text += `   Best path: ${p.connectorName} (via ${p.teamName})\n`;
                });
            });
            
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fourbridge-briefing-book-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Export saved paths to clipboard (for pasting into Google Sheets)
        function exportSavedPaths() {
            if (savedPaths.length === 0) {
                alert('No paths saved yet!');
                return;
            }
            
            // Format for Google Sheets: Tab-separated values
            const headers = 'Firm\tTeam Member\tConnector\tContact\tSaved Date';
            const rows = savedPaths.map(p => 
                `${p.firmName}\t${p.teamName}\t${p.connectorName}\t${p.contactName}\t${p.savedAt.split('T')[0]}`
            );
            
            const tsv = [headers, ...rows].join('\n');
            
            navigator.clipboard.writeText(tsv).then(() => {
                alert(`Copied ${savedPaths.length} paths to clipboard!\n\nPaste directly into Google Sheets.`);
            }).catch(err => {
                // Fallback: show in a prompt
                prompt('Copy this data and paste into Google Sheets:', tsv);
            });
        }

        // Clear all saved paths
        function clearSavedPaths() {
            if (savedPaths.length === 0) return;
            
            if (confirm(`Clear all ${savedPaths.length} saved paths?`)) {
                savedPaths = [];
                persistSavedPaths();
            }
        }

        // ========== PASSWORD PROTECTION ==========
        const FOURBRIDGE_PASSWORD = 'fourbridge2024'; // Change this password
        
        function checkPassword() {
            const input = document.getElementById('password-input');
            const error = document.getElementById('password-error');
            const gate = document.getElementById('password-gate');
            const app = document.getElementById('app-content');
            
            if (input.value === FOURBRIDGE_PASSWORD) {
                // Store session (stays logged in until browser tab closes)
                sessionStorage.setItem('fourbridge_authenticated', 'true');
                gate.classList.add('hidden');
                app.classList.add('visible');
                // Initialize the app after authentication
                onAuthenticated();
            } else {
                input.classList.add('error');
                error.classList.add('show');
                setTimeout(() => {
                    input.classList.remove('error');
                }, 500);
            }
        }

        function checkAuthentication() {
            if (sessionStorage.getItem('fourbridge_authenticated') === 'true') {
                document.getElementById('password-gate').classList.add('hidden');
                document.getElementById('app-content').classList.add('visible');
                // App will initialize in window.onload
            }
        }

        // Check auth on page load
        document.addEventListener('DOMContentLoaded', checkAuthentication);

        // ========== START APPLICATION ==========
        window.onload = function() {
            // Only initialize if authenticated
            if (sessionStorage.getItem('fourbridge_authenticated') === 'true') {
                loadSavedPaths();
                initializeApp();
            }
        };
        
        // Called after password entry
        function onAuthenticated() {
            loadSavedPaths();
            initializeApp();
        }
    </script>
    </div><!-- End app-content -->
</body>
</html>
